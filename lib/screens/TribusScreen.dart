// Dart SDK
import 'dart:async';
import 'dart:math';

// Flutter
import 'package:flutter/material.dart';
import 'package:flutter/gestures.dart';
import 'package:flutter/services.dart';

// Firebase
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:firebase_messaging/firebase_messaging.dart';

// Paquetes externos
import 'package:google_fonts/google_fonts.dart';
import 'package:go_router/go_router.dart';
import 'package:intl/intl.dart';

// Proyecto
import 'package:formulario_app/services/auth_service.dart';
import 'package:formulario_app/utils/excel_exporter.dart';
import 'package:formulario_app/utils/theme_constants.dart';

// Locales
import 'CoordinadorScreen.dart';

class TribusScreen extends StatefulWidget {
  final String tribuId;
  final String tribuNombre;

  const TribusScreen({
    Key? key,
    required this.tribuId,
    required this.tribuNombre,
  }) : super(key: key);

  @override
  State<TribusScreen> createState() => _TribusScreenState();
}

class _TribusScreenState extends State<TribusScreen>
    with SingleTickerProviderStateMixin {
  // Variables para el manejo de sesión
  Timer? _inactivityTimer;
  static const Duration _inactivityDuration = Duration(minutes: 15);

  // Controller para las pestañas
  late TabController _tabController;

  // Variables estáticas existentes
  static final List<Map<String, dynamic>> _tabOptions = [
    {'title': 'Timoteos', 'icon': Icons.people, 'key': 'timoteos'},
    {
      'title': 'Coordinadores',
      'icon': Icons.supervised_user_circle,
      'key': 'coordinadores'
    },
    {
      'title': 'Personas Asignadas',
      'icon': Icons.assignment_ind,
      'key': 'asignadas'
    },
    {'title': 'Asistencias', 'icon': Icons.list_alt, 'key': 'asistencias'},
    {'title': 'Eventos', 'icon': Icons.event_note, 'key': 'inscripciones'},
  ];

// Variables para almacenar los filtros seleccionados
  String? _anioSeleccionado;
  String? _mesSeleccionado;

  // Variables de bloqueo (ahora son de instancia, no estáticas)
  int _intentosFallidos = 0;
  DateTime? _tiempoBloqueo;
  String? _horaBloqueo; // Hora en formato legible
  static const int _maxIntentos = 3;
  static const Duration _duracionBloqueo = Duration(hours: 12);

  // Timer para actualizar el contador de bloqueo
  Timer? _contadorBloqueoTimer;

  @override
  void initState() {
    super.initState();
    _tabController = TabController(length: 5, vsync: this);
    _resetInactivityTimer();

    // Detectar interacciones del usuario
    WidgetsBinding.instance.addPostFrameCallback((_) {
      if (mounted) {
        GestureBinding.instance.pointerRouter.addGlobalRoute((event) {
          if (mounted) {
            _resetInactivityTimer();
          }
        });
      }
    });

    _cargarEstadoBloqueo();
  }

  @override
  void dispose() {
    _inactivityTimer?.cancel();
    _contadorBloqueoTimer?.cancel();
    _tabController.dispose();
    super.dispose();
  }

  // Métodos para manejo de sesión
  void _resetInactivityTimer() {
    if (!mounted) return;

    _inactivityTimer?.cancel();
    _inactivityTimer = Timer(_inactivityDuration, () {
      if (mounted) {
        _cerrarSesionPorInactividad();
      }
    });
  }

  Future<void> _cerrarSesionPorInactividad() async {
    if (!mounted) return;

    _inactivityTimer?.cancel();

    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Row(
          children: [
            Icon(Icons.error_outline, color: Colors.white),
            SizedBox(width: 12),
            Expanded(
              child: Text(
                'Sesión expirada por inactividad',
                style: GoogleFonts.poppins(
                  color: Colors.white,
                  fontWeight: FontWeight.w500,
                ),
              ),
            ),
          ],
        ),
        backgroundColor: Colors.red[600],
        behavior: SnackBarBehavior.floating,
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
        margin: EdgeInsets.all(16),
      ),
    );

    await Future.delayed(Duration(milliseconds: 500));

    if (mounted) {
      context.go('/login');
    }
  }

  Future<void> _confirmarCerrarSesion() async {
    _resetInactivityTimer();

    final confirm = await showDialog<bool>(
      context: context,
      barrierDismissible: false,
      builder: (context) => AlertDialog(
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
        title: Row(
          children: [
            Container(
              padding: EdgeInsets.all(8),
              decoration: BoxDecoration(
                color: Colors.orange.withOpacity(0.1),
                borderRadius: BorderRadius.circular(12),
              ),
              child: Icon(
                Icons.logout_rounded,
                color: Colors.orange,
                size: 24,
              ),
            ),
            SizedBox(width: 12),
            Text(
              'Cerrar Sesión',
              style: GoogleFonts.poppins(
                fontSize: 18,
                fontWeight: FontWeight.w600,
              ),
            ),
          ],
        ),
        content: Text(
          '¿Estás seguro que deseas cerrar sesión?',
          style: GoogleFonts.poppins(
            fontSize: 14,
            color: Colors.grey[700],
          ),
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context, false),
            style: TextButton.styleFrom(
              padding: EdgeInsets.symmetric(horizontal: 20, vertical: 10),
              shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(10)),
            ),
            child: Text(
              'Cancelar',
              style: GoogleFonts.poppins(
                color: Colors.grey[600],
                fontWeight: FontWeight.w500,
              ),
            ),
          ),
          ElevatedButton(
            onPressed: () => Navigator.pop(context, true),
            style: ElevatedButton.styleFrom(
              backgroundColor: Colors.red[600],
              foregroundColor: Colors.white,
              padding: EdgeInsets.symmetric(horizontal: 20, vertical: 10),
              shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(10)),
              elevation: 2,
            ),
            child: Text(
              'Cerrar Sesión',
              style: GoogleFonts.poppins(fontWeight: FontWeight.w600),
            ),
          ),
        ],
      ),
    );

    if (confirm == true) {
      _inactivityTimer?.cancel();

      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Row(
            children: [
              Container(
                padding: EdgeInsets.all(2),
                decoration: BoxDecoration(
                  color: Colors.white.withOpacity(0.2),
                  shape: BoxShape.circle,
                ),
                child: Icon(Icons.check, color: Colors.white, size: 20),
              ),
              SizedBox(width: 12),
              Text(
                'Cerrando sesión...',
                style: GoogleFonts.poppins(
                  color: Colors.white,
                  fontWeight: FontWeight.w500,
                ),
              ),
            ],
          ),
          backgroundColor: Color(0xFF1B998B),
          behavior: SnackBarBehavior.floating,
          shape:
              RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
          margin: EdgeInsets.all(16),
        ),
      );

      await Future.delayed(Duration(milliseconds: 300));
      if (mounted) {
        context.go('/login');
      }
    }
  }

  bool _estaUsuarioBloqueado() {
    if (_tiempoBloqueo == null) return false;

    final ahora = DateTime.now();
    if (ahora.isBefore(_tiempoBloqueo!)) {
      return true; // Aún bloqueado
    } else {
      // El bloqueo expiró, resetear y guardar
      _tiempoBloqueo = null;
      _horaBloqueo = null;
      _intentosFallidos = 0;
      _guardarEstadoBloqueo();
      return false;
    }
  }

  Duration _tiempoRestanteBloqueo() {
    if (_tiempoBloqueo == null) return Duration.zero;
    final ahora = DateTime.now();
    return _tiempoBloqueo!.difference(ahora);
  }

  Future<void> _mostrarVentanaBloqueo(BuildContext context) async {
    _contadorBloqueoTimer?.cancel();

    await showDialog(
      context: context,
      barrierDismissible: false,
      builder: (BuildContext dialogContext) {
        return StatefulBuilder(
          builder: (context, setState) {
            _contadorBloqueoTimer?.cancel();
            _contadorBloqueoTimer =
                Timer.periodic(Duration(seconds: 1), (timer) {
              if (!_estaUsuarioBloqueado()) {
                timer.cancel();
                Navigator.of(dialogContext).pop();
                return;
              }
              if (mounted) {
                setState(() {});
              }
            });

            final tiempoRestante = _tiempoRestanteBloqueo();
            final horas = tiempoRestante.inHours;
            final minutos = tiempoRestante.inMinutes.remainder(60);
            final segundos = tiempoRestante.inSeconds.remainder(60);

            final horaDesbloqueo = _tiempoBloqueo?.toLocal();
            final horaDesbloqueoStr = horaDesbloqueo != null
                ? DateFormat('hh:mm a', 'es').format(horaDesbloqueo)
                : 'Desconocida';

            // ✅ Responsive Layout Builder
            return LayoutBuilder(
              builder: (context, constraints) {
                final mediaQuery = MediaQuery.of(dialogContext);
                final screenWidth = mediaQuery.size.width;
                final screenHeight = mediaQuery.size.height;
                final isSmallScreen = screenWidth < 400;
                final isMediumScreen = screenWidth >= 400 && screenWidth < 600;
                final isLargeScreen = screenWidth >= 600;

                // ✅ Tamaños adaptativos
                final titleFontSize =
                    isSmallScreen ? 20.0 : (isMediumScreen ? 24.0 : 28.0);
                final subtitleFontSize =
                    isSmallScreen ? 12.0 : (isMediumScreen ? 14.0 : 16.0);
                final iconSize =
                    isSmallScreen ? 40.0 : (isMediumScreen ? 56.0 : 64.0);
                final padding =
                    isSmallScreen ? 16.0 : (isMediumScreen ? 20.0 : 28.0);
                final timeDigitSize =
                    isSmallScreen ? 24.0 : (isMediumScreen ? 32.0 : 40.0);
                final timeLabelSize =
                    isSmallScreen ? 9.0 : (isMediumScreen ? 11.0 : 13.0);
                final contentFontSize =
                    isSmallScreen ? 13.0 : (isMediumScreen ? 15.0 : 17.0);
                final infoPadding =
                    isSmallScreen ? 12.0 : (isMediumScreen ? 16.0 : 20.0);

                // ✅ Constraints adaptativos
                final maxWidth = isSmallScreen
                    ? screenWidth * 0.95
                    : (isMediumScreen ? 420.0 : 500.0);
                final maxHeight = isSmallScreen
                    ? screenHeight * 0.85
                    : (isMediumScreen ? screenHeight * 0.8 : 650.0);

                return Dialog(
                  backgroundColor: Colors.transparent,
                  elevation: 0,
                  insetPadding: EdgeInsets.symmetric(
                    horizontal: isSmallScreen ? 16 : 24,
                    vertical: isSmallScreen ? 20 : 24,
                  ),
                  child: Container(
                    constraints: BoxConstraints(
                      maxWidth: maxWidth,
                      maxHeight: maxHeight,
                    ),
                    decoration: BoxDecoration(
                      borderRadius:
                          BorderRadius.circular(isSmallScreen ? 24 : 32),
                      boxShadow: [
                        BoxShadow(
                          color: Colors.black.withOpacity(0.3),
                          blurRadius: 32,
                          spreadRadius: 4,
                          offset: Offset(0, 12),
                        ),
                        BoxShadow(
                          color: Colors.red.withOpacity(0.2),
                          blurRadius: 24,
                          spreadRadius: -4,
                          offset: Offset(0, 8),
                        ),
                      ],
                    ),
                    child: ClipRRect(
                      borderRadius:
                          BorderRadius.circular(isSmallScreen ? 24 : 32),
                      child: Column(
                        mainAxisSize: MainAxisSize.min,
                        children: [
                          // ✅ Header Premium con degradado mejorado
                          Container(
                            padding: EdgeInsets.symmetric(
                              vertical: padding,
                              horizontal: padding * 0.8,
                            ),
                            decoration: BoxDecoration(
                              gradient: LinearGradient(
                                begin: Alignment.topLeft,
                                end: Alignment.bottomRight,
                                colors: [
                                  Color(0xFFD32F2F),
                                  Color(0xFFC62828),
                                  Color(0xFFB71C1C),
                                ],
                                stops: [0.0, 0.5, 1.0],
                              ),
                              boxShadow: [
                                BoxShadow(
                                  color: Colors.red.shade900.withOpacity(0.4),
                                  blurRadius: 20,
                                  offset: Offset(0, 8),
                                ),
                              ],
                            ),
                            child: Column(
                              children: [
                                // Icono animado premium
                                TweenAnimationBuilder(
                                  tween: Tween<double>(begin: 0.0, end: 1.0),
                                  duration: Duration(milliseconds: 1000),
                                  curve: Curves.elasticOut,
                                  builder: (context, double value, child) {
                                    return Transform.scale(
                                      scale: value,
                                      child: Container(
                                        padding: EdgeInsets.all(isSmallScreen
                                            ? 16
                                            : (isMediumScreen ? 20 : 24)),
                                        decoration: BoxDecoration(
                                          color: Colors.white.withOpacity(0.2),
                                          shape: BoxShape.circle,
                                          border: Border.all(
                                            color:
                                                Colors.white.withOpacity(0.6),
                                            width: isSmallScreen ? 3 : 4,
                                          ),
                                          boxShadow: [
                                            BoxShadow(
                                              color:
                                                  Colors.white.withOpacity(0.3),
                                              blurRadius: 20,
                                              spreadRadius: 2,
                                            ),
                                          ],
                                        ),
                                        child: Icon(
                                          Icons.lock_clock_rounded,
                                          color: Colors.white,
                                          size: iconSize,
                                        ),
                                      ),
                                    );
                                  },
                                ),
                                SizedBox(height: isSmallScreen ? 16 : 24),
                                // Título con mejor tipografía
                                Container(
                                  padding: EdgeInsets.symmetric(horizontal: 16),
                                  child: Column(
                                    children: [
                                      Text(
                                        'Acceso Bloqueado',
                                        style: GoogleFonts.poppins(
                                          fontSize: titleFontSize,
                                          fontWeight: FontWeight.w700,
                                          color: Colors.white,
                                          letterSpacing: 0.5,
                                          height: 1.2,
                                        ),
                                        textAlign: TextAlign.center,
                                      ),
                                      SizedBox(height: isSmallScreen ? 6 : 10),
                                      Container(
                                        padding: EdgeInsets.symmetric(
                                          horizontal: isSmallScreen ? 12 : 16,
                                          vertical: isSmallScreen ? 6 : 8,
                                        ),
                                        decoration: BoxDecoration(
                                          color: Colors.white.withOpacity(0.15),
                                          borderRadius:
                                              BorderRadius.circular(20),
                                          border: Border.all(
                                            color:
                                                Colors.white.withOpacity(0.3),
                                            width: 1,
                                          ),
                                        ),
                                        child: Row(
                                          mainAxisSize: MainAxisSize.min,
                                          children: [
                                            Icon(
                                              Icons.security_rounded,
                                              color: Colors.white
                                                  .withOpacity(0.95),
                                              size: isSmallScreen ? 14 : 16,
                                            ),
                                            SizedBox(width: 6),
                                            Text(
                                              'Seguridad Activada',
                                              style: GoogleFonts.poppins(
                                                fontSize: subtitleFontSize - 2,
                                                fontWeight: FontWeight.w500,
                                                color: Colors.white
                                                    .withOpacity(0.95),
                                                letterSpacing: 0.3,
                                              ),
                                            ),
                                          ],
                                        ),
                                      ),
                                    ],
                                  ),
                                ),
                              ],
                            ),
                          ),

                          // ✅ Contenido con mejor diseño
                          Flexible(
                            child: Container(
                              decoration: BoxDecoration(
                                gradient: LinearGradient(
                                  begin: Alignment.topCenter,
                                  end: Alignment.bottomCenter,
                                  colors: [
                                    Colors.white,
                                    Colors.grey.shade50,
                                  ],
                                ),
                              ),
                              child: SingleChildScrollView(
                                padding: EdgeInsets.all(padding),
                                physics: BouncingScrollPhysics(),
                                child: Column(
                                  children: [
                                    // Alerta principal con mejor diseño
                                    Container(
                                      padding: EdgeInsets.all(infoPadding),
                                      decoration: BoxDecoration(
                                        gradient: LinearGradient(
                                          begin: Alignment.topLeft,
                                          end: Alignment.bottomRight,
                                          colors: [
                                            Colors.orange.shade50,
                                            Colors.orange.shade100
                                                .withOpacity(0.5),
                                          ],
                                        ),
                                        borderRadius: BorderRadius.circular(
                                            isSmallScreen ? 16 : 20),
                                        border: Border.all(
                                          color: Colors.orange.shade400,
                                          width: 2,
                                        ),
                                        boxShadow: [
                                          BoxShadow(
                                            color:
                                                Colors.orange.withOpacity(0.15),
                                            blurRadius: 12,
                                            offset: Offset(0, 4),
                                          ),
                                        ],
                                      ),
                                      child: Column(
                                        children: [
                                          Container(
                                            padding: EdgeInsets.all(
                                                isSmallScreen ? 10 : 12),
                                            decoration: BoxDecoration(
                                              color: Colors.orange.shade600,
                                              shape: BoxShape.circle,
                                              boxShadow: [
                                                BoxShadow(
                                                  color: Colors.orange.shade400
                                                      .withOpacity(0.4),
                                                  blurRadius: 8,
                                                  spreadRadius: 2,
                                                ),
                                              ],
                                            ),
                                            child: Icon(
                                              Icons.warning_rounded,
                                              color: Colors.white,
                                              size: isSmallScreen
                                                  ? 28
                                                  : (isMediumScreen ? 32 : 36),
                                            ),
                                          ),
                                          SizedBox(
                                              height: isSmallScreen ? 12 : 16),
                                          Text(
                                            'Límite de Intentos Excedido',
                                            style: GoogleFonts.poppins(
                                              fontSize: contentFontSize + 2,
                                              fontWeight: FontWeight.w700,
                                              color: Colors.orange.shade900,
                                              letterSpacing: 0.3,
                                            ),
                                            textAlign: TextAlign.center,
                                          ),
                                          SizedBox(
                                              height: isSmallScreen ? 8 : 12),
                                          Container(
                                            padding: EdgeInsets.symmetric(
                                              horizontal:
                                                  isSmallScreen ? 12 : 16,
                                              vertical: isSmallScreen ? 8 : 10,
                                            ),
                                            decoration: BoxDecoration(
                                              color:
                                                  Colors.white.withOpacity(0.7),
                                              borderRadius:
                                                  BorderRadius.circular(12),
                                              border: Border.all(
                                                color: Colors.orange.shade200,
                                                width: 1,
                                              ),
                                            ),
                                            child: Text(
                                              'Por motivos de seguridad, la función de eliminación ha sido bloqueada temporalmente.',
                                              style: GoogleFonts.poppins(
                                                fontSize: contentFontSize - 2,
                                                color: Colors.orange.shade800,
                                                height: 1.4,
                                                fontWeight: FontWeight.w500,
                                              ),
                                              textAlign: TextAlign.center,
                                            ),
                                          ),
                                        ],
                                      ),
                                    ),

                                    SizedBox(height: isSmallScreen ? 20 : 28),

                                    // Información de horarios mejorada
                                    if (_horaBloqueo != null)
                                      Container(
                                        padding: EdgeInsets.all(infoPadding),
                                        decoration: BoxDecoration(
                                          color: Colors.white,
                                          borderRadius: BorderRadius.circular(
                                              isSmallScreen ? 16 : 20),
                                          border: Border.all(
                                            color: Colors.grey.shade300,
                                            width: 1.5,
                                          ),
                                          boxShadow: [
                                            BoxShadow(
                                              color: Colors.black
                                                  .withOpacity(0.05),
                                              blurRadius: 12,
                                              offset: Offset(0, 4),
                                            ),
                                          ],
                                        ),
                                        child: Column(
                                          children: [
                                            // Bloqueado
                                            _buildTimeInfoRow(
                                              icon: Icons.lock_clock_rounded,
                                              iconColor: Colors.red.shade600,
                                              iconBgColor: Colors.red.shade50,
                                              label: 'Bloqueado',
                                              time: _horaBloqueo!,
                                              contentFontSize: contentFontSize,
                                              isSmallScreen: isSmallScreen,
                                            ),

                                            SizedBox(
                                                height:
                                                    isSmallScreen ? 12 : 16),

                                            // Divider elegante
                                            Container(
                                              height: 1,
                                              decoration: BoxDecoration(
                                                gradient: LinearGradient(
                                                  colors: [
                                                    Colors.transparent,
                                                    Colors.grey.shade300,
                                                    Colors.transparent,
                                                  ],
                                                ),
                                              ),
                                            ),

                                            SizedBox(
                                                height:
                                                    isSmallScreen ? 12 : 16),

                                            // Desbloqueado
                                            _buildTimeInfoRow(
                                              icon: Icons.lock_open_rounded,
                                              iconColor: Colors.green.shade600,
                                              iconBgColor: Colors.green.shade50,
                                              label: 'Se desbloqueará',
                                              time: horaDesbloqueoStr,
                                              contentFontSize: contentFontSize,
                                              isSmallScreen: isSmallScreen,
                                            ),
                                          ],
                                        ),
                                      ),

                                    SizedBox(height: isSmallScreen ? 20 : 28),

                                    // ✅ Contador de tiempo premium
                                    Container(
                                      padding: EdgeInsets.all(isSmallScreen
                                          ? 20
                                          : (isMediumScreen ? 24 : 28)),
                                      decoration: BoxDecoration(
                                        gradient: LinearGradient(
                                          begin: Alignment.topLeft,
                                          end: Alignment.bottomRight,
                                          colors: [
                                            Colors.red.shade50,
                                            Colors.red.shade100,
                                            Colors.red.shade50,
                                          ],
                                        ),
                                        borderRadius: BorderRadius.circular(
                                            isSmallScreen ? 20 : 24),
                                        border: Border.all(
                                          color: Colors.red.shade300,
                                          width: 2,
                                        ),
                                        boxShadow: [
                                          BoxShadow(
                                            color: Colors.red.withOpacity(0.2),
                                            blurRadius: 16,
                                            offset: Offset(0, 6),
                                          ),
                                        ],
                                      ),
                                      child: Column(
                                        children: [
                                          Row(
                                            mainAxisAlignment:
                                                MainAxisAlignment.center,
                                            children: [
                                              Container(
                                                padding: EdgeInsets.all(
                                                    isSmallScreen ? 6 : 8),
                                                decoration: BoxDecoration(
                                                  color: Colors.red.shade600,
                                                  shape: BoxShape.circle,
                                                ),
                                                child: Icon(
                                                  Icons.timer_rounded,
                                                  color: Colors.white,
                                                  size: isSmallScreen ? 16 : 20,
                                                ),
                                              ),
                                              SizedBox(width: 10),
                                              Text(
                                                'Tiempo Restante',
                                                style: GoogleFonts.poppins(
                                                  fontSize: contentFontSize,
                                                  fontWeight: FontWeight.w700,
                                                  color: Colors.red.shade900,
                                                  letterSpacing: 0.5,
                                                ),
                                              ),
                                            ],
                                          ),
                                          SizedBox(
                                              height: isSmallScreen ? 16 : 24),

                                          // ✅ Layout adaptativo para el contador
                                          isSmallScreen
                                              ? Column(
                                                  children: [
                                                    _buildTimeUnit(
                                                        horas,
                                                        'Horas',
                                                        timeDigitSize,
                                                        timeLabelSize,
                                                        isSmallScreen),
                                                    SizedBox(height: 12),
                                                    _buildTimeUnit(
                                                        minutos,
                                                        'Minutos',
                                                        timeDigitSize,
                                                        timeLabelSize,
                                                        isSmallScreen),
                                                    SizedBox(height: 12),
                                                    _buildTimeUnit(
                                                        segundos,
                                                        'Segundos',
                                                        timeDigitSize,
                                                        timeLabelSize,
                                                        isSmallScreen),
                                                  ],
                                                )
                                              : Wrap(
                                                  alignment:
                                                      WrapAlignment.center,
                                                  crossAxisAlignment:
                                                      WrapCrossAlignment.center,
                                                  spacing:
                                                      isSmallScreen ? 8 : 16,
                                                  children: [
                                                    _buildTimeUnit(
                                                        horas,
                                                        'Horas',
                                                        timeDigitSize,
                                                        timeLabelSize,
                                                        isSmallScreen),
                                                    Text(
                                                      ':',
                                                      style:
                                                          GoogleFonts.poppins(
                                                        fontSize: timeDigitSize,
                                                        fontWeight:
                                                            FontWeight.w800,
                                                        color:
                                                            Colors.red.shade700,
                                                        height: 1,
                                                      ),
                                                    ),
                                                    _buildTimeUnit(
                                                        minutos,
                                                        'Minutos',
                                                        timeDigitSize,
                                                        timeLabelSize,
                                                        isSmallScreen),
                                                    Text(
                                                      ':',
                                                      style:
                                                          GoogleFonts.poppins(
                                                        fontSize: timeDigitSize,
                                                        fontWeight:
                                                            FontWeight.w800,
                                                        color:
                                                            Colors.red.shade700,
                                                        height: 1,
                                                      ),
                                                    ),
                                                    _buildTimeUnit(
                                                        segundos,
                                                        'Segundos',
                                                        timeDigitSize,
                                                        timeLabelSize,
                                                        isSmallScreen),
                                                  ],
                                                ),
                                        ],
                                      ),
                                    ),
                                  ],
                                ),
                              ),
                            ),
                          ),

                          // ✅ Footer Premium
                          Container(
                            padding: EdgeInsets.all(padding),
                            decoration: BoxDecoration(
                              color: Colors.white,
                              border: Border(
                                top: BorderSide(
                                  color: Colors.grey.shade200,
                                  width: 1,
                                ),
                              ),
                              boxShadow: [
                                BoxShadow(
                                  color: Colors.black.withOpacity(0.05),
                                  blurRadius: 12,
                                  offset: Offset(0, -4),
                                ),
                              ],
                            ),
                            child: SizedBox(
                              width: double.infinity,
                              child: ElevatedButton(
                                onPressed: () {
                                  _contadorBloqueoTimer?.cancel();
                                  Navigator.of(dialogContext).pop();
                                },
                                style: ElevatedButton.styleFrom(
                                  backgroundColor: Colors.red.shade600,
                                  foregroundColor: Colors.white,
                                  padding: EdgeInsets.symmetric(
                                    vertical: isSmallScreen ? 14 : 18,
                                    horizontal: isSmallScreen ? 24 : 32,
                                  ),
                                  shape: RoundedRectangleBorder(
                                    borderRadius: BorderRadius.circular(
                                        isSmallScreen ? 12 : 16),
                                  ),
                                  elevation: 4,
                                  shadowColor:
                                      Colors.red.shade600.withOpacity(0.4),
                                ),
                                child: Row(
                                  mainAxisAlignment: MainAxisAlignment.center,
                                  children: [
                                    Icon(
                                      Icons.check_circle_rounded,
                                      size: isSmallScreen ? 20 : 24,
                                    ),
                                    SizedBox(width: isSmallScreen ? 8 : 12),
                                    Text(
                                      'Entendido',
                                      style: GoogleFonts.poppins(
                                        fontSize: isSmallScreen ? 15 : 18,
                                        fontWeight: FontWeight.w700,
                                        letterSpacing: 0.5,
                                      ),
                                    ),
                                  ],
                                ),
                              ),
                            ),
                          ),
                        ],
                      ),
                    ),
                  ),
                );
              },
            );
          },
        );
      },
    ).then((_) {
      _contadorBloqueoTimer?.cancel();
    });
  }

// MÉTODO para las filas de información de tiempo
  Widget _buildTimeInfoRow({
    required IconData icon,
    required Color iconColor,
    required Color iconBgColor,
    required String label,
    required String time,
    required double contentFontSize,
    required bool isSmallScreen,
  }) {
    return Row(
      children: [
        Container(
          padding: EdgeInsets.all(isSmallScreen ? 10 : 12),
          decoration: BoxDecoration(
            color: iconBgColor,
            borderRadius: BorderRadius.circular(12),
            border: Border.all(
              color: iconColor.withOpacity(0.3),
              width: 1.5,
            ),
          ),
          child: Icon(
            icon,
            color: iconColor,
            size: isSmallScreen ? 20 : 24,
          ),
        ),
        SizedBox(width: isSmallScreen ? 12 : 16),
        Expanded(
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text(
                label,
                style: GoogleFonts.poppins(
                  fontSize: contentFontSize - 4,
                  fontWeight: FontWeight.w600,
                  color: Colors.grey.shade600,
                  letterSpacing: 0.3,
                ),
              ),
              SizedBox(height: 4),
              Text(
                time,
                style: GoogleFonts.poppins(
                  fontSize: contentFontSize + 2,
                  fontWeight: FontWeight.w700,
                  color: iconColor,
                  letterSpacing: 0.5,
                ),
              ),
            ],
          ),
        ),
      ],
    );
  }

  Widget _buildTimeUnit(int value, String label, double digitSize,
      double labelSize, bool isSmallScreen) {
    return Column(
      mainAxisSize: MainAxisSize.min,
      children: [
        Container(
          padding: EdgeInsets.symmetric(
            horizontal: isSmallScreen ? 16 : 24,
            vertical: isSmallScreen ? 12 : 16,
          ),
          decoration: BoxDecoration(
            gradient: LinearGradient(
              begin: Alignment.topLeft,
              end: Alignment.bottomRight,
              colors: [
                Color(0xFFD32F2F),
                Color(0xFFC62828),
                Color(0xFFB71C1C),
              ],
            ),
            borderRadius: BorderRadius.circular(isSmallScreen ? 12 : 16),
            boxShadow: [
              BoxShadow(
                color: Colors.red.shade900.withOpacity(0.4),
                blurRadius: 12,
                offset: Offset(0, 6),
              ),
              BoxShadow(
                color: Colors.red.withOpacity(0.2),
                blurRadius: 8,
                offset: Offset(0, 2),
              ),
            ],
            border: Border.all(
              color: Colors.white.withOpacity(0.2),
              width: 1.5,
            ),
          ),
          child: Text(
            value.toString().padLeft(2, '0'),
            style: GoogleFonts.poppins(
              fontSize: digitSize,
              fontWeight: FontWeight.w800,
              color: Colors.white,
              letterSpacing: 2,
              shadows: [
                Shadow(
                  color: Colors.black.withOpacity(0.3),
                  offset: Offset(0, 2),
                  blurRadius: 4,
                ),
              ],
            ),
          ),
        ),
        SizedBox(height: isSmallScreen ? 6 : 10),
        Container(
          padding: EdgeInsets.symmetric(
            horizontal: isSmallScreen ? 8 : 12,
            vertical: isSmallScreen ? 4 : 6,
          ),
          decoration: BoxDecoration(
            color: Colors.red.shade700,
            borderRadius: BorderRadius.circular(8),
          ),
          child: Text(
            label,
            style: GoogleFonts.poppins(
              fontSize: labelSize,
              fontWeight: FontWeight.w700,
              color: Colors.white,
              letterSpacing: 0.8,
            ),
          ),
        ),
      ],
    );
  }

  /// Muestra un diálogo de confirmación con verificación de contraseña para eliminar un usuario

  Future<bool> _confirmarEliminacionConContrasena(
    BuildContext context, {
    required String tipoUsuario,
    required String nombreUsuario,
    required Future<void> Function() onConfirmed,
  }) async {
    _resetInactivityTimer();

    // ✅ CRÍTICO: Cargar estado de bloqueo ANTES de verificar
    await _cargarEstadoBloqueo();

    // ✅ VERIFICAR SI ESTÁ BLOQUEADO
    if (_estaUsuarioBloqueado()) {
      await _mostrarVentanaBloqueo(context);
      return false;
    }

    final _passwordController = TextEditingController();
    bool _obscurePassword = true;
    bool _isVerifying = false;
    String? _errorMessage;

    // ✅ NUEVA VARIABLE: Para controlar si se confirmó la eliminación
    bool eliminacionConfirmada = false;

    final result = await showDialog<bool>(
      context: context,
      barrierDismissible: true,
      builder: (BuildContext dialogContext) {
        final mediaQuery = MediaQuery.of(dialogContext);
        final screenWidth = mediaQuery.size.width;
        final screenHeight = mediaQuery.size.height;
        final isSmallScreen = screenWidth < 600;
        final isMediumScreen = screenWidth >= 600 && screenWidth < 900;

        return StatefulBuilder(
          builder: (context, setState) {
            return GestureDetector(
              onTap: () {
                FocusScope.of(context).unfocus();
              },
              child: Center(
                child: SingleChildScrollView(
                  child: Dialog(
                    backgroundColor: Colors.white,
                    shape: RoundedRectangleBorder(
                      borderRadius:
                          BorderRadius.circular(isSmallScreen ? 20 : 24),
                    ),
                    elevation: 16,
                    insetPadding: EdgeInsets.symmetric(
                      horizontal: isSmallScreen ? 16 : 24,
                      vertical: 20,
                    ),
                    child: Container(
                      width: isSmallScreen
                          ? screenWidth * 0.9
                          : (isMediumScreen ? 450 : 500),
                      decoration: BoxDecoration(
                        color: Colors.white,
                        borderRadius:
                            BorderRadius.circular(isSmallScreen ? 20 : 24),
                        boxShadow: [
                          BoxShadow(
                            color: Colors.black.withOpacity(0.2),
                            blurRadius: 20,
                            spreadRadius: 2,
                            offset: Offset(0, 10),
                          ),
                        ],
                      ),
                      child: Column(
                        mainAxisSize: MainAxisSize.min,
                        children: [
                          // Header con gradiente mejorado
                          Container(
                            padding: EdgeInsets.all(isSmallScreen ? 20 : 28),
                            decoration: BoxDecoration(
                              gradient: LinearGradient(
                                begin: Alignment.topLeft,
                                end: Alignment.bottomRight,
                                colors: [
                                  Color(0xFFDC2626),
                                  Color(0xFFB91C1C),
                                ],
                              ),
                              borderRadius: BorderRadius.only(
                                topLeft:
                                    Radius.circular(isSmallScreen ? 20 : 24),
                                topRight:
                                    Radius.circular(isSmallScreen ? 20 : 24),
                              ),
                              boxShadow: [
                                BoxShadow(
                                  color: Color(0xFFDC2626).withOpacity(0.4),
                                  blurRadius: 16,
                                  offset: Offset(0, 6),
                                ),
                              ],
                            ),
                            child: Column(
                              children: [
                                // Ícono animado
                                TweenAnimationBuilder(
                                  tween: Tween<double>(begin: 0.0, end: 1.0),
                                  duration: Duration(milliseconds: 600),
                                  curve: Curves.elasticOut,
                                  builder: (context, double value, child) {
                                    return Transform.scale(
                                      scale: value,
                                      child: Container(
                                        padding: EdgeInsets.all(
                                            isSmallScreen ? 14 : 18),
                                        decoration: BoxDecoration(
                                          color: Colors.white.withOpacity(0.25),
                                          shape: BoxShape.circle,
                                          border: Border.all(
                                            color:
                                                Colors.white.withOpacity(0.6),
                                            width: 3,
                                          ),
                                          boxShadow: [
                                            BoxShadow(
                                              color: Colors.black
                                                  .withOpacity(0.15),
                                              blurRadius: 12,
                                              offset: Offset(0, 4),
                                            ),
                                          ],
                                        ),
                                        child: Icon(
                                          Icons.warning_amber_rounded,
                                          color: Colors.white,
                                          size: isSmallScreen ? 40 : 52,
                                        ),
                                      ),
                                    );
                                  },
                                ),
                                SizedBox(height: isSmallScreen ? 16 : 20),
                                // Título
                                Text(
                                  '⚠️ Eliminar $tipoUsuario',
                                  style: GoogleFonts.poppins(
                                    fontSize: isSmallScreen ? 20 : 24,
                                    fontWeight: FontWeight.bold,
                                    color: Colors.white,
                                    letterSpacing: 0.5,
                                  ),
                                  textAlign: TextAlign.center,
                                  maxLines: 2,
                                  overflow: TextOverflow.ellipsis,
                                ),
                                SizedBox(height: isSmallScreen ? 6 : 8),
                                // Subtítulo
                                Container(
                                  padding: EdgeInsets.symmetric(
                                    horizontal: isSmallScreen ? 12 : 16,
                                    vertical: isSmallScreen ? 6 : 8,
                                  ),
                                  decoration: BoxDecoration(
                                    color: Colors.white.withOpacity(0.15),
                                    borderRadius: BorderRadius.circular(20),
                                  ),
                                  child: Text(
                                    'Esta acción no se puede deshacer',
                                    style: GoogleFonts.poppins(
                                      fontSize: isSmallScreen ? 12 : 14,
                                      color: Colors.white.withOpacity(0.95),
                                      fontWeight: FontWeight.w500,
                                    ),
                                    textAlign: TextAlign.center,
                                  ),
                                ),
                              ],
                            ),
                          ),

                          // Contenido
                          Padding(
                            padding: EdgeInsets.all(isSmallScreen ? 20 : 28),
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              mainAxisSize: MainAxisSize.min,
                              children: [
                                // Información del usuario mejorada
                                Container(
                                  padding:
                                      EdgeInsets.all(isSmallScreen ? 16 : 20),
                                  decoration: BoxDecoration(
                                    gradient: LinearGradient(
                                      begin: Alignment.topLeft,
                                      end: Alignment.bottomRight,
                                      colors: [
                                        Color(0xFFFEE2E2),
                                        Color(0xFFFECDD3),
                                      ],
                                    ),
                                    borderRadius: BorderRadius.circular(
                                        isSmallScreen ? 16 : 20),
                                    border: Border.all(
                                      color: Color(0xFFDC2626).withOpacity(0.3),
                                      width: 2,
                                    ),
                                    boxShadow: [
                                      BoxShadow(
                                        color:
                                            Color(0xFFDC2626).withOpacity(0.1),
                                        blurRadius: 12,
                                        offset: Offset(0, 4),
                                      ),
                                    ],
                                  ),
                                  child: Row(
                                    children: [
                                      Container(
                                        padding: EdgeInsets.all(
                                            isSmallScreen ? 12 : 16),
                                        decoration: BoxDecoration(
                                          gradient: LinearGradient(
                                            colors: [
                                              Color(0xFFDC2626),
                                              Color(0xFFB91C1C),
                                            ],
                                          ),
                                          borderRadius:
                                              BorderRadius.circular(16),
                                          boxShadow: [
                                            BoxShadow(
                                              color: Color(0xFFDC2626)
                                                  .withOpacity(0.4),
                                              blurRadius: 8,
                                              offset: Offset(0, 4),
                                            ),
                                          ],
                                        ),
                                        child: Icon(
                                          tipoUsuario == 'Coordinador'
                                              ? Icons.supervisor_account
                                              : Icons.person,
                                          color: Colors.white,
                                          size: isSmallScreen ? 28 : 32,
                                        ),
                                      ),
                                      SizedBox(width: isSmallScreen ? 16 : 20),
                                      Expanded(
                                        child: Column(
                                          crossAxisAlignment:
                                              CrossAxisAlignment.start,
                                          children: [
                                            Text(
                                              'Usuario a eliminar:',
                                              style: GoogleFonts.poppins(
                                                fontSize:
                                                    isSmallScreen ? 12 : 13,
                                                color: Color(0xFFB91C1C),
                                                fontWeight: FontWeight.w600,
                                              ),
                                            ),
                                            SizedBox(height: 6),
                                            Text(
                                              nombreUsuario,
                                              style: GoogleFonts.poppins(
                                                fontSize:
                                                    isSmallScreen ? 16 : 18,
                                                fontWeight: FontWeight.bold,
                                                color: Color(0xFF991B1B),
                                              ),
                                              maxLines: 2,
                                              overflow: TextOverflow.ellipsis,
                                            ),
                                          ],
                                        ),
                                      ),
                                    ],
                                  ),
                                ),

                                SizedBox(height: isSmallScreen ? 20 : 24),

                                // Pregunta de confirmación mejorada
                                Container(
                                  padding:
                                      EdgeInsets.all(isSmallScreen ? 16 : 20),
                                  decoration: BoxDecoration(
                                    gradient: LinearGradient(
                                      begin: Alignment.topLeft,
                                      end: Alignment.bottomRight,
                                      colors: [
                                        Color(0xFFFEF3C7),
                                        Color(0xFFFDE68A),
                                      ],
                                    ),
                                    borderRadius: BorderRadius.circular(16),
                                    border: Border.all(
                                      color: Color(0xFFF59E0B).withOpacity(0.4),
                                      width: 2,
                                    ),
                                    boxShadow: [
                                      BoxShadow(
                                        color:
                                            Color(0xFFF59E0B).withOpacity(0.15),
                                        blurRadius: 10,
                                        offset: Offset(0, 4),
                                      ),
                                    ],
                                  ),
                                  child: Row(
                                    children: [
                                      Container(
                                        padding: EdgeInsets.all(10),
                                        decoration: BoxDecoration(
                                          color: Color(0xFFF59E0B)
                                              .withOpacity(0.2),
                                          shape: BoxShape.circle,
                                        ),
                                        child: Icon(
                                          Icons.help_outline_rounded,
                                          color: Color(0xFFD97706),
                                          size: isSmallScreen ? 24 : 28,
                                        ),
                                      ),
                                      SizedBox(width: 14),
                                      Expanded(
                                        child: Text(
                                          '¿Estás seguro de que deseas eliminar este $tipoUsuario?',
                                          style: GoogleFonts.poppins(
                                            fontSize: isSmallScreen ? 13 : 15,
                                            fontWeight: FontWeight.w600,
                                            color: Color(0xFF92400E),
                                          ),
                                        ),
                                      ),
                                    ],
                                  ),
                                ),

                                SizedBox(height: isSmallScreen ? 20 : 24),

                                // Campo de contraseña mejorado
                                Text(
                                  'Ingresa tu contraseña para confirmar:',
                                  style: GoogleFonts.poppins(
                                    fontSize: isSmallScreen ? 13 : 15,
                                    fontWeight: FontWeight.w600,
                                    color: Colors.grey.shade800,
                                  ),
                                ),
                                SizedBox(height: isSmallScreen ? 10 : 12),

                                Container(
                                  decoration: BoxDecoration(
                                    borderRadius: BorderRadius.circular(
                                        isSmallScreen ? 14 : 18),
                                    boxShadow: [
                                      BoxShadow(
                                        color: Colors.black.withOpacity(0.08),
                                        blurRadius: 12,
                                        offset: Offset(0, 4),
                                      ),
                                    ],
                                  ),
                                  child: TextField(
                                    controller: _passwordController,
                                    obscureText: _obscurePassword,
                                    enabled: !_isVerifying,
                                    style: GoogleFonts.poppins(
                                      fontSize: isSmallScreen ? 14 : 16,
                                      fontWeight: FontWeight.w500,
                                    ),
                                    onChanged: (value) {
                                      setState(() {});
                                    },
                                    decoration: InputDecoration(
                                      labelText: 'Contraseña',
                                      labelStyle: GoogleFonts.poppins(
                                        color: Color(0xFF1B998B),
                                        fontSize: isSmallScreen ? 13 : 15,
                                        fontWeight: FontWeight.w500,
                                      ),
                                      prefixIcon: Container(
                                        margin: EdgeInsets.all(
                                            isSmallScreen ? 10 : 14),
                                        padding: EdgeInsets.all(
                                            isSmallScreen ? 8 : 10),
                                        decoration: BoxDecoration(
                                          gradient: LinearGradient(
                                            colors: [
                                              Color(0xFF1B998B)
                                                  .withOpacity(0.15),
                                              Color(0xFF1B998B)
                                                  .withOpacity(0.08),
                                            ],
                                          ),
                                          borderRadius:
                                              BorderRadius.circular(12),
                                        ),
                                        child: Icon(
                                          Icons.lock_outline,
                                          color: Color(0xFF1B998B),
                                          size: isSmallScreen ? 20 : 22,
                                        ),
                                      ),
                                      suffixIcon: IconButton(
                                        icon: Icon(
                                          _obscurePassword
                                              ? Icons.visibility_outlined
                                              : Icons.visibility_off_outlined,
                                          color: Color(0xFF1B998B),
                                          size: isSmallScreen ? 22 : 24,
                                        ),
                                        onPressed: () {
                                          setState(() {
                                            _obscurePassword =
                                                !_obscurePassword;
                                          });
                                        },
                                      ),
                                      filled: true,
                                      fillColor: Colors.white,
                                      border: OutlineInputBorder(
                                        borderRadius: BorderRadius.circular(
                                            isSmallScreen ? 14 : 18),
                                        borderSide: BorderSide(
                                          color: Colors.grey.shade300,
                                          width: 2,
                                        ),
                                      ),
                                      enabledBorder: OutlineInputBorder(
                                        borderRadius: BorderRadius.circular(
                                            isSmallScreen ? 14 : 18),
                                        borderSide: BorderSide(
                                          color: Colors.grey.shade300,
                                          width: 2,
                                        ),
                                      ),
                                      focusedBorder: OutlineInputBorder(
                                        borderRadius: BorderRadius.circular(
                                            isSmallScreen ? 14 : 18),
                                        borderSide: BorderSide(
                                          color: Color(0xFF1B998B),
                                          width: 2.5,
                                        ),
                                      ),
                                      errorBorder: OutlineInputBorder(
                                        borderRadius: BorderRadius.circular(
                                            isSmallScreen ? 14 : 18),
                                        borderSide: BorderSide(
                                          color: Color(0xFFDC2626),
                                          width: 2.5,
                                        ),
                                      ),
                                      focusedErrorBorder: OutlineInputBorder(
                                        borderRadius: BorderRadius.circular(
                                            isSmallScreen ? 14 : 18),
                                        borderSide: BorderSide(
                                          color: Color(0xFFDC2626),
                                          width: 2.5,
                                        ),
                                      ),
                                      contentPadding: EdgeInsets.symmetric(
                                        horizontal: isSmallScreen ? 14 : 18,
                                        vertical: isSmallScreen ? 16 : 18,
                                      ),
                                    ),
                                  ),
                                ),

                                // Mensaje de error mejorado
                                if (_errorMessage != null) ...[
                                  SizedBox(height: 16),
                                  Container(
                                    padding: EdgeInsets.all(16),
                                    decoration: BoxDecoration(
                                      gradient: LinearGradient(
                                        begin: Alignment.topLeft,
                                        end: Alignment.bottomRight,
                                        colors: [
                                          Color(0xFFFEE2E2),
                                          Color(0xFFFECDD3),
                                        ],
                                      ),
                                      borderRadius: BorderRadius.circular(14),
                                      border: Border.all(
                                        color:
                                            Color(0xFFDC2626).withOpacity(0.4),
                                        width: 2,
                                      ),
                                      boxShadow: [
                                        BoxShadow(
                                          color: Color(0xFFDC2626)
                                              .withOpacity(0.15),
                                          blurRadius: 10,
                                          offset: Offset(0, 4),
                                        ),
                                      ],
                                    ),
                                    child: Row(
                                      children: [
                                        Container(
                                          padding: EdgeInsets.all(8),
                                          decoration: BoxDecoration(
                                            color: Color(0xFFDC2626)
                                                .withOpacity(0.2),
                                            shape: BoxShape.circle,
                                          ),
                                          child: Icon(
                                            Icons.error_outline,
                                            color: Color(0xFFB91C1C),
                                            size: isSmallScreen ? 20 : 22,
                                          ),
                                        ),
                                        SizedBox(width: 12),
                                        Expanded(
                                          child: Text(
                                            _errorMessage!,
                                            style: GoogleFonts.poppins(
                                              fontSize: isSmallScreen ? 12 : 13,
                                              color: Color(0xFF991B1B),
                                              fontWeight: FontWeight.w600,
                                            ),
                                          ),
                                        ),
                                      ],
                                    ),
                                  ),
                                ],
                              ],
                            ),
                          ),

// Footer con botones mejorados ✅ (VERSIÓN CORREGIDA)
                          Container(
                            padding: EdgeInsets.all(isSmallScreen ? 18 : 24),
                            decoration: BoxDecoration(
                              color: Colors.grey.shade50,
                              border: Border(
                                top: BorderSide(
                                    color: Colors.grey.shade300, width: 1),
                              ),
                              borderRadius: BorderRadius.only(
                                bottomLeft:
                                    Radius.circular(isSmallScreen ? 20 : 24),
                                bottomRight:
                                    Radius.circular(isSmallScreen ? 20 : 24),
                              ),
                            ),
                            child: isSmallScreen
                                ? Column(
                                    children: [
                                      SizedBox(
                                        width: double.infinity,
                                        child: ElevatedButton(
                                          onPressed: (_isVerifying ||
                                                  _passwordController
                                                      .text.isEmpty)
                                              ? null
                                              : () async {
                                                  if (_isVerifying) return;

                                                  FocusManager
                                                      .instance.primaryFocus
                                                      ?.unfocus();

                                                  setState(() {
                                                    _isVerifying = true;
                                                    _errorMessage = null;
                                                  });

                                                  await Future.delayed(
                                                      const Duration(
                                                          milliseconds: 1500));

                                                  try {
                                                    final authService =
                                                        AuthService();
                                                    final userId =
                                                        await authService
                                                            .getUserId();
                                                    final userRole =
                                                        await authService
                                                            .getCurrentUserRole();

                                                    String? loginUsername;

                                                    if (userRole == 'tribu') {
                                                      final tribuDoc =
                                                          await FirebaseFirestore
                                                              .instance
                                                              .collection(
                                                                  'usuarios')
                                                              .doc(userId)
                                                              .get();
                                                      loginUsername = tribuDoc
                                                          .data()?['usuario'];
                                                    } else if (userRole ==
                                                        'coordinador') {
                                                      final coordDoc =
                                                          await FirebaseFirestore
                                                              .instance
                                                              .collection(
                                                                  'coordinadores')
                                                              .doc(userId)
                                                              .get();
                                                      loginUsername = coordDoc
                                                          .data()?['usuario'];
                                                    } else if (userRole ==
                                                        'timoteo') {
                                                      final timDoc =
                                                          await FirebaseFirestore
                                                              .instance
                                                              .collection(
                                                                  'timoteos')
                                                              .doc(userId)
                                                              .get();
                                                      loginUsername = timDoc
                                                          .data()?['usuario'];
                                                    }

                                                    if (loginUsername == null ||
                                                        loginUsername.isEmpty) {
                                                      setState(() {
                                                        _errorMessage =
                                                            'No se pudo obtener el usuario.';
                                                        _isVerifying = false;
                                                      });
                                                      return;
                                                    }

                                                    final loginResult =
                                                        await authService.login(
                                                      loginUsername,
                                                      _passwordController.text,
                                                    );

                                                    if (loginResult != null) {
                                                      // ✅ Contraseña correcta
                                                      _intentosFallidos = 0;
                                                      _tiempoBloqueo = null;
                                                      _horaBloqueo = null;
                                                      await _guardarEstadoBloqueo();

                                                      // ✅ MARCAR COMO CONFIRMADO
                                                      eliminacionConfirmada =
                                                          true;

                                                      // ✅ CORREGIDO: Cerrar diálogo usando el dialogContext (estable en web/móvil)
                                                      if (dialogContext
                                                          .mounted) {
                                                        Navigator.of(
                                                                dialogContext)
                                                            .pop(true);
                                                      }
                                                    } else {
                                                      // ❌ Contraseña incorrecta
                                                      _intentosFallidos++;

                                                      if (_intentosFallidos >=
                                                          _maxIntentos) {
                                                        final ahoraUtc =
                                                            DateTime.now()
                                                                .toUtc();
                                                        final ahoraColombia =
                                                            ahoraUtc.subtract(
                                                                const Duration(
                                                                    hours: 5));

                                                        _tiempoBloqueo =
                                                            DateTime.now().add(
                                                                _duracionBloqueo);
                                                        _horaBloqueo = DateFormat(
                                                                'hh:mm a', 'es')
                                                            .format(
                                                                ahoraColombia);
                                                        await _guardarEstadoBloqueo();

                                                        if (context.mounted) {
                                                          Navigator.of(context)
                                                              .pop(false);
                                                          await Future.delayed(
                                                              const Duration(
                                                                  milliseconds:
                                                                      500));

                                                          // ✅ CORREGIDO: Verificar mounted antes de mostrar ventana de bloqueo
                                                          final parentContext =
                                                              this.context;
                                                          if (parentContext
                                                              .mounted) {
                                                            await _mostrarVentanaBloqueo(
                                                                parentContext);
                                                          }
                                                        }
                                                      } else {
                                                        final intentosRestantes =
                                                            _maxIntentos -
                                                                _intentosFallidos;
                                                        setState(() {
                                                          _passwordController
                                                              .clear();
                                                          _isVerifying = false;
                                                          if (intentosRestantes ==
                                                              1) {
                                                            _errorMessage =
                                                                '⚠️ ÚLTIMO INTENTO: Si fallas nuevamente, serás bloqueado por 12 horas.';
                                                          } else {
                                                            _errorMessage =
                                                                'Contraseña incorrecta. Te quedan $intentosRestantes ${intentosRestantes == 1 ? 'intento' : 'intentos'}.';
                                                          }
                                                        });
                                                      }
                                                    }
                                                  } catch (e) {
                                                    setState(() {
                                                      _errorMessage =
                                                          'Error al verificar: ${e.toString()}';
                                                      _isVerifying = false;
                                                    });
                                                  }
                                                },
                                          style: ElevatedButton.styleFrom(
                                            backgroundColor:
                                                const Color(0xFFDC2626),
                                            foregroundColor: Colors.white,
                                            disabledBackgroundColor:
                                                Colors.grey.shade300,
                                            padding: const EdgeInsets.symmetric(
                                                vertical: 16),
                                            shape: RoundedRectangleBorder(
                                              borderRadius:
                                                  BorderRadius.circular(14),
                                            ),
                                            elevation: 3,
                                            shadowColor: const Color(0xFFDC2626)
                                                .withOpacity(0.4),
                                          ),
                                          child: _isVerifying
                                              ? const SizedBox(
                                                  height: 20,
                                                  width: 20,
                                                  child: CircularProgressIndicator(
                                                      strokeWidth: 2.5,
                                                      valueColor:
                                                          AlwaysStoppedAnimation<
                                                                  Color>(
                                                              Colors.white)),
                                                )
                                              : Row(
                                                  mainAxisAlignment:
                                                      MainAxisAlignment.center,
                                                  children: [
                                                    const Icon(
                                                        Icons.delete_forever,
                                                        size: 20),
                                                    const SizedBox(width: 10),
                                                    Text(
                                                      'Confirmar Eliminación',
                                                      style:
                                                          GoogleFonts.poppins(
                                                        fontSize: 15,
                                                        fontWeight:
                                                            FontWeight.w700,
                                                        letterSpacing: 0.3,
                                                      ),
                                                    ),
                                                  ],
                                                ),
                                        ),
                                      ),
                                      const SizedBox(height: 12),
                                      SizedBox(
                                        width: double.infinity,
                                        child: OutlinedButton(
                                          onPressed: _isVerifying
                                              ? null
                                              : () {
                                                  FocusScope.of(context)
                                                      .unfocus();
                                                  Navigator.of(dialogContext)
                                                      .pop(false);
                                                },
                                          style: OutlinedButton.styleFrom(
                                            padding: const EdgeInsets.symmetric(
                                                vertical: 16),
                                            side: BorderSide(
                                              color: Colors.grey.shade400,
                                              width: 2,
                                            ),
                                            shape: RoundedRectangleBorder(
                                              borderRadius:
                                                  BorderRadius.circular(14),
                                            ),
                                          ),
                                          child: Text(
                                            'Cancelar',
                                            style: GoogleFonts.poppins(
                                              fontSize: 16,
                                              fontWeight: FontWeight.w600,
                                              color: Colors.grey.shade700,
                                            ),
                                          ),
                                        ),
                                      ),
                                    ],
                                  )
                                : Row(
                                    children: [
                                      Expanded(
                                        child: OutlinedButton(
                                          onPressed: _isVerifying
                                              ? null
                                              : () {
                                                  FocusScope.of(context)
                                                      .unfocus();
                                                  Navigator.pop(context, false);
                                                },
                                          style: OutlinedButton.styleFrom(
                                            padding: const EdgeInsets.symmetric(
                                                vertical: 18),
                                            side: BorderSide(
                                              color: Colors.grey.shade400,
                                              width: 2,
                                            ),
                                            shape: RoundedRectangleBorder(
                                              borderRadius:
                                                  BorderRadius.circular(14),
                                            ),
                                          ),
                                          child: Text(
                                            'Cancelar',
                                            style: GoogleFonts.poppins(
                                              fontSize: 16,
                                              fontWeight: FontWeight.w600,
                                              color: Colors.grey.shade700,
                                            ),
                                          ),
                                        ),
                                      ),
                                      const SizedBox(width: 14),
                                      Expanded(
                                        flex: 2,
                                        child: ElevatedButton(
                                          onPressed: (_isVerifying ||
                                                  _passwordController
                                                      .text.isEmpty)
                                              ? null
                                              : () async {
                                                  if (_isVerifying) return;

                                                  FocusManager
                                                      .instance.primaryFocus
                                                      ?.unfocus();

                                                  setState(() {
                                                    _isVerifying = true;
                                                    _errorMessage = null;
                                                  });

                                                  await Future.delayed(
                                                      const Duration(
                                                          milliseconds: 1500));

                                                  try {
                                                    final authService =
                                                        AuthService();
                                                    final userId =
                                                        await authService
                                                            .getUserId();
                                                    final userRole =
                                                        await authService
                                                            .getCurrentUserRole();

                                                    String? loginUsername;

                                                    if (userRole == 'tribu') {
                                                      final tribuDoc =
                                                          await FirebaseFirestore
                                                              .instance
                                                              .collection(
                                                                  'usuarios')
                                                              .doc(userId)
                                                              .get();
                                                      loginUsername = tribuDoc
                                                          .data()?['usuario'];
                                                    } else if (userRole ==
                                                        'coordinador') {
                                                      final coordDoc =
                                                          await FirebaseFirestore
                                                              .instance
                                                              .collection(
                                                                  'coordinadores')
                                                              .doc(userId)
                                                              .get();
                                                      loginUsername = coordDoc
                                                          .data()?['usuario'];
                                                    } else if (userRole ==
                                                        'timoteo') {
                                                      final timDoc =
                                                          await FirebaseFirestore
                                                              .instance
                                                              .collection(
                                                                  'timoteos')
                                                              .doc(userId)
                                                              .get();
                                                      loginUsername = timDoc
                                                          .data()?['usuario'];
                                                    }

                                                    if (loginUsername == null ||
                                                        loginUsername.isEmpty) {
                                                      setState(() {
                                                        _errorMessage =
                                                            'No se pudo obtener el usuario.';
                                                        _isVerifying = false;
                                                      });
                                                      return;
                                                    }

                                                    final loginResult =
                                                        await authService.login(
                                                      loginUsername,
                                                      _passwordController.text,
                                                    );

                                                    if (loginResult != null) {
                                                      _intentosFallidos = 0;
                                                      _tiempoBloqueo = null;
                                                      _horaBloqueo = null;
                                                      await _guardarEstadoBloqueo();

                                                      eliminacionConfirmada =
                                                          true;

                                                      // ✅ CORREGIDO: Cerrar diálogo de forma segura
                                                      if (context.mounted) {
                                                        Navigator.of(context)
                                                            .pop(true);
                                                      }
                                                    } else {
                                                      _intentosFallidos++;

                                                      if (_intentosFallidos >=
                                                          _maxIntentos) {
                                                        final ahoraUtc =
                                                            DateTime.now()
                                                                .toUtc();
                                                        final ahoraColombia =
                                                            ahoraUtc.subtract(
                                                                const Duration(
                                                                    hours: 5));

                                                        _tiempoBloqueo =
                                                            DateTime.now().add(
                                                                _duracionBloqueo);
                                                        _horaBloqueo = DateFormat(
                                                                'hh:mm a', 'es')
                                                            .format(
                                                                ahoraColombia);
                                                        await _guardarEstadoBloqueo();

                                                        if (context.mounted) {
                                                          Navigator.of(context)
                                                              .pop(false);
                                                          await Future.delayed(
                                                              const Duration(
                                                                  milliseconds:
                                                                      500));

                                                          // ✅ CORREGIDO: Verificar mounted antes de mostrar ventana de bloqueo
                                                          final parentContext =
                                                              this.context;
                                                          if (parentContext
                                                              .mounted) {
                                                            await _mostrarVentanaBloqueo(
                                                                parentContext);
                                                          }
                                                        }
                                                      } else {
                                                        final intentosRestantes =
                                                            _maxIntentos -
                                                                _intentosFallidos;
                                                        setState(() {
                                                          _passwordController
                                                              .clear();
                                                          _isVerifying = false;
                                                          if (intentosRestantes ==
                                                              1) {
                                                            _errorMessage =
                                                                '⚠️ ÚLTIMO INTENTO: Si fallas nuevamente, serás bloqueado por 12 horas.';
                                                          } else {
                                                            _errorMessage =
                                                                'Contraseña incorrecta. Te quedan $intentosRestantes ${intentosRestantes == 1 ? 'intento' : 'intentos'}.';
                                                          }
                                                        });
                                                      }
                                                    }
                                                  } catch (e) {
                                                    setState(() {
                                                      _errorMessage =
                                                          'Error al verificar: ${e.toString()}';
                                                      _isVerifying = false;
                                                    });
                                                  }
                                                },
                                          style: ElevatedButton.styleFrom(
                                            backgroundColor:
                                                const Color(0xFFDC2626),
                                            foregroundColor: Colors.white,
                                            disabledBackgroundColor:
                                                Colors.grey.shade300,
                                            padding: const EdgeInsets.symmetric(
                                                vertical: 18),
                                            shape: RoundedRectangleBorder(
                                              borderRadius:
                                                  BorderRadius.circular(14),
                                            ),
                                            elevation: 3,
                                            shadowColor: const Color(0xFFDC2626)
                                                .withOpacity(0.4),
                                          ),
                                          child: _isVerifying
                                              ? const SizedBox(
                                                  height: 22,
                                                  width: 22,
                                                  child: CircularProgressIndicator(
                                                      strokeWidth: 2.5,
                                                      valueColor:
                                                          AlwaysStoppedAnimation<
                                                                  Color>(
                                                              Colors.white)),
                                                )
                                              : Row(
                                                  mainAxisAlignment:
                                                      MainAxisAlignment.center,
                                                  children: [
                                                    const Icon(
                                                        Icons.delete_forever,
                                                        size: 22),
                                                    const SizedBox(width: 10),
                                                    Text(
                                                      'Confirmar Eliminación',
                                                      style:
                                                          GoogleFonts.poppins(
                                                        fontSize: 16,
                                                        fontWeight:
                                                            FontWeight.w700,
                                                        letterSpacing: 0.3,
                                                      ),
                                                    ),
                                                  ],
                                                ),
                                        ),
                                      ),
                                    ],
                                  ),
                          ),
                        ],
                      ),
                    ),
                  ),
                ),
              ),
            );
          },
        );
      },
    );

// ✅ EJECUTAR onConfirmed SOLO SI SE CONFIRMÓ LA ELIMINACIÓN
// ✅ CORREGIDO: usar un context estable (this.context) para SnackBar en web/móvil
    if (eliminacionConfirmada && result == true && mounted) {
      await Future.delayed(const Duration(milliseconds: 100));

      if (mounted) {
        final BuildContext stableContext = this.context;

        try {
          await onConfirmed();
          return true;
        } catch (e) {
          print('❌ Error al ejecutar onConfirmed: $e');

          // ✅ Mostrar mensaje de error al usuario con context estable
          if (mounted) {
            ScaffoldMessenger.of(stableContext).showSnackBar(
              SnackBar(
                content: Row(
                  children: [
                    const Icon(Icons.error_outline, color: Colors.white),
                    const SizedBox(width: 12),
                    Expanded(
                      child: Text(
                        'Error al eliminar: ${e.toString()}',
                        style: GoogleFonts.poppins(fontWeight: FontWeight.w500),
                      ),
                    ),
                  ],
                ),
                backgroundColor: Colors.red,
                behavior: SnackBarBehavior.floating,
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(12),
                ),
                duration: const Duration(seconds: 5),
              ),
            );
          }
          return false;
        }
      }
    }

    return false;
  }

  /// Cargar estado de bloqueo desde Firestore
  Future<void> _cargarEstadoBloqueo() async {
    try {
      final authService = AuthService();
      final userId = await authService.getUserId();

      if (userId.isEmpty) {
        print('⚠️ No se pudo obtener userId');
        return;
      }

      print('🔍 Cargando estado de bloqueo para userId: $userId');

      final doc = await FirebaseFirestore.instance
          .collection('bloqueos_usuarios')
          .doc(userId)
          .get();

      if (doc.exists) {
        final data = doc.data()!;
        final tiempoBloqueoTimestamp = data['tiempoBloqueo'] as Timestamp?;

        if (tiempoBloqueoTimestamp != null) {
          final tiempoBloqueoRecuperado = tiempoBloqueoTimestamp.toDate();
          final horaBloqueoRecuperada = data['horaBloqueo'] as String?;
          final intentosFallidosRecuperados =
              data['intentosFallidos'] as int? ?? 0;

          print('🔍 Bloqueo encontrado en Firestore:');
          print('   - Tiempo bloqueo: $tiempoBloqueoRecuperado');
          print('   - Hora bloqueo: $horaBloqueoRecuperada');
          print('   - Intentos fallidos: $intentosFallidosRecuperados');

          // Verificar si el bloqueo ya expiró
          final ahora = DateTime.now();
          if (ahora.isBefore(tiempoBloqueoRecuperado)) {
            // Bloqueo aún activo
            if (mounted) {
              setState(() {
                _tiempoBloqueo = tiempoBloqueoRecuperado;
                _horaBloqueo = horaBloqueoRecuperada;
                _intentosFallidos = intentosFallidosRecuperados;
              });
            }
            print('🔒 Usuario sigue bloqueado hasta: $tiempoBloqueoRecuperado');
          } else {
            // Bloqueo expirado
            print('✅ El bloqueo ya expiró, limpiando estado...');
            if (mounted) {
              setState(() {
                _tiempoBloqueo = null;
                _horaBloqueo = null;
                _intentosFallidos = 0;
              });
            }
            await _guardarEstadoBloqueo();
          }
        } else {
          print('ℹ️ Documento existe pero no hay tiempoBloqueo');
        }
      } else {
        print('ℹ️ No existe documento de bloqueo para este usuario');
      }
    } catch (e) {
      print('❌ Error al cargar estado de bloqueo: $e');
    }
  }

  /// Guardar estado de bloqueo en Firestore
  Future<void> _guardarEstadoBloqueo() async {
    try {
      // ========================================
      // PASO 4: LOGS DE DEBUG
      // ========================================
      print('💾 Guardando estado de bloqueo:');
      print('   - Tiempo bloqueo: $_tiempoBloqueo');
      print('   - Hora bloqueo: $_horaBloqueo');
      print('   - Intentos fallidos: $_intentosFallidos');

      final authService = AuthService();
      final userId = await authService.getUserId();

      if (_tiempoBloqueo == null) {
        // Si no hay bloqueo, eliminar el documento
        await FirebaseFirestore.instance
            .collection('bloqueos_usuarios')
            .doc(userId)
            .delete();

        print('🗑️ Documento de bloqueo eliminado para userId: $userId');
      } else {
        // Guardar estado de bloqueo
        await FirebaseFirestore.instance
            .collection('bloqueos_usuarios')
            .doc(userId)
            .set({
          'tiempoBloqueo': Timestamp.fromDate(_tiempoBloqueo!),
          'horaBloqueo': _horaBloqueo,
          'intentosFallidos': _intentosFallidos,
          'userId': userId,
          'ultimaActualizacion': FieldValue.serverTimestamp(),
        });

        print('✅ Estado de bloqueo guardado correctamente en Firestore');
      }
    } catch (e) {
      print('❌ Error al guardar estado de bloqueo: $e');
    }
  }

// Función para determinar el ministerio basado en el nombre de la tribu
  String _determinarMinisterio(String tribuNombre) {
    if (tribuNombre.contains('Juvenil')) return 'Ministerio Juvenil';
    if (tribuNombre.contains('Damas')) return 'Ministerio de Damas';
    if (tribuNombre.contains('Caballeros')) return 'Ministerio de Caballeros';
    return 'Otro';
  }

// Función para guardar registro en Firebase
  void _guardarRegistroEnFirebase(BuildContext context,
      Map<String, dynamic> registro, String tribuId) async {
    _resetInactivityTimer();

    // Mostrar pantalla de carga con diseño mejorado
    showDialog(
      context: context,
      barrierDismissible: false,
      builder: (context) => Dialog(
        backgroundColor: Colors.transparent,
        elevation: 0,
        child: Container(
          padding: EdgeInsets.all(20),
          decoration: BoxDecoration(
            color: Colors.white,
            borderRadius: BorderRadius.circular(20),
            boxShadow: [
              BoxShadow(
                color: Colors.black.withOpacity(0.1),
                blurRadius: 10,
                offset: Offset(0, 5),
              ),
            ],
          ),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              CircularProgressIndicator(
                color: Color(0xFF038C7F),
                strokeWidth: 3,
              ),
              SizedBox(height: 16),
              Text(
                'Guardando registro...',
                style: TextStyle(
                  fontSize: 16,
                  fontWeight: FontWeight.w500,
                  color: Color(0xFF1B998B),
                ),
              ),
            ],
          ),
        ),
      ),
    );

    try {
      final tribuSnapshot = await FirebaseFirestore.instance
          .collection('tribus')
          .doc(tribuId)
          .get();

      if (!tribuSnapshot.exists) {
        if (context.mounted) {
          Navigator.of(context, rootNavigator: true).pop();
          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(
              content: Row(
                children: [
                  Icon(Icons.error_outline, color: Colors.white),
                  SizedBox(width: 12),
                  Expanded(
                    child: Text(
                      'Error: La tribu no existe',
                      style: TextStyle(fontWeight: FontWeight.w500),
                    ),
                  ),
                ],
              ),
              backgroundColor: Colors.red,
              behavior: SnackBarBehavior.floating,
              shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(10)),
              margin: EdgeInsets.all(16),
            ),
          );
        }
        return;
      }

      final tribuData = tribuSnapshot.data() as Map<String, dynamic>;
      final tribuNombre = tribuData['nombreTribu'] ?? 'Desconocida';
      final ministerioAsignado = tribuData['ministerioAsignado'] ??
          tribuData['ministerio'] ??
          tribuData['categoria'] ??
          _determinarMinisterio(tribuNombre);

      registro['tribuAsignada'] = tribuId;
      registro['ministerioAsignado'] = ministerioAsignado;

      await FirebaseFirestore.instance.collection('registros').add(registro);

      if (context.mounted) {
        Navigator.of(context, rootNavigator: true).pop();
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Row(
              children: [
                Container(
                  padding: EdgeInsets.all(2),
                  decoration: BoxDecoration(
                    color: Colors.white.withOpacity(0.2),
                    shape: BoxShape.circle,
                  ),
                  child: Icon(Icons.check, color: Colors.white, size: 20),
                ),
                SizedBox(width: 12),
                Expanded(
                  child: Text(
                    'Registro guardado correctamente',
                    style: TextStyle(fontWeight: FontWeight.w500),
                  ),
                ),
              ],
            ),
            backgroundColor: Colors.green,
            behavior: SnackBarBehavior.floating,
            shape:
                RoundedRectangleBorder(borderRadius: BorderRadius.circular(10)),
            margin: EdgeInsets.all(16),
            duration: Duration(seconds: 3),
          ),
        );
        Navigator.pop(context);
      }
    } catch (e) {
      if (context.mounted) {
        Navigator.of(context, rootNavigator: true).pop();
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Row(
              children: [
                Icon(Icons.error_outline, color: Colors.white),
                SizedBox(width: 12),
                Expanded(
                  child: Text(
                    'Error al guardar el registro: $e',
                    style: TextStyle(fontWeight: FontWeight.w500),
                  ),
                ),
              ],
            ),
            backgroundColor: Colors.red,
            behavior: SnackBarBehavior.floating,
            shape:
                RoundedRectangleBorder(borderRadius: BorderRadius.circular(10)),
            margin: EdgeInsets.all(16),
          ),
        );
      }
    }
  }

  void _showRegistroDialog(BuildContext context) {
    _resetInactivityTimer();

    final _formKey = GlobalKey<FormState>();
    final _scrollController = ScrollController();

    // FocusNodes para navegación automática con Enter
    final _nombreFocus = FocusNode();
    final _apellidoFocus = FocusNode();
    final _telefonoFocus = FocusNode();
    final _edadFocus = FocusNode();
    final _direccionFocus = FocusNode();
    final _barrioFocus = FocusNode();
    final _nombreParejaFocus = FocusNode();
    final _descripcionOcupacionesFocus = FocusNode();
    final _referenciaInvitacionFocus = FocusNode();
    final _observacionesFocus = FocusNode();
    final _estadoProcesoFocus = FocusNode();

    final List<String> _estadosCiviles = [
      'Casado(a)',
      'Soltero(a)',
      'Unión Libre',
      'Separado(a)',
      'Viudo(a)'
    ];
    final List<String> _ocupaciones = [
      'Estudiante',
      'Profesional',
      'Trabaja',
      'Ama de Casa',
      'Otro'
    ];
    final List<String> _estadosProceso = [
      'Pendiente',
      'Discipulado 1',
      'Discipulado 2',
      'Discipulado 3',
      'Consolidación',
      'Estudio Bíblico',
      'Escuela de Líderes'
    ];

    // Variables para almacenar datos del formulario
    String nombre = '';
    String apellido = '';
    String telefono = '';
    String sexo = '';
    int edad = 0;
    String direccion = '';
    String barrio = '';
    String estadoCivil = 'Soltero(a)';
    String? nombrePareja = 'No aplica';
    List<String> ocupacionesSeleccionadas = [];
    String descripcionOcupaciones = '';
    bool tieneHijos = false;
    String referenciaInvitacion = '';
    String? observaciones;
    DateTime? fechaAsignacionTribu;
    String estadoProceso = '';

    showDialog(
      context: context,
      barrierDismissible: true,
      builder: (dialogContext) => MediaQuery.removeViewInsets(
        context: dialogContext,
        removeBottom: true,
        child: StatefulBuilder(
          builder: (context, setState) {
            final mediaQuery = MediaQuery.of(dialogContext);
            final screenWidth = mediaQuery.size.width;
            final screenHeight = mediaQuery.size.height;
            final bottomInset = mediaQuery.viewInsets.bottom;

            final isVerySmallScreen = screenWidth < 360;
            final isSmallScreen = screenWidth < 600;
            final isMediumScreen = screenWidth >= 600 && screenWidth < 900;
            final isLargeScreen = screenWidth >= 900;

            // Tamaños adaptativos
            final horizontalPadding = isVerySmallScreen
                ? 12.0
                : (isSmallScreen ? 16.0 : (isMediumScreen ? 20.0 : 24.0));
            final verticalPadding = isVerySmallScreen
                ? 12.0
                : (isSmallScreen ? 16.0 : (isMediumScreen ? 20.0 : 24.0));
            final headerPadding = isVerySmallScreen
                ? 14.0
                : (isSmallScreen ? 16.0 : (isMediumScreen ? 20.0 : 24.0));
            final titleFontSize = isVerySmallScreen
                ? 15.0
                : (isSmallScreen ? 16.0 : (isMediumScreen ? 18.0 : 20.0));
            final subtitleFontSize = isVerySmallScreen
                ? 11.0
                : (isSmallScreen ? 12.0 : (isMediumScreen ? 13.0 : 14.0));
            final sectionTitleSize = isVerySmallScreen
                ? 13.0
                : (isSmallScreen ? 14.0 : (isMediumScreen ? 16.0 : 18.0));
            final inputFontSize = isVerySmallScreen
                ? 13.0
                : (isSmallScreen ? 14.0 : (isMediumScreen ? 15.0 : 16.0));
            final labelFontSize = isVerySmallScreen
                ? 12.0
                : (isSmallScreen ? 13.0 : (isMediumScreen ? 14.0 : 15.0));
            final buttonFontSize = isVerySmallScreen
                ? 13.0
                : (isSmallScreen ? 14.0 : (isMediumScreen ? 15.0 : 16.0));
            final iconSize = isVerySmallScreen
                ? 18.0
                : (isSmallScreen ? 20.0 : (isMediumScreen ? 22.0 : 24.0));
            final borderRadius = isVerySmallScreen
                ? 10.0
                : (isSmallScreen ? 12.0 : (isMediumScreen ? 14.0 : 16.0));

            return Scaffold(
              backgroundColor: Colors.transparent,
              resizeToAvoidBottomInset: true, // ✅ Cambiado a true
              body: GestureDetector(
                onTap: () => FocusScope.of(context).unfocus(),
                child: Center(
                  child: Material(
                    type: MaterialType.transparency,
                    child: Container(
                      width: isVerySmallScreen
                          ? screenWidth * 0.95
                          : (isSmallScreen
                              ? 600
                              : (isMediumScreen ? 650 : 700)),
                      constraints: BoxConstraints(
                        maxHeight: screenHeight *
                            0.85, // ✅ Usar maxHeight en lugar de height fija
                      ),
                      decoration: BoxDecoration(
                        color: Colors.white,
                        borderRadius: BorderRadius.circular(
                          isVerySmallScreen
                              ? 14
                              : (isSmallScreen
                                  ? 16
                                  : (isMediumScreen ? 20 : 24)),
                        ),
                        boxShadow: [
                          BoxShadow(
                            color: Colors.black.withOpacity(0.15),
                            blurRadius: 20,
                            offset: Offset(0, 10),
                          ),
                        ],
                      ),
                      child: Column(
                        mainAxisSize: MainAxisSize.min,
                        children: [
                          // Header
                          Container(
                            padding: EdgeInsets.all(headerPadding),
                            decoration: BoxDecoration(
                              gradient: LinearGradient(
                                colors: [Color(0xFF1B998B), Color(0xFF038C7F)],
                                begin: Alignment.topLeft,
                                end: Alignment.bottomRight,
                              ),
                              borderRadius: BorderRadius.only(
                                topLeft: Radius.circular(isVerySmallScreen
                                    ? 14
                                    : (isSmallScreen
                                        ? 16
                                        : (isMediumScreen ? 20 : 24))),
                                topRight: Radius.circular(isVerySmallScreen
                                    ? 14
                                    : (isSmallScreen
                                        ? 16
                                        : (isMediumScreen ? 20 : 24))),
                              ),
                            ),
                            child: Row(
                              children: [
                                Container(
                                  padding: EdgeInsets.all(isVerySmallScreen
                                      ? 6
                                      : (isSmallScreen ? 7 : 8)),
                                  decoration: BoxDecoration(
                                    color: Colors.white.withOpacity(0.2),
                                    borderRadius: BorderRadius.circular(10),
                                  ),
                                  child: Icon(
                                    Icons.person_add_rounded,
                                    color: Colors.white,
                                    size: iconSize,
                                  ),
                                ),
                                SizedBox(
                                    width: isVerySmallScreen
                                        ? 10
                                        : (isSmallScreen ? 12 : 16)),
                                Expanded(
                                  child: Column(
                                    crossAxisAlignment:
                                        CrossAxisAlignment.start,
                                    children: [
                                      FittedBox(
                                        fit: BoxFit.scaleDown,
                                        alignment: Alignment.centerLeft,
                                        child: Text(
                                          'Registrar Nuevo Miembro',
                                          style: GoogleFonts.poppins(
                                            fontSize: titleFontSize,
                                            fontWeight: FontWeight.bold,
                                            color: Colors.white,
                                          ),
                                          maxLines: 1,
                                        ),
                                      ),
                                      FittedBox(
                                        fit: BoxFit.scaleDown,
                                        alignment: Alignment.centerLeft,
                                        child: Text(
                                          'Completa la información del nuevo integrante',
                                          style: GoogleFonts.poppins(
                                            fontSize: subtitleFontSize,
                                            color:
                                                Colors.white.withOpacity(0.9),
                                          ),
                                          maxLines: 1,
                                        ),
                                      ),
                                    ],
                                  ),
                                ),
                                IconButton(
                                  onPressed: () {
                                    FocusScope.of(context).unfocus();
                                    Future.delayed(Duration(milliseconds: 100),
                                        () {
                                      _scrollController.dispose();
                                      _nombreFocus.dispose();
                                      _apellidoFocus.dispose();
                                      _telefonoFocus.dispose();
                                      _edadFocus.dispose();
                                      _direccionFocus.dispose();
                                      _barrioFocus.dispose();
                                      _nombreParejaFocus.dispose();
                                      _descripcionOcupacionesFocus.dispose();
                                      _referenciaInvitacionFocus.dispose();
                                      _observacionesFocus.dispose();
                                      _estadoProcesoFocus.dispose();
                                      Navigator.pop(dialogContext);
                                    });
                                  },
                                  icon: Icon(Icons.close_rounded,
                                      color: Colors.white, size: iconSize),
                                  style: IconButton.styleFrom(
                                    backgroundColor:
                                        Colors.white.withOpacity(0.2),
                                    shape: RoundedRectangleBorder(
                                        borderRadius:
                                            BorderRadius.circular(10)),
                                    padding: EdgeInsets.all(isVerySmallScreen
                                        ? 6
                                        : (isSmallScreen ? 8 : 10)),
                                  ),
                                ),
                              ],
                            ),
                          ),

                          // Formulario con scroll mejorado
                          Expanded(
                            child: NotificationListener<ScrollNotification>(
                              onNotification: (notification) {
                                if (notification is ScrollUpdateNotification &&
                                    notification.dragDetails != null) {
                                  FocusScope.of(context).unfocus();
                                }
                                return false;
                              },
                              child: Scrollbar(
                                controller: _scrollController,
                                thumbVisibility: true,
                                child: SingleChildScrollView(
                                  controller: _scrollController,
                                  physics: ClampingScrollPhysics(),
                                  keyboardDismissBehavior:
                                      ScrollViewKeyboardDismissBehavior.manual,
                                  padding: EdgeInsets.fromLTRB(
                                    horizontalPadding,
                                    verticalPadding,
                                    horizontalPadding,
                                    verticalPadding + 20 + bottomInset,
                                  ),
                                  child: Form(
                                    key: _formKey,
                                    child: Column(
                                      crossAxisAlignment:
                                          CrossAxisAlignment.start,
                                      children: [
                                        // Información Personal
                                        _buildSectionHeader(
                                            'Información Personal',
                                            Icons.person_outline_rounded,
                                            sectionTitleSize,
                                            iconSize,
                                            borderRadius),
                                        SizedBox(
                                            height: verticalPadding * 0.75),

                                        isSmallScreen
                                            ? Column(
                                                children: [
                                                  _buildTextFieldWithFocus(
                                                      'Nombre',
                                                      Icons.badge_outlined,
                                                      (value) => nombre = value,
                                                      _nombreFocus,
                                                      _apellidoFocus,
                                                      inputFontSize,
                                                      labelFontSize,
                                                      iconSize,
                                                      borderRadius),
                                                  _buildTextFieldWithFocus(
                                                      'Apellido',
                                                      Icons
                                                          .person_outline_rounded,
                                                      (value) =>
                                                          apellido = value,
                                                      _apellidoFocus,
                                                      _telefonoFocus,
                                                      inputFontSize,
                                                      labelFontSize,
                                                      iconSize,
                                                      borderRadius),
                                                ],
                                              )
                                            : Row(
                                                children: [
                                                  Expanded(
                                                      child:
                                                          _buildTextFieldWithFocus(
                                                              'Nombre',
                                                              Icons
                                                                  .badge_outlined,
                                                              (value) =>
                                                                  nombre =
                                                                      value,
                                                              _nombreFocus,
                                                              _apellidoFocus,
                                                              inputFontSize,
                                                              labelFontSize,
                                                              iconSize,
                                                              borderRadius)),
                                                  SizedBox(
                                                      width: horizontalPadding),
                                                  Expanded(
                                                      child: _buildTextFieldWithFocus(
                                                          'Apellido',
                                                          Icons
                                                              .person_outline_rounded,
                                                          (value) =>
                                                              apellido = value,
                                                          _apellidoFocus,
                                                          _telefonoFocus,
                                                          inputFontSize,
                                                          labelFontSize,
                                                          iconSize,
                                                          borderRadius)),
                                                ],
                                              ),

                                        isSmallScreen
                                            ? Column(
                                                children: [
                                                  _buildTextFieldWithFocus(
                                                      'Teléfono',
                                                      Icons.phone_outlined,
                                                      (value) =>
                                                          telefono = value,
                                                      _telefonoFocus,
                                                      _edadFocus,
                                                      inputFontSize,
                                                      labelFontSize,
                                                      iconSize,
                                                      borderRadius,
                                                      keyboardType:
                                                          TextInputType.phone),
                                                  _buildTextFieldWithFocus(
                                                      'Edad',
                                                      Icons.cake_outlined,
                                                      (value) => edad =
                                                          int.tryParse(value) ??
                                                              0,
                                                      _edadFocus,
                                                      _direccionFocus,
                                                      inputFontSize,
                                                      labelFontSize,
                                                      iconSize,
                                                      borderRadius,
                                                      keyboardType:
                                                          TextInputType.number),
                                                ],
                                              )
                                            : Row(
                                                children: [
                                                  Expanded(
                                                      flex: 2,
                                                      child:
                                                          _buildTextFieldWithFocus(
                                                              'Teléfono',
                                                              Icons
                                                                  .phone_outlined,
                                                              (value) =>
                                                                  telefono =
                                                                      value,
                                                              _telefonoFocus,
                                                              _edadFocus,
                                                              inputFontSize,
                                                              labelFontSize,
                                                              iconSize,
                                                              borderRadius,
                                                              keyboardType:
                                                                  TextInputType
                                                                      .phone)),
                                                  SizedBox(
                                                      width: horizontalPadding),
                                                  Expanded(
                                                      child: _buildTextFieldWithFocus(
                                                          'Edad',
                                                          Icons.cake_outlined,
                                                          (value) => edad =
                                                              int.tryParse(
                                                                      value) ??
                                                                  0,
                                                          _edadFocus,
                                                          _direccionFocus,
                                                          inputFontSize,
                                                          labelFontSize,
                                                          iconSize,
                                                          borderRadius,
                                                          keyboardType:
                                                              TextInputType
                                                                  .number)),
                                                ],
                                              ),

                                        _buildDropdownField(
                                            'Sexo',
                                            ['Masculino', 'Femenino'],
                                            (value) => sexo = value,
                                            Icons.wc_outlined,
                                            inputFontSize,
                                            labelFontSize,
                                            iconSize,
                                            borderRadius),

                                        SizedBox(height: verticalPadding),

                                        // Ubicación
                                        _buildSectionHeader(
                                            'Ubicación',
                                            Icons.location_on_outlined,
                                            sectionTitleSize,
                                            iconSize,
                                            borderRadius),
                                        SizedBox(
                                            height: verticalPadding * 0.75),

                                        _buildTextFieldWithFocus(
                                            'Dirección',
                                            Icons.home_outlined,
                                            (value) => direccion = value,
                                            _direccionFocus,
                                            _barrioFocus,
                                            inputFontSize,
                                            labelFontSize,
                                            iconSize,
                                            borderRadius),
                                        _buildTextFieldWithFocus(
                                            'Barrio',
                                            Icons.location_city_outlined,
                                            (value) => barrio = value,
                                            _barrioFocus,
                                            _referenciaInvitacionFocus,
                                            inputFontSize,
                                            labelFontSize,
                                            iconSize,
                                            borderRadius),

                                        SizedBox(height: verticalPadding),

                                        // Estado Civil
                                        _buildSectionHeader(
                                            'Estado Civil',
                                            Icons.favorite_outline_rounded,
                                            sectionTitleSize,
                                            iconSize,
                                            borderRadius),
                                        SizedBox(
                                            height: verticalPadding * 0.75),

                                        _buildDropdownField(
                                            'Estado Civil', _estadosCiviles,
                                            (value) {
                                          setState(() {
                                            estadoCivil = value;
                                            if (estadoCivil == 'Casado(a)' ||
                                                estadoCivil == 'Unión Libre') {
                                              nombrePareja = '';
                                            } else {
                                              nombrePareja = 'No aplica';
                                            }
                                          });
                                        },
                                            Icons.favorite_border_rounded,
                                            inputFontSize,
                                            labelFontSize,
                                            iconSize,
                                            borderRadius),

                                        AnimatedContainer(
                                          duration: Duration(milliseconds: 300),
                                          height: (estadoCivil == 'Casado(a)' ||
                                                  estadoCivil == 'Unión Libre')
                                              ? null
                                              : 0,
                                          child: AnimatedOpacity(
                                            duration:
                                                Duration(milliseconds: 300),
                                            opacity:
                                                (estadoCivil == 'Casado(a)' ||
                                                        estadoCivil ==
                                                            'Unión Libre')
                                                    ? 1.0
                                                    : 0.0,
                                            child: (estadoCivil ==
                                                        'Casado(a)' ||
                                                    estadoCivil ==
                                                        'Unión Libre')
                                                ? _buildTextFieldWithFocus(
                                                    'Nombre de la Pareja',
                                                    Icons.favorite_rounded,
                                                    (value) =>
                                                        nombrePareja = value,
                                                    _nombreParejaFocus,
                                                    _referenciaInvitacionFocus,
                                                    inputFontSize,
                                                    labelFontSize,
                                                    iconSize,
                                                    borderRadius)
                                                : SizedBox(),
                                          ),
                                        ),

                                        SizedBox(height: verticalPadding),

                                        // Ocupaciones
                                        _buildSectionHeader(
                                            'Ocupaciones',
                                            Icons.work_outline_rounded,
                                            sectionTitleSize,
                                            iconSize,
                                            borderRadius),
                                        SizedBox(
                                            height: verticalPadding * 0.75),

                                        _buildOcupacionesSelector(
                                            ocupacionesSeleccionadas,
                                            _ocupaciones,
                                            setState,
                                            inputFontSize,
                                            labelFontSize,
                                            borderRadius),

                                        AnimatedContainer(
                                          duration: Duration(milliseconds: 300),
                                          height: ocupacionesSeleccionadas
                                                  .isNotEmpty
                                              ? null
                                              : 0,
                                          child: AnimatedOpacity(
                                            duration:
                                                Duration(milliseconds: 300),
                                            opacity: ocupacionesSeleccionadas
                                                    .isNotEmpty
                                                ? 1.0
                                                : 0.0,
                                            child: ocupacionesSeleccionadas
                                                    .isNotEmpty
                                                ? Padding(
                                                    padding: EdgeInsets.only(
                                                        top: verticalPadding *
                                                            0.75),
                                                    child: _buildTextFieldWithFocus(
                                                        'Descripción de Ocupaciones',
                                                        Icons
                                                            .description_outlined,
                                                        (value) =>
                                                            descripcionOcupaciones =
                                                                value,
                                                        _descripcionOcupacionesFocus,
                                                        _referenciaInvitacionFocus,
                                                        inputFontSize,
                                                        labelFontSize,
                                                        iconSize,
                                                        borderRadius,
                                                        isRequired: false),
                                                  )
                                                : SizedBox(),
                                          ),
                                        ),

                                        SizedBox(height: verticalPadding),

                                        // Información Adicional
                                        _buildSectionHeader(
                                            'Información Adicional',
                                            Icons.info_outline_rounded,
                                            sectionTitleSize,
                                            iconSize,
                                            borderRadius),
                                        SizedBox(
                                            height: verticalPadding * 0.75),

                                        _buildDropdownField(
                                            'Tiene Hijos',
                                            ['No', 'Sí'],
                                            (value) =>
                                                tieneHijos = (value == 'Sí'),
                                            Icons.child_care_outlined,
                                            inputFontSize,
                                            labelFontSize,
                                            iconSize,
                                            borderRadius),

                                        _buildTextFieldWithFocus(
                                            'Referencia de Invitación',
                                            Icons.link_outlined,
                                            (value) =>
                                                referenciaInvitacion = value,
                                            _referenciaInvitacionFocus,
                                            _observacionesFocus,
                                            inputFontSize,
                                            labelFontSize,
                                            iconSize,
                                            borderRadius),

                                        _buildTextFieldWithFocus(
                                            'Observaciones',
                                            Icons.note_outlined,
                                            (value) => observaciones = value,
                                            _observacionesFocus,
                                            _estadoProcesoFocus,
                                            inputFontSize,
                                            labelFontSize,
                                            iconSize,
                                            borderRadius,
                                            isRequired: false,
                                            maxLines: 3),

                                        _buildTextFieldConOpcionesWithFocus(
                                            'Estado del Proceso',
                                            Icons.track_changes_outlined,
                                            (value) => estadoProceso = value,
                                            _estadoProcesoFocus,
                                            null,
                                            opciones: _estadosProceso,
                                            isRequired: false,
                                            inputFontSize: inputFontSize,
                                            labelFontSize: labelFontSize,
                                            iconSize: iconSize,
                                            borderRadius: borderRadius),

                                        _buildDatePickerField(
                                            context,
                                            fechaAsignacionTribu,
                                            (date) => setState(() =>
                                                fechaAsignacionTribu = date),
                                            inputFontSize,
                                            labelFontSize,
                                            iconSize,
                                            borderRadius),

                                        SizedBox(height: verticalPadding),
                                        Divider(
                                            color: Color(0xFF1B998B)
                                                .withOpacity(0.2),
                                            thickness: 1),
                                        SizedBox(
                                            height: verticalPadding * 0.75),

                                        // Botones de acción
                                        _buildActionButtons(
                                            context,
                                            _formKey,
                                            nombre,
                                            apellido,
                                            telefono,
                                            sexo,
                                            edad,
                                            direccion,
                                            barrio,
                                            estadoCivil,
                                            nombrePareja,
                                            ocupacionesSeleccionadas,
                                            descripcionOcupaciones,
                                            tieneHijos,
                                            referenciaInvitacion,
                                            observaciones,
                                            estadoProceso,
                                            fechaAsignacionTribu,
                                            isSmallScreen,
                                            buttonFontSize,
                                            iconSize,
                                            borderRadius,
                                            _scrollController, [
                                          _nombreFocus,
                                          _apellidoFocus,
                                          _telefonoFocus,
                                          _edadFocus,
                                          _direccionFocus,
                                          _barrioFocus,
                                          _nombreParejaFocus,
                                          _descripcionOcupacionesFocus,
                                          _referenciaInvitacionFocus,
                                          _observacionesFocus,
                                          _estadoProcesoFocus
                                        ]),

                                        SizedBox(
                                            height: verticalPadding * 0.75),
                                      ],
                                    ),
                                  ),
                                ),
                              ),
                            ),
                          ),
                        ],
                      ),
                    ),
                  ),
                ),
              ),
            );
          },
        ),
      ),
    );
  }

// Métodos auxiliares

  Widget _buildSectionHeader(String title, IconData icon, double fontSize,
      double iconSize, double borderRadius) {
    return Container(
      padding: EdgeInsets.symmetric(vertical: 6),
      child: Row(
        children: [
          Container(
            padding: EdgeInsets.all(6),
            decoration: BoxDecoration(
              color: Color(0xFF1B998B).withOpacity(0.1),
              borderRadius: BorderRadius.circular(8),
            ),
            child: Icon(icon, color: Color(0xFF1B998B), size: iconSize * 0.9),
          ),
          SizedBox(width: 10),
          Expanded(
            child: Text(
              title,
              style: GoogleFonts.poppins(
                fontSize: fontSize,
                fontWeight: FontWeight.bold,
                color: Color(0xFF1B998B),
              ),
              softWrap: true,
              maxLines: 2, // ✅ permite mostrarlo completo en pantallas pequeñas
              overflow: TextOverflow.visible, // ✅ evita el corte
            ),
          ),
          SizedBox(width: 8),
          Expanded(
            child: Container(
              height: 1,
              decoration: BoxDecoration(
                gradient: LinearGradient(
                  colors: [
                    Color(0xFF1B998B).withOpacity(0.3),
                    Colors.transparent
                  ],
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildTextFieldWithFocus(
    String label,
    IconData icon,
    Function(String) onChanged,
    FocusNode currentFocus,
    FocusNode? nextFocus,
    double inputFontSize,
    double labelFontSize,
    double iconSize,
    double borderRadius, {
    bool isRequired = true,
    TextInputType keyboardType = TextInputType.text,
    int maxLines = 1,
  }) {
    return Padding(
      padding: EdgeInsets.symmetric(vertical: 6),
      child: Builder(
        builder: (fieldContext) {
          return TextFormField(
            focusNode: currentFocus,
            keyboardType: keyboardType,
            textInputAction:
                nextFocus != null ? TextInputAction.next : TextInputAction.done,
            maxLines: maxLines,
            onTap: () {
              WidgetsBinding.instance.addPostFrameCallback((_) {
                Scrollable.ensureVisible(
                  fieldContext,
                  duration: const Duration(milliseconds: 250),
                  curve: Curves.easeInOut,
                  alignment: 0.2,
                );
              });
            },
            style: GoogleFonts.poppins(fontSize: inputFontSize),
            decoration: InputDecoration(
              labelText: label,
              labelStyle: GoogleFonts.poppins(
                  color: Colors.grey.shade600, fontSize: labelFontSize),
              prefixIcon: Container(
                margin: EdgeInsets.all(10),
                padding: EdgeInsets.all(6),
                decoration: BoxDecoration(
                  color: Color(0xFF1B998B).withOpacity(0.1),
                  borderRadius: BorderRadius.circular(8),
                ),
                child:
                    Icon(icon, color: Color(0xFF1B998B), size: iconSize * 0.85),
              ),
              border: OutlineInputBorder(
                borderRadius: BorderRadius.circular(borderRadius),
                borderSide: BorderSide(color: Colors.grey.shade300),
              ),
              focusedBorder: OutlineInputBorder(
                borderRadius: BorderRadius.circular(borderRadius),
                borderSide: BorderSide(color: Color(0xFF1B998B), width: 2),
              ),
              errorBorder: OutlineInputBorder(
                borderRadius: BorderRadius.circular(borderRadius),
                borderSide: BorderSide(color: Colors.red.shade400, width: 2),
              ),
              filled: true,
              fillColor: Colors.white,
              contentPadding:
                  EdgeInsets.symmetric(horizontal: 14, vertical: 14),
            ),
            validator: isRequired
                ? (value) => (value == null || value.isEmpty)
                    ? 'Campo obligatorio'
                    : null
                : null,
            onChanged: onChanged,
            onFieldSubmitted: (_) {
              if (nextFocus != null) {
                FocusScope.of(currentFocus.context!).requestFocus(nextFocus);
              } else {
                FocusScope.of(currentFocus.context!).unfocus();
              }
            },
          );
        },
      ),
    );
  }

  Widget _buildDropdownField(
    String label,
    List<String> options,
    Function(String) onChanged,
    IconData icon,
    double inputFontSize,
    double labelFontSize,
    double iconSize,
    double borderRadius,
  ) {
    return Padding(
      padding: EdgeInsets.symmetric(vertical: 6),
      child: DropdownButtonFormField<String>(
        style: GoogleFonts.poppins(
            fontSize: inputFontSize, color: Colors.grey.shade800),
        decoration: InputDecoration(
          labelText: label,
          labelStyle: GoogleFonts.poppins(
              color: Colors.grey.shade600, fontSize: labelFontSize),
          prefixIcon: Container(
            margin: EdgeInsets.all(10),
            padding: EdgeInsets.all(6),
            decoration: BoxDecoration(
              color: Color(0xFF1B998B).withOpacity(0.1),
              borderRadius: BorderRadius.circular(8),
            ),
            child: Icon(icon, color: Color(0xFF1B998B), size: iconSize * 0.85),
          ),
          border: OutlineInputBorder(
            borderRadius: BorderRadius.circular(borderRadius),
            borderSide: BorderSide(color: Colors.grey.shade300),
          ),
          focusedBorder: OutlineInputBorder(
            borderRadius: BorderRadius.circular(borderRadius),
            borderSide: BorderSide(color: Color(0xFF1B998B), width: 2),
          ),
          filled: true,
          fillColor: Colors.white,
          contentPadding: EdgeInsets.symmetric(horizontal: 14, vertical: 14),
        ),
        items: options
            .map((option) => DropdownMenuItem(
                value: option,
                child: Text(option,
                    style: GoogleFonts.poppins(fontSize: inputFontSize))))
            .toList(),
        validator: (value) => value == null ? 'Selecciona una opción' : null,
        onChanged: (value) {
          if (value != null) onChanged(value);
        },
        icon: Icon(Icons.keyboard_arrow_down_rounded,
            color: Color(0xFF1B998B), size: iconSize),
      ),
    );
  }

  Widget _buildOcupacionesSelector(
      List<String> selected,
      List<String> options,
      StateSetter setState,
      double fontSize,
      double labelFontSize,
      double borderRadius) {
    return Container(
      padding: EdgeInsets.all(12),
      decoration: BoxDecoration(
        color: Color(0xFF1B998B).withOpacity(0.05),
        borderRadius: BorderRadius.circular(borderRadius),
        border: Border.all(color: Color(0xFF1B998B).withOpacity(0.2)),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text('Selecciona las ocupaciones:',
              style: GoogleFonts.poppins(
                  fontSize: labelFontSize,
                  fontWeight: FontWeight.w500,
                  color: Color(0xFF1B998B))),
          SizedBox(height: 10),
          Wrap(
            spacing: 6,
            runSpacing: 6,
            children: options.map((opcion) {
              final isSelected = selected.contains(opcion);
              return FilterChip(
                label: Text(opcion,
                    style: GoogleFonts.poppins(
                        fontSize: fontSize - 1,
                        color: isSelected ? Colors.white : Color(0xFF1B998B),
                        fontWeight:
                            isSelected ? FontWeight.w600 : FontWeight.w500)),
                selected: isSelected,
                onSelected: (val) {
                  setState(() {
                    val ? selected.add(opcion) : selected.remove(opcion);
                  });
                },
                selectedColor: Color(0xFF1B998B),
                backgroundColor: Colors.white,
                side: BorderSide(
                    color: isSelected
                        ? Color(0xFF1B998B)
                        : Color(0xFF1B998B).withOpacity(0.3),
                    width: 1.5),
              );
            }).toList(),
          ),
        ],
      ),
    );
  }

  Widget _buildTextFieldConOpcionesWithFocus(
    String label,
    IconData icon,
    Function(String) onChanged,
    FocusNode currentFocus,
    FocusNode? nextFocus, {
    List<String>? opciones,
    bool isRequired = true,
    required double inputFontSize,
    required double labelFontSize,
    required double iconSize,
    required double borderRadius,
  }) {
    final controller = TextEditingController();

    return Padding(
      padding: EdgeInsets.symmetric(vertical: 6),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Builder(
            builder: (fieldContext) {
              return TextFormField(
                controller: controller,
                focusNode: currentFocus,
                textInputAction: nextFocus != null
                    ? TextInputAction.next
                    : TextInputAction.done,
                onTap: () {
                  WidgetsBinding.instance.addPostFrameCallback((_) {
                    Scrollable.ensureVisible(
                      fieldContext,
                      duration: const Duration(milliseconds: 250),
                      curve: Curves.easeInOut,
                      alignment: 0.2,
                    );
                  });
                },
                style: GoogleFonts.poppins(fontSize: inputFontSize),
                decoration: InputDecoration(
                  labelText: label,
                  labelStyle: GoogleFonts.poppins(
                      color: Colors.grey.shade600, fontSize: labelFontSize),
                  prefixIcon: Container(
                    margin: EdgeInsets.all(10),
                    padding: EdgeInsets.all(6),
                    decoration: BoxDecoration(
                      color: Color(0xFF1B998B).withOpacity(0.1),
                      borderRadius: BorderRadius.circular(8),
                    ),
                    child: Icon(icon,
                        color: Color(0xFF1B998B), size: iconSize * 0.85),
                  ),
                  border: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(borderRadius),
                    borderSide: BorderSide(color: Colors.grey.shade300),
                  ),
                  focusedBorder: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(borderRadius),
                    borderSide: BorderSide(color: Color(0xFF1B998B), width: 2),
                  ),
                  filled: true,
                  fillColor: Colors.white,
                  contentPadding:
                      EdgeInsets.symmetric(horizontal: 14, vertical: 14),
                ),
                validator: isRequired
                    ? (value) => (value == null || value.isEmpty)
                        ? 'Campo obligatorio'
                        : null
                    : null,
                onChanged: onChanged,
                onFieldSubmitted: (_) {
                  if (nextFocus != null) {
                    FocusScope.of(currentFocus.context!)
                        .requestFocus(nextFocus);
                  } else {
                    FocusScope.of(currentFocus.context!).unfocus();
                  }
                },
              );
            },
          ),
          if (opciones != null && opciones.isNotEmpty) ...[
            SizedBox(height: 10),
            Container(
              padding: EdgeInsets.all(10),
              decoration: BoxDecoration(
                color: Color(0xFF1B998B).withOpacity(0.05),
                borderRadius: BorderRadius.circular(borderRadius),
                border: Border.all(color: Color(0xFF1B998B).withOpacity(0.2)),
              ),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Row(
                    children: [
                      Icon(Icons.touch_app_outlined,
                          size: iconSize * 0.7, color: Color(0xFF1B998B)),
                      SizedBox(width: 6),
                      Text('Opciones rápidas:',
                          style: GoogleFonts.poppins(
                              fontSize: labelFontSize - 1,
                              fontWeight: FontWeight.w500,
                              color: Color(0xFF1B998B))),
                    ],
                  ),
                  SizedBox(height: 8),
                  Wrap(
                    spacing: 6,
                    runSpacing: 6,
                    children: opciones.map((opcion) {
                      return ActionChip(
                        label: Text(opcion,
                            style: GoogleFonts.poppins(
                                fontSize: labelFontSize - 2,
                                color: Color(0xFF1B998B),
                                fontWeight: FontWeight.w500)),
                        onPressed: () {
                          controller.text = opcion;
                          onChanged(opcion);
                        },
                        backgroundColor: Colors.white,
                        side: BorderSide(
                            color: Color(0xFF1B998B).withOpacity(0.3),
                            width: 1.5),
                      );
                    }).toList(),
                  ),
                ],
              ),
            ),
          ],
        ],
      ),
    );
  }

  Widget _buildDatePickerField(
      BuildContext context,
      DateTime? selectedDate,
      Function(DateTime) onDateSelected,
      double inputFontSize,
      double labelFontSize,
      double iconSize,
      double borderRadius) {
    return Padding(
      padding: EdgeInsets.symmetric(vertical: 6),
      child: TextFormField(
        readOnly: true,
        style: GoogleFonts.poppins(fontSize: inputFontSize),
        decoration: InputDecoration(
          labelText: 'Fecha de Asignación de la Tribu',
          labelStyle: GoogleFonts.poppins(
              color: selectedDate != null
                  ? Color(0xFF1B998B)
                  : Colors.grey.shade600,
              fontSize: labelFontSize),
          prefixIcon: Container(
            margin: EdgeInsets.all(10),
            padding: EdgeInsets.all(6),
            decoration: BoxDecoration(
              color: selectedDate != null
                  ? Color(0xFF1B998B).withOpacity(0.1)
                  : Colors.grey.shade100,
              borderRadius: BorderRadius.circular(8),
            ),
            child: Icon(Icons.calendar_today_outlined,
                color: selectedDate != null
                    ? Color(0xFF1B998B)
                    : Colors.grey.shade600,
                size: iconSize * 0.85),
          ),
          suffixIcon: selectedDate != null
              ? Icon(Icons.check_circle,
                  color: Color(0xFF1B998B), size: iconSize)
              : null,
          border: OutlineInputBorder(
            borderRadius: BorderRadius.circular(borderRadius),
            borderSide: BorderSide(
                color: selectedDate != null
                    ? Color(0xFF1B998B)
                    : Colors.grey.shade300,
                width: selectedDate != null ? 2 : 1),
          ),
          focusedBorder: OutlineInputBorder(
            borderRadius: BorderRadius.circular(borderRadius),
            borderSide: BorderSide(color: Color(0xFF1B998B), width: 2),
          ),
          filled: true,
          fillColor: Colors.white,
          contentPadding: EdgeInsets.symmetric(horizontal: 14, vertical: 14),
        ),
        validator: (value) => selectedDate == null ? 'Campo obligatorio' : null,
        onTap: () async {
          final pickedDate = await showDatePicker(
            context: context,
            initialDate: DateTime.now(),
            firstDate: DateTime(2000),
            lastDate: DateTime(2101),
            builder: (context, child) {
              return Theme(
                data: Theme.of(context).copyWith(
                  colorScheme: ColorScheme.light(
                    primary: Color(0xFF1B998B),
                    onPrimary: Colors.white,
                    onSurface: Colors.black,
                  ),
                  textButtonTheme: TextButtonThemeData(
                    style: TextButton.styleFrom(
                        foregroundColor: Color(0xFFFF7E00)),
                  ),
                ),
                child: child!,
              );
            },
          );
          if (pickedDate != null) onDateSelected(pickedDate);
        },
        controller: TextEditingController(
            text: selectedDate != null
                ? DateFormat('dd/MM/yyyy').format(selectedDate)
                : ''),
      ),
    );
  }

  Widget _buildActionButtons(
    BuildContext context,
    GlobalKey<FormState> formKey,
    String nombre,
    String apellido,
    String telefono,
    String sexo,
    int edad,
    String direccion,
    String barrio,
    String estadoCivil,
    String? nombrePareja,
    List<String> ocupaciones,
    String descripcionOcupaciones,
    bool tieneHijos,
    String referenciaInvitacion,
    String? observaciones,
    String estadoProceso,
    DateTime? fechaAsignacion,
    bool isSmallScreen,
    double fontSize,
    double iconSize,
    double borderRadius,
    ScrollController scrollController,
    List<FocusNode> focusNodes,
  ) {
    return isSmallScreen
        ? Column(
            children: [
              SizedBox(
                width: double.infinity,
                child: ElevatedButton(
                  style: ElevatedButton.styleFrom(
                    backgroundColor: Color(0xFFFF7E00),
                    foregroundColor: Colors.white,
                    padding: EdgeInsets.symmetric(vertical: 14),
                    shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(borderRadius)),
                    elevation: 2,
                  ),
                  onPressed: () {
                    if (formKey.currentState!.validate()) {
                      final registro = {
                        'fechaAsignacionTribu': fechaAsignacion != null
                            ? Timestamp.fromDate(fechaAsignacion)
                            : null,
                        'nombre': nombre,
                        'apellido': apellido,
                        'telefono': telefono,
                        'sexo': sexo,
                        'edad': edad,
                        'direccion': direccion,
                        'barrio': barrio,
                        'estadoCivil': estadoCivil,
                        'nombrePareja': nombrePareja,
                        'ocupaciones': ocupaciones,
                        'descripcionOcupaciones': descripcionOcupaciones,
                        'tieneHijos': tieneHijos,
                        'referenciaInvitacion': referenciaInvitacion,
                        'observaciones': observaciones,
                        'tribuAsignada': widget.tribuId,
                        'ministerioAsignado':
                            _determinarMinisterio(widget.tribuNombre),
                        'coordinadorAsignado': null,
                        'fechaRegistro': FieldValue.serverTimestamp(),
                        'activo': true,
                        'estadoProceso': estadoProceso,
                      };
                      scrollController.dispose();
                      for (var node in focusNodes) {
                        node.dispose();
                      }
                      _guardarRegistroEnFirebase(
                          context, registro, widget.tribuId);
                    }
                  },
                  child: Row(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      Icon(Icons.save_outlined, size: iconSize * 0.9),
                      SizedBox(width: 8),
                      Text('Guardar Registro',
                          style: GoogleFonts.poppins(
                              fontSize: fontSize, fontWeight: FontWeight.w600)),
                    ],
                  ),
                ),
              ),
              SizedBox(height: 12),
              SizedBox(
                width: double.infinity,
                child: TextButton(
                  onPressed: () {
                    scrollController.dispose();
                    for (var node in focusNodes) {
                      node.dispose();
                    }
                    Navigator.pop(context);
                  },
                  style: TextButton.styleFrom(
                    padding: EdgeInsets.symmetric(vertical: 14),
                    shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(borderRadius),
                        side: BorderSide(color: Colors.grey.shade300)),
                  ),
                  child: Text('Cancelar',
                      style: GoogleFonts.poppins(
                          fontSize: fontSize,
                          fontWeight: FontWeight.w600,
                          color: Colors.grey.shade700)),
                ),
              ),
            ],
          )
        : Row(
            children: [
              Expanded(
                child: TextButton(
                  onPressed: () {
                    scrollController.dispose();
                    for (var node in focusNodes) {
                      node.dispose();
                    }
                    Navigator.pop(context);
                  },
                  style: TextButton.styleFrom(
                    padding: EdgeInsets.symmetric(vertical: 16),
                    shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(borderRadius),
                        side: BorderSide(color: Colors.grey.shade300)),
                  ),
                  child: Text('Cancelar',
                      style: GoogleFonts.poppins(
                          fontSize: fontSize,
                          fontWeight: FontWeight.w600,
                          color: Colors.grey.shade700)),
                ),
              ),
              SizedBox(width: 16),
              Expanded(
                flex: 2,
                child: ElevatedButton(
                  style: ElevatedButton.styleFrom(
                    backgroundColor: Color(0xFFFF7E00),
                    foregroundColor: Colors.white,
                    padding: EdgeInsets.symmetric(vertical: 16),
                    shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(borderRadius)),
                    elevation: 2,
                  ),
                  onPressed: () {
                    if (formKey.currentState!.validate()) {
                      final registro = {
                        'fechaAsignacionTribu': fechaAsignacion != null
                            ? Timestamp.fromDate(fechaAsignacion)
                            : null,
                        'nombre': nombre,
                        'apellido': apellido,
                        'telefono': telefono,
                        'sexo': sexo,
                        'edad': edad,
                        'direccion': direccion,
                        'barrio': barrio,
                        'estadoCivil': estadoCivil,
                        'nombrePareja': nombrePareja,
                        'ocupaciones': ocupaciones,
                        'descripcionOcupaciones': descripcionOcupaciones,
                        'tieneHijos': tieneHijos,
                        'referenciaInvitacion': referenciaInvitacion,
                        'observaciones': observaciones,
                        'tribuAsignada': widget.tribuId,
                        'ministerioAsignado':
                            _determinarMinisterio(widget.tribuNombre),
                        'coordinadorAsignado': null,
                        'fechaRegistro': FieldValue.serverTimestamp(),
                        'activo': true,
                        'estadoProceso': estadoProceso,
                      };
                      scrollController.dispose();
                      for (var node in focusNodes) {
                        node.dispose();
                      }
                      _guardarRegistroEnFirebase(
                          context, registro, widget.tribuId);
                    }
                  },
                  child: Row(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      Icon(Icons.save_outlined, size: iconSize),
                      SizedBox(width: 8),
                      Text('Guardar Registro',
                          style: GoogleFonts.poppins(
                              fontSize: fontSize, fontWeight: FontWeight.w600)),
                    ],
                  ),
                ),
              ),
            ],
          );
  }

  @override
  Widget build(BuildContext context) {
    final Color primaryTeal = Color(0xFF1B998B);
    final Color secondaryOrange = Color(0xFFFF7E00);
    final Color lightTeal = Color(0xFFE0F7FA);

    return Theme(
      data: ThemeConstants.appTheme,
      child: DefaultTabController(
        length: 5,
        child: Scaffold(
          appBar: AppBar(
            elevation: 0,
            backgroundColor: primaryTeal,
            automaticallyImplyLeading: true,
            iconTheme: IconThemeData(color: Colors.white),
            flexibleSpace: Container(
              decoration: BoxDecoration(
                gradient: LinearGradient(
                  begin: Alignment.topLeft,
                  end: Alignment.bottomRight,
                  colors: [
                    primaryTeal,
                    primaryTeal.withOpacity(0.85),
                  ],
                ),
              ),
            ),
            toolbarHeight: MediaQuery.of(context).size.height * 0.085,
            title: LayoutBuilder(
              builder: (context, constraints) {
                final screenWidth = MediaQuery.of(context).size.width;
                final isVerySmallScreen = screenWidth < 360;
                final isSmallScreen = screenWidth < 400;
                final isMediumScreen = screenWidth >= 400 && screenWidth < 600;

                // Dividir nombre de tribu inteligentemente
                final tribuNombre = widget.tribuNombre;
                final palabras = tribuNombre.split(' ');

                // Determinar si necesitamos múltiples líneas basado en longitud
                final necesitaDosLineas = tribuNombre.length > 20 &&
                    (isVerySmallScreen || isSmallScreen);
                final necesitaTresLineas =
                    tribuNombre.length > 30 && isVerySmallScreen;

                return Row(
                  children: [
                    // Logo con efecto Hero
                    Hero(
                      tag: 'logo_tribu_${widget.tribuId}',
                      child: Container(
                        padding: EdgeInsets.all(isVerySmallScreen ? 3 : 4),
                        decoration: BoxDecoration(
                          color: Colors.white,
                          shape: BoxShape.circle,
                          boxShadow: [
                            BoxShadow(
                              color: Colors.black.withOpacity(0.2),
                              blurRadius: 8,
                              offset: Offset(0, 3),
                            ),
                          ],
                        ),
                        child: Container(
                          height: isVerySmallScreen
                              ? 34
                              : (isSmallScreen ? 36 : 38),
                          width: isVerySmallScreen
                              ? 34
                              : (isSmallScreen ? 36 : 38),
                          decoration: BoxDecoration(
                            shape: BoxShape.circle,
                            color: Colors.white,
                          ),
                          child: ClipOval(
                            child: Image.asset(
                              'assets/Cocep_.png',
                              fit: BoxFit.contain,
                            ),
                          ),
                        ),
                      ),
                    ),
                    SizedBox(width: isVerySmallScreen ? 8 : 12),

                    // Título de la tribu responsivo con múltiples líneas
                    Expanded(
                      child: necesitaTresLineas
                          ? _buildTituloTresLineas(palabras, isVerySmallScreen)
                          : necesitaDosLineas
                              ? _buildTituloDosLineas(
                                  tribuNombre, palabras, isSmallScreen)
                              : _buildTituloUnaLinea(
                                  tribuNombre, isSmallScreen, isMediumScreen),
                    ),

                    SizedBox(
                        width: isVerySmallScreen ? 4 : (isSmallScreen ? 6 : 8)),
                    //Container del boton de cerrar Session
                    Container(
                      constraints: BoxConstraints(
                        maxWidth:
                            isVerySmallScreen ? 58 : (isSmallScreen ? 65 : 90),
                      ),
                      decoration: BoxDecoration(
                        gradient: LinearGradient(
                          begin: Alignment.topLeft,
                          end: Alignment.bottomRight,
                          colors: [
                            Colors.white.withOpacity(0.25),
                            Colors.white.withOpacity(0.15),
                          ],
                        ),
                        borderRadius:
                            BorderRadius.circular(isVerySmallScreen ? 8 : 10),
                        border: Border.all(
                          color: Colors.white.withOpacity(0.6),
                          width: isVerySmallScreen ? 1 : 1.5,
                        ),
                        boxShadow: [
                          BoxShadow(
                            color: Colors.black.withOpacity(0.15),
                            blurRadius: 4,
                            offset: Offset(0, 2),
                          ),
                        ],
                      ),
                      child: Material(
                        color: Colors.transparent,
                        child: InkWell(
                          onTap: _confirmarCerrarSesion,
                          borderRadius:
                              BorderRadius.circular(isVerySmallScreen ? 8 : 10),
                          splashColor: Colors.white.withOpacity(0.3),
                          highlightColor: Colors.white.withOpacity(0.2),
                          child: Padding(
                            padding: EdgeInsets.symmetric(
                              horizontal: isVerySmallScreen
                                  ? 4
                                  : (isSmallScreen ? 6 : 8),
                              vertical: isVerySmallScreen
                                  ? 5
                                  : (isSmallScreen ? 6 : 8),
                            ),
                            child: Column(
                              mainAxisSize: MainAxisSize.min,
                              mainAxisAlignment: MainAxisAlignment.center,
                              children: [
                                Icon(
                                  Icons.logout_rounded,
                                  color: Colors.white,
                                  size: isVerySmallScreen
                                      ? 15
                                      : (isSmallScreen ? 17 : 20),
                                ),
                                SizedBox(height: isVerySmallScreen ? 1 : 2),
                                Text(
                                  'Cerrar\nSesión',
                                  textAlign: TextAlign.center,
                                  style: GoogleFonts.poppins(
                                    color: Colors.white,
                                    fontSize: isVerySmallScreen
                                        ? 7.5
                                        : (isSmallScreen ? 8.5 : 10),
                                    fontWeight: FontWeight.w700,
                                    height: 1.05,
                                    letterSpacing: 0.2,
                                    shadows: [
                                      Shadow(
                                        offset: Offset(0, 1),
                                        blurRadius: 2,
                                        color: Colors.black.withOpacity(0.3),
                                      ),
                                    ],
                                  ),
                                  maxLines: 2,
                                  overflow: TextOverflow.clip,
                                ),
                              ],
                            ),
                          ),
                        ),
                      ),
                    ),
                  ],
                );
              },
            ),
            bottom: PreferredSize(
              preferredSize: Size.fromHeight(60),
              child: Container(
                decoration: BoxDecoration(
                  color: primaryTeal,
                  boxShadow: [
                    BoxShadow(
                      color: Colors.black26,
                      offset: Offset(0, 2),
                      blurRadius: 4,
                    ),
                  ],
                ),
                child: LayoutBuilder(
                  builder: (context, constraints) {
                    final screenWidth = MediaQuery.of(context).size.width;
                    final isVerySmallScreen = screenWidth < 360;
                    final isSmallScreen = screenWidth < 500;

                    return TabBar(
                      controller: _tabController,
                      indicator: BoxDecoration(
                        color: secondaryOrange,
                        borderRadius: BorderRadius.only(
                          topLeft: Radius.circular(10),
                          topRight: Radius.circular(10),
                        ),
                      ),
                      labelColor: Colors.white,
                      unselectedLabelColor: Colors.white.withOpacity(0.7),
                      isScrollable: isSmallScreen,
                      labelPadding: EdgeInsets.symmetric(
                        horizontal: isVerySmallScreen ? 8 : 12,
                      ),
                      tabs: [
                        _buildResponsiveTab(
                          Icons.people,
                          'Timoteos',
                          isVerySmallScreen,
                          isSmallScreen,
                        ),
                        _buildResponsiveTab(
                          Icons.supervised_user_circle,
                          'Coordinadores',
                          isVerySmallScreen,
                          isSmallScreen,
                        ),
                        _buildResponsiveTab(
                          Icons.assignment_ind,
                          'Personas',
                          isVerySmallScreen,
                          isSmallScreen,
                        ),
                        _buildResponsiveTab(
                          Icons.list_alt,
                          'Asistencias',
                          isVerySmallScreen,
                          isSmallScreen,
                        ),
                        _buildResponsiveTab(
                          Icons.event_note,
                          'Eventos',
                          isVerySmallScreen,
                          isSmallScreen,
                        ),
                      ],
                    );
                  },
                ),
              ),
            ),
          ),
          body: Container(
            decoration: BoxDecoration(
              gradient: LinearGradient(
                begin: Alignment.topCenter,
                end: Alignment.bottomCenter,
                colors: [lightTeal, Colors.white],
                stops: [0.0, 0.5],
              ),
            ),
            child: TabBarView(
              controller: _tabController,
              children: [
                _buildTabContent(TimoteosTab(tribuId: widget.tribuId)),
                _buildTabContent(CoordinadoresTab(tribuId: widget.tribuId)),
                _buildTabContent(
                  RegistrosAsignadosTab(
                    tribuId: widget.tribuId,
                    tribuNombre: widget.tribuNombre,
                  ),
                ),
                _buildTabContent(AsistenciasTab(
                  tribuId: widget.tribuId,
                  tribuNombre: widget.tribuNombre,
                )),
                _buildTabContent(InscripcionesTab(tribuId: widget.tribuId)),
              ],
            ),
          ),
          // FloatingActionButton eliminado - Botón movido a pestaña Personas
        ),
      ),
    );
  }

  Widget _buildTab(IconData icon, String text) {
    return Tab(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Icon(icon, size: 20),
          SizedBox(height: 4),
          Text(
            text,
            style: GoogleFonts.poppins(
              fontSize: 10,
              fontWeight: FontWeight.w600,
            ),
            overflow: TextOverflow.ellipsis,
          ),
        ],
      ),
    );
  }

  Widget _buildTabContent(Widget child) {
    return Container(
      padding: EdgeInsets.all(8),
      child: child,
    );
  }

// ✅ NUEVA VERSIÓN: Acepta filtros como parámetros opcionales
  void descargarExcel(BuildContext context, String tribuId, String tribuNombre,
      {String? anioFiltro,
      String? mesFiltro,
      String? estadoFiltro} // ✅ AGREGADO estadoFiltro
      ) async {
    const Color primaryTeal = Color(0xFF1B998B);
    const Color secondaryOrange = Color(0xFFFF7E00);
    final Color lightTeal = primaryTeal.withOpacity(0.1);

    // ✅ Normalizar "Todos" a null
    if (anioFiltro == 'Todos') anioFiltro = null;
    if (mesFiltro == 'Todos') mesFiltro = null;

    print(
        '📊 Exportando con filtros: Año=${anioFiltro ?? "Todos"}, Mes=${mesFiltro ?? "Todos"}');

    showDialog(
      context: context,
      barrierDismissible: false,
      builder: (BuildContext dialogContext) {
        return Dialog(
          shape:
              RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
          child: Padding(
            padding: const EdgeInsets.all(20.0),
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                Container(
                  padding: const EdgeInsets.all(12),
                  decoration: BoxDecoration(
                    color: lightTeal,
                    borderRadius: BorderRadius.circular(12),
                  ),
                  child: Row(
                    children: [
                      Icon(Icons.file_download, color: primaryTeal, size: 28),
                      const SizedBox(width: 12),
                      Expanded(
                        child: Text(
                          'Exportando Registros',
                          style: TextStyle(
                            fontSize: 18,
                            fontWeight: FontWeight.bold,
                            color: primaryTeal,
                          ),
                        ),
                      ),
                    ],
                  ),
                ),
                const SizedBox(height: 20),
                CircularProgressIndicator(
                  valueColor: AlwaysStoppedAnimation<Color>(primaryTeal),
                ),
                const SizedBox(height: 20),
                Text(
                  'Preparando el archivo Excel...',
                  style: TextStyle(fontSize: 16, color: Colors.grey[800]),
                ),
              ],
            ),
          ),
        );
      },
    );

    try {
      final excelGenerator = ExcelExporter();

      // ✅ Pasar los filtros al exportador (incluyendo estado)
      await excelGenerator.exportarRegistros(
        context,
        tribuId,
        tribuNombre,
        anioFiltro: anioFiltro,
        mesFiltro: mesFiltro,
        estadoFiltro: estadoFiltro, // ✅ NUEVO
      );

      if (context.mounted) {
        Navigator.of(context, rootNavigator: true).pop();

        // Mensaje personalizado según filtros
        String mensajeExito =
            'Archivo "Datos de las personas - $tribuNombre" generado correctamente';

        if (anioFiltro != null || mesFiltro != null || estadoFiltro != null) {
          mensajeExito += ' (';

          final List<String> filtrosActivos = [];

          if (anioFiltro != null) {
            filtrosActivos.add('Año: $anioFiltro');
          }

          if (mesFiltro != null) {
            final mesesNombres = {
              '1': 'Enero',
              '2': 'Febrero',
              '3': 'Marzo',
              '4': 'Abril',
              '5': 'Mayo',
              '6': 'Junio',
              '7': 'Julio',
              '8': 'Agosto',
              '9': 'Septiembre',
              '10': 'Octubre',
              '11': 'Noviembre',
              '12': 'Diciembre'
            };
            filtrosActivos.add('Mes: ${mesesNombres[mesFiltro] ?? mesFiltro}');
          }

          if (estadoFiltro != null) {
            filtrosActivos.add('Estado: $estadoFiltro');
          }

          mensajeExito += filtrosActivos.join(', ');
          mensajeExito += ')';
        }

        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Row(
              children: [
                Icon(Icons.check_circle, color: Colors.white),
                SizedBox(width: 12),
                Expanded(
                  child: Text(mensajeExito, style: TextStyle(fontSize: 16)),
                ),
              ],
            ),
            backgroundColor: Colors.green,
            behavior: SnackBarBehavior.floating,
            shape:
                RoundedRectangleBorder(borderRadius: BorderRadius.circular(10)),
            margin: const EdgeInsets.all(12),
            padding: const EdgeInsets.symmetric(vertical: 14, horizontal: 20),
            duration: const Duration(seconds: 3),
          ),
        );
      }
    } catch (e) {
      print('❌ ERROR al generar Excel: $e');

      if (context.mounted) {
        Navigator.of(context, rootNavigator: true).pop();

        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Row(
              children: [
                Icon(Icons.error, color: Colors.white),
                SizedBox(width: 12),
                Expanded(
                  child: Text('Error al generar el archivo: ${e.toString()}',
                      style: TextStyle(fontSize: 16)),
                ),
              ],
            ),
            backgroundColor: Colors.red,
            behavior: SnackBarBehavior.floating,
            shape:
                RoundedRectangleBorder(borderRadius: BorderRadius.circular(10)),
            margin: const EdgeInsets.all(12),
            padding: const EdgeInsets.symmetric(vertical: 14, horizontal: 20),
            duration: const Duration(seconds: 5),
          ),
        );
      }
    }
  }

  void _showAddOptions(
      BuildContext context, Color primaryColor, Color secondaryColor) {
    _resetInactivityTimer();

    showModalBottomSheet(
      context: context,
      backgroundColor: Colors.transparent,
      builder: (context) => Container(
        padding: EdgeInsets.all(20),
        decoration: BoxDecoration(
          color: Colors.white,
          borderRadius: BorderRadius.only(
            topLeft: Radius.circular(20),
            topRight: Radius.circular(20),
          ),
          boxShadow: [
            BoxShadow(
              color: Colors.black26,
              blurRadius: 10,
              offset: Offset(0, -5),
            ),
          ],
        ),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            Container(
              padding: EdgeInsets.all(12),
              decoration: BoxDecoration(
                color: primaryColor.withOpacity(0.1),
                borderRadius: BorderRadius.circular(12),
              ),
              child: Row(
                children: [
                  Icon(Icons.add_circle_outline, color: primaryColor, size: 28),
                  SizedBox(width: 12),
                  Text(
                    'Agregar Nuevo',
                    style: TextStyle(
                      fontSize: 20,
                      fontWeight: FontWeight.bold,
                      color: primaryColor,
                    ),
                  ),
                ],
              ),
            ),
            SizedBox(height: 20),
            _buildOptionButton(
              context,
              'Registrar Miembro',
              Icons.person_add_alt_1,
              primaryColor,
              secondaryColor,
              () {
                Navigator.pop(context);
                _showRegistroDialog(context);
              },
            ),
            SizedBox(height: 12),
            _buildOptionButton(
              context,
              'Crear Evento',
              Icons.event_note,
              primaryColor,
              secondaryColor,
              () {
                Navigator.pop(context);
                showDialog(
                  context: context,
                  builder: (context) => DialogoCrearEvento(
                    tribuId: widget.tribuId,
                    primaryColor: primaryColor,
                    secondaryColor: secondaryColor,
                  ),
                );
              },
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildTituloUnaLinea(
      String tribuNombre, bool isSmallScreen, bool isMediumScreen) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      mainAxisAlignment: MainAxisAlignment.center,
      children: [
        Text(
          'Tribu',
          style: GoogleFonts.poppins(
            fontSize: isSmallScreen ? 11 : 13,
            fontWeight: FontWeight.w500,
            color: Colors.white.withOpacity(0.9),
            height: 1.1,
          ),
        ),
        SizedBox(height: 2),
        Text(
          tribuNombre,
          style: GoogleFonts.poppins(
            fontSize: isSmallScreen ? 16 : (isMediumScreen ? 18 : 18),
            fontWeight: FontWeight.bold,
            color: Colors.white,
            height: 1.1,
            shadows: [
              Shadow(
                offset: Offset(0, 1),
                blurRadius: 3,
                color: Colors.black.withOpacity(0.2),
              ),
            ],
          ),
          maxLines: 1,
          overflow: TextOverflow.ellipsis,
        ),
      ],
    );
  }

  Widget _buildTituloDosLineas(
      String tribuNombre, List<String> palabras, bool isSmallScreen) {
    // Dividir inteligentemente en dos líneas
    final mitad = (palabras.length / 2).ceil();
    final primeraLinea = palabras.sublist(0, mitad).join(' ');
    final segundaLinea = palabras.sublist(mitad).join(' ');

    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      mainAxisAlignment: MainAxisAlignment.center,
      children: [
        Text(
          'Tribu',
          style: GoogleFonts.poppins(
            fontSize: isSmallScreen ? 10 : 11,
            fontWeight: FontWeight.w500,
            color: Colors.white.withOpacity(0.85),
            height: 1.0,
          ),
        ),
        SizedBox(height: 1),
        Text(
          primeraLinea,
          style: GoogleFonts.poppins(
            fontSize: isSmallScreen ? 13 : 15,
            fontWeight: FontWeight.w600,
            color: Colors.white.withOpacity(0.95),
            height: 1.1,
            letterSpacing: 0.3,
          ),
          maxLines: 1,
          overflow: TextOverflow.ellipsis,
        ),
        Text(
          segundaLinea,
          style: GoogleFonts.poppins(
            fontSize: isSmallScreen ? 14 : 16,
            fontWeight: FontWeight.bold,
            color: Colors.white,
            height: 1.1,
            letterSpacing: 0.4,
            shadows: [
              Shadow(
                offset: Offset(0, 1),
                blurRadius: 3,
                color: Colors.black.withOpacity(0.2),
              ),
            ],
          ),
          maxLines: 1,
          overflow: TextOverflow.ellipsis,
        ),
      ],
    );
  }

  Widget _buildTituloTresLineas(List<String> palabras, bool isVerySmallScreen) {
    // Dividir en tres líneas para pantallas muy pequeñas
    final tercio = (palabras.length / 3).ceil();
    final primeraLinea =
        palabras.sublist(0, min(tercio, palabras.length)).join(' ');
    final segundaLinea = palabras.length > tercio
        ? palabras.sublist(tercio, min(tercio * 2, palabras.length)).join(' ')
        : '';
    final terceraLinea = palabras.length > tercio * 2
        ? palabras.sublist(tercio * 2).join(' ')
        : '';

    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      mainAxisAlignment: MainAxisAlignment.center,
      children: [
        Text(
          primeraLinea,
          style: GoogleFonts.poppins(
            fontSize: 11,
            fontWeight: FontWeight.w600,
            color: Colors.white.withOpacity(0.9),
            height: 1.0,
          ),
          maxLines: 1,
          overflow: TextOverflow.ellipsis,
        ),
        if (segundaLinea.isNotEmpty)
          Text(
            segundaLinea,
            style: GoogleFonts.poppins(
              fontSize: 12,
              fontWeight: FontWeight.w600,
              color: Colors.white.withOpacity(0.95),
              height: 1.0,
            ),
            maxLines: 1,
            overflow: TextOverflow.ellipsis,
          ),
        if (terceraLinea.isNotEmpty)
          Text(
            terceraLinea,
            style: GoogleFonts.poppins(
              fontSize: 13,
              fontWeight: FontWeight.bold,
              color: Colors.white,
              height: 1.0,
              shadows: [
                Shadow(
                  offset: Offset(0, 1),
                  blurRadius: 2,
                  color: Colors.black.withOpacity(0.2),
                ),
              ],
            ),
            maxLines: 1,
            overflow: TextOverflow.ellipsis,
          ),
      ],
    );
  }

  Widget _buildResponsiveTab(
      IconData icon, String text, bool isVerySmallScreen, bool isSmallScreen) {
    return Tab(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Icon(
            icon,
            size: isVerySmallScreen ? 18 : 20,
          ),
          SizedBox(height: 4),
          Text(
            text,
            style: GoogleFonts.poppins(
              fontSize: isVerySmallScreen ? 9 : 10,
              fontWeight: FontWeight.w600,
            ),
            maxLines: 1,
            overflow: TextOverflow.ellipsis,
            textAlign: TextAlign.center,
          ),
        ],
      ),
    );
  }

  Widget _buildOptionButton(
    BuildContext context,
    String title,
    IconData icon,
    Color primaryColor,
    Color secondaryColor,
    VoidCallback onTap,
  ) {
    return Material(
      color: Colors.transparent,
      child: InkWell(
        onTap: onTap,
        borderRadius: BorderRadius.circular(10),
        child: Ink(
          decoration: BoxDecoration(
            gradient: LinearGradient(
              colors: [primaryColor, primaryColor.withOpacity(0.8)],
              begin: Alignment.centerLeft,
              end: Alignment.centerRight,
            ),
            borderRadius: BorderRadius.circular(10),
            boxShadow: [
              BoxShadow(
                color: primaryColor.withOpacity(0.3),
                blurRadius: 5,
                offset: Offset(0, 3),
              ),
            ],
          ),
          child: Container(
            padding: EdgeInsets.symmetric(vertical: 12, horizontal: 16),
            child: Row(
              children: [
                Icon(icon, color: Colors.white, size: 24),
                SizedBox(width: 12),
                Text(
                  title,
                  style: TextStyle(
                    color: Colors.white,
                    fontSize: 16,
                    fontWeight: FontWeight.w500,
                  ),
                ),
                Spacer(),
                Icon(
                  Icons.arrow_forward_ios,
                  color: Colors.white,
                  size: 16,
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }
}

// Componente de ejemplo para mostrar animación de carga
class AnimatedLoadingIndicator extends StatefulWidget {
  @override
  _AnimatedLoadingIndicatorState createState() =>
      _AnimatedLoadingIndicatorState();
}

class _AnimatedLoadingIndicatorState extends State<AnimatedLoadingIndicator>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;

  @override
  void initState() {
    super.initState();
    _controller = AnimationController(
      vsync: this,
      duration: Duration(seconds: 1),
    )..repeat();
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Center(
      child: RotationTransition(
        turns: _controller,
        child: Container(
          width: 50,
          height: 50,
          child: Icon(
            Icons.local_fire_department,
            color: Color(0xFFFF7E00),
            size: 40,
          ),
        ),
      ),
    );
  }
}

// Ejemplo de cómo podría ser una tarjeta personalizada para los miembros de la tribu
class MiembroCard extends StatelessWidget {
  final String nombre;
  final String rol;
  final String? imageUrl;
  final VoidCallback onTap;

  const MiembroCard({
    Key? key,
    required this.nombre,
    required this.rol,
    this.imageUrl,
    required this.onTap,
  }) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return Card(
      elevation: 3,
      margin: EdgeInsets.symmetric(vertical: 8, horizontal: 12),
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.circular(12),
      ),
      child: InkWell(
        onTap: onTap,
        borderRadius: BorderRadius.circular(12),
        child: Padding(
          padding: EdgeInsets.all(12),
          child: Row(
            children: [
              Container(
                width: 60,
                height: 60,
                decoration: BoxDecoration(
                  color: Color(0xFF148B9C).withOpacity(0.2),
                  shape: BoxShape.circle,
                  border: Border.all(
                    color: Color(0xFF148B9C),
                    width: 2,
                  ),
                ),
                child: Center(
                  child: imageUrl != null
                      ? ClipOval(
                          child: Image.network(
                            imageUrl!,
                            width: 56,
                            height: 56,
                            fit: BoxFit.cover,
                          ),
                        )
                      : Icon(
                          Icons.person,
                          size: 30,
                          color: Color(0xFF148B9C),
                        ),
                ),
              ),
              SizedBox(width: 16),
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      nombre,
                      style: TextStyle(
                        fontSize: 16,
                        fontWeight: FontWeight.bold,
                        color: Colors.black87,
                      ),
                    ),
                    SizedBox(height: 4),
                    Text(
                      rol,
                      style: TextStyle(
                        fontSize: 14,
                        color: Colors.black54,
                      ),
                    ),
                  ],
                ),
              ),
              Icon(
                Icons.arrow_forward_ios,
                size: 16,
                color: Color(0xFFFF7E00),
              ),
            ],
          ),
        ),
      ),
    );
  }
}

//-------------------------------
class CoordinadoresTab extends StatelessWidget {
  final String tribuId;

  const CoordinadoresTab({Key? key, required this.tribuId}) : super(key: key);

  Future<void> _crearCoordinador(BuildContext context) async {
    final _nameController = TextEditingController();
    final _lastNameController = TextEditingController();
    final _ageController = TextEditingController();
    final _userController = TextEditingController();
    final _passwordController = TextEditingController();
    final _phoneController = TextEditingController();

    bool _isProcessing = false;
    bool _passwordVisible = false;

    await showDialog(
      context: context,
      barrierDismissible: false,
      builder: (context) {
        return StatefulBuilder(
          builder: (context, setState) {
            final mediaQuery = MediaQuery.of(context);
            final screenWidth = mediaQuery.size.width;
            final screenHeight = mediaQuery.size.height;
            final isSmallScreen = screenWidth < 600;
            final isMediumScreen = screenWidth >= 600 && screenWidth < 900;

            final dialogWidth = isSmallScreen
                ? screenWidth * 0.95
                : (isMediumScreen ? 450.0 : 500.0);

            return Dialog(
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(isSmallScreen ? 18 : 24),
              ),
              insetPadding: EdgeInsets.symmetric(
                horizontal: isSmallScreen ? 8 : 16,
                vertical: isSmallScreen ? 16 : 24,
              ),
              child: Container(
                width: dialogWidth,
                constraints: BoxConstraints(
                  maxHeight: screenHeight * 0.9,
                  maxWidth: dialogWidth,
                ),
                decoration: BoxDecoration(
                  borderRadius: BorderRadius.circular(isSmallScreen ? 18 : 24),
                  gradient: LinearGradient(
                    begin: Alignment.topLeft,
                    end: Alignment.bottomRight,
                    colors: [
                      Colors.white,
                      ThemeConstants.primaryTeal.withOpacity(0.02)
                    ],
                  ),
                ),
                child: Column(
                  mainAxisSize: MainAxisSize.min,
                  children: [
                    // Header
                    Container(
                      padding: EdgeInsets.all(isSmallScreen ? 16 : 24),
                      decoration: BoxDecoration(
                        gradient: LinearGradient(
                          begin: Alignment.topLeft,
                          end: Alignment.bottomRight,
                          colors: [
                            ThemeConstants.primaryTeal,
                            ThemeConstants.primaryTeal.withOpacity(0.8)
                          ],
                        ),
                        borderRadius: BorderRadius.only(
                          topLeft: Radius.circular(isSmallScreen ? 18 : 24),
                          topRight: Radius.circular(isSmallScreen ? 18 : 24),
                        ),
                      ),
                      child: Row(
                        children: [
                          Icon(Icons.supervisor_account,
                              color: Colors.white,
                              size: isSmallScreen ? 28 : 32),
                          SizedBox(width: isSmallScreen ? 12 : 16),
                          Expanded(
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Text(
                                  'Nuevo Coordinador',
                                  style: TextStyle(
                                    fontSize: isSmallScreen ? 18 : 24,
                                    fontWeight: FontWeight.bold,
                                    color: Colors.white,
                                  ),
                                ),
                                if (!isSmallScreen)
                                  Text(
                                    'Completa los datos del coordinador',
                                    style: TextStyle(
                                        fontSize: 13,
                                        color: Colors.white.withOpacity(0.9)),
                                  ),
                              ],
                            ),
                          ),
                        ],
                      ),
                    ),

                    // Contenido con scroll
                    Flexible(
                      child: SingleChildScrollView(
                        padding: EdgeInsets.all(isSmallScreen ? 16 : 24),
                        physics: ClampingScrollPhysics(),
                        child: Column(
                          children: [
                            _buildTextField(
                              controller: _nameController,
                              label: 'Nombre',
                              icon: Icons.person_outline,
                              hint: 'Ingresa el nombre',
                            ),
                            SizedBox(height: 16),
                            _buildTextField(
                              controller: _lastNameController,
                              label: 'Apellido',
                              icon: Icons.person,
                              hint: 'Ingresa el apellido',
                            ),
                            SizedBox(height: 16),
                            _buildTextField(
                              controller: _ageController,
                              label: 'Edad',
                              icon: Icons.cake,
                              keyboardType: TextInputType.number,
                              hint: 'Ej: 25',
                            ),
                            SizedBox(height: 16),
                            _buildTextField(
                              controller: _phoneController,
                              label: 'Teléfono',
                              icon: Icons.phone,
                              keyboardType: TextInputType.phone,
                              hint: '+57 300 123 4567',
                              formatters: [
                                FilteringTextInputFormatter.allow(
                                    RegExp(r'^\+?[0-9]*$'))
                              ],
                              onChanged: (value) {
                                if (!value.startsWith('+57') &&
                                    value.isNotEmpty) {
                                  String newValue =
                                      '+57${value.replaceAll('+57', '')}';
                                  _phoneController.value = TextEditingValue(
                                    text: newValue,
                                    selection: TextSelection.collapsed(
                                        offset: newValue.length),
                                  );
                                }
                              },
                            ),
                            SizedBox(height: 16),
                            _buildTextField(
                              controller: _userController,
                              label: 'Usuario',
                              icon: Icons.account_circle,
                              hint: 'Nombre de usuario',
                            ),
                            SizedBox(height: 16),
                            _buildTextField(
                              controller: _passwordController,
                              label: 'Contraseña',
                              icon: Icons.lock_outline,
                              isPassword: !_passwordVisible,
                              hint: 'Mínimo 6 caracteres',
                              suffixIcon: IconButton(
                                icon: Icon(
                                    _passwordVisible
                                        ? Icons.visibility_off
                                        : Icons.visibility,
                                    color: ThemeConstants.primaryTeal),
                                onPressed: () => setState(
                                    () => _passwordVisible = !_passwordVisible),
                              ),
                            ),
                            SizedBox(height: 24),

                            // Botones
                            Row(
                              children: [
                                Expanded(
                                  child: OutlinedButton(
                                    onPressed: _isProcessing
                                        ? null
                                        : () => Navigator.pop(context),
                                    style: OutlinedButton.styleFrom(
                                      padding:
                                          EdgeInsets.symmetric(vertical: 14),
                                      side: BorderSide(
                                          color: ThemeConstants.accentGrey,
                                          width: 2),
                                      shape: RoundedRectangleBorder(
                                          borderRadius:
                                              BorderRadius.circular(12)),
                                    ),
                                    child: Text('Cancelar',
                                        style: TextStyle(
                                            fontSize: 16,
                                            fontWeight: FontWeight.w600,
                                            color: ThemeConstants.accentGrey)),
                                  ),
                                ),
                                SizedBox(width: 12),
                                Expanded(
                                  flex: 2,
                                  child: ElevatedButton(
                                    onPressed: _isProcessing
                                        ? null
                                        : () async {
                                            if (_isProcessing) return;
                                            setState(
                                                () => _isProcessing = true);

                                            try {
                                              if (_validateFields(
                                                  _nameController.text,
                                                  _lastNameController.text,
                                                  _ageController.text,
                                                  _phoneController.text,
                                                  _userController.text,
                                                  _passwordController.text)) {
                                                await FirebaseFirestore.instance
                                                    .collection('coordinadores')
                                                    .add({
                                                  'nombre': _nameController.text
                                                      .trim(),
                                                  'apellido':
                                                      _lastNameController.text
                                                          .trim(),
                                                  'edad': int.tryParse(
                                                          _ageController
                                                              .text) ??
                                                      0,
                                                  'telefono': _phoneController
                                                      .text
                                                      .trim(),
                                                  'usuario': _userController
                                                      .text
                                                      .trim(),
                                                  'contrasena':
                                                      _passwordController.text,
                                                  'tribuId': tribuId,
                                                });

                                                Navigator.pop(context);

                                                if (context.mounted) {
                                                  ScaffoldMessenger.of(context)
                                                      .showSnackBar(
                                                    SnackBar(
                                                      content: Row(
                                                        children: [
                                                          Icon(
                                                              Icons
                                                                  .check_circle,
                                                              color:
                                                                  Colors.white),
                                                          SizedBox(width: 12),
                                                          Text(
                                                              'Coordinador creado exitosamente'),
                                                        ],
                                                      ),
                                                      backgroundColor:
                                                          Colors.green,
                                                      behavior: SnackBarBehavior
                                                          .floating,
                                                      shape:
                                                          RoundedRectangleBorder(
                                                              borderRadius:
                                                                  BorderRadius
                                                                      .circular(
                                                                          10)),
                                                    ),
                                                  );
                                                }
                                              } else {
                                                if (context.mounted) {
                                                  String errorMessage =
                                                      'Error de validación:\n';
                                                  if (_nameController.text
                                                      .trim()
                                                      .isEmpty)
                                                    errorMessage +=
                                                        '• Nombre es requerido\n';
                                                  if (_lastNameController.text
                                                      .trim()
                                                      .isEmpty)
                                                    errorMessage +=
                                                        '• Apellido es requerido\n';
                                                  if (_ageController.text
                                                      .trim()
                                                      .isEmpty) {
                                                    errorMessage +=
                                                        '• Edad es requerida\n';
                                                  } else {
                                                    final ageInt = int.tryParse(
                                                        _ageController.text
                                                            .trim());
                                                    if (ageInt == null ||
                                                        ageInt <= 0 ||
                                                        ageInt > 120) {
                                                      errorMessage +=
                                                          '• Edad debe ser un número entre 1 y 120\n';
                                                    }
                                                  }
                                                  if (_phoneController.text
                                                      .trim()
                                                      .isEmpty) {
                                                    errorMessage +=
                                                        '• Teléfono es requerido\n';
                                                  } else if (!RegExp(
                                                          r'^\+57[0-9]{10}$')
                                                      .hasMatch(_phoneController
                                                          .text
                                                          .trim())) {
                                                    errorMessage +=
                                                        '• Teléfono debe tener formato +57XXXXXXXXXX\n';
                                                  }
                                                  if (_userController.text
                                                      .trim()
                                                      .isEmpty) {
                                                    errorMessage +=
                                                        '• Usuario es requerido\n';
                                                  } else if (_userController
                                                          .text
                                                          .trim()
                                                          .length <
                                                      3) {
                                                    errorMessage +=
                                                        '• Usuario debe tener al menos 3 caracteres\n';
                                                  }
                                                  if (_passwordController.text
                                                      .trim()
                                                      .isEmpty) {
                                                    errorMessage +=
                                                        '• Contraseña es requerida\n';
                                                  } else if (_passwordController
                                                          .text
                                                          .trim()
                                                          .length <
                                                      6) {
                                                    errorMessage +=
                                                        '• Contraseña debe tener al menos 6 caracteres\n';
                                                  }

                                                  ScaffoldMessenger.of(context)
                                                      .showSnackBar(
                                                    SnackBar(
                                                      content: Text(
                                                          errorMessage.trim()),
                                                      backgroundColor:
                                                          Colors.red,
                                                      duration:
                                                          Duration(seconds: 4),
                                                      behavior: SnackBarBehavior
                                                          .floating,
                                                      shape:
                                                          RoundedRectangleBorder(
                                                              borderRadius:
                                                                  BorderRadius
                                                                      .circular(
                                                                          10)),
                                                    ),
                                                  );
                                                }
                                              }
                                            } catch (e) {
                                              print(
                                                  'Error al crear coordinador: $e');
                                              if (context.mounted) {
                                                ScaffoldMessenger.of(context)
                                                    .showSnackBar(
                                                  SnackBar(
                                                    content: Text(
                                                        'Error al crear coordinador: $e'),
                                                    backgroundColor: Colors.red,
                                                  ),
                                                );
                                              }
                                            } finally {
                                              setState(
                                                  () => _isProcessing = false);
                                            }
                                          },
                                    style: ElevatedButton.styleFrom(
                                      backgroundColor:
                                          ThemeConstants.secondaryOrange,
                                      padding:
                                          EdgeInsets.symmetric(vertical: 14),
                                      shape: RoundedRectangleBorder(
                                          borderRadius:
                                              BorderRadius.circular(12)),
                                      elevation: 2,
                                    ),
                                    child: _isProcessing
                                        ? SizedBox(
                                            height: 20,
                                            width: 20,
                                            child: CircularProgressIndicator(
                                              strokeWidth: 2,
                                              valueColor:
                                                  AlwaysStoppedAnimation<Color>(
                                                      Colors.white),
                                            ),
                                          )
                                        : Row(
                                            mainAxisAlignment:
                                                MainAxisAlignment.center,
                                            children: [
                                              Icon(Icons.save, size: 20),
                                              SizedBox(width: 8),
                                              Text('Guardar',
                                                  style: TextStyle(
                                                      fontSize: 16,
                                                      fontWeight:
                                                          FontWeight.w600)),
                                            ],
                                          ),
                                  ),
                                ),
                              ],
                            ),
                          ],
                        ),
                      ),
                    ),
                  ],
                ),
              ),
            );
          },
        );
      },
    );
  }

  Widget _buildTextField({
    required TextEditingController controller,
    required String label,
    required IconData icon,
    bool isPassword = false,
    TextInputType? keyboardType,
    List<TextInputFormatter>? formatters,
    Function(String)? onChanged,
    String? hint,
    Widget? suffixIcon,
  }) {
    return Container(
      decoration: BoxDecoration(
        borderRadius: BorderRadius.circular(12),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.04),
            blurRadius: 8,
            offset: Offset(0, 2),
          ),
        ],
      ),
      child: TextField(
        controller: controller,
        decoration: InputDecoration(
          labelText: label,
          hintText: hint,
          hintStyle: TextStyle(color: Colors.grey.shade400, fontSize: 14),
          labelStyle: TextStyle(
              color: ThemeConstants.primaryTeal, fontWeight: FontWeight.w500),
          prefixIcon: Container(
            margin: EdgeInsets.all(12),
            padding: EdgeInsets.all(8),
            decoration: BoxDecoration(
              gradient: LinearGradient(
                begin: Alignment.topLeft,
                end: Alignment.bottomRight,
                colors: [
                  ThemeConstants.primaryTeal.withOpacity(0.1),
                  ThemeConstants.primaryTeal.withOpacity(0.05),
                ],
              ),
              borderRadius: BorderRadius.circular(10),
            ),
            child: Icon(icon, color: ThemeConstants.primaryTeal, size: 20),
          ),
          suffixIcon: suffixIcon,
          filled: true,
          fillColor: Colors.white,
          border: OutlineInputBorder(
            borderRadius: BorderRadius.circular(12),
            borderSide: BorderSide(color: Colors.grey.shade300, width: 1.5),
          ),
          enabledBorder: OutlineInputBorder(
            borderRadius: BorderRadius.circular(12),
            borderSide: BorderSide(color: Colors.grey.shade300, width: 1.5),
          ),
          focusedBorder: OutlineInputBorder(
            borderRadius: BorderRadius.circular(12),
            borderSide: BorderSide(color: ThemeConstants.primaryTeal, width: 2),
          ),
          errorBorder: OutlineInputBorder(
            borderRadius: BorderRadius.circular(12),
            borderSide: BorderSide(color: Colors.red.shade400, width: 2),
          ),
          focusedErrorBorder: OutlineInputBorder(
            borderRadius: BorderRadius.circular(12),
            borderSide: BorderSide(color: Colors.red.shade400, width: 2),
          ),
          contentPadding: EdgeInsets.symmetric(horizontal: 16, vertical: 16),
        ),
        obscureText: isPassword,
        keyboardType: keyboardType,
        inputFormatters: formatters,
        onChanged: onChanged,
        style: TextStyle(
            fontSize: 15,
            color: Colors.grey.shade800,
            fontWeight: FontWeight.w500),
      ),
    );
  }

  bool _validateFields(String name, String lastName, String age, String phone,
      String user, String password) {
    if (name.trim().isEmpty ||
        lastName.trim().isEmpty ||
        age.trim().isEmpty ||
        phone.trim().isEmpty ||
        user.trim().isEmpty ||
        password.trim().isEmpty) {
      return false;
    }

    final ageInt = int.tryParse(age.trim());
    if (ageInt == null || ageInt <= 0 || ageInt > 120) return false;

    final phoneRegex = RegExp(r'^\+57[0-9]{10}$');
    if (!phoneRegex.hasMatch(phone.trim())) return false;

    if (user.trim().length < 3) return false;
    if (password.trim().length < 6) return false;

    return true;
  }

  Future<void> _editarCoordinador(
      BuildContext context, DocumentSnapshot coordinador) async {
    final nombreController = TextEditingController(text: coordinador['nombre']);
    final apellidoController =
        TextEditingController(text: coordinador['apellido']);
    final usuarioController =
        TextEditingController(text: coordinador['usuario']);
    final contrasenaController =
        TextEditingController(text: coordinador['contrasena']);

    bool _isProcessing = false;
    bool _passwordVisible = false;

    await showDialog(
      context: context,
      barrierDismissible: false,
      builder: (context) => StatefulBuilder(
        builder: (context, setState) {
          final screenWidth = MediaQuery.of(context).size.width;
          final screenHeight = MediaQuery.of(context).size.height;
          final isSmallScreen = screenWidth < 600;
          final isMediumScreen = screenWidth >= 600 && screenWidth < 900;

          final dialogWidth = isSmallScreen
              ? screenWidth * 0.95
              : (isMediumScreen ? 500.0 : 550.0);

          return Dialog(
            shape: RoundedRectangleBorder(
              borderRadius: BorderRadius.circular(isSmallScreen ? 18 : 24),
            ),
            insetPadding: EdgeInsets.symmetric(
              horizontal: isSmallScreen ? 8 : 16,
              vertical: isSmallScreen ? 16 : 24,
            ),
            child: Container(
              width: dialogWidth,
              constraints: BoxConstraints(
                maxHeight: screenHeight * 0.9,
                maxWidth: dialogWidth,
              ),
              decoration: BoxDecoration(
                borderRadius: BorderRadius.circular(isSmallScreen ? 18 : 24),
                gradient: LinearGradient(
                  begin: Alignment.topLeft,
                  end: Alignment.bottomRight,
                  colors: [
                    Colors.white,
                    ThemeConstants.secondaryOrange.withOpacity(0.02)
                  ],
                ),
              ),
              child: Column(
                mainAxisSize: MainAxisSize.min,
                children: [
                  // Header
                  Container(
                    padding: EdgeInsets.all(isSmallScreen ? 16 : 24),
                    decoration: BoxDecoration(
                      gradient: LinearGradient(
                        begin: Alignment.topLeft,
                        end: Alignment.bottomRight,
                        colors: [
                          ThemeConstants.secondaryOrange,
                          ThemeConstants.secondaryOrange.withOpacity(0.8)
                        ],
                      ),
                      borderRadius: BorderRadius.only(
                        topLeft: Radius.circular(isSmallScreen ? 18 : 24),
                        topRight: Radius.circular(isSmallScreen ? 18 : 24),
                      ),
                      boxShadow: [
                        BoxShadow(
                          color:
                              ThemeConstants.secondaryOrange.withOpacity(0.3),
                          blurRadius: 8,
                          offset: Offset(0, 4),
                        ),
                      ],
                    ),
                    child: Row(
                      children: [
                        Container(
                          padding: EdgeInsets.all(isSmallScreen ? 10 : 12),
                          decoration: BoxDecoration(
                            color: Colors.white.withOpacity(0.2),
                            borderRadius:
                                BorderRadius.circular(isSmallScreen ? 12 : 16),
                          ),
                          child: Icon(Icons.edit,
                              color: Colors.white,
                              size: isSmallScreen ? 24 : 28),
                        ),
                        SizedBox(width: isSmallScreen ? 12 : 16),
                        Expanded(
                          child: Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              Text(
                                'Editar Coordinador',
                                style: TextStyle(
                                  fontSize: isSmallScreen ? 18 : 22,
                                  fontWeight: FontWeight.bold,
                                  color: Colors.white,
                                ),
                              ),
                              if (!isSmallScreen)
                                Text(
                                  'Actualiza los datos del coordinador',
                                  style: TextStyle(
                                      fontSize: 13,
                                      color: Colors.white.withOpacity(0.9)),
                                ),
                            ],
                          ),
                        ),
                        Material(
                          color: Colors.transparent,
                          child: InkWell(
                            onTap: _isProcessing
                                ? null
                                : () => Navigator.pop(context),
                            borderRadius: BorderRadius.circular(10),
                            child: Container(
                              padding: EdgeInsets.all(8),
                              decoration: BoxDecoration(
                                color: Colors.white.withOpacity(0.2),
                                borderRadius: BorderRadius.circular(10),
                              ),
                              child: Icon(Icons.close,
                                  color: Colors.white,
                                  size: isSmallScreen ? 20 : 22),
                            ),
                          ),
                        ),
                      ],
                    ),
                  ),

                  // Contenido con scroll
                  Flexible(
                    child: SingleChildScrollView(
                      padding: EdgeInsets.all(isSmallScreen ? 16 : 24),
                      physics: ClampingScrollPhysics(),
                      child: Column(
                        children: [
                          _buildTextField(
                            controller: nombreController,
                            label: 'Nombre',
                            icon: Icons.person_outline,
                            hint: 'Ingresa el nombre',
                          ),
                          SizedBox(height: 16),
                          _buildTextField(
                            controller: apellidoController,
                            label: 'Apellido',
                            icon: Icons.person,
                            hint: 'Ingresa el apellido',
                          ),
                          SizedBox(height: 16),
                          _buildTextField(
                            controller: usuarioController,
                            label: 'Usuario',
                            icon: Icons.account_circle,
                            hint: 'Nombre de usuario',
                          ),
                          SizedBox(height: 16),
                          _buildTextField(
                            controller: contrasenaController,
                            label: 'Contraseña',
                            icon: Icons.lock_outline,
                            isPassword: !_passwordVisible,
                            hint: 'Modifica la contraseña si lo deseas',
                            suffixIcon: IconButton(
                              icon: Icon(
                                _passwordVisible
                                    ? Icons.visibility_off
                                    : Icons.visibility,
                                color: ThemeConstants.secondaryOrange,
                              ),
                              onPressed: () => setState(
                                  () => _passwordVisible = !_passwordVisible),
                            ),
                          ),
                          SizedBox(height: 24),

                          // Botones
                          if (isSmallScreen)
                            Column(
                              children: [
                                SizedBox(
                                  width: double.infinity,
                                  child: ElevatedButton(
                                    onPressed: _isProcessing
                                        ? null
                                        : () async {
                                            if (_isProcessing) return;
                                            setState(
                                                () => _isProcessing = true);

                                            try {
                                              final Map<String, dynamic>
                                                  datosActualizados = {
                                                'nombre': nombreController.text
                                                    .trim(),
                                                'apellido': apellidoController
                                                    .text
                                                    .trim(),
                                                'usuario': usuarioController
                                                    .text
                                                    .trim(),
                                                'contrasena':
                                                    contrasenaController.text
                                                        .trim(),
                                              };

                                              await FirebaseFirestore.instance
                                                  .collection('coordinadores')
                                                  .doc(coordinador.id)
                                                  .update(datosActualizados);

                                              Navigator.pop(context);

                                              if (context.mounted) {
                                                ScaffoldMessenger.of(context)
                                                    .showSnackBar(
                                                  SnackBar(
                                                    content: Row(
                                                      children: [
                                                        Icon(Icons.check_circle,
                                                            color:
                                                                Colors.white),
                                                        SizedBox(width: 12),
                                                        Text(
                                                            'Coordinador actualizado exitosamente'),
                                                      ],
                                                    ),
                                                    backgroundColor:
                                                        Colors.green,
                                                    behavior: SnackBarBehavior
                                                        .floating,
                                                    shape:
                                                        RoundedRectangleBorder(
                                                            borderRadius:
                                                                BorderRadius
                                                                    .circular(
                                                                        10)),
                                                  ),
                                                );
                                              }
                                            } catch (e) {
                                              print(
                                                  'Error al actualizar coordinador: $e');
                                              if (context.mounted) {
                                                ScaffoldMessenger.of(context)
                                                    .showSnackBar(
                                                  SnackBar(
                                                      content: Text(
                                                          'Error al actualizar coordinador: $e'),
                                                      backgroundColor:
                                                          Colors.red),
                                                );
                                              }
                                            } finally {
                                              setState(
                                                  () => _isProcessing = false);
                                            }
                                          },
                                    style: ElevatedButton.styleFrom(
                                      backgroundColor:
                                          ThemeConstants.secondaryOrange,
                                      padding:
                                          EdgeInsets.symmetric(vertical: 14),
                                      shape: RoundedRectangleBorder(
                                          borderRadius:
                                              BorderRadius.circular(12)),
                                      elevation: 2,
                                    ),
                                    child: _isProcessing
                                        ? SizedBox(
                                            height: 18,
                                            width: 18,
                                            child: CircularProgressIndicator(
                                              strokeWidth: 2,
                                              valueColor:
                                                  AlwaysStoppedAnimation<Color>(
                                                      Colors.white),
                                            ),
                                          )
                                        : Row(
                                            mainAxisAlignment:
                                                MainAxisAlignment.center,
                                            children: [
                                              Icon(Icons.save, size: 18),
                                              SizedBox(width: 8),
                                              Text('Guardar Cambios',
                                                  style: TextStyle(
                                                      fontSize: 15,
                                                      fontWeight:
                                                          FontWeight.w600)),
                                            ],
                                          ),
                                  ),
                                ),
                                SizedBox(height: 10),
                                SizedBox(
                                  width: double.infinity,
                                  child: OutlinedButton(
                                    onPressed: _isProcessing
                                        ? null
                                        : () => Navigator.pop(context),
                                    style: OutlinedButton.styleFrom(
                                      padding:
                                          EdgeInsets.symmetric(vertical: 14),
                                      side: BorderSide(
                                          color: ThemeConstants.accentGrey,
                                          width: 2),
                                      shape: RoundedRectangleBorder(
                                          borderRadius:
                                              BorderRadius.circular(12)),
                                    ),
                                    child: Text('Cancelar',
                                        style: TextStyle(
                                            fontSize: 15,
                                            fontWeight: FontWeight.w600,
                                            color: ThemeConstants.accentGrey)),
                                  ),
                                ),
                              ],
                            )
                          else
                            Row(
                              children: [
                                Expanded(
                                  child: OutlinedButton(
                                    onPressed: _isProcessing
                                        ? null
                                        : () => Navigator.pop(context),
                                    style: OutlinedButton.styleFrom(
                                      padding:
                                          EdgeInsets.symmetric(vertical: 16),
                                      side: BorderSide(
                                          color: ThemeConstants.accentGrey,
                                          width: 2),
                                      shape: RoundedRectangleBorder(
                                          borderRadius:
                                              BorderRadius.circular(12)),
                                    ),
                                    child: Text('Cancelar',
                                        style: TextStyle(
                                            fontSize: 16,
                                            fontWeight: FontWeight.w600,
                                            color: ThemeConstants.accentGrey)),
                                  ),
                                ),
                                SizedBox(width: 12),
                                Expanded(
                                  flex: 2,
                                  child: ElevatedButton(
                                    onPressed: _isProcessing
                                        ? null
                                        : () async {
                                            if (_isProcessing) return;
                                            setState(
                                                () => _isProcessing = true);

                                            try {
                                              final Map<String, dynamic>
                                                  datosActualizados = {
                                                'nombre': nombreController.text
                                                    .trim(),
                                                'apellido': apellidoController
                                                    .text
                                                    .trim(),
                                                'usuario': usuarioController
                                                    .text
                                                    .trim(),
                                                'contrasena':
                                                    contrasenaController.text
                                                        .trim(),
                                              };

                                              await FirebaseFirestore.instance
                                                  .collection('coordinadores')
                                                  .doc(coordinador.id)
                                                  .update(datosActualizados);

                                              Navigator.pop(context);

                                              if (context.mounted) {
                                                ScaffoldMessenger.of(context)
                                                    .showSnackBar(
                                                  SnackBar(
                                                    content: Row(
                                                      children: [
                                                        Icon(Icons.check_circle,
                                                            color:
                                                                Colors.white),
                                                        SizedBox(width: 12),
                                                        Text(
                                                            'Coordinador actualizado exitosamente'),
                                                      ],
                                                    ),
                                                    backgroundColor:
                                                        Colors.green,
                                                    behavior: SnackBarBehavior
                                                        .floating,
                                                    shape:
                                                        RoundedRectangleBorder(
                                                            borderRadius:
                                                                BorderRadius
                                                                    .circular(
                                                                        10)),
                                                  ),
                                                );
                                              }
                                            } catch (e) {
                                              print(
                                                  'Error al actualizar coordinador: $e');
                                              if (context.mounted) {
                                                ScaffoldMessenger.of(context)
                                                    .showSnackBar(
                                                  SnackBar(
                                                      content: Text(
                                                          'Error al actualizar coordinador: $e'),
                                                      backgroundColor:
                                                          Colors.red),
                                                );
                                              }
                                            } finally {
                                              setState(
                                                  () => _isProcessing = false);
                                            }
                                          },
                                    style: ElevatedButton.styleFrom(
                                      backgroundColor:
                                          ThemeConstants.secondaryOrange,
                                      padding:
                                          EdgeInsets.symmetric(vertical: 16),
                                      shape: RoundedRectangleBorder(
                                          borderRadius:
                                              BorderRadius.circular(12)),
                                      elevation: 2,
                                    ),
                                    child: _isProcessing
                                        ? SizedBox(
                                            height: 20,
                                            width: 20,
                                            child: CircularProgressIndicator(
                                              strokeWidth: 2,
                                              valueColor:
                                                  AlwaysStoppedAnimation<Color>(
                                                      Colors.white),
                                            ),
                                          )
                                        : Row(
                                            mainAxisAlignment:
                                                MainAxisAlignment.center,
                                            children: [
                                              Icon(Icons.save, size: 20),
                                              SizedBox(width: 8),
                                              Text('Guardar Cambios',
                                                  style: TextStyle(
                                                      fontSize: 16,
                                                      fontWeight:
                                                          FontWeight.w600)),
                                            ],
                                          ),
                                  ),
                                ),
                              ],
                            ),
                        ],
                      ),
                    ),
                  ),
                ],
              ),
            ),
          );
        },
      ),
    );
  }

  Future<void> _eliminarCoordinador(
      BuildContext context, DocumentSnapshot coordinador) async {
    final _TribusScreenState? tribusState =
        context.findAncestorStateOfType<_TribusScreenState>();

    if (tribusState == null) return;

    final BuildContext safeContext = tribusState.context;

    final nombreCompleto =
        '${coordinador['nombre']} ${coordinador['apellido']}';

    await tribusState._confirmarEliminacionConContrasena(
      safeContext,
      tipoUsuario: 'Coordinador',
      nombreUsuario: nombreCompleto,
      onConfirmed: () async {
        showDialog(
          context: safeContext,
          barrierDismissible: false,
          builder: (context) => Center(
            child: Container(
              padding: EdgeInsets.all(24),
              decoration: BoxDecoration(
                color: Colors.white,
                borderRadius: BorderRadius.circular(16),
              ),
              child: Column(
                mainAxisSize: MainAxisSize.min,
                children: [
                  CircularProgressIndicator(color: Color(0xFF1B998B)),
                  SizedBox(height: 16),
                  Text(
                    'Eliminando coordinador.',
                    style: GoogleFonts.poppins(
                      fontSize: 14,
                      fontWeight: FontWeight.w500,
                    ),
                  ),
                ],
              ),
            ),
          ),
        );

        try {
          final batch = FirebaseFirestore.instance.batch();

          final timoteos = await FirebaseFirestore.instance
              .collection('timoteos')
              .where('coordinadorId', isEqualTo: coordinador.id)
              .get();

          for (var timoteo in timoteos.docs) {
            batch.update(timoteo.reference,
                {'coordinadorId': null, 'nombreCoordinador': null});
          }

          final registros = await FirebaseFirestore.instance
              .collection('registros')
              .where('coordinadorAsignado', isEqualTo: coordinador.id)
              .get();

          for (var registro in registros.docs) {
            batch.update(registro.reference, {
              'coordinadorAsignado': null,
              'nombreCoordinador': null,
              'estado': 'pendiente'
            });
          }

          batch.delete(coordinador.reference);

          await batch.commit();

          if (tribusState.mounted &&
              Navigator.of(safeContext, rootNavigator: true).canPop()) {
            Navigator.of(safeContext, rootNavigator: true).pop();
          }

          if (tribusState.mounted) {
            ScaffoldMessenger.of(safeContext).showSnackBar(
              SnackBar(
                content: Row(
                  children: [
                    Icon(Icons.check_circle, color: Colors.white),
                    SizedBox(width: 12),
                    Expanded(
                      child: Text(
                        'Coordinador eliminado correctamente',
                        style: GoogleFonts.poppins(fontWeight: FontWeight.w500),
                      ),
                    ),
                  ],
                ),
                backgroundColor: Colors.green,
                behavior: SnackBarBehavior.floating,
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(12),
                ),
              ),
            );
          }
        } catch (e) {
          print('Error al eliminar coordinador: $e');

          if (tribusState.mounted &&
              Navigator.of(safeContext, rootNavigator: true).canPop()) {
            Navigator.of(safeContext, rootNavigator: true).pop();
          }

          if (tribusState.mounted) {
            ScaffoldMessenger.of(safeContext).showSnackBar(
              SnackBar(
                content: Row(
                  children: [
                    Icon(Icons.error_outline, color: Colors.white),
                    SizedBox(width: 12),
                    Expanded(
                      child: Text(
                        'Error al eliminar el coordinador: $e',
                        style: GoogleFonts.poppins(fontWeight: FontWeight.w500),
                      ),
                    ),
                  ],
                ),
                backgroundColor: Colors.red,
                behavior: SnackBarBehavior.floating,
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(12),
                ),
              ),
            );
          }
        }
      },
    );
  }

  Future<void> _verTimoteosAsignados(
      BuildContext context, DocumentSnapshot coordinador) async {
    await showDialog(
      context: context,
      builder: (context) {
        return Dialog(
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(24),
          ),
          elevation: 10,
          child: Container(
            width: MediaQuery.of(context).size.width * 0.9,
            height: MediaQuery.of(context).size.height * 0.8,
            decoration: BoxDecoration(
              borderRadius: BorderRadius.circular(24),
              gradient: LinearGradient(
                begin: Alignment.topCenter,
                end: Alignment.bottomCenter,
                colors: [
                  Colors.white,
                  ThemeConstants.primaryTeal.withOpacity(0.02),
                ],
              ),
            ),
            child: Column(
              children: [
                // Header personalizado
                Container(
                  padding: EdgeInsets.all(20),
                  decoration: BoxDecoration(
                    gradient: LinearGradient(
                      begin: Alignment.topLeft,
                      end: Alignment.bottomRight,
                      colors: [
                        ThemeConstants.primaryTeal,
                        ThemeConstants.primaryTeal.withOpacity(0.8),
                      ],
                    ),
                    borderRadius: BorderRadius.only(
                      topLeft: Radius.circular(24),
                      topRight: Radius.circular(24),
                    ),
                    boxShadow: [
                      BoxShadow(
                        color: ThemeConstants.primaryTeal.withOpacity(0.3),
                        blurRadius: 8,
                        offset: Offset(0, 4),
                      ),
                    ],
                  ),
                  child: Row(
                    children: [
                      Container(
                        padding: EdgeInsets.all(12),
                        decoration: BoxDecoration(
                          color: Colors.white.withOpacity(0.2),
                          borderRadius: BorderRadius.circular(16),
                        ),
                        child: Icon(
                          Icons.groups,
                          color: Colors.white,
                          size: 28,
                        ),
                      ),
                      SizedBox(width: 16),
                      Expanded(
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(
                              'Timoteos Asignados',
                              style: TextStyle(
                                fontSize: 20,
                                fontWeight: FontWeight.bold,
                                color: Colors.white,
                              ),
                            ),
                            Text(
                              '${coordinador['nombre']} ${coordinador['apellido']}',
                              style: TextStyle(
                                fontSize: 14,
                                color: Colors.white.withOpacity(0.9),
                              ),
                            ),
                          ],
                        ),
                      ),
                      Material(
                        color: Colors.transparent,
                        child: InkWell(
                          onTap: () => Navigator.pop(context),
                          borderRadius: BorderRadius.circular(12),
                          child: Container(
                            padding: EdgeInsets.all(8),
                            decoration: BoxDecoration(
                              color: Colors.white.withOpacity(0.2),
                              borderRadius: BorderRadius.circular(12),
                            ),
                            child: Icon(
                              Icons.close,
                              color: Colors.white,
                              size: 24,
                            ),
                          ),
                        ),
                      ),
                    ],
                  ),
                ),

                // Contenido con lista de timoteos
                Expanded(
                  child: StreamBuilder(
                    stream: FirebaseFirestore.instance
                        .collection('timoteos')
                        .where('coordinadorId', isEqualTo: coordinador.id)
                        .snapshots(),
                    builder: (context, AsyncSnapshot<QuerySnapshot> snapshot) {
                      if (snapshot.connectionState == ConnectionState.waiting) {
                        return Center(
                          child: Column(
                            mainAxisAlignment: MainAxisAlignment.center,
                            children: [
                              CircularProgressIndicator(
                                color: ThemeConstants.primaryTeal,
                              ),
                              SizedBox(height: 16),
                              Text(
                                'Cargando timoteos...',
                                style: TextStyle(
                                  color: ThemeConstants.accentGrey,
                                  fontSize: 14,
                                ),
                              ),
                            ],
                          ),
                        );
                      }

                      if (!snapshot.hasData || snapshot.data!.docs.isEmpty) {
                        return Center(
                          child: Column(
                            mainAxisAlignment: MainAxisAlignment.center,
                            children: [
                              Container(
                                padding: EdgeInsets.all(24),
                                decoration: BoxDecoration(
                                  color: ThemeConstants.primaryTeal
                                      .withOpacity(0.1),
                                  shape: BoxShape.circle,
                                ),
                                child: Icon(
                                  Icons.person_off,
                                  size: 64,
                                  color: ThemeConstants.primaryTeal
                                      .withOpacity(0.5),
                                ),
                              ),
                              SizedBox(height: 16),
                              Text(
                                'No hay timoteos asignados',
                                style: TextStyle(
                                  fontSize: 18,
                                  fontWeight: FontWeight.w600,
                                  color: ThemeConstants.accentGrey,
                                ),
                              ),
                              SizedBox(height: 8),
                              Text(
                                'Este coordinador no tiene timoteos',
                                style: TextStyle(
                                  fontSize: 14,
                                  color: ThemeConstants.accentGrey
                                      .withOpacity(0.7),
                                ),
                              ),
                            ],
                          ),
                        );
                      }

                      return ListView.builder(
                        padding: EdgeInsets.all(16),
                        itemCount: snapshot.data!.docs.length,
                        itemBuilder: (context, index) {
                          final timoteo = snapshot.data!.docs[index];
                          return Container(
                            margin: EdgeInsets.only(bottom: 12),
                            decoration: BoxDecoration(
                              borderRadius: BorderRadius.circular(16),
                              gradient: LinearGradient(
                                begin: Alignment.topLeft,
                                end: Alignment.bottomRight,
                                colors: [
                                  Colors.white,
                                  ThemeConstants.primaryTeal.withOpacity(0.03),
                                ],
                              ),
                              boxShadow: [
                                BoxShadow(
                                  color: Colors.black.withOpacity(0.05),
                                  blurRadius: 8,
                                  offset: Offset(0, 2),
                                ),
                              ],
                              border: Border.all(
                                color:
                                    ThemeConstants.primaryTeal.withOpacity(0.2),
                                width: 1,
                              ),
                            ),
                            child: ListTile(
                              contentPadding: EdgeInsets.all(16),
                              leading: Container(
                                width: 50,
                                height: 50,
                                decoration: BoxDecoration(
                                  gradient: LinearGradient(
                                    begin: Alignment.topLeft,
                                    end: Alignment.bottomRight,
                                    colors: [
                                      ThemeConstants.primaryTeal,
                                      ThemeConstants.primaryTeal
                                          .withOpacity(0.7),
                                    ],
                                  ),
                                  shape: BoxShape.circle,
                                  boxShadow: [
                                    BoxShadow(
                                      color: ThemeConstants.primaryTeal
                                          .withOpacity(0.3),
                                      blurRadius: 8,
                                      offset: Offset(0, 2),
                                    ),
                                  ],
                                ),
                                child: Center(
                                  child: Text(
                                    '${timoteo['nombre'][0]}${timoteo['apellido'][0]}'
                                        .toUpperCase(),
                                    style: TextStyle(
                                      color: Colors.white,
                                      fontWeight: FontWeight.bold,
                                      fontSize: 18,
                                    ),
                                  ),
                                ),
                              ),
                              title: Text(
                                '${timoteo['nombre']} ${timoteo['apellido']}',
                                style: TextStyle(
                                  fontWeight: FontWeight.bold,
                                  fontSize: 16,
                                  color: Colors.grey.shade800,
                                ),
                              ),
                              subtitle: Column(
                                crossAxisAlignment: CrossAxisAlignment.start,
                                children: [
                                  SizedBox(height: 8),
                                  Row(
                                    children: [
                                      Icon(
                                        Icons.account_circle,
                                        size: 16,
                                        color: ThemeConstants.accentGrey,
                                      ),
                                      SizedBox(width: 6),
                                      Text(
                                        'Usuario: ${timoteo['usuario']}',
                                        style: TextStyle(
                                          fontSize: 13,
                                          color: ThemeConstants.accentGrey,
                                        ),
                                      ),
                                    ],
                                  ),
                                  SizedBox(height: 4),
                                  Row(
                                    children: [
                                      Icon(
                                        Icons.lock_outline,
                                        size: 16,
                                        color: ThemeConstants.accentGrey,
                                      ),
                                      SizedBox(width: 6),
                                      Text(
                                        'Contraseña: ${timoteo['contrasena']}',
                                        style: TextStyle(
                                          fontSize: 13,
                                          color: ThemeConstants.accentGrey,
                                        ),
                                      ),
                                    ],
                                  ),
                                ],
                              ),
                              trailing: Material(
                                color: Colors.transparent,
                                child: InkWell(
                                  onTap: () async {
                                    final confirm = await showDialog<bool>(
                                      context: context,
                                      builder: (context) => AlertDialog(
                                        shape: RoundedRectangleBorder(
                                          borderRadius:
                                              BorderRadius.circular(16),
                                        ),
                                        title: Row(
                                          children: [
                                            Icon(
                                              Icons.warning_amber_rounded,
                                              color: Colors.orange,
                                            ),
                                            SizedBox(width: 12),
                                            Text('Confirmar'),
                                          ],
                                        ),
                                        content: Text(
                                          '¿Desasignar este timoteo del coordinador?',
                                        ),
                                        actions: [
                                          TextButton(
                                            onPressed: () =>
                                                Navigator.pop(context, false),
                                            child: Text('Cancelar'),
                                          ),
                                          ElevatedButton(
                                            onPressed: () =>
                                                Navigator.pop(context, true),
                                            style: ElevatedButton.styleFrom(
                                              backgroundColor: Colors.red,
                                            ),
                                            child: Text('Desasignar'),
                                          ),
                                        ],
                                      ),
                                    );

                                    if (confirm == true) {
                                      await FirebaseFirestore.instance
                                          .collection('timoteos')
                                          .doc(timoteo.id)
                                          .update({
                                        'coordinadorId': null,
                                        'nombreCoordinador': null,
                                      });

                                      if (context.mounted) {
                                        ScaffoldMessenger.of(context)
                                            .showSnackBar(
                                          SnackBar(
                                            content: Text(
                                                'Timoteo desasignado correctamente'),
                                            backgroundColor: Colors.green,
                                          ),
                                        );
                                      }
                                    }
                                  },
                                  borderRadius: BorderRadius.circular(12),
                                  child: Container(
                                    padding: EdgeInsets.all(8),
                                    decoration: BoxDecoration(
                                      color: Colors.red.withOpacity(0.1),
                                      borderRadius: BorderRadius.circular(12),
                                    ),
                                    child: Icon(
                                      Icons.person_remove,
                                      color: Colors.red,
                                      size: 24,
                                    ),
                                  ),
                                ),
                              ),
                            ),
                          );
                        },
                      );
                    },
                  ),
                ),
              ],
            ),
          ),
        );
      },
    );
  }

  @override
  Widget build(BuildContext context) {
    return Container(
      decoration: BoxDecoration(
        gradient: LinearGradient(
          begin: Alignment.topCenter,
          end: Alignment.bottomCenter,
          colors: [
            Colors.white,
            ThemeConstants.primaryTeal.withOpacity(0.03),
          ],
        ),
      ),
      child: Column(
        children: [
          // Botón de crear coordinador
          Container(
            margin: EdgeInsets.symmetric(horizontal: 16, vertical: 12),
            child: Container(
              decoration: BoxDecoration(
                borderRadius: BorderRadius.circular(12),
                gradient: LinearGradient(
                  begin: Alignment.topLeft,
                  end: Alignment.bottomRight,
                  colors: [
                    ThemeConstants.secondaryOrange,
                    ThemeConstants.secondaryOrange.withOpacity(0.85),
                  ],
                ),
                boxShadow: [
                  BoxShadow(
                    color: ThemeConstants.secondaryOrange.withOpacity(0.25),
                    blurRadius: 8,
                    offset: Offset(0, 4),
                  ),
                ],
              ),
              child: Material(
                color: Colors.transparent,
                child: InkWell(
                  onTap: () => _crearCoordinador(context),
                  borderRadius: BorderRadius.circular(12),
                  child: Padding(
                    padding: EdgeInsets.symmetric(vertical: 12, horizontal: 16),
                    child: Row(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        Container(
                          padding: EdgeInsets.all(6),
                          decoration: BoxDecoration(
                            color: Colors.white.withOpacity(0.2),
                            borderRadius: BorderRadius.circular(8),
                          ),
                          child: Icon(
                            Icons.group_add,
                            size: 20,
                            color: Colors.white,
                          ),
                        ),
                        SizedBox(width: 10),
                        Text(
                          'Crear Coordinador',
                          style: TextStyle(
                            fontSize: 15,
                            fontWeight: FontWeight.bold,
                            color: Colors.white,
                            letterSpacing: 0.3,
                          ),
                        ),
                      ],
                    ),
                  ),
                ),
              ),
            ),
          ),

          // Lista de coordinadores
          Expanded(
            child: StreamBuilder(
              stream: FirebaseFirestore.instance
                  .collection('coordinadores')
                  .where('tribuId', isEqualTo: tribuId)
                  .snapshots(),
              builder: (context, AsyncSnapshot<QuerySnapshot> snapshot) {
                if (snapshot.connectionState == ConnectionState.waiting) {
                  return Center(
                    child: Column(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        Container(
                          padding: EdgeInsets.all(20),
                          decoration: BoxDecoration(
                            color: ThemeConstants.primaryTeal.withOpacity(0.1),
                            shape: BoxShape.circle,
                          ),
                          child: CircularProgressIndicator(
                            color: ThemeConstants.primaryTeal,
                            strokeWidth: 3,
                          ),
                        ),
                        SizedBox(height: 20),
                        Text(
                          'Cargando coordinadores...',
                          style: TextStyle(
                            fontSize: 16,
                            color: ThemeConstants.primaryTeal,
                            fontWeight: FontWeight.w500,
                          ),
                        ),
                      ],
                    ),
                  );
                }

                if (!snapshot.hasData || snapshot.data!.docs.isEmpty) {
                  return Center(
                    child: Column(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        Container(
                          padding: EdgeInsets.all(24),
                          decoration: BoxDecoration(
                            color: ThemeConstants.accentGrey.withOpacity(0.1),
                            shape: BoxShape.circle,
                          ),
                          child: Icon(
                            Icons.groups,
                            size: 80,
                            color: ThemeConstants.accentGrey.withOpacity(0.5),
                          ),
                        ),
                        SizedBox(height: 24),
                        Text(
                          'No hay coordinadores registrados',
                          style: TextStyle(
                            fontSize: 20,
                            color: ThemeConstants.accentGrey,
                            fontWeight: FontWeight.w600,
                          ),
                        ),
                        SizedBox(height: 8),
                        Text(
                          'Presiona el botón superior para crear uno',
                          style: TextStyle(
                            fontSize: 14,
                            color: ThemeConstants.accentGrey.withOpacity(0.7),
                          ),
                        ),
                      ],
                    ),
                  );
                }

                return ListView.builder(
                  padding: EdgeInsets.symmetric(horizontal: 16, vertical: 8),
                  itemCount: snapshot.data!.docs.length,
                  itemBuilder: (context, index) {
                    final coordinador = snapshot.data!.docs[index];
                    final iniciales =
                        '${coordinador['nombre'][0]}${coordinador['apellido'][0]}'
                            .toUpperCase();

                    return Container(
                      margin: EdgeInsets.only(bottom: 16),
                      decoration: BoxDecoration(
                        borderRadius: BorderRadius.circular(20),
                        gradient: LinearGradient(
                          begin: Alignment.topLeft,
                          end: Alignment.bottomRight,
                          colors: [
                            Colors.white,
                            ThemeConstants.primaryTeal.withOpacity(0.03),
                          ],
                        ),
                        boxShadow: [
                          BoxShadow(
                            color: Colors.black.withOpacity(0.06),
                            blurRadius: 12,
                            offset: Offset(0, 4),
                          ),
                        ],
                        border: Border.all(
                          color: ThemeConstants.primaryTeal.withOpacity(0.15),
                          width: 1,
                        ),
                      ),
                      child: Theme(
                        data: Theme.of(context).copyWith(
                          dividerColor: Colors.transparent,
                        ),
                        child: ExpansionTile(
                          tilePadding: EdgeInsets.symmetric(
                              horizontal: 20, vertical: 12),
                          childrenPadding: EdgeInsets.all(0),
                          leading: Hero(
                            tag: 'coordinador_${coordinador.id}',
                            child: Container(
                              width: 56,
                              height: 56,
                              decoration: BoxDecoration(
                                gradient: LinearGradient(
                                  begin: Alignment.topLeft,
                                  end: Alignment.bottomRight,
                                  colors: [
                                    ThemeConstants.primaryTeal,
                                    ThemeConstants.primaryTeal.withOpacity(0.7),
                                  ],
                                ),
                                shape: BoxShape.circle,
                                boxShadow: [
                                  BoxShadow(
                                    color: ThemeConstants.primaryTeal
                                        .withOpacity(0.3),
                                    blurRadius: 8,
                                    offset: Offset(0, 4),
                                  ),
                                ],
                              ),
                              child: Center(
                                child: Text(
                                  iniciales,
                                  style: TextStyle(
                                    color: Colors.white,
                                    fontWeight: FontWeight.bold,
                                    fontSize: 20,
                                    letterSpacing: 1,
                                  ),
                                ),
                              ),
                            ),
                          ),
                          title: Text(
                            '${coordinador['nombre']} ${coordinador['apellido']}',
                            style: TextStyle(
                              fontWeight: FontWeight.bold,
                              color: ThemeConstants.primaryTeal,
                              fontSize: 17,
                            ),
                          ),
                          subtitle: Padding(
                            padding: EdgeInsets.only(top: 4),
                            child: Row(
                              children: [
                                Icon(
                                  Icons.cake,
                                  size: 14,
                                  color: ThemeConstants.accentGrey,
                                ),
                                SizedBox(width: 4),
                                Text(
                                  '${coordinador['edad']} años',
                                  style: TextStyle(
                                    color: ThemeConstants.accentGrey,
                                    fontSize: 13,
                                  ),
                                ),
                              ],
                            ),
                          ),
                          trailing: Icon(
                            Icons.expand_more,
                            color: ThemeConstants.primaryTeal,
                          ),
                          children: [
                            Container(
                              decoration: BoxDecoration(
                                color: Colors.grey.shade50,
                                borderRadius: BorderRadius.only(
                                  bottomLeft: Radius.circular(20),
                                  bottomRight: Radius.circular(20),
                                ),
                              ),
                              padding: EdgeInsets.all(20),
                              child: Column(
                                crossAxisAlignment: CrossAxisAlignment.start,
                                children: [
                                  _buildInfoRow(Icons.phone, 'Teléfono',
                                      coordinador['telefono']),
                                  SizedBox(height: 12),
                                  _buildInfoRow(Icons.person, 'Usuario',
                                      coordinador['usuario']),
                                  SizedBox(height: 12),
                                  _buildInfoRow(Icons.lock, 'Contraseña',
                                      coordinador['contrasena']),
                                  SizedBox(height: 20),
                                  Divider(
                                      height: 1, color: Colors.grey.shade300),
                                  SizedBox(height: 16),
                                  // Botones de acción mejorados
                                  Wrap(
                                    spacing: 8,
                                    runSpacing: 8,
                                    alignment: WrapAlignment.center,
                                    children: [
                                      _buildActionButton(
                                        icon: Icons.edit,
                                        label: 'Editar',
                                        color: ThemeConstants.primaryTeal,
                                        onPressed: () => _editarCoordinador(
                                            context, coordinador),
                                      ),
                                      _buildActionButton(
                                        icon: Icons.group,
                                        label: 'Timoteos',
                                        color: ThemeConstants.secondaryOrange,
                                        onPressed: () => _verTimoteosAsignados(
                                            context, coordinador),
                                      ),
                                      _buildActionButton(
                                        icon: Icons.arrow_forward,
                                        label: 'Ver más',
                                        color: Colors.blue,
                                        onPressed: () {
                                          Navigator.push(
                                            context,
                                            MaterialPageRoute(
                                              builder: (context) =>
                                                  CoordinadorScreen(
                                                coordinadorId: coordinador.id,
                                                coordinadorNombre:
                                                    '${coordinador['nombre']} ${coordinador['apellido']}',
                                              ),
                                            ),
                                          );
                                        },
                                      ),
                                      _buildActionButton(
                                        icon: Icons.delete,
                                        label: 'Eliminar',
                                        color: Colors.red,
                                        onPressed: () => _eliminarCoordinador(
                                            context, coordinador),
                                      ),
                                    ],
                                  ),
                                ],
                              ),
                            ),
                          ],
                        ),
                      ),
                    );
                  },
                );
              },
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildInfoRow(IconData icon, String label, String value) {
    bool esContrasena = label.toLowerCase().contains('contraseña');

    return Container(
      margin: EdgeInsets.only(bottom: 8),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Icon(icon, size: 20, color: ThemeConstants.accentGrey),
          SizedBox(width: 8),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  label,
                  style: TextStyle(
                    color: ThemeConstants.accentGrey,
                    fontWeight: FontWeight.w500,
                    fontSize: 12,
                  ),
                ),
                Text(
                  esContrasena ? '••••••••' : value,
                  style: TextStyle(
                    color: Colors.black87,
                    fontWeight: FontWeight.w500,
                    fontSize: 14,
                  ),
                  overflow: TextOverflow.ellipsis,
                  maxLines: 2,
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildActionButton({
    required IconData icon,
    required String label,
    required Color color,
    required VoidCallback onPressed,
    EdgeInsets padding =
        const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
    double fontSize = 13,
    double iconSize = 18,
  }) {
    return Container(
      decoration: BoxDecoration(
        borderRadius: BorderRadius.circular(10),
        gradient: LinearGradient(
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
          colors: [
            color,
            color.withOpacity(0.8),
          ],
        ),
        boxShadow: [
          BoxShadow(
            color: color.withOpacity(0.25),
            blurRadius: 6,
            offset: Offset(0, 3),
          ),
        ],
      ),
      child: Material(
        color: Colors.transparent,
        child: InkWell(
          onTap: onPressed,
          borderRadius: BorderRadius.circular(10),
          child: Padding(
            padding: padding,
            child: Row(
              mainAxisSize: MainAxisSize.min,
              children: [
                Icon(
                  icon,
                  color: Colors.white,
                  size: iconSize,
                ),
                if (label.isNotEmpty) ...[
                  SizedBox(width: 6),
                  Text(
                    label,
                    style: TextStyle(
                      color: Colors.white,
                      fontSize: fontSize,
                      fontWeight: FontWeight.w600,
                    ),
                  ),
                ],
              ],
            ),
          ),
        ),
      ),
    );
  }
}

class TimoteosTab extends StatelessWidget {
  final String tribuId;

  const TimoteosTab({Key? key, required this.tribuId}) : super(key: key);

  Future<void> _createTimoteo(BuildContext context) async {
    final TextEditingController _nameController = TextEditingController();
    final TextEditingController _lastNameController = TextEditingController();
    final TextEditingController _userController = TextEditingController();
    final TextEditingController _passwordController = TextEditingController();
    bool _passwordVisible = false;

    await showDialog(
      context: context,
      barrierDismissible: false,
      builder: (context) => StatefulBuilder(
        builder: (context, setState) {
          final mediaQuery = MediaQuery.of(context);
          final screenWidth = mediaQuery.size.width;
          final screenHeight = mediaQuery.size.height;
          final isSmallScreen = screenWidth < 600;
          final isMediumScreen = screenWidth >= 600 && screenWidth < 900;

          final dialogWidth = isSmallScreen
              ? screenWidth * 0.95
              : (isMediumScreen ? 450.0 : 500.0);

          return Dialog(
            shape: RoundedRectangleBorder(
              borderRadius: BorderRadius.circular(isSmallScreen ? 18 : 20),
            ),
            insetPadding: EdgeInsets.symmetric(
              horizontal: isSmallScreen ? 8 : 16,
              vertical: isSmallScreen ? 16 : 24,
            ),
            child: Container(
              width: dialogWidth,
              constraints: BoxConstraints(
                maxHeight: screenHeight * 0.9,
                maxWidth: dialogWidth,
              ),
              decoration: BoxDecoration(
                color: Colors.white,
                borderRadius: BorderRadius.circular(isSmallScreen ? 18 : 20),
              ),
              child: Column(
                mainAxisSize: MainAxisSize.min,
                children: [
                  // Header
                  Container(
                    padding: EdgeInsets.all(isSmallScreen ? 16 : 20),
                    decoration: BoxDecoration(
                      color: ThemeConstants.secondaryOrange,
                      borderRadius: BorderRadius.only(
                        topLeft: Radius.circular(isSmallScreen ? 18 : 20),
                        topRight: Radius.circular(isSmallScreen ? 18 : 20),
                      ),
                    ),
                    child: Row(
                      children: [
                        Icon(Icons.person_add,
                            color: Colors.white, size: isSmallScreen ? 24 : 30),
                        SizedBox(width: isSmallScreen ? 8 : 10),
                        Expanded(
                          child: Text(
                            'Crear Timoteo',
                            style: TextStyle(
                              fontSize: isSmallScreen ? 18 : 24,
                              fontWeight: FontWeight.bold,
                              color: Colors.white,
                            ),
                          ),
                        ),
                        IconButton(
                          onPressed: () => Navigator.pop(context),
                          icon: Icon(Icons.close,
                              color: Colors.white,
                              size: isSmallScreen ? 20 : 24),
                        ),
                      ],
                    ),
                  ),

                  // Contenido con scroll
                  Flexible(
                    child: SingleChildScrollView(
                      padding: EdgeInsets.all(isSmallScreen ? 16 : 20),
                      physics: ClampingScrollPhysics(),
                      child: Column(
                        children: [
                          TextField(
                            controller: _nameController,
                            decoration: InputDecoration(
                              labelText: 'Nombre',
                              prefixIcon: Icon(Icons.person_outline),
                              border: OutlineInputBorder(
                                borderRadius: BorderRadius.circular(12),
                              ),
                            ),
                          ),
                          SizedBox(height: 16),
                          TextField(
                            controller: _lastNameController,
                            decoration: InputDecoration(
                              labelText: 'Apellido',
                              prefixIcon: Icon(Icons.family_restroom),
                              border: OutlineInputBorder(
                                borderRadius: BorderRadius.circular(12),
                              ),
                            ),
                          ),
                          SizedBox(height: 16),
                          TextField(
                            controller: _userController,
                            decoration: InputDecoration(
                              labelText: 'Usuario',
                              prefixIcon: Icon(Icons.account_circle),
                              border: OutlineInputBorder(
                                borderRadius: BorderRadius.circular(12),
                              ),
                            ),
                          ),
                          SizedBox(height: 16),
                          TextField(
                            controller: _passwordController,
                            obscureText: !_passwordVisible,
                            decoration: InputDecoration(
                              labelText: 'Contraseña',
                              prefixIcon: Icon(Icons.lock_outline),
                              suffixIcon: IconButton(
                                icon: Icon(_passwordVisible
                                    ? Icons.visibility_off
                                    : Icons.visibility),
                                onPressed: () => setState(
                                    () => _passwordVisible = !_passwordVisible),
                              ),
                              border: OutlineInputBorder(
                                borderRadius: BorderRadius.circular(12),
                              ),
                            ),
                          ),
                          SizedBox(height: 24),

                          // Botones
                          Row(
                            children: [
                              Expanded(
                                child: TextButton(
                                  onPressed: () => Navigator.pop(context),
                                  style: TextButton.styleFrom(
                                    padding: EdgeInsets.symmetric(vertical: 14),
                                  ),
                                  child: Text('Cancelar',
                                      style: TextStyle(fontSize: 16)),
                                ),
                              ),
                              SizedBox(width: 12),
                              Expanded(
                                flex: 2,
                                child: ElevatedButton.icon(
                                  icon: Icon(Icons.save, size: 20),
                                  label: Text('Guardar',
                                      style: TextStyle(fontSize: 16)),
                                  onPressed: () async {
                                    if (_nameController.text.isNotEmpty &&
                                        _lastNameController.text.isNotEmpty &&
                                        _userController.text.isNotEmpty &&
                                        _passwordController.text.isNotEmpty) {
                                      await FirebaseFirestore.instance
                                          .collection('timoteos')
                                          .add({
                                        'nombre': _nameController.text,
                                        'apellido': _lastNameController.text,
                                        'usuario': _userController.text,
                                        'contrasena': _passwordController.text,
                                        'tribuId': tribuId,
                                        'coordinadorId': null,
                                      });
                                      Navigator.pop(context);
                                      ScaffoldMessenger.of(context)
                                          .showSnackBar(
                                        SnackBar(
                                          content: Text(
                                              'Timoteo creado exitosamente'),
                                          backgroundColor: Colors.green,
                                        ),
                                      );
                                    } else {
                                      ScaffoldMessenger.of(context)
                                          .showSnackBar(
                                        SnackBar(
                                          content: Text(
                                              'Por favor completa todos los campos'),
                                          backgroundColor: Colors.red,
                                        ),
                                      );
                                    }
                                  },
                                  style: ElevatedButton.styleFrom(
                                    padding: EdgeInsets.symmetric(vertical: 14),
                                    backgroundColor:
                                        ThemeConstants.secondaryOrange,
                                  ),
                                ),
                              ),
                            ],
                          ),
                        ],
                      ),
                    ),
                  ),
                ],
              ),
            ),
          );
        },
      ),
    );
  }

  Future<void> _editarTimoteo(
      BuildContext context, DocumentSnapshot timoteo) async {
    final nombreController = TextEditingController(text: timoteo['nombre']);
    final apellidoController = TextEditingController(text: timoteo['apellido']);
    final usuarioController = TextEditingController(text: timoteo['usuario']);
    final contrasenaController =
        TextEditingController(text: timoteo['contrasena']);
    bool _isProcessing = false;
    bool _passwordVisible = false;

    await showDialog(
      context: context,
      barrierDismissible: false,
      builder: (context) => StatefulBuilder(
        builder: (context, setState) {
          final screenWidth = MediaQuery.of(context).size.width;
          final screenHeight = MediaQuery.of(context).size.height;
          final isSmallScreen = screenWidth < 600;
          final isMediumScreen = screenWidth >= 600 && screenWidth < 900;

          final dialogWidth = isSmallScreen
              ? screenWidth * 0.95
              : (isMediumScreen ? 500.0 : 550.0);

          return Dialog(
            shape: RoundedRectangleBorder(
              borderRadius: BorderRadius.circular(isSmallScreen ? 18 : 24),
            ),
            insetPadding: EdgeInsets.symmetric(
              horizontal: isSmallScreen ? 8 : 16,
              vertical: isSmallScreen ? 16 : 24,
            ),
            child: Container(
              width: dialogWidth,
              constraints: BoxConstraints(
                maxHeight: screenHeight * 0.9,
                maxWidth: dialogWidth,
              ),
              decoration: BoxDecoration(
                borderRadius: BorderRadius.circular(isSmallScreen ? 18 : 24),
                gradient: LinearGradient(
                  begin: Alignment.topLeft,
                  end: Alignment.bottomRight,
                  colors: [
                    Colors.white,
                    ThemeConstants.primaryTeal.withOpacity(0.02)
                  ],
                ),
              ),
              child: Column(
                mainAxisSize: MainAxisSize.min,
                children: [
                  // Header
                  Container(
                    padding: EdgeInsets.all(isSmallScreen ? 16 : 24),
                    decoration: BoxDecoration(
                      gradient: LinearGradient(
                        begin: Alignment.topLeft,
                        end: Alignment.bottomRight,
                        colors: [
                          ThemeConstants.primaryTeal,
                          ThemeConstants.primaryTeal.withOpacity(0.8)
                        ],
                      ),
                      borderRadius: BorderRadius.only(
                        topLeft: Radius.circular(isSmallScreen ? 18 : 24),
                        topRight: Radius.circular(isSmallScreen ? 18 : 24),
                      ),
                      boxShadow: [
                        BoxShadow(
                          color: ThemeConstants.primaryTeal.withOpacity(0.3),
                          blurRadius: 8,
                          offset: Offset(0, 4),
                        ),
                      ],
                    ),
                    child: Row(
                      children: [
                        Container(
                          padding: EdgeInsets.all(isSmallScreen ? 10 : 12),
                          decoration: BoxDecoration(
                            color: Colors.white.withOpacity(0.2),
                            borderRadius:
                                BorderRadius.circular(isSmallScreen ? 12 : 16),
                          ),
                          child: Icon(Icons.edit_note,
                              color: Colors.white,
                              size: isSmallScreen ? 24 : 28),
                        ),
                        SizedBox(width: isSmallScreen ? 12 : 16),
                        Expanded(
                          child: Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              Text(
                                'Editar Timoteo',
                                style: TextStyle(
                                  fontSize: isSmallScreen ? 18 : 22,
                                  fontWeight: FontWeight.bold,
                                  color: Colors.white,
                                ),
                              ),
                              if (!isSmallScreen)
                                Text(
                                  'Actualiza la información del timoteo',
                                  style: TextStyle(
                                      fontSize: 13,
                                      color: Colors.white.withOpacity(0.9)),
                                ),
                            ],
                          ),
                        ),
                        Material(
                          color: Colors.transparent,
                          child: InkWell(
                            onTap: _isProcessing
                                ? null
                                : () => Navigator.pop(context),
                            borderRadius: BorderRadius.circular(10),
                            child: Container(
                              padding: EdgeInsets.all(8),
                              decoration: BoxDecoration(
                                color: Colors.white.withOpacity(0.2),
                                borderRadius: BorderRadius.circular(10),
                              ),
                              child: Icon(Icons.close,
                                  color: Colors.white,
                                  size: isSmallScreen ? 20 : 22),
                            ),
                          ),
                        ),
                      ],
                    ),
                  ),

                  // Contenido con scroll
                  Flexible(
                    child: SingleChildScrollView(
                      padding: EdgeInsets.all(isSmallScreen ? 16 : 24),
                      physics: ClampingScrollPhysics(),
                      child: Column(
                        children: [
                          _buildResponsiveTextField(
                            controller: nombreController,
                            label: 'Nombre',
                            icon: Icons.person_outline,
                            hint: 'Ingresa el nombre',
                            isSmallScreen: isSmallScreen,
                          ),
                          SizedBox(height: isSmallScreen ? 12 : 16),
                          _buildResponsiveTextField(
                            controller: apellidoController,
                            label: 'Apellido',
                            icon: Icons.person,
                            hint: 'Ingresa el apellido',
                            isSmallScreen: isSmallScreen,
                          ),
                          SizedBox(height: isSmallScreen ? 12 : 16),
                          _buildResponsiveTextField(
                            controller: usuarioController,
                            label: 'Usuario',
                            icon: Icons.account_circle,
                            hint: 'Nombre de usuario',
                            isSmallScreen: isSmallScreen,
                          ),
                          SizedBox(height: isSmallScreen ? 12 : 16),
                          _buildResponsiveTextField(
                            controller: contrasenaController,
                            label: 'Contraseña',
                            icon: Icons.lock_outline,
                            isPassword: !_passwordVisible,
                            hint: 'Modifica la contraseña si lo deseas',
                            isSmallScreen: isSmallScreen,
                            suffixIcon: IconButton(
                              icon: Icon(
                                _passwordVisible
                                    ? Icons.visibility_off
                                    : Icons.visibility,
                                color: ThemeConstants.primaryTeal,
                                size: isSmallScreen ? 20 : 22,
                              ),
                              onPressed: () => setState(
                                  () => _passwordVisible = !_passwordVisible),
                            ),
                          ),
                          SizedBox(height: 24),

                          // Botones
                          if (isSmallScreen)
                            Column(
                              children: [
                                SizedBox(
                                  width: double.infinity,
                                  child: ElevatedButton(
                                    onPressed: _isProcessing
                                        ? null
                                        : () async {
                                            if (_isProcessing) return;
                                            setState(
                                                () => _isProcessing = true);

                                            try {
                                              final Map<String, dynamic>
                                                  datosActualizados = {
                                                'nombre': nombreController.text
                                                    .trim(),
                                                'apellido': apellidoController
                                                    .text
                                                    .trim(),
                                                'usuario': usuarioController
                                                    .text
                                                    .trim(),
                                                'contrasena':
                                                    contrasenaController.text
                                                        .trim(),
                                              };

                                              await FirebaseFirestore.instance
                                                  .collection('timoteos')
                                                  .doc(timoteo.id)
                                                  .update(datosActualizados);

                                              Navigator.pop(context);

                                              if (context.mounted) {
                                                ScaffoldMessenger.of(context)
                                                    .showSnackBar(
                                                  SnackBar(
                                                    content: Row(
                                                      children: [
                                                        Icon(Icons.check_circle,
                                                            color:
                                                                Colors.white),
                                                        SizedBox(width: 12),
                                                        Expanded(
                                                            child: Text(
                                                                'Timoteo actualizado exitosamente',
                                                                style: TextStyle(
                                                                    fontSize:
                                                                        14))),
                                                      ],
                                                    ),
                                                    backgroundColor:
                                                        Colors.green,
                                                    behavior: SnackBarBehavior
                                                        .floating,
                                                    shape:
                                                        RoundedRectangleBorder(
                                                            borderRadius:
                                                                BorderRadius
                                                                    .circular(
                                                                        10)),
                                                  ),
                                                );
                                              }
                                            } catch (e) {
                                              print(
                                                  'Error al actualizar timoteo: $e');
                                              if (context.mounted) {
                                                ScaffoldMessenger.of(context)
                                                    .showSnackBar(
                                                  SnackBar(
                                                      content: Text(
                                                          'Error al actualizar: $e'),
                                                      backgroundColor:
                                                          Colors.red),
                                                );
                                              }
                                            } finally {
                                              setState(
                                                  () => _isProcessing = false);
                                            }
                                          },
                                    style: ElevatedButton.styleFrom(
                                      backgroundColor:
                                          ThemeConstants.primaryTeal,
                                      padding:
                                          EdgeInsets.symmetric(vertical: 14),
                                      shape: RoundedRectangleBorder(
                                          borderRadius:
                                              BorderRadius.circular(12)),
                                      elevation: 2,
                                    ),
                                    child: _isProcessing
                                        ? SizedBox(
                                            height: 18,
                                            width: 18,
                                            child: CircularProgressIndicator(
                                              strokeWidth: 2,
                                              valueColor:
                                                  AlwaysStoppedAnimation<Color>(
                                                      Colors.white),
                                            ),
                                          )
                                        : Row(
                                            mainAxisAlignment:
                                                MainAxisAlignment.center,
                                            children: [
                                              Icon(Icons.save, size: 18),
                                              SizedBox(width: 8),
                                              Text('Guardar Cambios',
                                                  style: TextStyle(
                                                      fontSize: 15,
                                                      fontWeight:
                                                          FontWeight.w600)),
                                            ],
                                          ),
                                  ),
                                ),
                                SizedBox(height: 10),
                                SizedBox(
                                  width: double.infinity,
                                  child: OutlinedButton(
                                    onPressed: _isProcessing
                                        ? null
                                        : () => Navigator.pop(context),
                                    style: OutlinedButton.styleFrom(
                                      padding:
                                          EdgeInsets.symmetric(vertical: 14),
                                      side: BorderSide(
                                          color: ThemeConstants.accentGrey,
                                          width: 2),
                                      shape: RoundedRectangleBorder(
                                          borderRadius:
                                              BorderRadius.circular(12)),
                                    ),
                                    child: Text('Cancelar',
                                        style: TextStyle(
                                            fontSize: 15,
                                            fontWeight: FontWeight.w600,
                                            color: ThemeConstants.accentGrey)),
                                  ),
                                ),
                              ],
                            )
                          else
                            Row(
                              children: [
                                Expanded(
                                  child: OutlinedButton(
                                    onPressed: _isProcessing
                                        ? null
                                        : () => Navigator.pop(context),
                                    style: OutlinedButton.styleFrom(
                                      padding:
                                          EdgeInsets.symmetric(vertical: 16),
                                      side: BorderSide(
                                          color: ThemeConstants.accentGrey,
                                          width: 2),
                                      shape: RoundedRectangleBorder(
                                          borderRadius:
                                              BorderRadius.circular(12)),
                                    ),
                                    child: Text('Cancelar',
                                        style: TextStyle(
                                            fontSize: 16,
                                            fontWeight: FontWeight.w600,
                                            color: ThemeConstants.accentGrey)),
                                  ),
                                ),
                                SizedBox(width: 12),
                                Expanded(
                                  flex: 2,
                                  child: ElevatedButton(
                                    onPressed: _isProcessing
                                        ? null
                                        : () async {
                                            if (_isProcessing) return;
                                            setState(
                                                () => _isProcessing = true);

                                            try {
                                              final Map<String, dynamic>
                                                  datosActualizados = {
                                                'nombre': nombreController.text
                                                    .trim(),
                                                'apellido': apellidoController
                                                    .text
                                                    .trim(),
                                                'usuario': usuarioController
                                                    .text
                                                    .trim(),
                                                'contrasena':
                                                    contrasenaController.text
                                                        .trim(),
                                              };

                                              await FirebaseFirestore.instance
                                                  .collection('timoteos')
                                                  .doc(timoteo.id)
                                                  .update(datosActualizados);

                                              Navigator.pop(context);

                                              if (context.mounted) {
                                                ScaffoldMessenger.of(context)
                                                    .showSnackBar(
                                                  SnackBar(
                                                    content: Row(
                                                      children: [
                                                        Icon(Icons.check_circle,
                                                            color:
                                                                Colors.white),
                                                        SizedBox(width: 12),
                                                        Text(
                                                            'Timoteo actualizado exitosamente'),
                                                      ],
                                                    ),
                                                    backgroundColor:
                                                        Colors.green,
                                                    behavior: SnackBarBehavior
                                                        .floating,
                                                    shape:
                                                        RoundedRectangleBorder(
                                                            borderRadius:
                                                                BorderRadius
                                                                    .circular(
                                                                        10)),
                                                  ),
                                                );
                                              }
                                            } catch (e) {
                                              print(
                                                  'Error al actualizar timoteo: $e');
                                              if (context.mounted) {
                                                ScaffoldMessenger.of(context)
                                                    .showSnackBar(
                                                  SnackBar(
                                                      content: Text(
                                                          'Error al actualizar timoteo: $e'),
                                                      backgroundColor:
                                                          Colors.red),
                                                );
                                              }
                                            } finally {
                                              setState(
                                                  () => _isProcessing = false);
                                            }
                                          },
                                    style: ElevatedButton.styleFrom(
                                      backgroundColor:
                                          ThemeConstants.primaryTeal,
                                      padding:
                                          EdgeInsets.symmetric(vertical: 16),
                                      shape: RoundedRectangleBorder(
                                          borderRadius:
                                              BorderRadius.circular(12)),
                                      elevation: 2,
                                    ),
                                    child: _isProcessing
                                        ? SizedBox(
                                            height: 20,
                                            width: 20,
                                            child: CircularProgressIndicator(
                                              strokeWidth: 2,
                                              valueColor:
                                                  AlwaysStoppedAnimation<Color>(
                                                      Colors.white),
                                            ),
                                          )
                                        : Row(
                                            mainAxisAlignment:
                                                MainAxisAlignment.center,
                                            children: [
                                              Icon(Icons.save, size: 20),
                                              SizedBox(width: 8),
                                              Text('Guardar Cambios',
                                                  style: TextStyle(
                                                      fontSize: 16,
                                                      fontWeight:
                                                          FontWeight.w600)),
                                            ],
                                          ),
                                  ),
                                ),
                              ],
                            ),
                        ],
                      ),
                    ),
                  ),
                ],
              ),
            ),
          );
        },
      ),
    );
  }

  // Widget helper para campos de texto responsive
  Widget _buildResponsiveTextField({
    required TextEditingController controller,
    required String label,
    required IconData icon,
    bool isPassword = false,
    String? hint,
    Widget? suffixIcon,
    required bool isSmallScreen,
  }) {
    final iconSize = isSmallScreen ? 18.0 : 20.0;
    final fontSize = isSmallScreen ? 14.0 : 15.0;
    final labelSize = isSmallScreen ? 13.0 : 14.0;

    return Container(
      decoration: BoxDecoration(
        borderRadius: BorderRadius.circular(12),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.04),
            blurRadius: 8,
            offset: Offset(0, 2),
          ),
        ],
      ),
      child: TextField(
        controller: controller,
        obscureText: isPassword,
        style: TextStyle(
          fontSize: fontSize,
          color: Colors.grey.shade800,
          fontWeight: FontWeight.w500,
        ),
        decoration: InputDecoration(
          labelText: label,
          hintText: hint,
          hintStyle: TextStyle(
            color: Colors.grey.shade400,
            fontSize: labelSize,
          ),
          labelStyle: TextStyle(
            color: ThemeConstants.primaryTeal,
            fontWeight: FontWeight.w500,
            fontSize: labelSize,
          ),
          prefixIcon: Container(
            margin: EdgeInsets.all(isSmallScreen ? 10 : 12),
            padding: EdgeInsets.all(isSmallScreen ? 6 : 8),
            decoration: BoxDecoration(
              gradient: LinearGradient(
                begin: Alignment.topLeft,
                end: Alignment.bottomRight,
                colors: [
                  ThemeConstants.primaryTeal.withOpacity(0.1),
                  ThemeConstants.primaryTeal.withOpacity(0.05),
                ],
              ),
              borderRadius: BorderRadius.circular(10),
            ),
            child: Icon(
              icon,
              color: ThemeConstants.primaryTeal,
              size: iconSize,
            ),
          ),
          suffixIcon: suffixIcon,
          filled: true,
          fillColor: Colors.white,
          border: OutlineInputBorder(
            borderRadius: BorderRadius.circular(12),
            borderSide: BorderSide(
              color: Colors.grey.shade300,
              width: 1.5,
            ),
          ),
          enabledBorder: OutlineInputBorder(
            borderRadius: BorderRadius.circular(12),
            borderSide: BorderSide(
              color: Colors.grey.shade300,
              width: 1.5,
            ),
          ),
          focusedBorder: OutlineInputBorder(
            borderRadius: BorderRadius.circular(12),
            borderSide: BorderSide(
              color: ThemeConstants.primaryTeal,
              width: 2,
            ),
          ),
          errorBorder: OutlineInputBorder(
            borderRadius: BorderRadius.circular(12),
            borderSide: BorderSide(
              color: Colors.red.shade400,
              width: 2,
            ),
          ),
          focusedErrorBorder: OutlineInputBorder(
            borderRadius: BorderRadius.circular(12),
            borderSide: BorderSide(
              color: Colors.red.shade400,
              width: 2,
            ),
          ),
          contentPadding: EdgeInsets.symmetric(
            horizontal: isSmallScreen ? 12 : 16,
            vertical: isSmallScreen ? 14 : 16,
          ),
        ),
      ),
    );
  }

  Future<void> _eliminarTimoteo(
      BuildContext context, DocumentSnapshot timoteo) async {
    final _TribusScreenState? tribusState =
        context.findAncestorStateOfType<_TribusScreenState>();

    if (tribusState == null) return;

    final BuildContext safeContext = tribusState.context;

    final nombreCompleto = '${timoteo['nombre']} ${timoteo['apellido']}';

    await tribusState._confirmarEliminacionConContrasena(
      safeContext,
      tipoUsuario: 'Timoteo',
      nombreUsuario: nombreCompleto,
      onConfirmed: () async {
        showDialog(
          context: safeContext,
          barrierDismissible: false,
          builder: (context) => Center(
            child: Container(
              padding: EdgeInsets.all(24),
              decoration: BoxDecoration(
                color: Colors.white,
                borderRadius: BorderRadius.circular(16),
              ),
              child: Column(
                mainAxisSize: MainAxisSize.min,
                children: [
                  CircularProgressIndicator(color: Color(0xFF1B998B)),
                  SizedBox(height: 16),
                  Text(
                    'Eliminando timoteo.',
                    style: GoogleFonts.poppins(
                      fontSize: 14,
                      fontWeight: FontWeight.w500,
                    ),
                  ),
                ],
              ),
            ),
          ),
        );

        try {
          final batch = FirebaseFirestore.instance.batch();

          final registros = await FirebaseFirestore.instance
              .collection('registros')
              .where('timoteoAsignado', isEqualTo: timoteo.id)
              .get();

          for (var registro in registros.docs) {
            batch.update(registro.reference,
                {'timoteoAsignado': null, 'nombreTimoteo': null});
          }

          batch.delete(timoteo.reference);

          await batch.commit();

          if (tribusState.mounted &&
              Navigator.of(safeContext, rootNavigator: true).canPop()) {
            Navigator.of(safeContext, rootNavigator: true).pop();
          }

          if (tribusState.mounted) {
            ScaffoldMessenger.of(safeContext).showSnackBar(
              SnackBar(
                content: Row(
                  children: [
                    Icon(Icons.check_circle, color: Colors.white),
                    SizedBox(width: 12),
                    Expanded(
                      child: Text(
                        'Timoteo eliminado correctamente',
                        style: GoogleFonts.poppins(fontWeight: FontWeight.w500),
                      ),
                    ),
                  ],
                ),
                backgroundColor: Colors.green,
                behavior: SnackBarBehavior.floating,
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(12),
                ),
              ),
            );
          }
        } catch (e) {
          if (tribusState.mounted &&
              Navigator.of(safeContext, rootNavigator: true).canPop()) {
            Navigator.of(safeContext, rootNavigator: true).pop();
          }

          if (tribusState.mounted) {
            ScaffoldMessenger.of(safeContext).showSnackBar(
              SnackBar(
                content: Row(
                  children: [
                    Icon(Icons.error_outline, color: Colors.white),
                    SizedBox(width: 12),
                    Expanded(
                      child: Text(
                        'Error al eliminar el timoteo: $e',
                        style: GoogleFonts.poppins(fontWeight: FontWeight.w500),
                      ),
                    ),
                  ],
                ),
                backgroundColor: Colors.red,
                behavior: SnackBarBehavior.floating,
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(12),
                ),
              ),
            );
          }
        }
      },
    );
  }

  Future<void> _asignarACoordinador(
      BuildContext context, DocumentSnapshot timoteo) async {
    // Verificar si el timoteo ya está asignado
    final bool estaAsignado =
        timoteo.data().toString().contains('coordinadorId') &&
            timoteo.get('coordinadorId') != null;

    // Si está asignado, desasignar directamente
    if (estaAsignado) {
      await showDialog(
        context: context,
        builder: (context) {
          return AlertDialog(
            shape: RoundedRectangleBorder(
              borderRadius: BorderRadius.circular(16),
            ),
            title: Row(
              children: [
                Icon(
                  Icons.person_remove_rounded,
                  color: Colors.orange.shade700,
                  size: 28,
                ),
                SizedBox(width: 12),
                Expanded(
                  child: Text(
                    'Desasignar Coordinador',
                    style: GoogleFonts.poppins(
                      fontWeight: FontWeight.bold,
                      fontSize: 18,
                    ),
                  ),
                ),
              ],
            ),
            content: Text(
              '¿Estás seguro de que deseas desasignar a ${timoteo['nombre']} ${timoteo['apellido']} de su coordinador actual?',
              style: GoogleFonts.poppins(fontSize: 14),
            ),
            actions: [
              TextButton(
                onPressed: () => Navigator.pop(context),
                child: Text(
                  'Cancelar',
                  style: TextStyle(color: ThemeConstants.accentGrey),
                ),
              ),
              ElevatedButton(
                onPressed: () async {
                  try {
                    await FirebaseFirestore.instance
                        .collection('timoteos')
                        .doc(timoteo.id)
                        .update({
                      'coordinadorId': null,
                      'nombreCoordinador': null,
                    });

                    Navigator.pop(context);
                    ScaffoldMessenger.of(context).showSnackBar(
                      SnackBar(
                        content: Row(
                          children: [
                            Icon(Icons.check_circle, color: Colors.white),
                            SizedBox(width: 12),
                            Expanded(
                              child: Text('Timoteo desasignado exitosamente'),
                            ),
                          ],
                        ),
                        backgroundColor: Colors.green,
                        behavior: SnackBarBehavior.floating,
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(10),
                        ),
                      ),
                    );
                  } catch (e) {
                    Navigator.pop(context);
                    ScaffoldMessenger.of(context).showSnackBar(
                      SnackBar(
                        content: Text('Error al desasignar: $e'),
                        backgroundColor: Colors.red,
                      ),
                    );
                  }
                },
                style: ElevatedButton.styleFrom(
                  backgroundColor: Colors.orange.shade700,
                ),
                child: Text('Desasignar'),
              ),
            ],
          );
        },
      );
      return;
    }

    // Si NO está asignado, proceder con la asignación normal
    final coordinadoresSnapshot = await FirebaseFirestore.instance
        .collection('coordinadores')
        .where('tribuId', isEqualTo: tribuId)
        .get();

    if (coordinadoresSnapshot.docs.isEmpty) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('No hay coordinadores disponibles para asignar'),
          backgroundColor: Colors.orange,
        ),
      );
      return;
    }

    String? coordinadorSeleccionado;

    await showDialog(
      context: context,
      builder: (context) {
        return AlertDialog(
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(16),
          ),
          title: Row(
            children: [
              Icon(
                Icons.person_add_rounded,
                color: ThemeConstants.secondaryOrange,
                size: 28,
              ),
              SizedBox(width: 12),
              Expanded(
                child: Text(
                  'Asignar a Coordinador',
                  style: GoogleFonts.poppins(
                    fontWeight: FontWeight.bold,
                    fontSize: 18,
                  ),
                ),
              ),
            ],
          ),
          content: DropdownButtonFormField<String>(
            items: coordinadoresSnapshot.docs.map((coordinador) {
              return DropdownMenuItem(
                value: coordinador.id,
                child:
                    Text('${coordinador['nombre']} ${coordinador['apellido']}'),
              );
            }).toList(),
            onChanged: (value) {
              coordinadorSeleccionado = value;
            },
            decoration: InputDecoration(
              labelText: 'Selecciona un coordinador',
              border: OutlineInputBorder(
                borderRadius: BorderRadius.circular(12),
              ),
            ),
          ),
          actions: [
            TextButton(
              onPressed: () => Navigator.pop(context),
              child: Text(
                'Cancelar',
                style: TextStyle(color: ThemeConstants.accentGrey),
              ),
            ),
            ElevatedButton(
              onPressed: () async {
                if (coordinadorSeleccionado != null) {
                  try {
                    final coordinador = coordinadoresSnapshot.docs.firstWhere(
                      (doc) => doc.id == coordinadorSeleccionado,
                    );

                    await FirebaseFirestore.instance
                        .collection('timoteos')
                        .doc(timoteo.id)
                        .update({
                      'coordinadorId': coordinador.id,
                      'nombreCoordinador':
                          '${coordinador['nombre']} ${coordinador['apellido']}',
                    });

                    Navigator.pop(context);
                    ScaffoldMessenger.of(context).showSnackBar(
                      SnackBar(
                        content: Row(
                          children: [
                            Icon(Icons.check_circle, color: Colors.white),
                            SizedBox(width: 12),
                            Expanded(
                              child: Text(
                                  'Timoteo asignado exitosamente a ${coordinador['nombre']}'),
                            ),
                          ],
                        ),
                        backgroundColor: Colors.green,
                        behavior: SnackBarBehavior.floating,
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(10),
                        ),
                      ),
                    );
                  } catch (e) {
                    ScaffoldMessenger.of(context).showSnackBar(
                      SnackBar(
                        content: Text('Error al asignar el Timoteo: $e'),
                        backgroundColor: Colors.red,
                      ),
                    );
                  }
                }
              },
              style: ElevatedButton.styleFrom(
                backgroundColor: ThemeConstants.secondaryOrange,
              ),
              child: Text('Asignar'),
            ),
          ],
        );
      },
    );
  }

  @override
  Widget build(BuildContext context) {
    // 📱 Obtener dimensiones de pantalla para responsive
    final screenWidth = MediaQuery.of(context).size.width;
    final screenHeight = MediaQuery.of(context).size.height;
    final isSmallScreen = screenWidth < 600;
    final isMediumScreen = screenWidth >= 600 && screenWidth < 900;
    final isLargeScreen = screenWidth >= 900;

    // 🎨 Tamaños responsive mejorados
    final headerFontSize =
        isSmallScreen ? 13.0 : (isMediumScreen ? 15.0 : 16.0);
    final subtitleFontSize =
        isSmallScreen ? 10.5 : (isMediumScreen ? 11.5 : 12.0);
    final counterFontSize =
        isSmallScreen ? 11.0 : (isMediumScreen ? 13.0 : 14.0);
    final iconSize = isSmallScreen ? 20.0 : (isMediumScreen ? 24.0 : 26.0);
    final avatarSize = isSmallScreen ? 42.0 : (isMediumScreen ? 47.0 : 50.0);
    final cardTitleSize = isSmallScreen ? 13.0 : (isMediumScreen ? 15.0 : 16.0);
    final cardSubtitleSize =
        isSmallScreen ? 10.0 : (isMediumScreen ? 11.5 : 12.0);
    final buttonIconSize =
        isSmallScreen ? 18.0 : (isMediumScreen ? 22.0 : 24.0);
    final buttonLabelSize =
        isSmallScreen ? 9.5 : (isMediumScreen ? 10.5 : 11.0);
    final infoRowLabelSize =
        isSmallScreen ? 10.0 : (isMediumScreen ? 11.0 : 12.0);
    final infoRowValueSize =
        isSmallScreen ? 11.0 : (isMediumScreen ? 12.5 : 13.5);

    // 📐 Márgenes y paddings responsive
    final horizontalPadding =
        isSmallScreen ? 12.0 : (isMediumScreen ? 14.0 : 16.0);
    final verticalPadding =
        isSmallScreen ? 8.0 : (isMediumScreen ? 10.0 : 12.0);
    final headerPadding = isSmallScreen ? 12.0 : (isMediumScreen ? 16.0 : 18.0);

    // 🔧 Widget helper para info rows - RESPONSIVE
    Widget _buildInfoRow(IconData icon, String label, String value) {
      bool esContrasena = label.toLowerCase().contains('contraseña');

      return Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Icon(
            icon,
            size: isSmallScreen ? 16 : 18,
            color: ThemeConstants.primaryTeal.withOpacity(0.7),
          ),
          SizedBox(width: isSmallScreen ? 8 : 10),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  label,
                  style: GoogleFonts.poppins(
                    fontSize: infoRowLabelSize,
                    fontWeight: FontWeight.w600,
                    color: ThemeConstants.accentGrey.withOpacity(0.7),
                    letterSpacing: -0.2,
                  ),
                ),
                SizedBox(height: 2),
                Text(
                  esContrasena ? '••••••••' : value,
                  style: GoogleFonts.poppins(
                    fontSize: infoRowValueSize,
                    fontWeight: FontWeight.w600,
                    color: ThemeConstants.primaryTeal,
                    letterSpacing: -0.3,
                  ),
                  maxLines: 2,
                  overflow: TextOverflow.ellipsis,
                ),
              ],
            ),
          ),
        ],
      );
    }

    return Container(
      decoration: BoxDecoration(
        gradient: LinearGradient(
          begin: Alignment.topCenter,
          end: Alignment.bottomCenter,
          colors: [
            Colors.white,
            ThemeConstants.primaryTeal.withOpacity(0.03),
          ],
        ),
      ),
      child: Column(
        children: [
          // Botón de crear timoteo - Responsive
          Container(
            margin: EdgeInsets.symmetric(
              horizontal: horizontalPadding,
              vertical: verticalPadding,
            ),
            child: Container(
              decoration: BoxDecoration(
                borderRadius: BorderRadius.circular(12),
                gradient: LinearGradient(
                  begin: Alignment.topLeft,
                  end: Alignment.bottomRight,
                  colors: [
                    ThemeConstants.secondaryOrange,
                    ThemeConstants.secondaryOrange.withOpacity(0.85),
                  ],
                ),
                boxShadow: [
                  BoxShadow(
                    color: ThemeConstants.secondaryOrange.withOpacity(0.25),
                    blurRadius: 8,
                    offset: Offset(0, 4),
                  ),
                ],
              ),
              child: Material(
                color: Colors.transparent,
                child: InkWell(
                  onTap: () => _createTimoteo(context),
                  borderRadius: BorderRadius.circular(12),
                  child: Padding(
                    padding: EdgeInsets.symmetric(
                      vertical: isSmallScreen ? 10 : 12,
                      horizontal: horizontalPadding,
                    ),
                    child: Row(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        Container(
                          padding: EdgeInsets.all(isSmallScreen ? 5 : 6),
                          decoration: BoxDecoration(
                            color: Colors.white.withOpacity(0.2),
                            borderRadius: BorderRadius.circular(8),
                          ),
                          child: Icon(
                            Icons.person_add,
                            size: isSmallScreen ? 18 : 20,
                            color: Colors.white,
                          ),
                        ),
                        SizedBox(width: isSmallScreen ? 8 : 10),
                        Text(
                          'Crear Timoteo',
                          style: TextStyle(
                            fontSize: isSmallScreen ? 14 : 15,
                            fontWeight: FontWeight.bold,
                            color: Colors.white,
                            letterSpacing: 0.3,
                          ),
                        ),
                      ],
                    ),
                  ),
                ),
              ),
            ),
          ),
          Expanded(
            child: StreamBuilder<QuerySnapshot>(
              stream: FirebaseFirestore.instance
                  .collection('timoteos')
                  .where('tribuId', isEqualTo: tribuId)
                  .snapshots(),
              builder: (context, snapshot) {
                if (snapshot.connectionState == ConnectionState.waiting) {
                  return Center(
                    child: CircularProgressIndicator(
                      color: ThemeConstants.primaryTeal,
                    ),
                  );
                }

                if (!snapshot.hasData || snapshot.data!.docs.isEmpty) {
                  return Center(
                    child: Padding(
                      padding: EdgeInsets.all(horizontalPadding * 2),
                      child: Column(
                        mainAxisAlignment: MainAxisAlignment.center,
                        children: [
                          Icon(
                            Icons.people_outline,
                            size:
                                isSmallScreen ? 48 : (isMediumScreen ? 56 : 64),
                            color: ThemeConstants.accentGrey,
                          ),
                          SizedBox(height: 16),
                          Text(
                            'No hay Timoteos disponibles',
                            style: TextStyle(
                              fontSize: isSmallScreen ? 16 : 18,
                              color: ThemeConstants.accentGrey,
                              fontWeight: FontWeight.w500,
                            ),
                            textAlign: TextAlign.center,
                          ),
                        ],
                      ),
                    ),
                  );
                }

                final docs =
                    List<QueryDocumentSnapshot>.from(snapshot.data!.docs);

                // ✅ Agrupar: sin coordinador primero, luego asignados
                final List<QueryDocumentSnapshot> sinCoordinador = [];
                final List<QueryDocumentSnapshot> conCoordinador = [];

                // Función local para saber si está asignado
                bool _estaAsignado(QueryDocumentSnapshot t) {
                  try {
                    return t.data().toString().contains('coordinadorId') &&
                        t.get('coordinadorId') != null;
                  } catch (_) {
                    return false;
                  }
                }

                // Función local para ordenar por nombre + apellido
                String _nombreOrden(QueryDocumentSnapshot t) {
                  try {
                    final n = '${t.get('nombre')} ${t.get('apellido')}';
                    return n.trim().toLowerCase();
                  } catch (_) {
                    return '';
                  }
                }

                // ✨ BOTÓN DE ACCIÓN MEJORADO - RESPONSIVE
                Widget _buildActionButton({
                  required IconData icon,
                  required String label,
                  required Color color,
                  required VoidCallback onPressed,
                }) {
                  return InkWell(
                    onTap: onPressed,
                    borderRadius: BorderRadius.circular(10),
                    child: Padding(
                      padding: EdgeInsets.symmetric(
                        horizontal: isSmallScreen ? 6 : 12,
                        vertical: isSmallScreen ? 6 : 8,
                      ),
                      child: Column(
                        mainAxisSize: MainAxisSize.min,
                        children: [
                          Icon(icon, color: color, size: buttonIconSize),
                          SizedBox(height: isSmallScreen ? 2 : 4),
                          Text(
                            label,
                            style: GoogleFonts.poppins(
                              fontSize: buttonLabelSize,
                              fontWeight: FontWeight.w600,
                              color: color,
                              letterSpacing: -0.2,
                            ),
                            textAlign: TextAlign.center,
                            maxLines: 1,
                            overflow: TextOverflow.ellipsis,
                          ),
                        ],
                      ),
                    ),
                  );
                }

                // Particionar
                for (final t in docs) {
                  if (_estaAsignado(t)) {
                    conCoordinador.add(t);
                  } else {
                    sinCoordinador.add(t);
                  }
                }

                // Orden alfabético
                sinCoordinador
                    .sort((a, b) => _nombreOrden(a).compareTo(_nombreOrden(b)));
                conCoordinador
                    .sort((a, b) => _nombreOrden(a).compareTo(_nombreOrden(b)));

                // ✨ TARJETA DE TIMOTEO MEJORADA - RESPONSIVE
                Widget _buildTimoteoCard(QueryDocumentSnapshot timoteo) {
                  final bool estaAsignado = _estaAsignado(timoteo);

                  return Container(
                    margin: EdgeInsets.symmetric(
                      vertical: isSmallScreen ? 6 : 8,
                    ),
                    decoration: BoxDecoration(
                      borderRadius:
                          BorderRadius.circular(isSmallScreen ? 14 : 18),
                      boxShadow: [
                        BoxShadow(
                          color: estaAsignado
                              ? ThemeConstants.secondaryOrange.withOpacity(0.12)
                              : ThemeConstants.primaryTeal.withOpacity(0.1),
                          blurRadius: isSmallScreen ? 10 : 15,
                          offset: Offset(0, isSmallScreen ? 4 : 6),
                          spreadRadius: -3,
                        ),
                      ],
                    ),
                    child: ClipRRect(
                      borderRadius:
                          BorderRadius.circular(isSmallScreen ? 14 : 18),
                      child: Container(
                        decoration: BoxDecoration(
                          gradient: LinearGradient(
                            begin: Alignment.topLeft,
                            end: Alignment.bottomRight,
                            colors: estaAsignado
                                ? [
                                    Colors.white,
                                    ThemeConstants.secondaryOrange
                                        .withOpacity(0.02)
                                  ]
                                : [
                                    Colors.white,
                                    ThemeConstants.primaryTeal.withOpacity(0.02)
                                  ],
                          ),
                          border: Border.all(
                            color: estaAsignado
                                ? ThemeConstants.secondaryOrange
                                    .withOpacity(0.25)
                                : ThemeConstants.primaryTeal.withOpacity(0.2),
                            width: 1.5,
                          ),
                          borderRadius:
                              BorderRadius.circular(isSmallScreen ? 14 : 18),
                        ),
                        child: ExpansionTile(
                          tilePadding: EdgeInsets.symmetric(
                            horizontal: horizontalPadding,
                            vertical: isSmallScreen ? 2 : 4,
                          ),
                          childrenPadding: EdgeInsets.zero,
                          leading: Hero(
                            tag: 'avatar_${timoteo.id}',
                            child: Container(
                              width: avatarSize,
                              height: avatarSize,
                              decoration: BoxDecoration(
                                gradient: LinearGradient(
                                  begin: Alignment.topLeft,
                                  end: Alignment.bottomRight,
                                  colors: estaAsignado
                                      ? [
                                          ThemeConstants.secondaryOrange,
                                          ThemeConstants.secondaryOrange
                                              .withOpacity(0.7),
                                        ]
                                      : [
                                          ThemeConstants.primaryTeal,
                                          ThemeConstants.primaryTeal
                                              .withOpacity(0.7),
                                        ],
                                ),
                                shape: BoxShape.circle,
                                boxShadow: [
                                  BoxShadow(
                                    color: estaAsignado
                                        ? ThemeConstants.secondaryOrange
                                            .withOpacity(0.3)
                                        : ThemeConstants.primaryTeal
                                            .withOpacity(0.3),
                                    blurRadius: isSmallScreen ? 6 : 10,
                                    offset: Offset(0, isSmallScreen ? 2 : 4),
                                  ),
                                ],
                              ),
                              child: Center(
                                child: Text(
                                  '${timoteo['nombre'][0]}${timoteo['apellido'][0]}',
                                  style: GoogleFonts.poppins(
                                    color: Colors.white,
                                    fontWeight: FontWeight.w700,
                                    fontSize: isSmallScreen ? 14 : 18,
                                    letterSpacing: -0.5,
                                  ),
                                ),
                              ),
                            ),
                          ),
                          title: Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            mainAxisSize: MainAxisSize.min,
                            children: [
                              Row(
                                children: [
                                  Expanded(
                                    child: Text(
                                      '${timoteo['nombre']} ${timoteo['apellido']}',
                                      style: GoogleFonts.poppins(
                                        fontWeight: FontWeight.w700,
                                        color: estaAsignado
                                            ? ThemeConstants.secondaryOrange
                                            : ThemeConstants.primaryTeal,
                                        fontSize: cardTitleSize,
                                        letterSpacing: -0.3,
                                        height: 1.2,
                                      ),
                                      maxLines: 1,
                                      overflow: TextOverflow.ellipsis,
                                    ),
                                  ),
                                  if (estaAsignado) ...[
                                    SizedBox(width: isSmallScreen ? 6 : 8),
                                    Container(
                                      padding: EdgeInsets.symmetric(
                                        horizontal: isSmallScreen ? 6 : 8,
                                        vertical: isSmallScreen ? 4 : 5,
                                      ),
                                      decoration: BoxDecoration(
                                        gradient: LinearGradient(
                                          begin: Alignment.topCenter,
                                          end: Alignment.bottomCenter,
                                          colors: [
                                            ThemeConstants.secondaryOrange
                                                .withOpacity(0.15),
                                            ThemeConstants.secondaryOrange
                                                .withOpacity(0.08),
                                          ],
                                        ),
                                        borderRadius: BorderRadius.circular(10),
                                        border: Border.all(
                                          color: ThemeConstants.secondaryOrange
                                              .withOpacity(0.4),
                                          width: 1,
                                        ),
                                      ),
                                      child: Row(
                                        mainAxisSize: MainAxisSize.min,
                                        children: [
                                          Icon(
                                            Icons.check_circle_rounded,
                                            size: isSmallScreen ? 11 : 13,
                                            color:
                                                ThemeConstants.secondaryOrange,
                                          ),
                                          SizedBox(width: 3),
                                          Text(
                                            'Asignado',
                                            style: GoogleFonts.poppins(
                                              fontSize:
                                                  isSmallScreen ? 9 : 10.5,
                                              fontWeight: FontWeight.w700,
                                              color: ThemeConstants
                                                  .secondaryOrange,
                                              letterSpacing: -0.1,
                                            ),
                                          ),
                                        ],
                                      ),
                                    ),
                                  ],
                                ],
                              ),
                              if (estaAsignado) ...[
                                SizedBox(height: isSmallScreen ? 4 : 6),
                                Padding(
                                  padding: EdgeInsets.only(
                                      right: isSmallScreen ? 8 : 12),
                                  child: Row(
                                    children: [
                                      Icon(
                                        Icons.supervisor_account_rounded,
                                        size: isSmallScreen ? 11 : 14,
                                        color: ThemeConstants.accentGrey
                                            .withOpacity(0.7),
                                      ),
                                      SizedBox(width: 4),
                                      Expanded(
                                        child: Text(
                                          timoteo['nombreCoordinador'] ??
                                              'Sin nombre',
                                          style: GoogleFonts.poppins(
                                            fontSize: cardSubtitleSize,
                                            fontWeight: FontWeight.w500,
                                            color: ThemeConstants.accentGrey
                                                .withOpacity(0.8),
                                            fontStyle: FontStyle.italic,
                                            height: 1.3,
                                          ),
                                          maxLines: 2,
                                          overflow: TextOverflow.ellipsis,
                                        ),
                                      ),
                                    ],
                                  ),
                                ),
                              ],
                            ],
                          ),
                          children: [
                            Container(
                              margin: EdgeInsets.fromLTRB(
                                horizontalPadding,
                                verticalPadding,
                                horizontalPadding,
                                horizontalPadding,
                              ),
                              padding: EdgeInsets.all(horizontalPadding),
                              decoration: BoxDecoration(
                                color: Colors.grey.shade50,
                                borderRadius: BorderRadius.circular(12),
                                border: Border.all(
                                  color: Colors.grey.shade200,
                                  width: 1,
                                ),
                              ),
                              child: Column(
                                crossAxisAlignment: CrossAxisAlignment.start,
                                children: [
                                  _buildInfoRow(
                                    Icons.person_outline_rounded,
                                    'Usuario',
                                    timoteo['usuario'],
                                  ),
                                  SizedBox(height: isSmallScreen ? 10 : 12),
                                  _buildInfoRow(
                                    Icons.lock_outline_rounded,
                                    'Contraseña',
                                    timoteo['contrasena'],
                                  ),
                                  if (estaAsignado) ...[
                                    SizedBox(height: isSmallScreen ? 10 : 12),
                                    _buildInfoRow(
                                      Icons.supervisor_account_rounded,
                                      'Coordinador',
                                      timoteo['nombreCoordinador'] ??
                                          'Sin asignar',
                                    ),
                                  ],
                                  SizedBox(height: isSmallScreen ? 12 : 16),
                                  Container(
                                    padding:
                                        EdgeInsets.all(isSmallScreen ? 8 : 12),
                                    decoration: BoxDecoration(
                                      color: Colors.white,
                                      borderRadius: BorderRadius.circular(12),
                                      border: Border.all(
                                        color: Colors.grey.shade200,
                                        width: 1,
                                      ),
                                    ),
                                    child: Row(
                                      mainAxisAlignment:
                                          MainAxisAlignment.spaceEvenly,
                                      children: [
                                        _buildActionButton(
                                          icon: Icons.edit_rounded,
                                          label: 'Editar',
                                          color: ThemeConstants.primaryTeal,
                                          onPressed: () =>
                                              _editarTimoteo(context, timoteo),
                                        ),
                                        Container(
                                          width: 1,
                                          height: isSmallScreen ? 24 : 30,
                                          color: Colors.grey.shade300,
                                        ),
                                        _buildActionButton(
                                          icon: Icons.delete_outline_rounded,
                                          label: 'Eliminar',
                                          color: Colors.red.shade600,
                                          onPressed: () => _eliminarTimoteo(
                                              context, timoteo),
                                        ),
                                        Container(
                                          width: 1,
                                          height: isSmallScreen ? 24 : 30,
                                          color: Colors.grey.shade300,
                                        ),
                                        _buildActionButton(
                                          icon: estaAsignado
                                              ? Icons.person_remove_rounded
                                              : Icons.person_add_rounded,
                                          label: estaAsignado
                                              ? 'Reasignar'
                                              : 'Asignar',
                                          color: ThemeConstants.secondaryOrange,
                                          onPressed: () => _asignarACoordinador(
                                              context, timoteo),
                                        ),
                                      ],
                                    ),
                                  ),
                                ],
                              ),
                            ),
                          ],
                        ),
                      ),
                    ),
                  );
                }

                // ✨ SECCIÓN CON HEADER INTEGRADO - RESPONSIVE MEJORADO
                Widget _buildSection({
                  required String title,
                  required String subtitle,
                  required IconData icon,
                  required int count,
                  required Color accent,
                  required List<QueryDocumentSnapshot> items,
                  required bool initiallyExpanded,
                }) {
                  return Container(
                    margin: EdgeInsets.fromLTRB(
                      horizontalPadding,
                      isSmallScreen ? 8 : 12,
                      horizontalPadding,
                      isSmallScreen ? 8 : 12,
                    ),
                    decoration: BoxDecoration(
                      color: Colors.white,
                      borderRadius:
                          BorderRadius.circular(isSmallScreen ? 14 : 16),
                      border: Border.all(
                        color: accent.withOpacity(0.15),
                        width: 1,
                      ),
                      boxShadow: [
                        BoxShadow(
                          color: accent.withOpacity(0.08),
                          blurRadius: isSmallScreen ? 12 : 16,
                          offset: Offset(0, isSmallScreen ? 4 : 6),
                          spreadRadius: -2,
                        ),
                      ],
                    ),
                    child: ClipRRect(
                      borderRadius:
                          BorderRadius.circular(isSmallScreen ? 14 : 16),
                      child: ExpansionTile(
                        initiallyExpanded: initiallyExpanded,
                        tilePadding: EdgeInsets.symmetric(
                          horizontal: headerPadding,
                          vertical: isSmallScreen ? 10 : 14,
                        ),
                        collapsedIconColor: accent,
                        iconColor: accent,
                        title: Row(
                          children: [
                            Container(
                              padding: EdgeInsets.all(isSmallScreen ? 8 : 12),
                              decoration: BoxDecoration(
                                gradient: LinearGradient(
                                  begin: Alignment.topLeft,
                                  end: Alignment.bottomRight,
                                  colors: [accent, accent.withOpacity(0.7)],
                                ),
                                borderRadius: BorderRadius.circular(12),
                                boxShadow: [
                                  BoxShadow(
                                    color: accent.withOpacity(0.25),
                                    blurRadius: 8,
                                    offset: Offset(0, 3),
                                  ),
                                ],
                              ),
                              child: Icon(
                                icon,
                                color: Colors.white,
                                size: isSmallScreen ? 18 : (iconSize * 0.85),
                              ),
                            ),
                            SizedBox(width: isSmallScreen ? 8 : 12),
                            Expanded(
                              child: Column(
                                crossAxisAlignment: CrossAxisAlignment.start,
                                children: [
                                  Text(
                                    title,
                                    style: GoogleFonts.poppins(
                                      fontSize: headerFontSize,
                                      fontWeight: FontWeight.w700,
                                      color: ThemeConstants.primaryTeal,
                                      letterSpacing: -0.3,
                                      height: 1.2,
                                    ),
                                    maxLines: 2,
                                    overflow: TextOverflow.ellipsis,
                                  ),
                                  if (!isSmallScreen) ...[
                                    SizedBox(height: 2),
                                    Text(
                                      subtitle,
                                      style: GoogleFonts.poppins(
                                        fontSize: subtitleFontSize,
                                        fontWeight: FontWeight.w500,
                                        color: ThemeConstants.accentGrey
                                            .withOpacity(0.8),
                                        height: 1.3,
                                      ),
                                      maxLines: 1,
                                      overflow: TextOverflow.ellipsis,
                                    ),
                                  ],
                                ],
                              ),
                            ),
                            SizedBox(width: isSmallScreen ? 6 : 10),
                            Container(
                              constraints: BoxConstraints(
                                minWidth: isSmallScreen ? 32 : 44,
                              ),
                              padding: EdgeInsets.symmetric(
                                horizontal: isSmallScreen ? 8 : 12,
                                vertical: isSmallScreen ? 5 : 8,
                              ),
                              decoration: BoxDecoration(
                                gradient: LinearGradient(
                                  begin: Alignment.topCenter,
                                  end: Alignment.bottomCenter,
                                  colors: [
                                    accent.withOpacity(0.18),
                                    accent.withOpacity(0.08),
                                  ],
                                ),
                                borderRadius: BorderRadius.circular(999),
                                border: Border.all(
                                  color: accent.withOpacity(0.35),
                                  width: 1.5,
                                ),
                              ),
                              child: Center(
                                child: Text(
                                  '$count',
                                  style: GoogleFonts.poppins(
                                    fontSize: counterFontSize,
                                    fontWeight: FontWeight.w800,
                                    color: accent,
                                    letterSpacing: -0.5,
                                  ),
                                ),
                              ),
                            ),
                          ],
                        ),
                        children: [
                          Padding(
                            padding: EdgeInsets.fromLTRB(
                              headerPadding,
                              0,
                              headerPadding,
                              headerPadding,
                            ),
                            child: items.isEmpty
                                ? Container(
                                    padding:
                                        EdgeInsets.all(isSmallScreen ? 14 : 20),
                                    decoration: BoxDecoration(
                                      color: count == 0 &&
                                              accent ==
                                                  ThemeConstants.primaryTeal
                                          ? Colors.green.shade50
                                          : Colors.grey.shade100,
                                      borderRadius: BorderRadius.circular(12),
                                      border: Border.all(
                                        color: count == 0 &&
                                                accent ==
                                                    ThemeConstants.primaryTeal
                                            ? Colors.green.shade200
                                            : Colors.grey.shade300,
                                        width: 1,
                                      ),
                                    ),
                                    child: Row(
                                      children: [
                                        Icon(
                                          count == 0 &&
                                                  accent ==
                                                      ThemeConstants.primaryTeal
                                              ? Icons
                                                  .check_circle_outline_rounded
                                              : Icons.info_outline_rounded,
                                          color: count == 0 &&
                                                  accent ==
                                                      ThemeConstants.primaryTeal
                                              ? Colors.green.shade700
                                              : ThemeConstants.accentGrey,
                                          size: isSmallScreen ? 18 : 24,
                                        ),
                                        SizedBox(width: isSmallScreen ? 8 : 12),
                                        Expanded(
                                          child: Text(
                                            count == 0 &&
                                                    accent ==
                                                        ThemeConstants
                                                            .primaryTeal
                                                ? 'No hay timoteos pendientes de asignación.'
                                                : 'Aún no hay timoteos asignados.',
                                            style: GoogleFonts.poppins(
                                              color: count == 0 &&
                                                      accent ==
                                                          ThemeConstants
                                                              .primaryTeal
                                                  ? Colors.green.shade800
                                                  : ThemeConstants.accentGrey,
                                              fontWeight: FontWeight.w600,
                                              fontSize: isSmallScreen ? 11 : 13,
                                            ),
                                            maxLines: 2,
                                            overflow: TextOverflow.ellipsis,
                                          ),
                                        ),
                                      ],
                                    ),
                                  )
                                : Column(
                                    children:
                                        items.map(_buildTimoteoCard).toList(),
                                  ),
                          ),
                        ],
                      ),
                    ),
                  );
                }

                // ✨ LISTA PRINCIPAL - RESPONSIVE Y MINIMALISTA
                return ListView(
                  padding: EdgeInsets.only(
                    bottom: isSmallScreen ? 16 : 24,
                    top: isSmallScreen ? 4 : 8,
                  ),
                  children: [
                    _buildSection(
                      title: 'Timoteos sin coordinador',
                      subtitle: 'Requieren asignación prioritaria',
                      icon: Icons.person_add_alt_1_rounded,
                      count: sinCoordinador.length,
                      accent: ThemeConstants.primaryTeal,
                      items: sinCoordinador,
                      initiallyExpanded: true,
                    ),
                    _buildSection(
                      title: 'Timoteos asignados',
                      subtitle: 'Con coordinador designado',
                      icon: Icons.verified_rounded,
                      count: conCoordinador.length,
                      accent: ThemeConstants.secondaryOrange,
                      items: conCoordinador,
                      initiallyExpanded: false,
                    ),
                  ],
                );
              },
            ),
          ),
        ],
      ),
    );
  }
}

Widget _buildInfoRow(IconData icon, String label, String value) {
  return Row(
    children: [
      Icon(icon, size: 20, color: ThemeConstants.accentGrey),
      SizedBox(width: 8),
      Text(
        '$label: ',
        style: TextStyle(
          color: ThemeConstants.accentGrey,
          fontWeight: FontWeight.w500,
        ),
      ),
      Text(
        value,
        style: TextStyle(
          color: Colors.black87,
          fontWeight: FontWeight.w500,
        ),
      ),
    ],
  );
}

//--Clase de la pestaña de Personas
class RegistrosAsignadosTab extends StatefulWidget {
  final String tribuId;
  final String tribuNombre;

  const RegistrosAsignadosTab({
    Key? key,
    required this.tribuId,
    required this.tribuNombre,
  }) : super(key: key);

  @override
  State<RegistrosAsignadosTab> createState() => _RegistrosAsignadosTabState();
}

class _RegistrosAsignadosTabState extends State<RegistrosAsignadosTab> {
  final TextEditingController _searchController = TextEditingController();

// ✅ NUEVO: Variable de estado para el término de búsqueda
  String _searchTerm = '';

// ✅ NUEVO: FocusNode para controlar el foco del campo de texto
  final FocusNode _searchFocusNode = FocusNode();

// ✅ NUEVO: Variables para filtros de fecha
  String? _anioSeleccionado;
  String? _mesSeleccionado;
  List<String> _aniosDisponibles = [];
  bool _cargandoAnios = false;

// ✅ AGREGADO: Variables para el nuevo filtro de Estado en la Iglesia
  String _tipoBusqueda = 'nombre'; // 'nombre' o 'estado'
  final TextEditingController _searchEstadoController = TextEditingController();
  String _searchEstadoTerm = '';
  final FocusNode _searchEstadoFocusNode = FocusNode();

// 🆕 NUEVA VARIABLE: Control de expansión del panel de filtros
  bool _filtrosExpandidos = false;

  @override
  void initState() {
    super.initState();
    // ✅ NUEVO: Listener para actualizar el término de búsqueda en tiempo real
    _searchController.addListener(() {
      setState(() {
        _searchTerm = _searchController.text.toLowerCase();
      });
    });

    // ✅ AGREGADO: Listener para búsqueda por estado
    _searchEstadoController.addListener(() {
      setState(() {
        _searchEstadoTerm = _searchEstadoController.text.toLowerCase();
      });
    });

    // ✅ NUEVO: Cargar años disponibles
    _cargarAniosDisponibles();
  }

  @override
  void dispose() {
    // ✅ NUEVO: Limpieza de recursos
    _searchController.dispose();
    _searchFocusNode.dispose();
    // ✅ AGREGADO: Limpieza de recursos del nuevo controlador
    _searchEstadoController.dispose();
    _searchEstadoFocusNode.dispose();
    super.dispose();
  }

// ✅ NUEVO: Método para cargar años disponibles
  Future<void> _cargarAniosDisponibles() async {
    setState(() {
      _cargandoAnios = true;
    });

    try {
      final registrosSnapshot = await FirebaseFirestore.instance
          .collection('registros')
          .where('tribuAsignada', isEqualTo: widget.tribuId)
          .get();

      Set<String> aniosSet = {};

      for (var doc in registrosSnapshot.docs) {
        final data = doc.data();

        // Buscar en múltiples campos de fecha
        final fechaTribu = data['fechaAsignacionTribu'] as Timestamp?;
        final fechaAsignacion = data['fechaAsignacion'] as Timestamp?;

        DateTime? fecha;
        if (fechaTribu != null) {
          fecha = fechaTribu.toDate();
        } else if (fechaAsignacion != null) {
          fecha = fechaAsignacion.toDate();
        }

        if (fecha != null) {
          aniosSet.add(fecha.year.toString());
        }
      }

      setState(() {
        _aniosDisponibles = aniosSet.toList()..sort((a, b) => b.compareTo(a));
        _cargandoAnios = false;
      });
    } catch (e) {
      print('Error al cargar años: $e');
      setState(() {
        _cargandoAnios = false;
      });
    }
  }

// ✅ NUEVO: Método para obtener el nombre del mes en español
  String _obtenerNombreMes(int mes) {
    const meses = [
      'Enero',
      'Febrero',
      'Marzo',
      'Abril',
      'Mayo',
      'Junio',
      'Julio',
      'Agosto',
      'Septiembre',
      'Octubre',
      'Noviembre',
      'Diciembre'
    ];
    return meses[mes - 1];
  }

// ✅ NUEVO: Método para filtrar registros por fecha
  bool _cumpleFiltroFecha(DocumentSnapshot doc) {
    // Si no hay filtros activos, mostrar todo
    if (_anioSeleccionado == null && _mesSeleccionado == null) {
      return true;
    }

    final data = doc.data() as Map<String, dynamic>;

    // Buscar fecha de asignación
    final fechaTribu = data['fechaAsignacionTribu'] as Timestamp?;
    final fechaAsignacion = data['fechaAsignacion'] as Timestamp?;

    DateTime? fecha;
    if (fechaTribu != null) {
      fecha = fechaTribu.toDate();
    } else if (fechaAsignacion != null) {
      fecha = fechaAsignacion.toDate();
    }

    // Si no tiene fecha, no pasa el filtro
    if (fecha == null) return false;

    // Verificar año
    if (_anioSeleccionado != null && _anioSeleccionado != 'Todos') {
      if (fecha.year.toString() != _anioSeleccionado) {
        return false;
      }
    }

    // Verificar mes
    if (_mesSeleccionado != null && _mesSeleccionado != 'Todos') {
      int mesNumero = int.parse(_mesSeleccionado!);
      if (fecha.month != mesNumero) {
        return false;
      }
    }

    return true;
  }

// ✅ NUEVO: Método para filtrar registros por estado en la iglesia
  bool _cumpleFiltroEstado(DocumentSnapshot doc) {
    // Si no hay término de búsqueda de estado, no filtrar
    if (_searchEstadoTerm.isEmpty) {
      return true;
    }

    final data = doc.data() as Map<String, dynamic>;
    final estadoProceso =
        (data['estadoProceso'] as String? ?? '').toLowerCase();

    // Búsqueda flexible: contiene el término
    return estadoProceso.contains(_searchEstadoTerm);
  }

  void _limpiarFiltros() {
    setState(() {
      _anioSeleccionado = null;
      _mesSeleccionado = null;
      _searchController.clear();
      _searchEstadoController.clear();
      _searchTerm = '';
      _searchEstadoTerm = '';
    });
  }

  // ✅ MANTENER: Funciones originales sin cambios
  Future<void> _asignarACoordinador(
      BuildContext context, DocumentSnapshot registro) async {
    final coordinadoresSnapshot = await FirebaseFirestore.instance
        .collection('coordinadores')
        .where('tribuId', isEqualTo: widget.tribuId)
        .get();

    if (coordinadoresSnapshot.docs.isEmpty) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Row(
            children: [
              Icon(Icons.warning_amber_rounded, color: Colors.white),
              SizedBox(width: 8),
              Text('No hay coordinadores disponibles'),
            ],
          ),
          backgroundColor: Colors.red.shade700,
          behavior: SnackBarBehavior.floating,
          shape:
              RoundedRectangleBorder(borderRadius: BorderRadius.circular(10)),
          margin: EdgeInsets.all(10),
        ),
      );
      return;
    }

    String? selectedCoordinador;

    await showDialog(
      context: context,
      builder: (context) => Dialog(
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
        child: Container(
          padding: EdgeInsets.all(24),
          decoration: BoxDecoration(
            color: Colors.white,
            borderRadius: BorderRadius.circular(20),
            boxShadow: [
              BoxShadow(
                color: ThemeConstants.primaryTeal.withOpacity(0.1),
                blurRadius: 10,
                spreadRadius: 5,
              ),
            ],
          ),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              Row(
                children: [
                  Icon(
                    Icons.people_alt_rounded,
                    color: ThemeConstants.secondaryOrange,
                    size: 30,
                  ),
                  SizedBox(width: 12),
                  Text(
                    'Asignar a Coordinador',
                    style: TextStyle(
                      fontSize: 20,
                      fontWeight: FontWeight.bold,
                      color: ThemeConstants.primaryTeal,
                    ),
                  ),
                ],
              ),
              SizedBox(height: 24),
              Container(
                decoration: BoxDecoration(
                  borderRadius: BorderRadius.circular(12),
                  border: Border.all(
                    color: ThemeConstants.primaryTeal.withOpacity(0.3),
                  ),
                ),
                child: DropdownButtonFormField<String>(
                  items: coordinadoresSnapshot.docs.map((coordinador) {
                    return DropdownMenuItem(
                      value: coordinador.id,
                      child: Text(
                        '${coordinador['nombre']} ${coordinador['apellido']}',
                        style: TextStyle(
                          color: ThemeConstants.primaryTeal,
                          fontWeight: FontWeight.w500,
                        ),
                      ),
                    );
                  }).toList(),
                  onChanged: (value) {
                    selectedCoordinador = value;
                  },
                  decoration: InputDecoration(
                    labelText: 'Seleccione un coordinador',
                    labelStyle: TextStyle(color: ThemeConstants.accentGrey),
                    border: InputBorder.none,
                    contentPadding:
                        EdgeInsets.symmetric(horizontal: 16, vertical: 8),
                  ),
                  icon: Icon(Icons.arrow_drop_down,
                      color: ThemeConstants.primaryTeal),
                ),
              ),
              SizedBox(height: 24),
              Row(
                mainAxisAlignment: MainAxisAlignment.end,
                children: [
                  TextButton(
                    onPressed: () => Navigator.pop(context),
                    child: Text(
                      'Cancelar',
                      style: TextStyle(
                        color: ThemeConstants.accentGrey,
                        fontWeight: FontWeight.w600,
                      ),
                    ),
                    style: TextButton.styleFrom(
                      padding:
                          EdgeInsets.symmetric(horizontal: 20, vertical: 12),
                    ),
                  ),
                  SizedBox(width: 12),
                  ElevatedButton.icon(
                    icon: Icon(Icons.check_circle_outline),
                    label: Text('Asignar'),
                    onPressed: () async {
                      if (selectedCoordinador != null) {
                        try {
                          await FirebaseFirestore.instance
                              .collection('registros')
                              .doc(registro.id)
                              .update({
                            'coordinadorAsignado': selectedCoordinador,
                            'fechaAsignacionCoordinador':
                                FieldValue.serverTimestamp(),
                          });
                          Navigator.pop(context);
                          ScaffoldMessenger.of(context).showSnackBar(
                            SnackBar(
                              content: Row(
                                children: [
                                  Icon(Icons.check_circle, color: Colors.white),
                                  SizedBox(width: 8),
                                  Text('¡Asignación exitosa!'),
                                ],
                              ),
                              backgroundColor: Colors.green,
                              behavior: SnackBarBehavior.floating,
                              shape: RoundedRectangleBorder(
                                borderRadius: BorderRadius.circular(10),
                              ),
                              margin: EdgeInsets.all(10),
                            ),
                          );
                        } catch (e) {
                          ScaffoldMessenger.of(context).showSnackBar(
                            SnackBar(
                              content: Text('Error al asignar el registro: $e'),
                              backgroundColor: Colors.red,
                            ),
                          );
                        }
                      }
                    },
                    style: ElevatedButton.styleFrom(
                      backgroundColor: ThemeConstants.secondaryOrange,
                      foregroundColor: Colors.white,
                      padding:
                          EdgeInsets.symmetric(horizontal: 20, vertical: 12),
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(12),
                      ),
                    ),
                  ),
                ],
              ),
            ],
          ),
        ),
      ),
    );
  }

//logica para editar los registro

  dynamic obtenerValorCampoEdicion(Map<String, dynamic> data, String campo) {
    // Si el campo existe directamente, lo devolvemos (con validación null)
    if (data.containsKey(campo) && data[campo] != null) {
      return data[campo];
    }

    // ✅ CORRECCIÓN CRÍTICA: Detección especial para descripcionOcupacion
    if (campo == 'descripcionOcupacion') {
      // Buscar primero 'descripcionOcupacion', luego 'descripcionOcupaciones'
      if (data.containsKey('descripcionOcupacion') &&
          data['descripcionOcupacion'] != null) {
        return data['descripcionOcupacion'];
      } else if (data.containsKey('descripcionOcupaciones') &&
          data['descripcionOcupaciones'] != null) {
        return data['descripcionOcupaciones'];
      }
    }

    // Si no se encuentra el campo o es null, devolver null
    return null;
  }

  void _editarRegistro(BuildContext context, DocumentSnapshot registro) {
    // Colores de la aplicación
    const Color primaryTeal = Color(0xFF1B998B);
    const Color secondaryOrange = Color(0xFFFF7E00);
    final Color lightTeal = primaryTeal.withOpacity(0.1);

    // Flag para rastrear si hay cambios sin guardar
    bool hayModificaciones = false;

    // ✅ NUEVO: FocusNodes para navegación entre campos
    final Map<String, FocusNode> focusNodes = {};

    // Función mejorada para obtener un valor seguro del documento
    T? getSafeValue<T>(String field) {
      try {
        final data = registro.data();
        if (data == null) return null;

        if (data is Map) {
          final value =
              obtenerValorCampoEdicion(data as Map<String, dynamic>, field);

          if (value is T) {
            return value;
          } else if (value != null) {
            if (T == String && value != null) {
              return value.toString() as T;
            } else if (T == int && value is num) {
              return value.toInt() as T;
            } else if (T == double && value is num) {
              return value.toDouble() as T;
            }
          }
        }
        return null;
      } catch (e) {
        print('Error getting field $field: $e');
        return null;
      }
    }

    // Función para calcular la edad
    int _calcularEdad(DateTime fechaNacimiento) {
      final hoy = DateTime.now();
      int edad = hoy.year - fechaNacimiento.year;
      if (hoy.month < fechaNacimiento.month ||
          (hoy.month == fechaNacimiento.month &&
              hoy.day < fechaNacimiento.day)) {
        edad--;
      }
      return edad;
    }

    // Función para calcular el próximo cumpleaños
    String _calcularProximoCumpleanos(DateTime fechaNacimiento) {
      final hoy = DateTime.now();
      DateTime proximoCumpleanos =
          DateTime(hoy.year, fechaNacimiento.month, fechaNacimiento.day);

      if (proximoCumpleanos.isBefore(hoy) ||
          proximoCumpleanos.isAtSameMomentAs(hoy)) {
        proximoCumpleanos =
            DateTime(hoy.year + 1, fechaNacimiento.month, fechaNacimiento.day);
      }

      final diferencia = proximoCumpleanos.difference(hoy).inDays;

      if (diferencia == 0) {
        return '¡Hoy es su cumpleaños! 🎉';
      } else if (diferencia == 1) {
        return 'Mañana (${diferencia} día)';
      } else if (diferencia <= 7) {
        return 'En ${diferencia} días';
      } else if (diferencia <= 30) {
        return 'En ${diferencia} días';
      } else {
        final meses = (diferencia / 30).floor();
        if (meses == 1) {
          return 'En aproximadamente 1 mes';
        } else {
          return 'En aproximadamente ${meses} meses';
        }
      }
    }

    // Controladores para los campos
    final Map<String, TextEditingController> controllers = {};

    // Estado para campos de selección
    String estadoCivilSeleccionado =
        getSafeValue<String>('estadoCivil') ?? 'Soltero(a)';
    String sexoSeleccionado = getSafeValue<String>('sexo') ?? 'Hombre';

    // Estado activo del registro
    bool estadoActivo = getSafeValue<bool>('activo') ?? true;
    bool estadoActivoAnterior = estadoActivo;

    // Fecha de nacimiento
    DateTime? fechaNacimiento;
    final fechaNacimientoValue = getSafeValue('fechaNacimiento');
    if (fechaNacimientoValue != null) {
      if (fechaNacimientoValue is Timestamp) {
        fechaNacimiento = fechaNacimientoValue.toDate();
      } else if (fechaNacimientoValue is String) {
        try {
          fechaNacimiento = DateTime.parse(fechaNacimientoValue);
        } catch (e) {
          print('Error parsing date string: $e');
          fechaNacimiento = null; // ✅ ASEGURAR que quede null en caso de error
        }
      }
    }

    // Opciones para los campos de selección
    final List<String> opcionesEstadoCivil = [
      'Casado(a)',
      'Soltero(a)',
      'Unión Libre',
      'Separado(a)',
      'Viudo(a)',
    ];

    final List<String> opcionesSexo = [
      'Hombre',
      'Mujer',
    ];

    // Definición de campos con sus iconos y tipos
    final Map<String, Map<String, dynamic>> camposDefinicion = {
      'nombre': {'icon': Icons.person, 'type': 'text'},
      'apellido': {'icon': Icons.person_outline, 'type': 'text'},
      'telefono': {'icon': Icons.phone, 'type': 'text'},
      'direccion': {'icon': Icons.location_on, 'type': 'text'},
      'barrio': {'icon': Icons.home, 'type': 'text'},
      'estadoCivil': {'icon': Icons.family_restroom, 'type': 'dropdown'},
      'nombrePareja': {'icon': Icons.favorite, 'type': 'text'},
      'ocupaciones': {'icon': Icons.work, 'type': 'list'},
      'descripcionOcupacion': {'icon': Icons.note, 'type': 'text'},
      'referenciaInvitacion': {'icon': Icons.link, 'type': 'text'},
      'observaciones': {'icon': Icons.comment, 'type': 'text'},
      'estadoFonovisita': {'icon': Icons.assignment, 'type': 'text'},
      'observaciones2': {'icon': Icons.notes, 'type': 'text'},
      'edad': {'icon': Icons.cake, 'type': 'int'},
      'peticiones': {'icon': Icons.volunteer_activism, 'type': 'text'},
      'sexo': {'icon': Icons.wc, 'type': 'dropdown'},
      'estadoProceso': {'icon': Icons.track_changes_outlined, 'type': 'text'},
      'fechaNacimiento': {'icon': Icons.calendar_today, 'type': 'date'},
    };

    // Inicializar controladores y FocusNodes
    camposDefinicion.forEach((key, value) {
      if (key != 'estadoCivil' && key != 'sexo' && key != 'fechaNacimiento') {
        var fieldValue = getSafeValue(key);

        if (value['type'] == 'list' && fieldValue is List) {
          controllers[key] = TextEditingController(text: fieldValue.join(', '));
        } else if (value['type'] == 'int' && fieldValue != null) {
          controllers[key] = TextEditingController(text: fieldValue.toString());
        } else if (fieldValue != null) {
          controllers[key] = TextEditingController(text: fieldValue.toString());
        } else {
          controllers[key] = TextEditingController();
        }

        // ✅ NUEVO: Crear FocusNode para cada campo
        focusNodes[key] = FocusNode();
      }
    });

    if (controllers['nombrePareja'] == null) {
      controllers['nombrePareja'] = TextEditingController();
      focusNodes['nombrePareja'] = FocusNode();
    }

    // ✅ NUEVO: Lista ordenada de campos para navegación
    final List<String> camposOrdenados = [
      'nombre',
      'apellido',
      'telefono',
      'direccion',
      'barrio',
      'nombrePareja',
      'ocupaciones',
      'descripcionOcupacion',
      'referenciaInvitacion',
      'observaciones',
      'estadoFonovisita',
      'observaciones2',
      'edad',
      'peticiones',
      'estadoProceso',
    ];

    // ✅ NUEVO: Función para ir al siguiente campo
    void _irAlSiguienteCampo(String campoActual) {
      final index = camposOrdenados.indexOf(campoActual);
      if (index != -1 && index < camposOrdenados.length - 1) {
        final siguienteCampo = camposOrdenados[index + 1];
        if (focusNodes.containsKey(siguienteCampo)) {
          focusNodes[siguienteCampo]?.requestFocus();
        }
      } else {
        FocusScope.of(context).unfocus();
      }
    }

    // Función para verificar si se debe mostrar el campo de nombre de pareja
    bool mostrarNombrePareja() {
      return estadoCivilSeleccionado == 'Casado(a)' ||
          estadoCivilSeleccionado == 'Unión Libre';
    }

    // Función para mostrar el selector de fecha
    Future<void> _seleccionarFecha(StateSetter setState) async {
      final DateTime? pickedDate = await showDatePicker(
        context: context,
        initialDate: fechaNacimiento ??
            DateTime.now().subtract(Duration(days: 365 * 25)),
        firstDate: DateTime(1900),
        lastDate: DateTime.now(),
        builder: (context, child) {
          return Theme(
            data: Theme.of(context).copyWith(
              colorScheme: ColorScheme.light(
                primary: primaryTeal,
                onPrimary: Colors.white,
                surface: Colors.white,
                onSurface: Colors.black,
              ),
            ),
            child: child ?? const SizedBox.shrink(),
          );
        },
      );

      if (pickedDate != null) {
        setState(() {
          fechaNacimiento = pickedDate;
          hayModificaciones = true;
        });
      }
    }

    // Función para mostrar diálogo de observaciones al desactivar
    Future<String?> _mostrarDialogoObservacionesDesactivacion() async {
      final TextEditingController observacionesController =
          TextEditingController();
      String? resultado;

      await showDialog(
        context: context,
        barrierDismissible: false,
        builder: (BuildContext dialogContext) {
          return AlertDialog(
            shape:
                RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
            title: Row(
              children: [
                Container(
                  padding: EdgeInsets.all(8),
                  decoration: BoxDecoration(
                    color: Colors.orange.withOpacity(0.1),
                    borderRadius: BorderRadius.circular(12),
                  ),
                  child: Icon(
                    Icons.warning_amber_rounded,
                    color: Colors.orange,
                    size: 24,
                  ),
                ),
                SizedBox(width: 12),
                Expanded(
                  child: Text(
                    'Observaciones Requeridas',
                    style: TextStyle(
                      fontSize: 18,
                      fontWeight: FontWeight.w600,
                      color: primaryTeal,
                    ),
                  ),
                ),
              ],
            ),
            content: SingleChildScrollView(
              child: Column(
                mainAxisSize: MainAxisSize.min,
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Container(
                    padding: EdgeInsets.all(12),
                    decoration: BoxDecoration(
                      color: Colors.orange.withOpacity(0.1),
                      borderRadius: BorderRadius.circular(8),
                      border: Border.all(
                        color: Colors.orange.withOpacity(0.3),
                        width: 1,
                      ),
                    ),
                    child: Row(
                      children: [
                        Icon(Icons.info_outline,
                            color: Colors.orange, size: 20),
                        SizedBox(width: 8),
                        Expanded(
                          child: Text(
                            'Por favor, explica la razón por la cual esta persona ya no forma parte de la iglesia.',
                            style: TextStyle(
                              fontSize: 13,
                              color: Colors.orange[800],
                            ),
                          ),
                        ),
                      ],
                    ),
                  ),
                  SizedBox(height: 16),
                  TextField(
                    controller: observacionesController,
                    maxLines: 5,
                    maxLength: 500,
                    decoration: InputDecoration(
                      labelText: 'Observaciones *',
                      labelStyle: TextStyle(
                        color: primaryTeal.withOpacity(0.8),
                        fontWeight: FontWeight.w500,
                      ),
                      hintText: 'Describe el motivo de la desactivación...',
                      hintStyle: TextStyle(
                        color: Colors.grey[400],
                        fontSize: 14,
                      ),
                      prefixIcon: Container(
                        margin: EdgeInsets.all(12),
                        padding: EdgeInsets.all(8),
                        decoration: BoxDecoration(
                          color: primaryTeal.withOpacity(0.1),
                          borderRadius: BorderRadius.circular(8),
                        ),
                        child:
                            Icon(Icons.edit_note, color: primaryTeal, size: 20),
                      ),
                      border: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(12),
                        borderSide:
                            BorderSide(color: primaryTeal.withOpacity(0.3)),
                      ),
                      enabledBorder: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(12),
                        borderSide:
                            BorderSide(color: primaryTeal.withOpacity(0.5)),
                      ),
                      focusedBorder: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(12),
                        borderSide: BorderSide(color: primaryTeal, width: 2),
                      ),
                      errorBorder: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(12),
                        borderSide:
                            BorderSide(color: Colors.red.shade400, width: 2),
                      ),
                      filled: true,
                      fillColor: Colors.white,
                      contentPadding:
                          EdgeInsets.symmetric(horizontal: 16, vertical: 16),
                      counterStyle:
                          TextStyle(color: Colors.grey[600], fontSize: 12),
                    ),
                    style: TextStyle(fontSize: 15),
                    textCapitalization: TextCapitalization.sentences,
                  ),
                ],
              ),
            ),
            actions: [
              TextButton(
                onPressed: () {
                  Navigator.of(dialogContext).pop();
                  resultado = null;
                },
                style: TextButton.styleFrom(
                  padding: EdgeInsets.symmetric(horizontal: 20, vertical: 12),
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(10),
                  ),
                ),
                child: Text(
                  'Cancelar',
                  style: TextStyle(
                    color: Colors.grey[600],
                    fontWeight: FontWeight.w500,
                  ),
                ),
              ),
              ElevatedButton(
                onPressed: () {
                  if (observacionesController.text.trim().isEmpty) {
                    ScaffoldMessenger.of(context).showSnackBar(
                      SnackBar(
                        content: Row(
                          children: [
                            Icon(Icons.error_outline, color: Colors.white),
                            SizedBox(width: 12),
                            Expanded(
                              child: Text(
                                'Las observaciones son obligatorias al desactivar un registro',
                                style: TextStyle(fontWeight: FontWeight.w500),
                              ),
                            ),
                          ],
                        ),
                        backgroundColor: Colors.red,
                        behavior: SnackBarBehavior.floating,
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(10),
                        ),
                        margin: EdgeInsets.all(16),
                      ),
                    );
                    return;
                  }

                  resultado = observacionesController.text.trim();
                  Navigator.of(dialogContext).pop();
                },
                style: ElevatedButton.styleFrom(
                  backgroundColor: secondaryOrange,
                  foregroundColor: Colors.white,
                  padding: EdgeInsets.symmetric(horizontal: 20, vertical: 12),
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(10),
                  ),
                  elevation: 2,
                ),
                child: Text(
                  'Guardar Observación',
                  style: TextStyle(fontWeight: FontWeight.w600),
                ),
              ),
            ],
          );
        },
      );

      observacionesController.dispose();
      return resultado;
    }

    // Función para mostrar el diálogo de confirmación
    Future<bool> confirmarSalida() async {
      if (!hayModificaciones) return true;

      if (!context.mounted) return false;

      bool confirmar = false;
      await showDialog(
        context: context,
        barrierDismissible: true,
        builder: (BuildContext dialogContext) => AlertDialog(
          title: Row(
            children: [
              Icon(Icons.warning, color: Colors.amber),
              SizedBox(width: 10),
              Text('Cambios sin guardar'),
            ],
          ),
          content: Text(
              '¿Estás seguro de que deseas salir sin guardar los cambios?'),
          actions: [
            TextButton(
              onPressed: () {
                Navigator.of(dialogContext).pop();
                confirmar = false;
              },
              child:
                  Text('Cancelar', style: TextStyle(color: Colors.grey[700])),
            ),
            ElevatedButton(
              style: ElevatedButton.styleFrom(
                backgroundColor: secondaryOrange,
              ),
              onPressed: () {
                Navigator.of(dialogContext).pop();
                confirmar = true;
              },
              child: Text('Salir sin guardar'),
            ),
          ],
          shape:
              RoundedRectangleBorder(borderRadius: BorderRadius.circular(15)),
        ),
      );

      return confirmar;
    }

    // Mostrar el nombre del registro
    String getNombreCompleto() {
      String nombre = getSafeValue<String>('nombre') ?? '';
      String apellido = getSafeValue<String>('apellido') ?? '';

      if (nombre.isNotEmpty || apellido.isNotEmpty) {
        return '$nombre $apellido'.trim();
      }

      return 'Registro ${registro.id}';
    }

    if (!context.mounted) return;

    showDialog(
      context: context,
      barrierDismissible: true,
      builder: (BuildContext dialogContext) {
        return MediaQuery.removeViewInsets(
          context: dialogContext,
          removeBottom: true,
          child: StatefulBuilder(
            builder: (stateContext, setState) {
              return WillPopScope(
                onWillPop: () async {
                  final bool confirmar = await confirmarSalida();
                  return confirmar;
                },
                child: Dialog(
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(20),
                  ),
                  child: LayoutBuilder(
                    builder: (context, constraints) {
                      // ✅ RESPONSIVE: Calcular tamaños dinámicos
                      final mediaQuery = MediaQuery.of(dialogContext);
                      final screenWidth = mediaQuery.size.width;
                      final screenHeight = mediaQuery.size.height;
                      final bottomInset = mediaQuery.viewInsets.bottom;

                      final isVerySmallScreen = screenWidth < 360;
                      final isSmallScreen = screenWidth < 600;
                      final isMediumScreen =
                          screenWidth >= 600 && screenWidth < 900;

                      // ✅ Tamaños adaptativos mejorados
                      final horizontalPadding = isVerySmallScreen
                          ? 12.0
                          : (isSmallScreen
                              ? 16.0
                              : (isMediumScreen ? 20.0 : 24.0));
                      final verticalPadding = isVerySmallScreen
                          ? 12.0
                          : (isSmallScreen
                              ? 16.0
                              : (isMediumScreen ? 20.0 : 24.0));
                      final headerPadding = isVerySmallScreen
                          ? 14.0
                          : (isSmallScreen
                              ? 16.0
                              : (isMediumScreen ? 20.0 : 24.0));
                      final titleFontSize = isVerySmallScreen
                          ? 18.0
                          : (isSmallScreen
                              ? 20.0
                              : (isMediumScreen ? 22.0 : 24.0));
                      final labelFontSize = isVerySmallScreen
                          ? 13.0
                          : (isSmallScreen
                              ? 14.0
                              : (isMediumScreen ? 15.0 : 16.0));
                      final contentFontSize = isVerySmallScreen
                          ? 14.0
                          : (isSmallScreen
                              ? 15.0
                              : (isMediumScreen ? 16.0 : 17.0));
                      final buttonFontSize = isVerySmallScreen
                          ? 13.0
                          : (isSmallScreen
                              ? 14.0
                              : (isMediumScreen ? 15.0 : 16.0));
                      final iconSize = isVerySmallScreen
                          ? 20.0
                          : (isSmallScreen
                              ? 22.0
                              : (isMediumScreen ? 24.0 : 26.0));
                      final borderRadius = isVerySmallScreen
                          ? 10.0
                          : (isSmallScreen
                              ? 12.0
                              : (isMediumScreen ? 14.0 : 16.0));

                      final maxWidth = isVerySmallScreen
                          ? screenWidth * 0.95
                          : (isSmallScreen
                              ? 600.0
                              : (isMediumScreen ? 650.0 : 700.0));

                      return Container(
                        constraints: BoxConstraints(
                          maxWidth: maxWidth,
                          maxHeight: screenHeight *
                              0.85, // ✅ maxHeight en lugar de height
                        ),
                        child: Column(
                          mainAxisSize: MainAxisSize.min,
                          children: [
                            // ✅ Encabezado RESPONSIVE
                            Container(
                              padding: EdgeInsets.all(headerPadding),
                              decoration: BoxDecoration(
                                gradient: LinearGradient(
                                  colors: [
                                    primaryTeal,
                                    primaryTeal.withOpacity(0.85)
                                  ],
                                  begin: Alignment.topLeft,
                                  end: Alignment.bottomRight,
                                ),
                                borderRadius: BorderRadius.only(
                                  topLeft: Radius.circular(20),
                                  topRight: Radius.circular(20),
                                ),
                                boxShadow: [
                                  BoxShadow(
                                    color: primaryTeal.withOpacity(0.3),
                                    blurRadius: 8,
                                    offset: Offset(0, 4),
                                  ),
                                ],
                              ),
                              child: Row(
                                children: [
                                  Container(
                                    padding: EdgeInsets.all(
                                        isVerySmallScreen ? 6 : 8),
                                    decoration: BoxDecoration(
                                      color: Colors.white.withOpacity(0.2),
                                      borderRadius: BorderRadius.circular(10),
                                    ),
                                    child: Icon(
                                      Icons.edit_rounded,
                                      color: Colors.white,
                                      size: iconSize,
                                    ),
                                  ),
                                  SizedBox(width: 12),
                                  Expanded(
                                    child: Column(
                                      crossAxisAlignment:
                                          CrossAxisAlignment.start,
                                      children: [
                                        FittedBox(
                                          fit: BoxFit.scaleDown,
                                          alignment: Alignment.centerLeft,
                                          child: Text(
                                            'Editar Registro',
                                            style: GoogleFonts.poppins(
                                              fontSize: titleFontSize,
                                              fontWeight: FontWeight.bold,
                                              color: Colors.white,
                                            ),
                                            maxLines: 1,
                                          ),
                                        ),
                                        if (!isVerySmallScreen)
                                          FittedBox(
                                            fit: BoxFit.scaleDown,
                                            alignment: Alignment.centerLeft,
                                            child: Text(
                                              'Modifica la información del miembro',
                                              style: GoogleFonts.poppins(
                                                fontSize: labelFontSize - 2,
                                                color: Colors.white
                                                    .withOpacity(0.9),
                                              ),
                                              maxLines: 1,
                                            ),
                                          ),
                                      ],
                                    ),
                                  ),
                                  IconButton(
                                    onPressed: () async {
                                      focusNodes.values
                                          .forEach((fn) => fn.dispose());
                                      bool confirmar = await confirmarSalida();
                                      if (confirmar && dialogContext.mounted) {
                                        Navigator.pop(dialogContext);
                                      }
                                    },
                                    icon: Icon(Icons.close_rounded,
                                        color: Colors.white, size: iconSize),
                                    style: IconButton.styleFrom(
                                      backgroundColor:
                                          Colors.white.withOpacity(0.2),
                                      shape: RoundedRectangleBorder(
                                          borderRadius:
                                              BorderRadius.circular(10)),
                                      padding: EdgeInsets.all(
                                          isVerySmallScreen ? 6 : 8),
                                    ),
                                  ),
                                ],
                              ),
                            ),

                            // ✅ CONTENIDO CON SCROLL + BOTONES AL FINAL
                            Expanded(
                              child: SingleChildScrollView(
                                keyboardDismissBehavior:
                                    ScrollViewKeyboardDismissBehavior.manual,
                                physics: ClampingScrollPhysics(),
                                padding: EdgeInsets.fromLTRB(
                                  horizontalPadding,
                                  horizontalPadding,
                                  horizontalPadding,
                                  horizontalPadding + bottomInset,
                                ),
                                child: Column(
                                  crossAxisAlignment: CrossAxisAlignment.start,
                                  children: [
                                    SizedBox(height: verticalPadding * 0.5),

                                    // Información del registro
                                    Row(
                                      children: [
                                        Expanded(
                                          child: Container(
                                            padding: EdgeInsets.all(12),
                                            decoration: BoxDecoration(
                                              color:
                                                  Colors.grey.withOpacity(0.1),
                                              borderRadius:
                                                  BorderRadius.circular(
                                                      borderRadius),
                                              border: Border.all(
                                                color: Colors.grey
                                                    .withOpacity(0.3),
                                              ),
                                            ),
                                            child: Row(
                                              children: [
                                                Icon(Icons.person,
                                                    color: Colors.grey[700],
                                                    size: iconSize * 0.8),
                                                SizedBox(width: 8),
                                                Expanded(
                                                  child: Text(
                                                    getNombreCompleto(),
                                                    style: GoogleFonts.poppins(
                                                      fontSize: labelFontSize,
                                                      color: Colors.grey[800],
                                                      fontWeight:
                                                          FontWeight.w600,
                                                    ),
                                                    maxLines: 2,
                                                    overflow:
                                                        TextOverflow.ellipsis,
                                                  ),
                                                ),
                                              ],
                                            ),
                                          ),
                                        ),
                                      ],
                                    ),
                                    SizedBox(height: verticalPadding),

                                    // Switch para estado activo/inactivo
                                    Container(
                                      padding:
                                          EdgeInsets.all(horizontalPadding),
                                      decoration: BoxDecoration(
                                        color: estadoActivo
                                            ? Colors.green.withOpacity(0.1)
                                            : Colors.red.withOpacity(0.1),
                                        borderRadius:
                                            BorderRadius.circular(borderRadius),
                                        border: Border.all(
                                          color: estadoActivo
                                              ? Colors.green.withOpacity(0.3)
                                              : Colors.red.withOpacity(0.3),
                                          width: 1,
                                        ),
                                      ),
                                      child: Row(
                                        mainAxisAlignment:
                                            MainAxisAlignment.spaceBetween,
                                        children: [
                                          Expanded(
                                            child: Row(
                                              children: [
                                                Icon(
                                                  estadoActivo
                                                      ? Icons.check_circle
                                                      : Icons.cancel,
                                                  color: estadoActivo
                                                      ? Colors.green
                                                      : Colors.red,
                                                  size: iconSize,
                                                ),
                                                SizedBox(width: 12),
                                                Expanded(
                                                  child: Column(
                                                    crossAxisAlignment:
                                                        CrossAxisAlignment
                                                            .start,
                                                    children: [
                                                      Text(
                                                        'Estado del Registro',
                                                        style:
                                                            GoogleFonts.poppins(
                                                          fontSize:
                                                              labelFontSize - 2,
                                                          color:
                                                              Colors.grey[600],
                                                          fontWeight:
                                                              FontWeight.w500,
                                                        ),
                                                        maxLines: 1,
                                                        overflow: TextOverflow
                                                            .ellipsis,
                                                      ),
                                                      Text(
                                                        estadoActivo
                                                            ? "Activo"
                                                            : "No Activo",
                                                        style:
                                                            GoogleFonts.poppins(
                                                          fontSize:
                                                              labelFontSize,
                                                          fontWeight:
                                                              FontWeight.w700,
                                                          color: estadoActivo
                                                              ? Colors
                                                                  .green[700]
                                                              : Colors.red[700],
                                                        ),
                                                        maxLines: 1,
                                                        overflow: TextOverflow
                                                            .ellipsis,
                                                      ),
                                                    ],
                                                  ),
                                                ),
                                              ],
                                            ),
                                          ),
                                          Switch(
                                            value: estadoActivo,
                                            activeColor: secondaryOrange,
                                            inactiveThumbColor:
                                                Colors.grey[400],
                                            inactiveTrackColor:
                                                Colors.grey[300],
                                            onChanged: (value) async {
                                              if (!value &&
                                                  estadoActivoAnterior) {
                                                final observacion =
                                                    await _mostrarDialogoObservacionesDesactivacion();

                                                if (observacion != null &&
                                                    observacion.isNotEmpty) {
                                                  if (controllers[
                                                          'observaciones'] !=
                                                      null) {
                                                    final observacionActual =
                                                        controllers[
                                                                'observaciones']!
                                                            .text;
                                                    final nuevaObservacion =
                                                        observacionActual
                                                                .isEmpty
                                                            ? 'MOTIVO DESACTIVACIÓN: $observacion'
                                                            : '$observacionActual\n\nMOTIVO DESACTIVACIÓN: $observacion';
                                                    controllers['observaciones']!
                                                            .text =
                                                        nuevaObservacion;
                                                  }

                                                  setState(() {
                                                    estadoActivo = value;
                                                    estadoActivoAnterior =
                                                        value;
                                                    hayModificaciones = true;
                                                  });
                                                }
                                              } else {
                                                setState(() {
                                                  estadoActivo = value;
                                                  estadoActivoAnterior = value;
                                                  hayModificaciones = true;
                                                });
                                              }
                                            },
                                          ),
                                        ],
                                      ),
                                    ),
                                    SizedBox(height: verticalPadding),

                                    if (!estadoActivo)
                                      Container(
                                        padding: EdgeInsets.all(12),
                                        margin: EdgeInsets.only(
                                            bottom: verticalPadding),
                                        decoration: BoxDecoration(
                                          color: Colors.orange.withOpacity(0.1),
                                          borderRadius: BorderRadius.circular(
                                              borderRadius),
                                          border: Border.all(
                                            color:
                                                Colors.orange.withOpacity(0.3),
                                            width: 1,
                                          ),
                                        ),
                                        child: Row(
                                          children: [
                                            Icon(Icons.info_outline,
                                                color: Colors.orange,
                                                size: iconSize * 0.8),
                                            SizedBox(width: 8),
                                            Expanded(
                                              child: Text(
                                                'Al desactivar este registro, se eliminarán automáticamente las asignaciones de coordinador y timoteo.',
                                                style: GoogleFonts.poppins(
                                                  fontSize: labelFontSize - 2,
                                                  color: Colors.orange[800],
                                                ),
                                              ),
                                            ),
                                          ],
                                        ),
                                      ),

                                    // ✅ CAMPOS DEL FORMULARIO CON NAVEGACIÓN
                                    ...camposDefinicion.entries.map((entry) {
                                      final fieldName = entry.key;
                                      final fieldData = entry.value;
                                      final controller = controllers[fieldName];
                                      final fieldIcon = fieldData['icon'] ??
                                          Icons.help_outline;
                                      final focusNode = focusNodes[fieldName];

                                      if (fieldName == 'estadoCivil') {
                                        return _buildDropdownFieldResponsive(
                                          label: 'Estado Civil',
                                          icon: fieldIcon,
                                          value: estadoCivilSeleccionado,
                                          items: opcionesEstadoCivil,
                                          primaryColor: primaryTeal,
                                          fontSize: contentFontSize,
                                          iconSize: iconSize,
                                          borderRadius: borderRadius,
                                          onChanged: (newValue) {
                                            if (newValue != null) {
                                              setState(() {
                                                estadoCivilSeleccionado =
                                                    newValue;
                                                hayModificaciones = true;
                                              });
                                            }
                                          },
                                        );
                                      } else if (fieldName == 'sexo') {
                                        return _buildDropdownFieldResponsive(
                                          label: 'Sexo',
                                          icon: fieldIcon,
                                          value: sexoSeleccionado,
                                          items: opcionesSexo,
                                          primaryColor: primaryTeal,
                                          fontSize: contentFontSize,
                                          iconSize: iconSize,
                                          borderRadius: borderRadius,
                                          onChanged: (newValue) {
                                            if (newValue != null) {
                                              setState(() {
                                                sexoSeleccionado = newValue;
                                                hayModificaciones = true;
                                              });
                                            }
                                          },
                                        );
                                      } else if (fieldName ==
                                          'fechaNacimiento') {
                                        return Column(
                                          children: [
                                            Container(
                                              margin: EdgeInsets.only(
                                                  bottom: verticalPadding),
                                              child: InkWell(
                                                onTap: () =>
                                                    _seleccionarFecha(setState),
                                                borderRadius:
                                                    BorderRadius.circular(
                                                        borderRadius),
                                                child: Container(
                                                  padding: EdgeInsets.all(
                                                      horizontalPadding),
                                                  decoration: BoxDecoration(
                                                    color: Colors.grey
                                                        .withOpacity(0.05),
                                                    borderRadius:
                                                        BorderRadius.circular(
                                                            borderRadius),
                                                    border: Border.all(
                                                      color: primaryTeal
                                                          .withOpacity(0.3),
                                                      width: 1,
                                                    ),
                                                  ),
                                                  child: Row(
                                                    children: [
                                                      Container(
                                                        padding:
                                                            EdgeInsets.all(8),
                                                        decoration:
                                                            BoxDecoration(
                                                          color: primaryTeal
                                                              .withOpacity(0.1),
                                                          borderRadius:
                                                              BorderRadius
                                                                  .circular(8),
                                                        ),
                                                        child: Icon(
                                                          fieldIcon,
                                                          color: primaryTeal,
                                                          size: iconSize * 0.8,
                                                        ),
                                                      ),
                                                      SizedBox(width: 12),
                                                      Expanded(
                                                        child: Column(
                                                          crossAxisAlignment:
                                                              CrossAxisAlignment
                                                                  .start,
                                                          children: [
                                                            Text(
                                                              'Fecha de Nacimiento',
                                                              style: GoogleFonts
                                                                  .poppins(
                                                                fontSize:
                                                                    labelFontSize -
                                                                        2,
                                                                color: Colors
                                                                    .grey[600],
                                                                fontWeight:
                                                                    FontWeight
                                                                        .w500,
                                                              ),
                                                              maxLines: 1,
                                                              overflow:
                                                                  TextOverflow
                                                                      .ellipsis,
                                                            ),
                                                            SizedBox(height: 4),
                                                            Text(
                                                              fechaNacimiento !=
                                                                      null
                                                                  ? '${fechaNacimiento!.day}/${fechaNacimiento!.month}/${fechaNacimiento!.year}'
                                                                  : 'Seleccionar fecha',
                                                              style: GoogleFonts
                                                                  .poppins(
                                                                fontSize:
                                                                    contentFontSize,
                                                                fontWeight:
                                                                    FontWeight
                                                                        .w500,
                                                                color: fechaNacimiento !=
                                                                        null
                                                                    ? Colors
                                                                        .black87
                                                                    : Colors.grey[
                                                                        500],
                                                              ),
                                                              maxLines: 1,
                                                              overflow:
                                                                  TextOverflow
                                                                      .ellipsis,
                                                            ),
                                                          ],
                                                        ),
                                                      ),
                                                      Icon(
                                                        Icons
                                                            .keyboard_arrow_down,
                                                        color: Colors.grey[600],
                                                        size: iconSize,
                                                      ),
                                                    ],
                                                  ),
                                                ),
                                              ),
                                            ),
                                            if (fechaNacimiento != null)
                                              Container(
                                                margin: EdgeInsets.only(
                                                    bottom: verticalPadding),
                                                padding: EdgeInsets.all(
                                                    horizontalPadding),
                                                decoration: BoxDecoration(
                                                  gradient: LinearGradient(
                                                    colors: [
                                                      Color(0xFF1B998B)
                                                          .withOpacity(0.1),
                                                      Color(0xFFFF7E00)
                                                          .withOpacity(0.1),
                                                    ],
                                                    begin: Alignment.topLeft,
                                                    end: Alignment.bottomRight,
                                                  ),
                                                  borderRadius:
                                                      BorderRadius.circular(
                                                          borderRadius),
                                                  border: Border.all(
                                                    color: Color(0xFF1B998B)
                                                        .withOpacity(0.3),
                                                    width: 1,
                                                  ),
                                                ),
                                                child: Column(
                                                  crossAxisAlignment:
                                                      CrossAxisAlignment.start,
                                                  children: [
                                                    Row(
                                                      children: [
                                                        Container(
                                                          padding:
                                                              EdgeInsets.all(8),
                                                          decoration:
                                                              BoxDecoration(
                                                            color: Color(
                                                                    0xFF1B998B)
                                                                .withOpacity(
                                                                    0.2),
                                                            borderRadius:
                                                                BorderRadius
                                                                    .circular(
                                                                        8),
                                                          ),
                                                          child: Icon(
                                                            Icons.celebration,
                                                            color: Color(
                                                                0xFF1B998B),
                                                            size:
                                                                iconSize * 0.8,
                                                          ),
                                                        ),
                                                        SizedBox(width: 12),
                                                        Expanded(
                                                          child: Text(
                                                            'Información de Cumpleaños',
                                                            style: GoogleFonts
                                                                .poppins(
                                                              fontSize:
                                                                  labelFontSize,
                                                              fontWeight:
                                                                  FontWeight
                                                                      .bold,
                                                              color: Color(
                                                                  0xFF1B998B),
                                                            ),
                                                            maxLines: 1,
                                                            overflow:
                                                                TextOverflow
                                                                    .ellipsis,
                                                          ),
                                                        ),
                                                      ],
                                                    ),
                                                    SizedBox(height: 12),
                                                    isSmallScreen
                                                        ? Column(
                                                            children: [
                                                              Container(
                                                                width: double
                                                                    .infinity,
                                                                padding:
                                                                    EdgeInsets
                                                                        .all(
                                                                            12),
                                                                decoration:
                                                                    BoxDecoration(
                                                                  color: Colors
                                                                      .white
                                                                      .withOpacity(
                                                                          0.7),
                                                                  borderRadius:
                                                                      BorderRadius
                                                                          .circular(
                                                                              8),
                                                                ),
                                                                child: Column(
                                                                  crossAxisAlignment:
                                                                      CrossAxisAlignment
                                                                          .start,
                                                                  children: [
                                                                    Text(
                                                                      'Edad Actual',
                                                                      style: GoogleFonts
                                                                          .poppins(
                                                                        fontSize:
                                                                            labelFontSize -
                                                                                2,
                                                                        color: Colors
                                                                            .grey[600],
                                                                        fontWeight:
                                                                            FontWeight.w500,
                                                                      ),
                                                                    ),
                                                                    Text(
                                                                      '${_calcularEdad(fechaNacimiento!)} años',
                                                                      style: GoogleFonts
                                                                          .poppins(
                                                                        fontSize:
                                                                            contentFontSize,
                                                                        fontWeight:
                                                                            FontWeight.bold,
                                                                        color: Color(
                                                                            0xFF1B998B),
                                                                      ),
                                                                    ),
                                                                  ],
                                                                ),
                                                              ),
                                                              SizedBox(
                                                                  height: 12),
                                                              Container(
                                                                width: double
                                                                    .infinity,
                                                                padding:
                                                                    EdgeInsets
                                                                        .all(
                                                                            12),
                                                                decoration:
                                                                    BoxDecoration(
                                                                  color: Colors
                                                                      .white
                                                                      .withOpacity(
                                                                          0.7),
                                                                  borderRadius:
                                                                      BorderRadius
                                                                          .circular(
                                                                              8),
                                                                ),
                                                                child: Column(
                                                                  crossAxisAlignment:
                                                                      CrossAxisAlignment
                                                                          .start,
                                                                  children: [
                                                                    Text(
                                                                      'Próximo Cumpleaños',
                                                                      style: GoogleFonts
                                                                          .poppins(
                                                                        fontSize:
                                                                            labelFontSize -
                                                                                2,
                                                                        color: Colors
                                                                            .grey[600],
                                                                        fontWeight:
                                                                            FontWeight.w500,
                                                                      ),
                                                                    ),
                                                                    Text(
                                                                      _calcularProximoCumpleanos(
                                                                          fechaNacimiento!),
                                                                      style: GoogleFonts
                                                                          .poppins(
                                                                        fontSize:
                                                                            labelFontSize,
                                                                        fontWeight:
                                                                            FontWeight.bold,
                                                                        color: Color(
                                                                            0xFFFF7E00),
                                                                      ),
                                                                    ),
                                                                  ],
                                                                ),
                                                              ),
                                                            ],
                                                          )
                                                        : Row(
                                                            children: [
                                                              Expanded(
                                                                child:
                                                                    Container(
                                                                  padding:
                                                                      EdgeInsets
                                                                          .all(
                                                                              12),
                                                                  decoration:
                                                                      BoxDecoration(
                                                                    color: Colors
                                                                        .white
                                                                        .withOpacity(
                                                                            0.7),
                                                                    borderRadius:
                                                                        BorderRadius
                                                                            .circular(8),
                                                                  ),
                                                                  child: Column(
                                                                    crossAxisAlignment:
                                                                        CrossAxisAlignment
                                                                            .start,
                                                                    children: [
                                                                      Text(
                                                                        'Edad Actual',
                                                                        style: GoogleFonts
                                                                            .poppins(
                                                                          fontSize:
                                                                              labelFontSize - 2,
                                                                          color:
                                                                              Colors.grey[600],
                                                                          fontWeight:
                                                                              FontWeight.w500,
                                                                        ),
                                                                      ),
                                                                      Text(
                                                                        '${_calcularEdad(fechaNacimiento!)} años',
                                                                        style: GoogleFonts
                                                                            .poppins(
                                                                          fontSize:
                                                                              contentFontSize,
                                                                          fontWeight:
                                                                              FontWeight.bold,
                                                                          color:
                                                                              Color(0xFF1B998B),
                                                                        ),
                                                                      ),
                                                                    ],
                                                                  ),
                                                                ),
                                                              ),
                                                              SizedBox(
                                                                  width: 12),
                                                              Expanded(
                                                                flex: 2,
                                                                child:
                                                                    Container(
                                                                  padding:
                                                                      EdgeInsets
                                                                          .all(
                                                                              12),
                                                                  decoration:
                                                                      BoxDecoration(
                                                                    color: Colors
                                                                        .white
                                                                        .withOpacity(
                                                                            0.7),
                                                                    borderRadius:
                                                                        BorderRadius
                                                                            .circular(8),
                                                                  ),
                                                                  child: Column(
                                                                    crossAxisAlignment:
                                                                        CrossAxisAlignment
                                                                            .start,
                                                                    children: [
                                                                      Text(
                                                                        'Próximo Cumpleaños',
                                                                        style: GoogleFonts
                                                                            .poppins(
                                                                          fontSize:
                                                                              labelFontSize - 2,
                                                                          color:
                                                                              Colors.grey[600],
                                                                          fontWeight:
                                                                              FontWeight.w500,
                                                                        ),
                                                                      ),
                                                                      Text(
                                                                        _calcularProximoCumpleanos(
                                                                            fechaNacimiento!),
                                                                        style: GoogleFonts
                                                                            .poppins(
                                                                          fontSize:
                                                                              labelFontSize,
                                                                          fontWeight:
                                                                              FontWeight.bold,
                                                                          color:
                                                                              Color(0xFFFF7E00),
                                                                        ),
                                                                      ),
                                                                    ],
                                                                  ),
                                                                ),
                                                              ),
                                                            ],
                                                          ),
                                                  ],
                                                ),
                                              ),
                                          ],
                                        );
                                      } else if (fieldName == 'nombrePareja') {
                                        if (mostrarNombrePareja() &&
                                            controller != null) {
                                          return _buildAnimatedTextFieldResponsive(
                                            label: 'Nombre de Pareja',
                                            icon: fieldIcon,
                                            controller: controller,
                                            focusNode: focusNode!,
                                            primaryColor: primaryTeal,
                                            fontSize: contentFontSize,
                                            iconSize: iconSize,
                                            borderRadius: borderRadius,
                                            onChanged: (value) {
                                              hayModificaciones = true;
                                            },
                                            onSubmitted: (value) {
                                              _irAlSiguienteCampo(fieldName);
                                            },
                                          );
                                        } else {
                                          return SizedBox.shrink();
                                        }
                                      } else if (fieldName == 'estadoProceso') {
                                        return _buildAnimatedTextFieldConOpcionesResponsive(
                                          label: 'Estado del Proceso',
                                          icon: fieldIcon,
                                          controller: controller!,
                                          focusNode: focusNode!,
                                          primaryColor: primaryTeal,
                                          fontSize: contentFontSize,
                                          iconSize: iconSize,
                                          borderRadius: borderRadius,
                                          opciones: [
                                            'Pendiente',
                                            'Discipulado 1',
                                            'Discipulado 2',
                                            'Discipulado 3',
                                            'Consolidación',
                                            'Estudio Bíblico',
                                            'Escuela de Líderes'
                                          ],
                                          onChanged: (value) {
                                            hayModificaciones = true;
                                          },
                                          onSubmitted: (value) {
                                            _irAlSiguienteCampo(fieldName);
                                          },
                                        );
                                      } else if (controller != null &&
                                          focusNode != null) {
                                        return _buildAnimatedTextFieldResponsive(
                                          label: _formatFieldName(fieldName),
                                          icon: fieldIcon,
                                          controller: controller,
                                          focusNode: focusNode,
                                          primaryColor: primaryTeal,
                                          fontSize: contentFontSize,
                                          iconSize: iconSize,
                                          borderRadius: borderRadius,
                                          onChanged: (value) {
                                            hayModificaciones = true;
                                          },
                                          onSubmitted: (value) {
                                            _irAlSiguienteCampo(fieldName);
                                          },
                                        );
                                      } else {
                                        return SizedBox.shrink();
                                      }
                                    }).toList(),

                                    SizedBox(height: verticalPadding),
                                    Divider(
                                        color: primaryTeal.withOpacity(0.2),
                                        thickness: 1),
                                    SizedBox(height: verticalPadding),

                                    // ✅ BOTONES AL FINAL DEL SCROLL (NO FIJOS)

                                    isSmallScreen
                                        ? Column(
                                            children: [
                                              SizedBox(
                                                width: double.infinity,
                                                child: ElevatedButton.icon(
                                                  style:
                                                      ElevatedButton.styleFrom(
                                                    backgroundColor:
                                                        secondaryOrange,
                                                    foregroundColor:
                                                        Colors.white,
                                                    padding:
                                                        EdgeInsets.symmetric(
                                                            vertical: 14),
                                                    shape: RoundedRectangleBorder(
                                                        borderRadius:
                                                            BorderRadius.circular(
                                                                borderRadius)),
                                                    elevation: 2,
                                                  ),
                                                  icon: Icon(Icons.save_rounded,
                                                      size: iconSize * 0.8),
                                                  label: Text('Guardar Cambios',
                                                      style: GoogleFonts.poppins(
                                                          fontSize:
                                                              buttonFontSize,
                                                          fontWeight:
                                                              FontWeight.bold)),
                                                  onPressed: () async {
                                                    try {
                                                      final Map<String, dynamic>
                                                          updateData = {};

                                                      // Recopilar datos de los campos
                                                      updateData[
                                                              'estadoCivil'] =
                                                          estadoCivilSeleccionado;
                                                      updateData['sexo'] =
                                                          sexoSeleccionado;

                                                      // ✅ CORRECCIÓN CRÍTICA: Manejo seguro de fecha de nacimiento
                                                      if (fechaNacimiento !=
                                                          null) {
                                                        updateData[
                                                                'fechaNacimiento'] =
                                                            Timestamp.fromDate(
                                                                fechaNacimiento!);
                                                      } else {
                                                        // ✅ Si no hay fecha, NO incluirla en la actualización
                                                        // Esto evita sobrescribir con null si ya existía una fecha
                                                        // updateData['fechaNacimiento'] = null; // ❌ NO hacer esto
                                                      }

                                                      updateData['activo'] =
                                                          estadoActivo;
                                                      if (!estadoActivo) {
                                                        updateData[
                                                                'coordinadorAsignado'] =
                                                            null;
                                                        updateData[
                                                                'coordinadorNombre'] =
                                                            null;
                                                        updateData[
                                                                'timoteoAsignado'] =
                                                            null;
                                                        updateData[
                                                                'nombreTimoteo'] =
                                                            null;
                                                      }

                                                      controllers.forEach(
                                                          (key, controller) {
                                                        if (controller !=
                                                            null) {
                                                          final fieldType =
                                                              camposDefinicion[
                                                                  key]?['type'];
                                                          if (fieldType ==
                                                              'list') {
                                                            updateData[
                                                                key] = controller
                                                                    .text
                                                                    .isEmpty
                                                                ? []
                                                                : controller
                                                                    .text
                                                                    .split(',')
                                                                    .map((e) =>
                                                                        e.trim())
                                                                    .toList();
                                                          } else if (fieldType ==
                                                              'int') {
                                                            int? parsedValue =
                                                                int.tryParse(
                                                                    controller
                                                                        .text);
                                                            updateData[key] =
                                                                parsedValue ??
                                                                    0;
                                                          } else {
                                                            updateData[key] =
                                                                controller.text;
                                                          }
                                                        }
                                                      });

                                                      // Manejar campo descripcionOcupacion vs descripcionOcupaciones
                                                      final data =
                                                          registro.data();
                                                      if (data != null &&
                                                          data is Map<String,
                                                              dynamic>) {
                                                        if (data.containsKey(
                                                                'descripcionOcupaciones') &&
                                                            !data.containsKey(
                                                                'descripcionOcupacion')) {
                                                          if (updateData
                                                              .containsKey(
                                                                  'descripcionOcupacion')) {
                                                            updateData[
                                                                    'descripcionOcupaciones'] =
                                                                updateData[
                                                                    'descripcionOcupacion'];
                                                            updateData.remove(
                                                                'descripcionOcupacion');
                                                          }
                                                        }
                                                      }

                                                      if (FirebaseFirestore
                                                              .instance !=
                                                          null) {
                                                        // ✅ 1. ACTUALIZAR REGISTRO
                                                        await FirebaseFirestore
                                                            .instance
                                                            .collection(
                                                                'registros')
                                                            .doc(registro.id)
                                                            .update(updateData);

                                                        print(
                                                            '✅ Registro actualizado');

                                                        // ✅ 2. VERIFICAR SI HAY PERFIL SOCIAL ASOCIADO Y SINCRONIZARLO
                                                        final registroActualizado =
                                                            await FirebaseFirestore
                                                                .instance
                                                                .collection(
                                                                    'registros')
                                                                .doc(
                                                                    registro.id)
                                                                .get();

                                                        if (registroActualizado
                                                            .exists) {
                                                          final registroData =
                                                              registroActualizado
                                                                      .data()
                                                                  as Map<String,
                                                                      dynamic>?;
                                                          final perfilSocialId =
                                                              registroData?[
                                                                  'perfilSocialId'];

                                                          if (perfilSocialId !=
                                                                  null &&
                                                              perfilSocialId
                                                                  .toString()
                                                                  .trim()
                                                                  .isNotEmpty) {
                                                            try {
                                                              final perfilDoc = await FirebaseFirestore
                                                                  .instance
                                                                  .collection(
                                                                      'social_profiles')
                                                                  .doc(perfilSocialId
                                                                      .toString())
                                                                  .get();

                                                              if (perfilDoc
                                                                  .exists) {
                                                                print(
                                                                    '📝 Sincronizando con perfil social: $perfilSocialId');

                                                                // ✅ MAPEO COMPLETO (registro → perfil)
                                                                Map<String,
                                                                        dynamic>
                                                                    updateDataPerfil =
                                                                    {
                                                                  'name': updateData[
                                                                      'nombre'],
                                                                  'lastName':
                                                                      updateData[
                                                                          'apellido'],
                                                                  'phone':
                                                                      updateData[
                                                                          'telefono'],
                                                                  'address':
                                                                      updateData[
                                                                          'direccion'],
                                                                  'city': updateData[
                                                                      'barrio'],
                                                                  'age':
                                                                      updateData[
                                                                          'edad'],
                                                                  'gender':
                                                                      updateData[
                                                                          'sexo'],
                                                                  'prayerRequest':
                                                                      updateData[
                                                                          'peticiones'],
                                                                  'estadoFonovisita':
                                                                      updateData[
                                                                          'estadoFonovisita'],
                                                                  'observaciones':
                                                                      updateData[
                                                                          'observaciones'],
                                                                  'estadoProceso':
                                                                      updateData[
                                                                          'estadoProceso'],
                                                                };

                                                                // Manejar descripcionOcupacion
                                                                if (updateData
                                                                    .containsKey(
                                                                        'descripcionOcupacion')) {
                                                                  updateDataPerfil[
                                                                          'descripcionOcupacion'] =
                                                                      updateData[
                                                                          'descripcionOcupacion'];
                                                                } else if (updateData
                                                                    .containsKey(
                                                                        'descripcionOcupaciones')) {
                                                                  updateDataPerfil[
                                                                          'descripcionOcupacion'] =
                                                                      updateData[
                                                                          'descripcionOcupaciones'];
                                                                }

                                                                // Remover valores null
                                                                updateDataPerfil
                                                                    .removeWhere((key,
                                                                            value) =>
                                                                        value ==
                                                                        null);

                                                                await FirebaseFirestore
                                                                    .instance
                                                                    .collection(
                                                                        'social_profiles')
                                                                    .doc(perfilSocialId
                                                                        .toString())
                                                                    .update(
                                                                        updateDataPerfil);

                                                                print(
                                                                    '✅ Perfil social sincronizado');
                                                              } else {
                                                                print(
                                                                    '⚠️ El perfil social no existe: $perfilSocialId');

                                                                // Limpiar referencia inválida
                                                                await FirebaseFirestore
                                                                    .instance
                                                                    .collection(
                                                                        'registros')
                                                                    .doc(
                                                                        registro
                                                                            .id)
                                                                    .update({
                                                                  'perfilSocialId':
                                                                      null
                                                                });
                                                              }
                                                            } catch (e) {
                                                              print(
                                                                  '⚠️ Error al sincronizar perfil social: $e');
                                                            }
                                                          } else {
                                                            print(
                                                                'ℹ️ No hay perfil social asociado para sincronizar');
                                                          }
                                                        }

                                                        // ✅ Limpiar recursos
                                                        focusNodes.values
                                                            .forEach((fn) =>
                                                                fn.dispose());

                                                        if (dialogContext
                                                            .mounted) {
                                                          Navigator.pop(
                                                              dialogContext);
                                                        }

                                                        if (context.mounted) {
                                                          ScaffoldMessenger.of(
                                                                  context)
                                                              .showSnackBar(
                                                            SnackBar(
                                                              content: Row(
                                                                children: const [
                                                                  Icon(
                                                                      Icons
                                                                          .check_circle,
                                                                      color: Colors
                                                                          .white),
                                                                  SizedBox(
                                                                      width:
                                                                          12),
                                                                  Text(
                                                                    'Registro actualizado correctamente',
                                                                    style: TextStyle(
                                                                        fontSize:
                                                                            16),
                                                                  ),
                                                                ],
                                                              ),
                                                              backgroundColor:
                                                                  Colors.green,
                                                              behavior:
                                                                  SnackBarBehavior
                                                                      .floating,
                                                              shape:
                                                                  RoundedRectangleBorder(
                                                                borderRadius:
                                                                    BorderRadius
                                                                        .circular(
                                                                            10),
                                                              ),
                                                              margin: EdgeInsets
                                                                  .all(12),
                                                              padding: EdgeInsets
                                                                  .symmetric(
                                                                      vertical:
                                                                          14,
                                                                      horizontal:
                                                                          20),
                                                              duration:
                                                                  Duration(
                                                                      seconds:
                                                                          3),
                                                            ),
                                                          );
                                                        }
                                                      } else {
                                                        throw Exception(
                                                            "No se pudo conectar con Firestore");
                                                      }
                                                    } catch (e) {
                                                      focusNodes.values.forEach(
                                                          (fn) => fn.dispose());

                                                      if (dialogContext
                                                          .mounted) {
                                                        Navigator.pop(
                                                            dialogContext);
                                                      }
                                                      if (context.mounted) {
                                                        ScaffoldMessenger.of(
                                                                context)
                                                            .showSnackBar(
                                                          SnackBar(
                                                            content: Row(
                                                              children: [
                                                                Icon(
                                                                    Icons.error,
                                                                    color: Colors
                                                                        .white),
                                                                SizedBox(
                                                                    width: 12),
                                                                Expanded(
                                                                  child: Text(
                                                                    'Error al actualizar: ${e.toString()}',
                                                                    style: TextStyle(
                                                                        fontSize:
                                                                            16),
                                                                  ),
                                                                ),
                                                              ],
                                                            ),
                                                            backgroundColor:
                                                                Colors.red,
                                                            behavior:
                                                                SnackBarBehavior
                                                                    .floating,
                                                            shape:
                                                                RoundedRectangleBorder(
                                                              borderRadius:
                                                                  BorderRadius
                                                                      .circular(
                                                                          10),
                                                            ),
                                                            margin:
                                                                EdgeInsets.all(
                                                                    12),
                                                            padding: EdgeInsets
                                                                .symmetric(
                                                                    vertical:
                                                                        14,
                                                                    horizontal:
                                                                        20),
                                                            duration: Duration(
                                                                seconds: 5),
                                                          ),
                                                        );
                                                      }
                                                    }
                                                  },
                                                ),
                                              ),
                                              SizedBox(height: 12),
                                              SizedBox(
                                                width: double.infinity,
                                                child: TextButton.icon(
                                                  onPressed: () async {
                                                    focusNodes.values.forEach(
                                                        (fn) => fn.dispose());

                                                    bool confirmar =
                                                        await confirmarSalida();
                                                    if (confirmar &&
                                                        dialogContext.mounted) {
                                                      Navigator.pop(
                                                          dialogContext);
                                                    }
                                                  },
                                                  icon: Icon(
                                                      Icons.cancel_rounded,
                                                      size: iconSize * 0.8),
                                                  label: Text('Cancelar',
                                                      style: GoogleFonts.poppins(
                                                          fontSize:
                                                              buttonFontSize,
                                                          fontWeight:
                                                              FontWeight.w600)),
                                                  style: TextButton.styleFrom(
                                                    foregroundColor:
                                                        Colors.grey[700],
                                                    padding:
                                                        EdgeInsets.symmetric(
                                                            vertical: 14),
                                                    shape:
                                                        RoundedRectangleBorder(
                                                      borderRadius:
                                                          BorderRadius.circular(
                                                              borderRadius),
                                                      side: BorderSide(
                                                          color: Colors
                                                              .grey.shade300,
                                                          width: 2),
                                                    ),
                                                  ),
                                                ),
                                              ),
                                            ],
                                          )
                                        : Row(
                                            children: [
                                              Expanded(
                                                child: TextButton.icon(
                                                  onPressed: () async {
                                                    focusNodes.values.forEach(
                                                        (fn) => fn.dispose());

                                                    bool confirmar =
                                                        await confirmarSalida();
                                                    if (confirmar &&
                                                        dialogContext.mounted) {
                                                      Navigator.pop(
                                                          dialogContext);
                                                    }
                                                  },
                                                  icon: Icon(
                                                      Icons.cancel_rounded,
                                                      size: iconSize * 0.8),
                                                  label: Text('Cancelar',
                                                      style: GoogleFonts.poppins(
                                                          fontSize:
                                                              buttonFontSize,
                                                          fontWeight:
                                                              FontWeight.w600)),
                                                  style: TextButton.styleFrom(
                                                    foregroundColor:
                                                        Colors.grey[700],
                                                    padding:
                                                        EdgeInsets.symmetric(
                                                            vertical: 16),
                                                    shape:
                                                        RoundedRectangleBorder(
                                                      borderRadius:
                                                          BorderRadius.circular(
                                                              borderRadius),
                                                      side: BorderSide(
                                                          color: Colors
                                                              .grey.shade300,
                                                          width: 2),
                                                    ),
                                                  ),
                                                ),
                                              ),
                                              SizedBox(width: 16),
                                              Expanded(
                                                flex: 2,
                                                child: ElevatedButton.icon(
                                                  style:
                                                      ElevatedButton.styleFrom(
                                                    backgroundColor:
                                                        secondaryOrange,
                                                    foregroundColor:
                                                        Colors.white,
                                                    padding:
                                                        EdgeInsets.symmetric(
                                                            vertical: 16),
                                                    shape: RoundedRectangleBorder(
                                                        borderRadius:
                                                            BorderRadius.circular(
                                                                borderRadius)),
                                                    elevation: 2,
                                                  ),
                                                  icon: Icon(Icons.save_rounded,
                                                      size: iconSize * 0.8),
                                                  label: Text('Guardar Cambios',
                                                      style: GoogleFonts.poppins(
                                                          fontSize:
                                                              buttonFontSize,
                                                          fontWeight:
                                                              FontWeight.bold)),
                                                  onPressed: () async {
                                                    try {
                                                      final Map<String, dynamic>
                                                          updateData = {};

                                                      updateData[
                                                              'estadoCivil'] =
                                                          estadoCivilSeleccionado;
                                                      updateData['sexo'] =
                                                          sexoSeleccionado;

                                                      if (fechaNacimiento !=
                                                          null) {
                                                        updateData[
                                                                'fechaNacimiento'] =
                                                            Timestamp.fromDate(
                                                                fechaNacimiento!);
                                                      }

                                                      updateData['activo'] =
                                                          estadoActivo;
                                                      if (!estadoActivo) {
                                                        updateData[
                                                                'coordinadorAsignado'] =
                                                            null;
                                                        updateData[
                                                                'coordinadorNombre'] =
                                                            null;
                                                        updateData[
                                                                'timoteoAsignado'] =
                                                            null;
                                                        updateData[
                                                                'nombreTimoteo'] =
                                                            null;
                                                      }

                                                      controllers.forEach(
                                                          (key, controller) {
                                                        if (controller !=
                                                            null) {
                                                          final fieldType =
                                                              camposDefinicion[
                                                                  key]?['type'];
                                                          if (fieldType ==
                                                              'list') {
                                                            updateData[
                                                                key] = controller
                                                                    .text
                                                                    .isEmpty
                                                                ? []
                                                                : controller
                                                                    .text
                                                                    .split(',')
                                                                    .map((e) =>
                                                                        e.trim())
                                                                    .toList();
                                                          } else if (fieldType ==
                                                              'int') {
                                                            int? parsedValue =
                                                                int.tryParse(
                                                                    controller
                                                                        .text);
                                                            updateData[key] =
                                                                parsedValue ??
                                                                    0;
                                                          } else {
                                                            updateData[key] =
                                                                controller.text;
                                                          }
                                                        }
                                                      });

                                                      final data =
                                                          registro.data();
                                                      if (data != null &&
                                                          data is Map<String,
                                                              dynamic>) {
                                                        if (data.containsKey(
                                                                'descripcionOcupaciones') &&
                                                            !data.containsKey(
                                                                'descripcionOcupacion')) {
                                                          if (updateData
                                                              .containsKey(
                                                                  'descripcionOcupacion')) {
                                                            updateData[
                                                                    'descripcionOcupaciones'] =
                                                                updateData[
                                                                    'descripcionOcupacion'];
                                                            updateData.remove(
                                                                'descripcionOcupacion');
                                                          }
                                                        }
                                                      }

                                                      if (FirebaseFirestore
                                                              .instance !=
                                                          null) {
                                                        await FirebaseFirestore
                                                            .instance
                                                            .collection(
                                                                'registros')
                                                            .doc(registro.id)
                                                            .update(updateData);

                                                        print(
                                                            '✅ Registro actualizado');

                                                        final registroActualizado =
                                                            await FirebaseFirestore
                                                                .instance
                                                                .collection(
                                                                    'registros')
                                                                .doc(
                                                                    registro.id)
                                                                .get();

                                                        if (registroActualizado
                                                            .exists) {
                                                          final registroData =
                                                              registroActualizado
                                                                      .data()
                                                                  as Map<String,
                                                                      dynamic>?;
                                                          final perfilSocialId =
                                                              registroData?[
                                                                  'perfilSocialId'];

                                                          if (perfilSocialId !=
                                                                  null &&
                                                              perfilSocialId
                                                                  .toString()
                                                                  .trim()
                                                                  .isNotEmpty) {
                                                            try {
                                                              final perfilDoc = await FirebaseFirestore
                                                                  .instance
                                                                  .collection(
                                                                      'social_profiles')
                                                                  .doc(perfilSocialId
                                                                      .toString())
                                                                  .get();

                                                              if (perfilDoc
                                                                  .exists) {
                                                                print(
                                                                    '📝 Sincronizando con perfil social: $perfilSocialId');

                                                                Map<String,
                                                                        dynamic>
                                                                    updateDataPerfil =
                                                                    {
                                                                  'name': updateData[
                                                                      'nombre'],
                                                                  'lastName':
                                                                      updateData[
                                                                          'apellido'],
                                                                  'phone':
                                                                      updateData[
                                                                          'telefono'],
                                                                  'address':
                                                                      updateData[
                                                                          'direccion'],
                                                                  'city': updateData[
                                                                      'barrio'],
                                                                  'age':
                                                                      updateData[
                                                                          'edad'],
                                                                  'gender':
                                                                      updateData[
                                                                          'sexo'],
                                                                  'prayerRequest':
                                                                      updateData[
                                                                          'peticiones'],
                                                                  'estadoFonovisita':
                                                                      updateData[
                                                                          'estadoFonovisita'],
                                                                  'observaciones':
                                                                      updateData[
                                                                          'observaciones'],
                                                                  'estadoProceso':
                                                                      updateData[
                                                                          'estadoProceso'],
                                                                };

                                                                if (updateData
                                                                    .containsKey(
                                                                        'descripcionOcupacion')) {
                                                                  updateDataPerfil[
                                                                          'descripcionOcupacion'] =
                                                                      updateData[
                                                                          'descripcionOcupacion'];
                                                                } else if (updateData
                                                                    .containsKey(
                                                                        'descripcionOcupaciones')) {
                                                                  updateDataPerfil[
                                                                          'descripcionOcupacion'] =
                                                                      updateData[
                                                                          'descripcionOcupaciones'];
                                                                }

                                                                updateDataPerfil
                                                                    .removeWhere((key,
                                                                            value) =>
                                                                        value ==
                                                                        null);

                                                                await FirebaseFirestore
                                                                    .instance
                                                                    .collection(
                                                                        'social_profiles')
                                                                    .doc(perfilSocialId
                                                                        .toString())
                                                                    .update(
                                                                        updateDataPerfil);

                                                                print(
                                                                    '✅ Perfil social sincronizado');
                                                              } else {
                                                                print(
                                                                    '⚠️ El perfil social no existe: $perfilSocialId');

                                                                await FirebaseFirestore
                                                                    .instance
                                                                    .collection(
                                                                        'registros')
                                                                    .doc(
                                                                        registro
                                                                            .id)
                                                                    .update({
                                                                  'perfilSocialId':
                                                                      null
                                                                });
                                                              }
                                                            } catch (e) {
                                                              print(
                                                                  '⚠️ Error al sincronizar perfil social: $e');
                                                            }
                                                          } else {
                                                            print(
                                                                'ℹ️ No hay perfil social asociado para sincronizar');
                                                          }
                                                        }

                                                        focusNodes.values
                                                            .forEach((fn) =>
                                                                fn.dispose());

                                                        if (dialogContext
                                                            .mounted) {
                                                          Navigator.pop(
                                                              dialogContext);
                                                        }

                                                        if (context.mounted) {
                                                          ScaffoldMessenger.of(
                                                                  context)
                                                              .showSnackBar(
                                                            SnackBar(
                                                              content: Row(
                                                                children: const [
                                                                  Icon(
                                                                      Icons
                                                                          .check_circle,
                                                                      color: Colors
                                                                          .white),
                                                                  SizedBox(
                                                                      width:
                                                                          12),
                                                                  Text(
                                                                    'Registro actualizado correctamente',
                                                                    style: TextStyle(
                                                                        fontSize:
                                                                            16),
                                                                  ),
                                                                ],
                                                              ),
                                                              backgroundColor:
                                                                  Colors.green,
                                                              behavior:
                                                                  SnackBarBehavior
                                                                      .floating,
                                                              shape:
                                                                  RoundedRectangleBorder(
                                                                borderRadius:
                                                                    BorderRadius
                                                                        .circular(
                                                                            10),
                                                              ),
                                                              margin: EdgeInsets
                                                                  .all(12),
                                                              padding: EdgeInsets
                                                                  .symmetric(
                                                                      vertical:
                                                                          14,
                                                                      horizontal:
                                                                          20),
                                                              duration:
                                                                  Duration(
                                                                      seconds:
                                                                          3),
                                                            ),
                                                          );
                                                        }
                                                      } else {
                                                        throw Exception(
                                                            "No se pudo conectar con Firestore");
                                                      }
                                                    } catch (e) {
                                                      focusNodes.values.forEach(
                                                          (fn) => fn.dispose());

                                                      if (dialogContext
                                                          .mounted) {
                                                        Navigator.pop(
                                                            dialogContext);
                                                      }
                                                      if (context.mounted) {
                                                        ScaffoldMessenger.of(
                                                                context)
                                                            .showSnackBar(
                                                          SnackBar(
                                                            content: Row(
                                                              children: [
                                                                Icon(
                                                                    Icons.error,
                                                                    color: Colors
                                                                        .white),
                                                                SizedBox(
                                                                    width: 12),
                                                                Expanded(
                                                                  child: Text(
                                                                    'Error al actualizar: ${e.toString()}',
                                                                    style: TextStyle(
                                                                        fontSize:
                                                                            16),
                                                                  ),
                                                                ),
                                                              ],
                                                            ),
                                                            backgroundColor:
                                                                Colors.red,
                                                            behavior:
                                                                SnackBarBehavior
                                                                    .floating,
                                                            shape:
                                                                RoundedRectangleBorder(
                                                              borderRadius:
                                                                  BorderRadius
                                                                      .circular(
                                                                          10),
                                                            ),
                                                            margin:
                                                                EdgeInsets.all(
                                                                    12),
                                                            padding: EdgeInsets
                                                                .symmetric(
                                                                    vertical:
                                                                        14,
                                                                    horizontal:
                                                                        20),
                                                            duration: Duration(
                                                                seconds: 5),
                                                          ),
                                                        );
                                                      }
                                                    }
                                                  },
                                                ),
                                              ),
                                            ],
                                          ),

                                    SizedBox(height: verticalPadding),
                                  ],
                                ),
                              ),
                            ),
                          ],
                        ),
                      );
                    },
                  ),
                ),
              );
            },
          ),
        );
      },
    );
  }

// ✅ MÉTODOS AUXILIARES RESPONSIVE ACTUALIZADOS
  Widget _buildAnimatedTextFieldResponsive({
    required String label,
    required IconData icon,
    required TextEditingController controller,
    required FocusNode focusNode,
    required Color primaryColor,
    required double fontSize,
    required double iconSize,
    required double borderRadius,
    required Function(String) onChanged,
    required Function(String) onSubmitted,
  }) {
    return Padding(
      padding: EdgeInsets.only(bottom: 16.0),
      child: AnimatedContainer(
        duration: Duration(milliseconds: 300),
        child: Builder(
          builder: (fieldContext) {
            return TextField(
              controller: controller,
              focusNode: focusNode,
              textInputAction: TextInputAction.next,
              onTap: () {
                WidgetsBinding.instance.addPostFrameCallback((_) {
                  Scrollable.ensureVisible(
                    fieldContext,
                    duration: const Duration(milliseconds: 250),
                    curve: Curves.easeInOut,
                    alignment: 0.2,
                  );
                });
              },
              onChanged: onChanged,
              onSubmitted: onSubmitted,
              style: GoogleFonts.poppins(fontSize: fontSize),
              decoration: InputDecoration(
                labelText: label,
                labelStyle: GoogleFonts.poppins(
                  color: primaryColor.withOpacity(0.8),
                  fontWeight: FontWeight.w500,
                  fontSize: fontSize - 2,
                ),
                prefixIcon: Container(
                  margin: EdgeInsets.all(10),
                  padding: EdgeInsets.all(6),
                  decoration: BoxDecoration(
                    color: primaryColor.withOpacity(0.1),
                    borderRadius: BorderRadius.circular(8),
                  ),
                  child: Icon(icon, color: primaryColor, size: iconSize * 0.8),
                ),
                border: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(borderRadius),
                  borderSide: BorderSide(color: primaryColor.withOpacity(0.3)),
                ),
                enabledBorder: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(borderRadius),
                  borderSide: BorderSide(color: primaryColor.withOpacity(0.5)),
                ),
                focusedBorder: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(borderRadius),
                  borderSide: BorderSide(color: primaryColor, width: 2),
                ),
                filled: true,
                fillColor: Colors.white,
                contentPadding:
                    EdgeInsets.symmetric(horizontal: 16, vertical: 16),
              ),
            );
          },
        ),
      ),
    );
  }

  Widget _buildAnimatedTextFieldConOpcionesResponsive({
    required String label,
    required IconData icon,
    required TextEditingController controller,
    required FocusNode focusNode,
    required Color primaryColor,
    required double fontSize,
    required double iconSize,
    required double borderRadius,
    required List<String> opciones,
    required Function(String) onChanged,
    required Function(String) onSubmitted,
  }) {
    return Padding(
      padding: EdgeInsets.only(bottom: 16.0),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          AnimatedContainer(
            duration: Duration(milliseconds: 300),
            child: Builder(
              builder: (fieldContext) {
                return TextField(
                  controller: controller,
                  focusNode: focusNode,
                  textInputAction: TextInputAction.next,
                  onTap: () {
                    WidgetsBinding.instance.addPostFrameCallback((_) {
                      Scrollable.ensureVisible(
                        fieldContext,
                        duration: const Duration(milliseconds: 250),
                        curve: Curves.easeInOut,
                        alignment: 0.2,
                      );
                    });
                  },
                  onChanged: onChanged,
                  onSubmitted: onSubmitted,
                  style: GoogleFonts.poppins(fontSize: fontSize),
                  decoration: InputDecoration(
                    labelText: label,
                    labelStyle: GoogleFonts.poppins(
                      color: primaryColor.withOpacity(0.8),
                      fontWeight: FontWeight.w500,
                      fontSize: fontSize - 2,
                    ),
                    prefixIcon: Container(
                      margin: EdgeInsets.all(10),
                      padding: EdgeInsets.all(6),
                      decoration: BoxDecoration(
                        color: primaryColor.withOpacity(0.1),
                        borderRadius: BorderRadius.circular(8),
                      ),
                      child:
                          Icon(icon, color: primaryColor, size: iconSize * 0.8),
                    ),
                    border: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(borderRadius),
                      borderSide:
                          BorderSide(color: primaryColor.withOpacity(0.3)),
                    ),
                    enabledBorder: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(borderRadius),
                      borderSide:
                          BorderSide(color: primaryColor.withOpacity(0.5)),
                    ),
                    focusedBorder: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(borderRadius),
                      borderSide: BorderSide(color: primaryColor, width: 2),
                    ),
                    filled: true,
                    fillColor: Colors.white,
                    contentPadding:
                        EdgeInsets.symmetric(horizontal: 16, vertical: 16),
                  ),
                );
              },
            ),
          ),
          SizedBox(height: 12),
          Container(
            padding: EdgeInsets.all(12),
            decoration: BoxDecoration(
              color: primaryColor.withOpacity(0.05),
              borderRadius: BorderRadius.circular(borderRadius),
              border: Border.all(
                color: primaryColor.withOpacity(0.2),
                width: 1,
              ),
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Row(
                  children: [
                    Icon(
                      Icons.touch_app_outlined,
                      size: iconSize * 0.6,
                      color: primaryColor,
                    ),
                    SizedBox(width: 6),
                    Text(
                      'Opciones rápidas:',
                      style: GoogleFonts.poppins(
                        fontWeight: FontWeight.w500,
                        color: primaryColor,
                        fontSize: fontSize - 3,
                      ),
                    ),
                  ],
                ),
                SizedBox(height: 8),
                Wrap(
                  spacing: 6,
                  runSpacing: 6,
                  children: opciones.map((opcion) {
                    return ActionChip(
                      label: Text(
                        opcion,
                        style: GoogleFonts.poppins(
                          color: primaryColor,
                          fontWeight: FontWeight.w500,
                          fontSize: fontSize - 4,
                        ),
                      ),
                      onPressed: () {
                        controller.text = opcion;
                        onChanged(opcion);
                      },
                      backgroundColor: Colors.white,
                      side: BorderSide(
                        color: primaryColor.withOpacity(0.3),
                        width: 1.5,
                      ),
                      padding: EdgeInsets.symmetric(
                        horizontal: 8,
                        vertical: 4,
                      ),
                      elevation: 0,
                      pressElevation: 2,
                      shadowColor: primaryColor.withOpacity(0.3),
                    );
                  }).toList(),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildDropdownFieldResponsive({
    required String label,
    required IconData icon,
    required String? value,
    required List<String> items,
    required Color primaryColor,
    required double fontSize,
    required double iconSize,
    required double borderRadius,
    required Function(String?) onChanged,
  }) {
    final String safeValue = value ?? (items.isNotEmpty ? items[0] : '');
    return Padding(
      padding: EdgeInsets.only(bottom: 16.0),
      child: Container(
        decoration: BoxDecoration(
          borderRadius: BorderRadius.circular(borderRadius),
          border: Border.all(color: primaryColor.withOpacity(0.5)),
        ),
        child: Padding(
          padding: EdgeInsets.symmetric(horizontal: 12.0, vertical: 4.0),
          child: Row(
            children: [
              Container(
                margin: EdgeInsets.only(right: 12),
                padding: EdgeInsets.all(6),
                decoration: BoxDecoration(
                  color: primaryColor.withOpacity(0.1),
                  borderRadius: BorderRadius.circular(8),
                ),
                child: Icon(icon, color: primaryColor, size: iconSize * 0.8),
              ),
              Expanded(
                child: DropdownButtonHideUnderline(
                  child: DropdownButton<String>(
                    value: items.contains(safeValue)
                        ? safeValue
                        : (items.isNotEmpty ? items[0] : null),
                    hint: Text(
                      'Seleccionar $label',
                      style: GoogleFonts.poppins(
                          color: Colors.grey, fontSize: fontSize),
                    ),
                    icon: Icon(Icons.arrow_drop_down,
                        color: primaryColor, size: iconSize),
                    isExpanded: true,
                    onChanged: onChanged,
                    style: GoogleFonts.poppins(
                      color: Colors.black87,
                      fontSize: fontSize,
                    ),
                    dropdownColor: Colors.white,
                    items: items.map<DropdownMenuItem<String>>((String value) {
                      return DropdownMenuItem<String>(
                        value: value,
                        child: Padding(
                          padding: EdgeInsets.symmetric(vertical: 8.0),
                          child: Text(value),
                        ),
                      );
                    }).toList(),
                  ),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    // Definimos colores según los proporcionados
    final primaryTeal = Color(0xFF038C7F);
    final secondaryOrange = Color(0xFFFF5722);
    final accentGrey = Color(0xFF78909C);
    final backgroundGrey = Color(0xFFF5F5F5);

    return GestureDetector(
      onTap: () {
        // Solo desfocus si no estamos scrolleando
        FocusScope.of(context).requestFocus(FocusNode());
      },
      behavior: HitTestBehavior.translucent,
      child: Scaffold(
        resizeToAvoidBottomInset: false,
        backgroundColor: Colors.transparent,
        body: Stack(
          children: [
            Container(
              decoration: BoxDecoration(
                gradient: LinearGradient(
                  begin: Alignment.topCenter,
                  end: Alignment.bottomCenter,
                  colors: [
                    primaryTeal.withOpacity(0.05),
                    backgroundGrey,
                  ],
                ),
              ),
              child: Column(
                children: [
                  // 🎯 SECCIÓN DE CONTROLES SUPERIORES
                  Container(
                    margin: EdgeInsets.all(12),
                    decoration: BoxDecoration(
                      color: Colors.white,
                      borderRadius: BorderRadius.circular(16),
                      boxShadow: [
                        BoxShadow(
                          color: primaryTeal.withOpacity(0.15),
                          blurRadius: 12,
                          offset: Offset(0, 4),
                        ),
                      ],
                    ),
                    child: Column(
                      children: [
                        // 🆕 ENCABEZADO CON BOTÓN DE COLAPSAR
                        InkWell(
                          onTap: () {
                            setState(() {
                              _filtrosExpandidos = !_filtrosExpandidos;
                            });
                          },
                          borderRadius: BorderRadius.only(
                            topLeft: Radius.circular(16),
                            topRight: Radius.circular(16),
                            bottomLeft: _filtrosExpandidos
                                ? Radius.zero
                                : Radius.circular(16),
                            bottomRight: _filtrosExpandidos
                                ? Radius.zero
                                : Radius.circular(16),
                          ),
                          child: Container(
                            padding: EdgeInsets.symmetric(
                                horizontal: 16, vertical: 12),
                            decoration: BoxDecoration(
                              gradient: LinearGradient(
                                colors: [
                                  primaryTeal.withOpacity(0.1),
                                  primaryTeal.withOpacity(0.05),
                                ],
                                begin: Alignment.centerLeft,
                                end: Alignment.centerRight,
                              ),
                              borderRadius: BorderRadius.only(
                                topLeft: Radius.circular(16),
                                topRight: Radius.circular(16),
                                bottomLeft: _filtrosExpandidos
                                    ? Radius.zero
                                    : Radius.circular(16),
                                bottomRight: _filtrosExpandidos
                                    ? Radius.zero
                                    : Radius.circular(16),
                              ),
                              border: Border(
                                bottom: _filtrosExpandidos
                                    ? BorderSide(
                                        color: primaryTeal.withOpacity(0.2),
                                        width: 1)
                                    : BorderSide.none,
                              ),
                            ),
                            child: Row(
                              children: [
                                Container(
                                  padding: EdgeInsets.all(8),
                                  decoration: BoxDecoration(
                                    color: primaryTeal.withOpacity(0.15),
                                    borderRadius: BorderRadius.circular(10),
                                  ),
                                  child: Icon(Icons.filter_list_rounded,
                                      color: primaryTeal, size: 20),
                                ),
                                SizedBox(width: 12),
                                Expanded(
                                  child: Column(
                                    crossAxisAlignment:
                                        CrossAxisAlignment.start,
                                    children: [
                                      Text(
                                        'Filtros de Búsqueda',
                                        style: GoogleFonts.poppins(
                                          fontSize: 15,
                                          fontWeight: FontWeight.w600,
                                          color: primaryTeal,
                                          letterSpacing: 0.3,
                                        ),
                                      ),
                                      if (!_filtrosExpandidos) ...[
                                        SizedBox(height: 2),
                                        Text(
                                          _obtenerTextoFiltrosActivos(),
                                          style: GoogleFonts.poppins(
                                            fontSize: 11,
                                            color: accentGrey,
                                            fontWeight: FontWeight.w500,
                                          ),
                                          maxLines: 1,
                                          overflow: TextOverflow.ellipsis,
                                        ),
                                      ],
                                    ],
                                  ),
                                ),
                                if (_hayFiltrosActivos())
                                  Container(
                                    margin: EdgeInsets.only(right: 8),
                                    padding: EdgeInsets.symmetric(
                                        horizontal: 8, vertical: 4),
                                    decoration: BoxDecoration(
                                      color: secondaryOrange.withOpacity(0.15),
                                      borderRadius: BorderRadius.circular(12),
                                      border: Border.all(
                                          color:
                                              secondaryOrange.withOpacity(0.3),
                                          width: 1),
                                    ),
                                    child: Row(
                                      mainAxisSize: MainAxisSize.min,
                                      children: [
                                        Container(
                                          width: 6,
                                          height: 6,
                                          decoration: BoxDecoration(
                                              color: secondaryOrange,
                                              shape: BoxShape.circle),
                                        ),
                                        SizedBox(width: 4),
                                        Text(
                                          _contarFiltrosActivos().toString(),
                                          style: TextStyle(
                                            fontSize: 11,
                                            fontWeight: FontWeight.bold,
                                            color: secondaryOrange,
                                          ),
                                        ),
                                      ],
                                    ),
                                  ),
                                AnimatedRotation(
                                  turns: _filtrosExpandidos ? 0.5 : 0,
                                  duration: Duration(milliseconds: 300),
                                  curve: Curves.easeInOut,
                                  child: Container(
                                    padding: EdgeInsets.all(6),
                                    decoration: BoxDecoration(
                                      color: primaryTeal.withOpacity(0.1),
                                      borderRadius: BorderRadius.circular(8),
                                    ),
                                    child: Icon(
                                        Icons.keyboard_arrow_down_rounded,
                                        color: primaryTeal,
                                        size: 20),
                                  ),
                                ),
                              ],
                            ),
                          ),
                        ),

                        // 🔽 CONTENIDO EXPANDIBLE DE FILTROS CON SCROLL INDEPENDIENTE
                        AnimatedSize(
                          duration: Duration(milliseconds: 300),
                          curve: Curves.easeInOut,
                          child: _filtrosExpandidos
                              ? ConstrainedBox(
                                  constraints: BoxConstraints(
                                    maxHeight:
                                        MediaQuery.of(context).size.height *
                                            0.4,
                                  ),
                                  child: SingleChildScrollView(
                                    physics: ClampingScrollPhysics(),
                                    child: Column(
                                      children: [
                                        // 🔍 BARRA DE BÚSQUEDA CON SCROLL AUTOMÁTICO
                                        LayoutBuilder(
                                          builder: (context, constraints) {
                                            final screenWidth =
                                                MediaQuery.of(context)
                                                    .size
                                                    .width;
                                            final isVerySmall =
                                                screenWidth < 360;
                                            final isSmall = screenWidth < 600;

                                            return Padding(
                                              padding: EdgeInsets.fromLTRB(
                                                  12, 12, 12, 8),
                                              child: Column(
                                                children: [
                                                  // Selector de tipo de búsqueda RESPONSIVO
                                                  Container(
                                                    padding:
                                                        EdgeInsets.symmetric(
                                                      horizontal:
                                                          isVerySmall ? 8 : 12,
                                                      vertical:
                                                          isVerySmall ? 4 : 6,
                                                    ),
                                                    decoration: BoxDecoration(
                                                      color: primaryTeal
                                                          .withOpacity(0.1),
                                                      borderRadius:
                                                          BorderRadius.circular(
                                                              10),
                                                      border: Border.all(
                                                          color: primaryTeal
                                                              .withOpacity(0.3),
                                                          width: 1),
                                                    ),
                                                    child: Row(
                                                      children: [
                                                        Icon(
                                                          Icons
                                                              .filter_list_rounded,
                                                          color: primaryTeal,
                                                          size: isVerySmall
                                                              ? 16
                                                              : 18,
                                                        ),
                                                        SizedBox(
                                                            width: isVerySmall
                                                                ? 6
                                                                : 8),
                                                        Flexible(
                                                          child: Text(
                                                            'Buscar por:',
                                                            style: TextStyle(
                                                              fontSize:
                                                                  isVerySmall
                                                                      ? 11
                                                                      : 13,
                                                              fontWeight:
                                                                  FontWeight
                                                                      .w600,
                                                              color:
                                                                  primaryTeal,
                                                            ),
                                                            overflow:
                                                                TextOverflow
                                                                    .ellipsis,
                                                          ),
                                                        ),
                                                        SizedBox(
                                                            width: isVerySmall
                                                                ? 8
                                                                : 12),
                                                        Expanded(
                                                          flex: 3,
                                                          child: Row(
                                                            children: [
                                                              Expanded(
                                                                child: InkWell(
                                                                  onTap: () {
                                                                    setState(
                                                                        () {
                                                                      _tipoBusqueda =
                                                                          'nombre';
                                                                      _searchEstadoController
                                                                          .clear();
                                                                      _searchEstadoTerm =
                                                                          '';
                                                                    });
                                                                  },
                                                                  borderRadius:
                                                                      BorderRadius
                                                                          .circular(
                                                                              8),
                                                                  child:
                                                                      Container(
                                                                    padding:
                                                                        EdgeInsets
                                                                            .symmetric(
                                                                      horizontal:
                                                                          isVerySmall
                                                                              ? 6
                                                                              : 12,
                                                                      vertical:
                                                                          isVerySmall
                                                                              ? 6
                                                                              : 8,
                                                                    ),
                                                                    decoration:
                                                                        BoxDecoration(
                                                                      color: _tipoBusqueda ==
                                                                              'nombre'
                                                                          ? primaryTeal
                                                                          : Colors
                                                                              .transparent,
                                                                      borderRadius:
                                                                          BorderRadius.circular(
                                                                              8),
                                                                      border:
                                                                          Border
                                                                              .all(
                                                                        color: _tipoBusqueda ==
                                                                                'nombre'
                                                                            ? primaryTeal
                                                                            : primaryTeal.withOpacity(0.3),
                                                                        width:
                                                                            1.5,
                                                                      ),
                                                                    ),
                                                                    child: Row(
                                                                      mainAxisAlignment:
                                                                          MainAxisAlignment
                                                                              .center,
                                                                      children: [
                                                                        Icon(
                                                                          Icons
                                                                              .person_search_rounded,
                                                                          color: _tipoBusqueda == 'nombre'
                                                                              ? Colors.white
                                                                              : primaryTeal,
                                                                          size: isVerySmall
                                                                              ? 14
                                                                              : 16,
                                                                        ),
                                                                        if (!isVerySmall) ...[
                                                                          SizedBox(
                                                                              width: 4),
                                                                          Flexible(
                                                                            child:
                                                                                Text(
                                                                              'Nombre',
                                                                              style: TextStyle(
                                                                                fontSize: isSmall ? 11 : 12,
                                                                                fontWeight: FontWeight.w600,
                                                                                color: _tipoBusqueda == 'nombre' ? Colors.white : primaryTeal,
                                                                              ),
                                                                              overflow: TextOverflow.ellipsis,
                                                                            ),
                                                                          ),
                                                                        ],
                                                                      ],
                                                                    ),
                                                                  ),
                                                                ),
                                                              ),
                                                              SizedBox(
                                                                  width:
                                                                      isVerySmall
                                                                          ? 4
                                                                          : 8),
                                                              Expanded(
                                                                child: InkWell(
                                                                  onTap: () {
                                                                    setState(
                                                                        () {
                                                                      _tipoBusqueda =
                                                                          'estado';
                                                                      _searchController
                                                                          .clear();
                                                                      _searchTerm =
                                                                          '';
                                                                    });
                                                                  },
                                                                  borderRadius:
                                                                      BorderRadius
                                                                          .circular(
                                                                              8),
                                                                  child:
                                                                      Container(
                                                                    padding:
                                                                        EdgeInsets
                                                                            .symmetric(
                                                                      horizontal:
                                                                          isVerySmall
                                                                              ? 6
                                                                              : 12,
                                                                      vertical:
                                                                          isVerySmall
                                                                              ? 6
                                                                              : 8,
                                                                    ),
                                                                    decoration:
                                                                        BoxDecoration(
                                                                      color: _tipoBusqueda ==
                                                                              'estado'
                                                                          ? secondaryOrange
                                                                          : Colors
                                                                              .transparent,
                                                                      borderRadius:
                                                                          BorderRadius.circular(
                                                                              8),
                                                                      border:
                                                                          Border
                                                                              .all(
                                                                        color: _tipoBusqueda ==
                                                                                'estado'
                                                                            ? secondaryOrange
                                                                            : secondaryOrange.withOpacity(0.3),
                                                                        width:
                                                                            1.5,
                                                                      ),
                                                                    ),
                                                                    child: Row(
                                                                      mainAxisAlignment:
                                                                          MainAxisAlignment
                                                                              .center,
                                                                      children: [
                                                                        Icon(
                                                                          Icons
                                                                              .track_changes_rounded,
                                                                          color: _tipoBusqueda == 'estado'
                                                                              ? Colors.white
                                                                              : secondaryOrange,
                                                                          size: isVerySmall
                                                                              ? 14
                                                                              : 16,
                                                                        ),
                                                                        if (!isVerySmall) ...[
                                                                          SizedBox(
                                                                              width: 4),
                                                                          Flexible(
                                                                            child:
                                                                                Text(
                                                                              'Estado',
                                                                              style: TextStyle(
                                                                                fontSize: isSmall ? 11 : 12,
                                                                                fontWeight: FontWeight.w600,
                                                                                color: _tipoBusqueda == 'estado' ? Colors.white : secondaryOrange,
                                                                              ),
                                                                              overflow: TextOverflow.ellipsis,
                                                                            ),
                                                                          ),
                                                                        ],
                                                                      ],
                                                                    ),
                                                                  ),
                                                                ),
                                                              ),
                                                            ],
                                                          ),
                                                        ),
                                                      ],
                                                    ),
                                                  ),
                                                  SizedBox(height: 8),

                                                  // Campo de búsqueda CON SCROLL AUTOMÁTICO
                                                  AnimatedSwitcher(
                                                    duration: Duration(
                                                        milliseconds: 300),
                                                    transitionBuilder:
                                                        (Widget child,
                                                            Animation<double>
                                                                animation) {
                                                      return FadeTransition(
                                                        opacity: animation,
                                                        child: SlideTransition(
                                                          position:
                                                              Tween<Offset>(
                                                            begin: Offset(
                                                                0.0, 0.2),
                                                            end: Offset.zero,
                                                          ).animate(animation),
                                                          child: child,
                                                        ),
                                                      );
                                                    },
                                                    child: Builder(
                                                      key: ValueKey<String>(
                                                          _tipoBusqueda),
                                                      builder: (fieldContext) {
                                                        return Container(
                                                          decoration:
                                                              BoxDecoration(
                                                            color: backgroundGrey
                                                                .withOpacity(
                                                                    0.5),
                                                            borderRadius:
                                                                BorderRadius
                                                                    .circular(
                                                                        12),
                                                            border: Border.all(
                                                              color: (_tipoBusqueda ==
                                                                          'nombre'
                                                                      ? primaryTeal
                                                                      : secondaryOrange)
                                                                  .withOpacity(
                                                                      0.3),
                                                              width: 1.5,
                                                            ),
                                                          ),
                                                          child: TextField(
                                                            controller: _tipoBusqueda ==
                                                                    'nombre'
                                                                ? _searchController
                                                                : _searchEstadoController,
                                                            focusNode: _tipoBusqueda ==
                                                                    'nombre'
                                                                ? _searchFocusNode
                                                                : _searchEstadoFocusNode,
                                                            textInputAction:
                                                                TextInputAction
                                                                    .search,
                                                            enableInteractiveSelection:
                                                                true,
                                                            style: TextStyle(
                                                                fontSize:
                                                                    isVerySmall
                                                                        ? 13
                                                                        : 15,
                                                                color: Colors
                                                                    .black87),
                                                            // ✅ SOLUCIÓN CLAVE: Scroll automático al recibir foco
                                                            onTap: () {
                                                              WidgetsBinding
                                                                  .instance
                                                                  .addPostFrameCallback(
                                                                      (_) {
                                                                if (fieldContext
                                                                    .mounted) {
                                                                  Scrollable
                                                                      .ensureVisible(
                                                                    fieldContext,
                                                                    duration: Duration(
                                                                        milliseconds:
                                                                            300),
                                                                    curve: Curves
                                                                        .easeInOut,
                                                                    alignment:
                                                                        0.0, // Mantener en la parte superior
                                                                  );
                                                                }
                                                              });
                                                            },
                                                            decoration:
                                                                InputDecoration(
                                                              hintText: _tipoBusqueda ==
                                                                      'nombre'
                                                                  ? 'Buscar por nombre o apellido...'
                                                                  : 'Buscar por estado (ej: Discipulado 1)...',
                                                              hintStyle:
                                                                  TextStyle(
                                                                color: Colors
                                                                    .grey[400],
                                                                fontSize:
                                                                    isVerySmall
                                                                        ? 12
                                                                        : 14,
                                                              ),
                                                              prefixIcon:
                                                                  Container(
                                                                margin:
                                                                    EdgeInsets
                                                                        .all(8),
                                                                padding:
                                                                    EdgeInsets
                                                                        .all(6),
                                                                decoration:
                                                                    BoxDecoration(
                                                                  color: (_tipoBusqueda ==
                                                                              'nombre'
                                                                          ? primaryTeal
                                                                          : secondaryOrange)
                                                                      .withOpacity(
                                                                          0.1),
                                                                  borderRadius:
                                                                      BorderRadius
                                                                          .circular(
                                                                              8),
                                                                ),
                                                                child: Icon(
                                                                  _tipoBusqueda ==
                                                                          'nombre'
                                                                      ? Icons
                                                                          .search_rounded
                                                                      : Icons
                                                                          .track_changes_rounded,
                                                                  color: _tipoBusqueda ==
                                                                          'nombre'
                                                                      ? primaryTeal
                                                                      : secondaryOrange,
                                                                  size:
                                                                      isVerySmall
                                                                          ? 18
                                                                          : 20,
                                                                ),
                                                              ),
                                                              suffixIcon: (_tipoBusqueda ==
                                                                          'nombre'
                                                                      ? _searchController
                                                                          .text
                                                                          .isNotEmpty
                                                                      : _searchEstadoController
                                                                          .text
                                                                          .isNotEmpty)
                                                                  ? IconButton(
                                                                      icon: Icon(
                                                                          Icons
                                                                              .close_rounded,
                                                                          color:
                                                                              accentGrey,
                                                                          size:
                                                                              20),
                                                                      onPressed:
                                                                          () {
                                                                        setState(
                                                                            () {
                                                                          if (_tipoBusqueda ==
                                                                              'nombre') {
                                                                            _searchController.clear();
                                                                            _searchTerm =
                                                                                '';
                                                                            _searchFocusNode.requestFocus();
                                                                          } else {
                                                                            _searchEstadoController.clear();
                                                                            _searchEstadoTerm =
                                                                                '';
                                                                            _searchEstadoFocusNode.requestFocus();
                                                                          }
                                                                        });
                                                                      },
                                                                    )
                                                                  : null,
                                                              border:
                                                                  InputBorder
                                                                      .none,
                                                              contentPadding:
                                                                  EdgeInsets.symmetric(
                                                                      vertical:
                                                                          12,
                                                                      horizontal:
                                                                          4),
                                                              isDense: true,
                                                            ),
                                                            onSubmitted:
                                                                (value) {
                                                              if (_tipoBusqueda ==
                                                                  'nombre') {
                                                                _searchFocusNode
                                                                    .unfocus();
                                                              } else {
                                                                _searchEstadoFocusNode
                                                                    .unfocus();
                                                              }
                                                            },
                                                          ),
                                                        );
                                                      },
                                                    ),
                                                  ),
                                                ],
                                              ),
                                            );
                                          },
                                        ),

                                        // 📅 FILTROS DE FECHA
                                        Padding(
                                          padding:
                                              EdgeInsets.fromLTRB(12, 0, 12, 8),
                                          child: LayoutBuilder(
                                            builder: (context, constraints) {
                                              final isSmallScreen =
                                                  constraints.maxWidth < 600;
                                              return Column(
                                                crossAxisAlignment:
                                                    CrossAxisAlignment.start,
                                                children: [
                                                  Row(
                                                    children: [
                                                      Icon(
                                                          Icons
                                                              .filter_list_rounded,
                                                          color: primaryTeal,
                                                          size: 18),
                                                      SizedBox(width: 6),
                                                      Text(
                                                        'Filtrar por fecha de asignación',
                                                        style: TextStyle(
                                                          fontWeight:
                                                              FontWeight.w600,
                                                          color: primaryTeal,
                                                          fontSize: 13,
                                                          letterSpacing: 0.2,
                                                        ),
                                                      ),
                                                      Spacer(),
                                                      if (_anioSeleccionado !=
                                                              null ||
                                                          _mesSeleccionado !=
                                                              null)
                                                        InkWell(
                                                          onTap:
                                                              _limpiarFiltros,
                                                          borderRadius:
                                                              BorderRadius
                                                                  .circular(6),
                                                          child: Container(
                                                            padding: EdgeInsets
                                                                .symmetric(
                                                                    horizontal:
                                                                        8,
                                                                    vertical:
                                                                        4),
                                                            decoration:
                                                                BoxDecoration(
                                                              color: secondaryOrange
                                                                  .withOpacity(
                                                                      0.1),
                                                              borderRadius:
                                                                  BorderRadius
                                                                      .circular(
                                                                          6),
                                                            ),
                                                            child: Row(
                                                              mainAxisSize:
                                                                  MainAxisSize
                                                                      .min,
                                                              children: [
                                                                Icon(
                                                                    Icons
                                                                        .clear_rounded,
                                                                    color:
                                                                        secondaryOrange,
                                                                    size: 14),
                                                                SizedBox(
                                                                    width: 4),
                                                                Text(
                                                                  'Limpiar',
                                                                  style:
                                                                      TextStyle(
                                                                    color:
                                                                        secondaryOrange,
                                                                    fontSize:
                                                                        11,
                                                                    fontWeight:
                                                                        FontWeight
                                                                            .w600,
                                                                  ),
                                                                ),
                                                              ],
                                                            ),
                                                          ),
                                                        ),
                                                    ],
                                                  ),
                                                  SizedBox(height: 10),
                                                  isSmallScreen
                                                      ? Column(
                                                          children: [
                                                            _buildDropdownFiltroCompacto(
                                                              label: 'Año',
                                                              icon: Icons
                                                                  .calendar_today_rounded,
                                                              value:
                                                                  _anioSeleccionado,
                                                              items: [
                                                                'Todos',
                                                                ..._aniosDisponibles
                                                              ],
                                                              onChanged:
                                                                  (value) {
                                                                setState(() {
                                                                  _anioSeleccionado =
                                                                      value;
                                                                });
                                                              },
                                                              primaryTeal:
                                                                  primaryTeal,
                                                              accentGrey:
                                                                  accentGrey,
                                                              backgroundGrey:
                                                                  backgroundGrey,
                                                            ),
                                                            SizedBox(height: 8),
                                                            _buildDropdownFiltroCompacto(
                                                              label: 'Mes',
                                                              icon: Icons
                                                                  .event_rounded,
                                                              value:
                                                                  _mesSeleccionado,
                                                              items: [
                                                                'Todos',
                                                                '1',
                                                                '2',
                                                                '3',
                                                                '4',
                                                                '5',
                                                                '6',
                                                                '7',
                                                                '8',
                                                                '9',
                                                                '10',
                                                                '11',
                                                                '12'
                                                              ],
                                                              itemBuilder:
                                                                  (value) {
                                                                if (value ==
                                                                    'Todos')
                                                                  return 'Todos';
                                                                return _obtenerNombreMes(
                                                                    int.parse(
                                                                        value));
                                                              },
                                                              onChanged:
                                                                  (value) {
                                                                setState(() {
                                                                  _mesSeleccionado =
                                                                      value;
                                                                });
                                                              },
                                                              primaryTeal:
                                                                  primaryTeal,
                                                              accentGrey:
                                                                  accentGrey,
                                                              backgroundGrey:
                                                                  backgroundGrey,
                                                            ),
                                                          ],
                                                        )
                                                      : Row(
                                                          children: [
                                                            Expanded(
                                                              child:
                                                                  _buildDropdownFiltroCompacto(
                                                                label: 'Año',
                                                                icon: Icons
                                                                    .calendar_today_rounded,
                                                                value:
                                                                    _anioSeleccionado,
                                                                items: [
                                                                  'Todos',
                                                                  ..._aniosDisponibles
                                                                ],
                                                                onChanged:
                                                                    (value) {
                                                                  setState(() {
                                                                    _anioSeleccionado =
                                                                        value;
                                                                  });
                                                                },
                                                                primaryTeal:
                                                                    primaryTeal,
                                                                accentGrey:
                                                                    accentGrey,
                                                                backgroundGrey:
                                                                    backgroundGrey,
                                                              ),
                                                            ),
                                                            SizedBox(width: 10),
                                                            Expanded(
                                                              child:
                                                                  _buildDropdownFiltroCompacto(
                                                                label: 'Mes',
                                                                icon: Icons
                                                                    .event_rounded,
                                                                value:
                                                                    _mesSeleccionado,
                                                                items: [
                                                                  'Todos',
                                                                  '1',
                                                                  '2',
                                                                  '3',
                                                                  '4',
                                                                  '5',
                                                                  '6',
                                                                  '7',
                                                                  '8',
                                                                  '9',
                                                                  '10',
                                                                  '11',
                                                                  '12'
                                                                ],
                                                                itemBuilder:
                                                                    (value) {
                                                                  if (value ==
                                                                      'Todos')
                                                                    return 'Todos';
                                                                  return _obtenerNombreMes(
                                                                      int.parse(
                                                                          value));
                                                                },
                                                                onChanged:
                                                                    (value) {
                                                                  setState(() {
                                                                    _mesSeleccionado =
                                                                        value;
                                                                  });
                                                                },
                                                                primaryTeal:
                                                                    primaryTeal,
                                                                accentGrey:
                                                                    accentGrey,
                                                                backgroundGrey:
                                                                    backgroundGrey,
                                                              ),
                                                            ),
                                                          ],
                                                        ),
                                                ],
                                              );
                                            },
                                          ),
                                        ),

                                        // 📥 BOTÓN DE DESCARGAR EXCEL
                                        Padding(
                                          padding: EdgeInsets.fromLTRB(
                                              12, 4, 12, 12),
                                          child: SizedBox(
                                            width: double.infinity,
                                            child: ElevatedButton.icon(
                                              style: ElevatedButton.styleFrom(
                                                backgroundColor:
                                                    secondaryOrange,
                                                foregroundColor: Colors.white,
                                                padding: EdgeInsets.symmetric(
                                                    horizontal: 16,
                                                    vertical: 14),
                                                shape: RoundedRectangleBorder(
                                                    borderRadius:
                                                        BorderRadius.circular(
                                                            12)),
                                                elevation: 2,
                                              ),
                                              icon: Icon(Icons.download_rounded,
                                                  size: 20),
                                              label: Text(
                                                'Descargar Excel',
                                                style: TextStyle(
                                                  fontSize: 15,
                                                  fontWeight: FontWeight.w600,
                                                  letterSpacing: 0.3,
                                                ),
                                              ),
                                              onPressed: () {
                                                final tribusState = context
                                                    .findAncestorStateOfType<
                                                        _TribusScreenState>();
                                                if (tribusState != null) {
                                                  String? estadoActivo;
                                                  if (_tipoBusqueda ==
                                                          'estado' &&
                                                      _searchEstadoTerm
                                                          .isNotEmpty) {
                                                    estadoActivo =
                                                        _searchEstadoTerm;
                                                  }
                                                  tribusState.descargarExcel(
                                                    context,
                                                    widget.tribuId,
                                                    widget.tribuNombre,
                                                    anioFiltro:
                                                        _anioSeleccionado,
                                                    mesFiltro: _mesSeleccionado,
                                                    estadoFiltro: estadoActivo,
                                                  );
                                                } else {
                                                  ScaffoldMessenger.of(context)
                                                      .showSnackBar(
                                                    SnackBar(
                                                      content: Text(
                                                          'Error: No se pudo acceder al contexto de descarga'),
                                                      backgroundColor:
                                                          Colors.red,
                                                    ),
                                                  );
                                                }
                                              },
                                            ),
                                          ),
                                        ),
                                      ],
                                    ),
                                  ),
                                )
                              : SizedBox.shrink(),
                        ),
                      ],
                    ),
                  ),

                  // 📋 CONTENIDO PRINCIPAL - LISTA DE REGISTROS
                  Expanded(
                    child: StreamBuilder<QuerySnapshot>(
                      stream: FirebaseFirestore.instance
                          .collection('registros')
                          .where('tribuAsignada', isEqualTo: widget.tribuId)
                          .snapshots(),
                      builder: (context, snapshot) {
                        if (snapshot.connectionState ==
                                ConnectionState.waiting &&
                            !snapshot.hasData) {
                          return Container();
                        }

                        if (!snapshot.hasData ||
                            snapshot.data?.docs.isEmpty == true) {
                          return Center(
                            child: Column(
                              mainAxisAlignment: MainAxisAlignment.center,
                              children: [
                                Icon(
                                  Icons.group_off_outlined,
                                  size: 64,
                                  color: accentGrey,
                                ),
                                SizedBox(height: 16),
                                Text(
                                  'No hay jóvenes asignados a esta tribu',
                                  style: TextStyle(
                                    fontSize: 18,
                                    color: accentGrey,
                                    fontWeight: FontWeight.w500,
                                  ),
                                ),
                              ],
                            ),
                          );
                        }

                        final allDocs = snapshot.data?.docs ?? [];
                        var filteredDocs = allDocs;

                        if (_tipoBusqueda == 'nombre' &&
                            _searchTerm.isNotEmpty) {
                          filteredDocs = filteredDocs.where((doc) {
                            final data = doc.data() as Map<String, dynamic>;
                            final nombre =
                                (data['nombre'] as String? ?? '').toLowerCase();
                            final apellido = (data['apellido'] as String? ?? '')
                                .toLowerCase();
                            final nombreCompleto =
                                '$nombre $apellido'.toLowerCase();

                            return nombre.contains(_searchTerm) ||
                                apellido.contains(_searchTerm) ||
                                nombreCompleto.contains(_searchTerm);
                          }).toList();
                        } else if (_tipoBusqueda == 'estado' &&
                            _searchEstadoTerm.isNotEmpty) {
                          filteredDocs = filteredDocs
                              .where((doc) => _cumpleFiltroEstado(doc))
                              .toList();
                        }

                        if (_anioSeleccionado != null ||
                            _mesSeleccionado != null) {
                          filteredDocs = filteredDocs
                              .where((doc) => _cumpleFiltroFecha(doc))
                              .toList();
                        }

                        filteredDocs.sort((a, b) {
                          final dataA = a.data() as Map<String, dynamic>;
                          final dataB = b.data() as Map<String, dynamic>;

                          bool esRegistroNuevo(Map<String, dynamic> data) {
                            DateTime? fechaTribu =
                                (data['fechaAsignacionTribu'] as Timestamp?)
                                        ?.toDate() ??
                                    (data['fechaAsignacion'] as Timestamp?)
                                        ?.toDate();
                            DateTime? fechaCoord =
                                (data['fechaAsignacionCoordinador']
                                        as Timestamp?)
                                    ?.toDate();
                            DateTime? fechaTimoteo =
                                (data['fechaAsignacionTimoteo'] as Timestamp?)
                                    ?.toDate();

                            DateTime? fechaMasReciente = [
                              fechaTribu,
                              fechaCoord,
                              fechaTimoteo
                            ].whereType<DateTime>().fold<DateTime?>(
                                null,
                                (prev, curr) =>
                                    prev == null || curr.isAfter(prev)
                                        ? curr
                                        : prev);

                            return fechaMasReciente != null &&
                                DateTime.now()
                                        .difference(fechaMasReciente)
                                        .inDays <=
                                    14;
                          }

                          bool nuevoA = esRegistroNuevo(dataA);
                          bool nuevoB = esRegistroNuevo(dataB);

                          if (nuevoA && !nuevoB) return -1;
                          if (!nuevoA && nuevoB) return 1;

                          final nombreA =
                              '${dataA['nombre'] ?? ''} ${dataA['apellido'] ?? ''}'
                                  .toLowerCase();
                          final nombreB =
                              '${dataB['nombre'] ?? ''} ${dataB['apellido'] ?? ''}'
                                  .toLowerCase();
                          return nombreA.compareTo(nombreB);
                        });

                        if (filteredDocs.isEmpty) {
                          String mensaje;
                          if (_tipoBusqueda == 'nombre' &&
                              _searchTerm.isNotEmpty) {
                            mensaje =
                                'No se encontraron resultados para "$_searchTerm"';
                          } else if (_tipoBusqueda == 'estado' &&
                              _searchEstadoTerm.isNotEmpty) {
                            mensaje =
                                'No hay registros con estado "$_searchEstadoTerm"';
                          } else {
                            mensaje =
                                'No hay registros con los filtros aplicados';
                          }

                          return Center(
                            child: Column(
                              mainAxisAlignment: MainAxisAlignment.center,
                              children: [
                                Icon(
                                  _searchTerm.isNotEmpty
                                      ? Icons.search_off_rounded
                                      : Icons.filter_list_off_rounded,
                                  size: 64,
                                  color: accentGrey,
                                ),
                                SizedBox(height: 16),
                                Padding(
                                  padding: EdgeInsets.symmetric(horizontal: 32),
                                  child: Text(
                                    mensaje,
                                    style: TextStyle(
                                      fontSize: 16,
                                      color: accentGrey,
                                      fontWeight: FontWeight.w500,
                                    ),
                                    textAlign: TextAlign.center,
                                  ),
                                ),
                                SizedBox(height: 16),
                                ElevatedButton.icon(
                                  onPressed: () {
                                    setState(() {
                                      _searchController.clear();
                                      _searchEstadoController.clear();
                                      _searchTerm = '';
                                      _searchEstadoTerm = '';
                                      _limpiarFiltros();
                                    });
                                  },
                                  icon: Icon(Icons.refresh_rounded, size: 20),
                                  label: Text('Limpiar todo'),
                                  style: ElevatedButton.styleFrom(
                                    backgroundColor: primaryTeal,
                                    foregroundColor: Colors.white,
                                    padding: EdgeInsets.symmetric(
                                      horizontal: 20,
                                      vertical: 12,
                                    ),
                                    shape: RoundedRectangleBorder(
                                      borderRadius: BorderRadius.circular(10),
                                    ),
                                  ),
                                ),
                              ],
                            ),
                          );
                        }

                        List<DocumentSnapshot> registrosActivos = [];
                        List<DocumentSnapshot> registrosInactivos = [];
                        List<DocumentSnapshot> sinCoordinador = [];
                        Map<String, List<DocumentSnapshot>> porCoordinador = {};
                        List<String> idsCoordinadores = [];

                        for (var doc in filteredDocs) {
                          var data = doc.data() as Map<String, dynamic>;
                          bool activo = data['activo'] ?? true;

                          if (activo) {
                            registrosActivos.add(doc);
                          } else {
                            registrosInactivos.add(doc);
                          }
                        }

                        for (var doc in registrosActivos) {
                          var data = doc.data() as Map<String, dynamic>;
                          if (data['coordinadorAsignado'] == null) {
                            sinCoordinador.add(doc);
                          } else {
                            String coordinadorId = data['coordinadorAsignado'];
                            if (!porCoordinador.containsKey(coordinadorId)) {
                              porCoordinador[coordinadorId] = [];
                              idsCoordinadores.add(coordinadorId);
                            }
                            porCoordinador[coordinadorId]!.add(doc);
                          }
                        }

                        return FutureBuilder<Map<String, String>>(
                          future: obtenerNombresCoordinadores(idsCoordinadores),
                          builder: (context, futureSnapshot) {
                            Map<String, String> nombresCoordinadores =
                                futureSnapshot.data ?? {};

                            Map<String, bool> groupExpandedStates = {};
                            Map<String, bool> expandedStates = {};

                            if (_searchTerm.isNotEmpty) {
                              if (sinCoordinador.isNotEmpty) {
                                groupExpandedStates['Sin_Coordinador'] = true;
                              }

                              porCoordinador.keys.forEach((key) {
                                groupExpandedStates['Coordinador_${key}'] =
                                    true;
                              });

                              if (registrosInactivos.isNotEmpty) {
                                groupExpandedStates['Registros_No_Activos'] =
                                    true;
                              }

                              for (var doc in filteredDocs) {
                                expandedStates[doc.id] = true;
                              }
                            }

                            return Padding(
                              padding: EdgeInsets.symmetric(horizontal: 12),
                              child: ListView(
                                keyboardDismissBehavior:
                                    ScrollViewKeyboardDismissBehavior.onDrag,
                                children: [
                                  if (sinCoordinador.isNotEmpty)
                                    _buildGrupo(
                                      context,
                                      'Sin Coordinador',
                                      sinCoordinador,
                                      primaryTeal,
                                      secondaryOrange,
                                      accentGrey,
                                      backgroundGrey,
                                      expandedStates,
                                      groupExpandedStates,
                                    ),
                                  ...porCoordinador.entries.map(
                                    (entry) => _buildGrupo(
                                      context,
                                      'Coordinador: ${nombresCoordinadores[entry.key] ?? "Desconocido"}',
                                      entry.value,
                                      primaryTeal,
                                      secondaryOrange,
                                      accentGrey,
                                      backgroundGrey,
                                      expandedStates,
                                      groupExpandedStates,
                                    ),
                                  ),
                                  if (registrosInactivos.isNotEmpty)
                                    _buildGrupoInactivos(
                                      context,
                                      'Registros No Activos',
                                      registrosInactivos,
                                      primaryTeal,
                                      secondaryOrange,
                                      accentGrey,
                                      backgroundGrey,
                                      expandedStates,
                                      groupExpandedStates,
                                    ),
                                ],
                              ),
                            );
                          },
                        );
                      },
                    ),
                  ),
                ],
              ),
            ),

            // 🎯 BOTÓN FLOTANTE PARA REGISTRAR MIEMBRO
            Positioned(
              right: 16,
              bottom: 16,
              child: Material(
                elevation: 6,
                shadowColor: secondaryOrange.withOpacity(0.3),
                borderRadius: BorderRadius.circular(14),
                child: InkWell(
                  onTap: () {
                    final tribusState =
                        context.findAncestorStateOfType<_TribusScreenState>();
                    if (tribusState != null) {
                      tribusState._showRegistroDialog(context);
                    }
                  },
                  borderRadius: BorderRadius.circular(14),
                  child: Container(
                    padding: EdgeInsets.symmetric(
                      horizontal:
                          MediaQuery.of(context).size.width < 360 ? 12 : 16,
                      vertical: 12,
                    ),
                    decoration: BoxDecoration(
                      gradient: LinearGradient(
                        colors: [
                          secondaryOrange,
                          secondaryOrange.withOpacity(0.85),
                        ],
                        begin: Alignment.topLeft,
                        end: Alignment.bottomRight,
                      ),
                      borderRadius: BorderRadius.circular(14),
                      boxShadow: [
                        BoxShadow(
                          color: secondaryOrange.withOpacity(0.25),
                          blurRadius: 8,
                          offset: Offset(0, 3),
                        ),
                      ],
                    ),
                    child: Row(
                      mainAxisSize: MainAxisSize.min,
                      children: [
                        Icon(
                          Icons.person_add_alt_1_rounded,
                          color: Colors.white,
                          size: 20,
                        ),
                        if (MediaQuery.of(context).size.width >= 360) ...[
                          SizedBox(width: 10),
                          Text(
                            'Registrar',
                            style: GoogleFonts.poppins(
                              color: Colors.white,
                              fontSize: 14,
                              fontWeight: FontWeight.w600,
                              letterSpacing: 0.3,
                            ),
                          ),
                        ],
                      ],
                    ),
                  ),
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }

// 🎨 MÉTODO AUXILIAR PARA DROPDOWNS COMPACTOS
  Widget _buildDropdownFiltroCompacto({
    required String label,
    required IconData icon,
    required String? value,
    required List<String> items,
    String Function(String)? itemBuilder,
    required Function(String?) onChanged,
    required Color primaryTeal,
    required Color accentGrey,
    required Color backgroundGrey,
  }) {
    return Container(
      padding: EdgeInsets.symmetric(horizontal: 10, vertical: 8),
      decoration: BoxDecoration(
        color: backgroundGrey.withOpacity(0.5),
        borderRadius: BorderRadius.circular(10),
        border: Border.all(
          color: primaryTeal.withOpacity(0.2),
          width: 1,
        ),
      ),
      child: Row(
        children: [
          Icon(
            icon,
            color: primaryTeal,
            size: 16,
          ),
          SizedBox(width: 8),
          Text(
            '$label:',
            style: TextStyle(
              fontSize: 12,
              fontWeight: FontWeight.w600,
              color: accentGrey,
            ),
          ),
          SizedBox(width: 8),
          Expanded(
            child: DropdownButtonHideUnderline(
              child: DropdownButton<String>(
                value: value ?? 'Todos',
                isDense: true,
                isExpanded: true,
                icon: Icon(
                  Icons.arrow_drop_down_rounded,
                  color: primaryTeal,
                  size: 20,
                ),
                style: TextStyle(
                  fontSize: 13,
                  fontWeight: FontWeight.w500,
                  color: Colors.black87,
                ),
                items: items.map((item) {
                  String displayText =
                      itemBuilder != null ? itemBuilder(item) : item;
                  return DropdownMenuItem<String>(
                    value: item == 'Todos' ? null : item,
                    child: Text(
                      displayText,
                      overflow: TextOverflow.ellipsis,
                    ),
                  );
                }).toList(),
                onChanged: onChanged,
              ),
            ),
          ),
        ],
      ),
    );
  }

  // NUEVO: Método específico para construir el grupo de registros inactivos
  Widget _buildGrupoInactivos(
    BuildContext context,
    String titulo,
    List<DocumentSnapshot> registros,
    Color primaryTeal,
    Color secondaryOrange,
    Color accentGrey,
    Color backgroundGrey,
    Map<String, bool> expandedStates,
    Map<String, bool> groupExpandedStates,
  ) {
    String groupKey = 'Registros_No_Activos';
    bool isGroupExpanded = groupExpandedStates[groupKey] ?? false;

    return StatefulBuilder(
      builder: (context, setStateLocal) {
        return Container(
          margin: EdgeInsets.only(bottom: 16),
          decoration: BoxDecoration(
            color: Colors.white,
            borderRadius: BorderRadius.circular(16),
            boxShadow: [
              BoxShadow(
                color: Colors.red.withOpacity(0.1),
                blurRadius: 8,
                offset: Offset(0, 4),
              ),
            ],
            border: Border.all(
              color: Colors.red.withOpacity(0.2),
              width: 1.5,
            ),
          ),
          child: Column(
            children: [
              // Encabezado del grupo inactivo
              InkWell(
                onTap: () {
                  setStateLocal(() {
                    groupExpandedStates[groupKey] = !isGroupExpanded;
                    isGroupExpanded = groupExpandedStates[groupKey]!;
                  });
                },
                borderRadius: BorderRadius.circular(16),
                child: Container(
                  padding: EdgeInsets.all(16),
                  decoration: BoxDecoration(
                    gradient: LinearGradient(
                      colors: [
                        Colors.red.withOpacity(0.1),
                        Colors.red.withOpacity(0.05),
                      ],
                      begin: Alignment.centerLeft,
                      end: Alignment.centerRight,
                    ),
                    borderRadius: BorderRadius.circular(16),
                  ),
                  child: Row(
                    children: [
                      Container(
                        padding: EdgeInsets.all(8),
                        decoration: BoxDecoration(
                          color: Colors.red.withOpacity(0.15),
                          borderRadius: BorderRadius.circular(8),
                        ),
                        child: Icon(
                          Icons.cancel_outlined,
                          color: Colors.red[700],
                          size: 20,
                        ),
                      ),
                      SizedBox(width: 12),
                      Expanded(
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(
                              titulo,
                              style: TextStyle(
                                fontSize: 16,
                                fontWeight: FontWeight.bold,
                                color: Colors.red[700],
                              ),
                            ),
                            SizedBox(height: 2),
                            Text(
                              '${registros.length} registro${registros.length != 1 ? 's' : ''} inactivo${registros.length != 1 ? 's' : ''}',
                              style: TextStyle(
                                fontSize: 13,
                                color: Colors.red[600],
                                fontWeight: FontWeight.w500,
                              ),
                            ),
                          ],
                        ),
                      ),
                      Container(
                        padding:
                            EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                        decoration: BoxDecoration(
                          color: Colors.red.withOpacity(0.15),
                          borderRadius: BorderRadius.circular(12),
                        ),
                        child: Text(
                          '${registros.length}',
                          style: TextStyle(
                            color: Colors.red[700],
                            fontWeight: FontWeight.bold,
                            fontSize: 12,
                          ),
                        ),
                      ),
                      SizedBox(width: 8),
                      AnimatedRotation(
                        turns: isGroupExpanded ? 0.5 : 0,
                        duration: Duration(milliseconds: 200),
                        child: Icon(
                          Icons.expand_more,
                          color: Colors.red[600],
                        ),
                      ),
                    ],
                  ),
                ),
              ),

              // Lista de registros inactivos
              AnimatedContainer(
                duration: Duration(milliseconds: 300),
                height: isGroupExpanded ? null : 0,
                child: isGroupExpanded
                    ? Column(
                        children: registros.map((registro) {
                          final data = registro.data() as Map<String, dynamic>;
                          final nombre = data['nombre'] ?? '';
                          final apellido = data['apellido'] ?? '';
                          final telefono = data['telefono'] ?? '';
                          final edad = data['edad']?.toString() ?? '';
                          final sexo = data['sexo'] ?? '';

                          bool isExpanded =
                              expandedStates[registro.id] ?? false;

                          return Container(
                            margin: EdgeInsets.fromLTRB(16, 0, 16, 8),
                            decoration: BoxDecoration(
                              color: Colors.red.withOpacity(0.05),
                              borderRadius: BorderRadius.circular(12),
                              border: Border.all(
                                color: Colors.red.withOpacity(0.2),
                                width: 1,
                              ),
                            ),
                            child: Column(
                              children: [
                                InkWell(
                                  onTap: () {
                                    setStateLocal(() {
                                      expandedStates[registro.id] = !isExpanded;
                                    });
                                  },
                                  borderRadius: BorderRadius.circular(12),
                                  child: Padding(
                                    padding: EdgeInsets.all(12),
                                    child: Row(
                                      children: [
                                        CircleAvatar(
                                          radius: 20,
                                          backgroundColor:
                                              Colors.red.withOpacity(0.2),
                                          child: Icon(
                                            sexo.toLowerCase() == 'mujer'
                                                ? Icons.female
                                                : Icons.male,
                                            color: Colors.red[700],
                                            size: 20,
                                          ),
                                        ),
                                        SizedBox(width: 12),
                                        Expanded(
                                          child: Column(
                                            crossAxisAlignment:
                                                CrossAxisAlignment.start,
                                            children: [
                                              Text(
                                                '$nombre $apellido',
                                                style: TextStyle(
                                                  fontWeight: FontWeight.w600,
                                                  fontSize: 14,
                                                  color: Colors.red[800],
                                                ),
                                                overflow: TextOverflow.ellipsis,
                                              ),
                                              if (telefono.isNotEmpty)
                                                Text(
                                                  telefono,
                                                  style: TextStyle(
                                                    fontSize: 12,
                                                    color: Colors.red[600],
                                                  ),
                                                ),
                                            ],
                                          ),
                                        ),
                                        if (edad.isNotEmpty)
                                          Container(
                                            padding: EdgeInsets.symmetric(
                                                horizontal: 8, vertical: 4),
                                            decoration: BoxDecoration(
                                              color:
                                                  Colors.red.withOpacity(0.1),
                                              borderRadius:
                                                  BorderRadius.circular(8),
                                            ),
                                            child: Text(
                                              '$edad años',
                                              style: TextStyle(
                                                fontSize: 11,
                                                fontWeight: FontWeight.w500,
                                                color: Colors.red[700],
                                              ),
                                            ),
                                          ),
                                        SizedBox(width: 8),
                                        // Botón de editar
                                        IconButton(
                                          onPressed: () {
                                            _editarRegistro(context, registro);
                                          },
                                          icon: Icon(
                                            Icons.edit,
                                            color: Colors.red[600],
                                            size: 18,
                                          ),
                                          constraints: BoxConstraints(
                                            minWidth: 32,
                                            minHeight: 32,
                                          ),
                                          padding: EdgeInsets.all(4),
                                        ),
                                        AnimatedRotation(
                                          turns: isExpanded ? 0.5 : 0,
                                          duration: Duration(milliseconds: 200),
                                          child: Icon(
                                            Icons.expand_more,
                                            color: Colors.red[600],
                                          ),
                                        ),
                                      ],
                                    ),
                                  ),
                                ),
                                // Detalles expandidos
                                if (isExpanded)
                                  Container(
                                    padding: EdgeInsets.fromLTRB(16, 0, 16, 16),
                                    child: Column(
                                      crossAxisAlignment:
                                          CrossAxisAlignment.start,
                                      children: [
                                        Divider(
                                            color: Colors.red.withOpacity(0.3)),
                                        SizedBox(height: 8),
                                        _buildDetalleInactivo(
                                            'Dirección', data['direccion']),
                                        _buildDetalleInactivo(
                                            'Barrio', data['barrio']),
                                        _buildDetalleInactivo('Estado Civil',
                                            data['estadoCivil']),
                                        if (data['nombrePareja'] != null &&
                                            data['nombrePareja']
                                                .toString()
                                                .isNotEmpty)
                                          _buildDetalleInactivo(
                                              'Pareja', data['nombrePareja']),
                                        _buildDetalleInactivo('Ocupación',
                                            data['descripcionOcupacion']),
                                        if (data['observaciones'] != null &&
                                            data['observaciones']
                                                .toString()
                                                .isNotEmpty)
                                          _buildDetalleInactivo('Observaciones',
                                              data['observaciones']),

                                        // Información de estado inactivo
                                        SizedBox(height: 8),
                                        Container(
                                          padding: EdgeInsets.all(8),
                                          decoration: BoxDecoration(
                                            color: Colors.red.withOpacity(0.1),
                                            borderRadius:
                                                BorderRadius.circular(6),
                                          ),
                                          child: Row(
                                            children: [
                                              Icon(Icons.info_outline,
                                                  color: Colors.red[700],
                                                  size: 16),
                                              SizedBox(width: 6),
                                              Text(
                                                'Registro inactivo - Sin asignaciones',
                                                style: TextStyle(
                                                  fontSize: 11,
                                                  color: Colors.red[700],
                                                  fontWeight: FontWeight.w500,
                                                ),
                                              ),
                                            ],
                                          ),
                                        ),
                                      ],
                                    ),
                                  ),
                              ],
                            ),
                          );
                        }).toList(),
                      )
                    : SizedBox.shrink(),
              ),
            ],
          ),
        );
      },
    );
  }

  // NUEVO: Método auxiliar para mostrar detalles en registros inactivos
  Widget _buildDetalleInactivo(String label, dynamic value) {
    if (value == null || value.toString().isEmpty) return SizedBox.shrink();

    return Padding(
      padding: EdgeInsets.only(bottom: 4),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          SizedBox(
            width: 80,
            child: Text(
              '$label:',
              style: TextStyle(
                fontSize: 11,
                fontWeight: FontWeight.w500,
                color: Colors.red[600],
              ),
            ),
          ),
          Expanded(
            child: Text(
              value.toString(),
              style: TextStyle(
                fontSize: 11,
                color: Colors.red[700],
              ),
            ),
          ),
        ],
      ),
    );
  }

// Nueva función para obtener nombres de coordinadores
  Future<Map<String, String>> obtenerNombresCoordinadores(
      List<String> coordinadorIds) async {
    Map<String, String> nombresCoordinadores = {};

    if (coordinadorIds.isEmpty) return nombresCoordinadores;

    try {
      var snapshot = await FirebaseFirestore.instance
          .collection('coordinadores')
          .where(FieldPath.documentId, whereIn: coordinadorIds)
          .get();

      for (var doc in snapshot.docs) {
        var data = doc.data();
        nombresCoordinadores[doc.id] = "${data['nombre']} ${data['apellido']}";
      }
    } catch (e) {
      print("Error obteniendo nombres de coordinadores: $e");
    }

    return nombresCoordinadores;
  }

  Widget _buildGrupo(
      BuildContext context,
      String titulo,
      List<DocumentSnapshot> registros,
      Color primaryTeal,
      Color secondaryOrange,
      Color accentGrey,
      Color backgroundGrey,
      Map<String, bool> expandedStates,
      Map<String, bool> groupExpandedStates) {
    final String groupId = titulo.replaceAll(' ', '_');

    // Inicializa el estado de expansión del grupo si no existe
    groupExpandedStates[groupId] ??= false;

    return StatefulBuilder(
      builder: (BuildContext context, StateSetter setState) {
        return Card(
          margin: EdgeInsets.only(bottom: 16),
          elevation: 3,
          shadowColor: primaryTeal.withOpacity(0.1),
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(16),
            side: BorderSide(
              color: primaryTeal.withOpacity(0.1),
              width: 1,
            ),
          ),
          child: Column(
            children: [
              // Encabezado del grupo
              GestureDetector(
                onTap: () {
                  setState(() {
                    groupExpandedStates[groupId] =
                        !groupExpandedStates[groupId]!;
                  });
                },
                child: Padding(
                  padding: EdgeInsets.all(16),
                  child: Row(
                    children: [
                      Container(
                        width: 50,
                        height: 50,
                        decoration: BoxDecoration(
                          color: primaryTeal.withOpacity(0.2),
                          borderRadius: BorderRadius.circular(12),
                          border: Border.all(
                            color: primaryTeal.withOpacity(0.5),
                            width: 1.5,
                          ),
                        ),
                        child: Center(
                          child: Icon(
                            titulo.contains('Sin')
                                ? Icons.person_off_outlined
                                : Icons.supervisor_account,
                            color: primaryTeal,
                            size: 24,
                          ),
                        ),
                      ),
                      SizedBox(width: 16),
                      Expanded(
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(
                              titulo,
                              style: TextStyle(
                                fontSize: 16,
                                fontWeight: FontWeight.bold,
                                color: primaryTeal,
                              ),
                            ),
                            SizedBox(height: 4),
                            Text(
                              '${registros.length} ${registros.length == 1 ? 'joven' : 'jóvenes'}',
                              style: TextStyle(
                                color: accentGrey,
                                fontSize: 14,
                              ),
                            ),
                          ],
                        ),
                      ),
                      Icon(
                        groupExpandedStates[groupId]!
                            ? Icons.keyboard_arrow_up
                            : Icons.keyboard_arrow_down,
                        size: 24,
                        color: primaryTeal,
                      ),
                    ],
                  ),
                ),
              ),
              // Lista de registros si el grupo está expandido
              if (groupExpandedStates[groupId]!)
                ListView.builder(
                  shrinkWrap: true,
                  physics: NeverScrollableScrollPhysics(),
                  itemCount: registros.length,
                  itemBuilder: (context, index) {
                    final registro = registros[index];
                    final data = registro.data() as Map<String, dynamic>? ?? {};
                    final registroId = registro.id;

                    // Acceso seguro con valores por defecto
                    final nombre = data['nombre'] as String? ?? '';
                    final apellido = data['apellido'] as String? ?? '';
                    final telefono =
                        data['telefono'] as String? ?? 'No disponible';
                    final ministerioAsignado =
                        data['ministerioAsignado'] ?? 'Sin ministerio';

                    String iniciales = '';
                    if (nombre.isNotEmpty && nombre.length >= 1) {
                      iniciales += nombre[0];
                    }
                    if (apellido.isNotEmpty && apellido.length >= 1) {
                      iniciales += apellido[0];
                    }
                    if (iniciales.isEmpty) {
                      iniciales = '?';
                    }

                    // Determinamos un color de fondo aleatorio pero consistente para las iniciales
                    final List<Color> avatarColors = [
                      primaryTeal,
                      secondaryOrange,
                      accentGrey,
                    ];

                    // Usamos la suma de los códigos de caracteres para generar un índice
                    int colorIndex = 0;
                    if (iniciales.isNotEmpty) {
                      colorIndex = iniciales.codeUnits.reduce((a, b) => a + b) %
                          avatarColors.length;
                    }

                    // Utilizamos un StatefulBuilder para manejar el estado de expansión
                    return StatefulBuilder(
                      builder: (BuildContext context, StateSetter setState) {
                        // Inicializamos el estado de expansión si no existe
                        expandedStates[registroId] ??= false;

                        // FUNCIONALIDAD: Detectar si es un registro nuevo
                        DateTime? fechaTribu = (data['fechaAsignacionTribu']
                                    as Timestamp?)
                                ?.toDate() ??
                            (data['fechaAsignacion'] as Timestamp?)?.toDate();
                        DateTime? fechaCoord =
                            (data['fechaAsignacionCoordinador'] as Timestamp?)
                                ?.toDate();
                        DateTime? fechaTimoteo =
                            (data['fechaAsignacionTimoteo'] as Timestamp?)
                                ?.toDate();

                        // Obtener la fecha más reciente de asignación
                        DateTime? fechaMasReciente = [
                          fechaTribu,
                          fechaCoord,
                          fechaTimoteo
                        ].whereType<DateTime>().fold<DateTime?>(
                            null,
                            (prev, curr) => prev == null || curr.isAfter(prev)
                                ? curr
                                : prev);

                        bool esNuevo = fechaMasReciente != null &&
                            DateTime.now()
                                    .difference(fechaMasReciente)
                                    .inDays <=
                                14;

                        int diasDesdeAsignacion = fechaMasReciente != null
                            ? DateTime.now().difference(fechaMasReciente).inDays
                            : 0;

                        // Colores dinámicos según antiguedad
                        Color colorTarjeta =
                            esNuevo ? Colors.amber.shade50 : Colors.white;
                        Color colorBorde = esNuevo
                            ? Colors.amber.withOpacity(0.4)
                            : primaryTeal.withOpacity(0.1);
                        Color colorSombra = esNuevo
                            ? Colors.amber.withOpacity(0.2)
                            : primaryTeal.withOpacity(0.1);

                        return Container(
                          margin:
                              EdgeInsets.symmetric(horizontal: 16, vertical: 8),
                          child: Stack(
                            children: [
                              Card(
                                margin: EdgeInsets.zero,
                                elevation: esNuevo ? 4 : 2,
                                shadowColor: colorSombra,
                                color: colorTarjeta,
                                shape: RoundedRectangleBorder(
                                  borderRadius: BorderRadius.circular(12),
                                  side: BorderSide(
                                    color: colorBorde,
                                    width: esNuevo ? 2 : 1,
                                  ),
                                ),
                                child: Column(
                                  children: [
                                    // Indicador visual para registros nuevos
                                    if (esNuevo)
                                      Container(
                                        width: double.infinity,
                                        padding: EdgeInsets.symmetric(
                                            horizontal: 12, vertical: 6),
                                        decoration: BoxDecoration(
                                          gradient: LinearGradient(
                                            colors: [
                                              Colors.amber.shade100,
                                              Colors.amber.shade200,
                                            ],
                                            begin: Alignment.centerLeft,
                                            end: Alignment.centerRight,
                                          ),
                                          borderRadius: BorderRadius.only(
                                            topLeft: Radius.circular(10),
                                            topRight: Radius.circular(10),
                                          ),
                                        ),
                                        child: Row(
                                          mainAxisSize: MainAxisSize.min,
                                          children: [
                                            Icon(
                                              Icons.fiber_new,
                                              color: Colors.amber.shade700,
                                              size: 16,
                                            ),
                                            SizedBox(width: 4),
                                            Text(
                                              diasDesdeAsignacion == 0
                                                  ? 'RECIÉN ASIGNADO'
                                                  : 'NUEVO - ${diasDesdeAsignacion} día${diasDesdeAsignacion != 1 ? 's' : ''}',
                                              style: TextStyle(
                                                fontSize: 11,
                                                fontWeight: FontWeight.bold,
                                                color: Colors.amber.shade700,
                                              ),
                                            ),
                                            Spacer(),
                                            Container(
                                              padding: EdgeInsets.symmetric(
                                                  horizontal: 6, vertical: 2),
                                              decoration: BoxDecoration(
                                                color: Colors.amber.shade700,
                                                borderRadius:
                                                    BorderRadius.circular(8),
                                              ),
                                              child: Text(
                                                '${14 - diasDesdeAsignacion} días restantes',
                                                style: TextStyle(
                                                  fontSize: 9,
                                                  fontWeight: FontWeight.w500,
                                                  color: Colors.white,
                                                ),
                                              ),
                                            ),
                                          ],
                                        ),
                                      ),

                                    // Parte superior de la tarjeta con información básica
                                    GestureDetector(
                                      onTap: () {
                                        // NUEVO: Imprimir ID del registro en consola
                                        print(
                                            "ID del registro seleccionado:: ${registro.id}, Nombre: $nombre $apellido");

                                        setState(() {
                                          // Invertimos el estado de expansión al tocar
                                          expandedStates[registroId] =
                                              !expandedStates[registroId]!;
                                        });
                                      },
                                      child: Padding(
                                        padding: EdgeInsets.all(16),
                                        child: Row(
                                          children: [
                                            // Avatar con iniciales
                                            Container(
                                              width: 40,
                                              height: 40,
                                              decoration: BoxDecoration(
                                                color: avatarColors[colorIndex]
                                                    .withOpacity(0.2),
                                                borderRadius:
                                                    BorderRadius.circular(10),
                                                border: Border.all(
                                                  color:
                                                      avatarColors[colorIndex]
                                                          .withOpacity(0.5),
                                                  width: 1.5,
                                                ),
                                              ),
                                              child: Center(
                                                child: Text(
                                                  iniciales,
                                                  style: TextStyle(
                                                    fontSize: 18,
                                                    fontWeight: FontWeight.bold,
                                                    color: avatarColors[
                                                        colorIndex],
                                                  ),
                                                ),
                                              ),
                                            ),
                                            SizedBox(width: 16),
                                            // Información del registro
                                            Expanded(
                                              child: Column(
                                                crossAxisAlignment:
                                                    CrossAxisAlignment.start,
                                                children: [
                                                  Text(
                                                    '$nombre $apellido',
                                                    style: TextStyle(
                                                      fontSize: 16,
                                                      fontWeight:
                                                          FontWeight.bold,
                                                      color: primaryTeal,
                                                    ),
                                                  ),
                                                  SizedBox(height: 4),
                                                  Row(
                                                    children: [
                                                      Icon(
                                                        Icons.phone_outlined,
                                                        size: 14,
                                                        color: accentGrey,
                                                      ),
                                                      SizedBox(width: 4),
                                                      Text(
                                                        telefono,
                                                        style: TextStyle(
                                                          color: accentGrey,
                                                          fontSize: 14,
                                                        ),
                                                      ),
                                                    ],
                                                  ),
                                                  SizedBox(height: 4),
                                                  Row(
                                                    children: [
                                                      Icon(
                                                        Icons
                                                            .account_tree_outlined,
                                                        size: 14,
                                                        color: accentGrey,
                                                      ),
                                                      SizedBox(width: 4),
                                                      Text(
                                                        'Ministerio: $ministerioAsignado',
                                                        style: TextStyle(
                                                          color: accentGrey,
                                                          fontSize: 14,
                                                        ),
                                                      ),
                                                    ],
                                                  ),
                                                ],
                                              ),
                                            ),
                                            // Botones de acción
                                            Row(
                                              children: [
                                                // Botón de ver detalles
                                                Material(
                                                  color: Colors.transparent,
                                                  child: InkWell(
                                                    borderRadius:
                                                        BorderRadius.circular(
                                                            12),
                                                    onTap: () {
                                                      // NUEVO: Imprimir ID cuando se ven detalles
                                                      print(
                                                          "ID del registro Ver detalles del registro: ${registro.id}, Nombre: $nombre $apellido");

                                                      _mostrarDetallesRegistro(
                                                        context,
                                                        data,
                                                        primaryTeal,
                                                        secondaryOrange,
                                                        accentGrey,
                                                        backgroundGrey,
                                                      );
                                                    },
                                                    child: Container(
                                                      padding:
                                                          EdgeInsets.all(10),
                                                      decoration: BoxDecoration(
                                                        color: primaryTeal
                                                            .withOpacity(0.1),
                                                        borderRadius:
                                                            BorderRadius
                                                                .circular(12),
                                                      ),
                                                      child: Icon(
                                                        Icons
                                                            .visibility_outlined,
                                                        color: primaryTeal,
                                                        size: 22,
                                                      ),
                                                    ),
                                                  ),
                                                ),
                                                SizedBox(width: 8),
                                                // Botón condicional basado en si tiene coordinador asignado
                                                data.containsKey(
                                                            'coordinadorAsignado') &&
                                                        data['coordinadorAsignado'] !=
                                                            null
                                                    ? Material(
                                                        color:
                                                            Colors.transparent,
                                                        child: InkWell(
                                                          borderRadius:
                                                              BorderRadius
                                                                  .circular(12),
                                                          onTap: () {
                                                            // NUEVO: Imprimir ID cuando se quita asignación
                                                            print(
                                                                "Quitar asignación del registro: ${registro.id}");
                                                            _quitarAsignacion(
                                                                context,
                                                                registroId,
                                                                primaryTeal);
                                                          },
                                                          child: Container(
                                                            padding:
                                                                EdgeInsets.all(
                                                                    10),
                                                            decoration:
                                                                BoxDecoration(
                                                              color: Colors.red
                                                                  .withOpacity(
                                                                      0.1),
                                                              borderRadius:
                                                                  BorderRadius
                                                                      .circular(
                                                                          12),
                                                            ),
                                                            child: Icon(
                                                              Icons
                                                                  .person_remove_outlined,
                                                              color: Colors.red,
                                                              size: 22,
                                                            ),
                                                          ),
                                                        ),
                                                      )
                                                    : !data.containsKey(
                                                                'coordinadorAsignado') ||
                                                            data['coordinadorAsignado'] ==
                                                                null
                                                        ? Material(
                                                            color: Colors
                                                                .transparent,
                                                            child: InkWell(
                                                              borderRadius:
                                                                  BorderRadius
                                                                      .circular(
                                                                          12),
                                                              onTap: () {
                                                                // NUEVO: Imprimir ID cuando se asigna coordinador
                                                                print(
                                                                    "Asignar coordinador al registro: ${registro.id}");
                                                                _asignarACoordinador(
                                                                    context,
                                                                    registro);
                                                              },
                                                              child: Container(
                                                                padding:
                                                                    EdgeInsets
                                                                        .all(
                                                                            10),
                                                                decoration:
                                                                    BoxDecoration(
                                                                  color: secondaryOrange
                                                                      .withOpacity(
                                                                          0.1),
                                                                  borderRadius:
                                                                      BorderRadius
                                                                          .circular(
                                                                              12),
                                                                ),
                                                                child: Icon(
                                                                  Icons
                                                                      .person_add_alt_1_outlined,
                                                                  color:
                                                                      secondaryOrange,
                                                                  size: 22,
                                                                ),
                                                              ),
                                                            ),
                                                          )
                                                        : SizedBox(),
                                              ],
                                            ),
                                          ],
                                        ),
                                      ),
                                    ),

                                    // Información adicional para registros nuevos
                                    if (esNuevo && fechaMasReciente != null)
                                      Container(
                                        margin: EdgeInsets.symmetric(
                                            horizontal: 16),
                                        padding: EdgeInsets.all(8),
                                        decoration: BoxDecoration(
                                          color: Colors.amber.shade50,
                                          borderRadius:
                                              BorderRadius.circular(8),
                                          border: Border.all(
                                            color: Colors.amber.shade200,
                                            width: 1,
                                          ),
                                        ),
                                        child: Row(
                                          children: [
                                            Icon(
                                              Icons.schedule_outlined,
                                              size: 14,
                                              color: Colors.amber.shade700,
                                            ),
                                            SizedBox(width: 6),
                                            Text(
                                              'Asignado el: ${fechaMasReciente.day}/${fechaMasReciente.month}/${fechaMasReciente.year}',
                                              style: TextStyle(
                                                fontSize: 11,
                                                color: Colors.amber.shade700,
                                                fontWeight: FontWeight.w500,
                                              ),
                                            ),
                                            Spacer(),
                                            Container(
                                              padding: EdgeInsets.symmetric(
                                                  horizontal: 6, vertical: 2),
                                              decoration: BoxDecoration(
                                                color: diasDesdeAsignacion <= 3
                                                    ? Colors.red.shade100
                                                    : Colors.blue.shade100,
                                                borderRadius:
                                                    BorderRadius.circular(4),
                                              ),
                                              child: Text(
                                                diasDesdeAsignacion <= 3
                                                    ? 'PRIORIDAD ALTA'
                                                    : 'Seguimiento',
                                                style: TextStyle(
                                                  fontSize: 9,
                                                  fontWeight: FontWeight.bold,
                                                  color: diasDesdeAsignacion <=
                                                          3
                                                      ? Colors.red.shade700
                                                      : Colors.blue.shade700,
                                                ),
                                              ),
                                            ),
                                          ],
                                        ),
                                      ),

                                    // Botón para expandir en la parte inferior de la tarjeta
                                    Align(
                                      alignment: Alignment.centerRight,
                                      child: Padding(
                                        padding: EdgeInsets.only(
                                            right: 16, bottom: 8),
                                        child: InkWell(
                                          onTap: () {
                                            setState(() {
                                              // Invertimos el estado de expansión con el botón
                                              expandedStates[registroId] =
                                                  !expandedStates[registroId]!;
                                            });
                                          },
                                          child: Container(
                                            padding: EdgeInsets.symmetric(
                                                horizontal: 12, vertical: 4),
                                            decoration: BoxDecoration(
                                              color:
                                                  primaryTeal.withOpacity(0.1),
                                              borderRadius:
                                                  BorderRadius.circular(12),
                                            ),
                                            child: Row(
                                              mainAxisSize: MainAxisSize.min,
                                              children: [
                                                Text(
                                                  expandedStates[registroId]!
                                                      ? 'Menos'
                                                      : 'Más',
                                                  style: TextStyle(
                                                    color: primaryTeal,
                                                    fontSize: 12,
                                                    fontWeight: FontWeight.bold,
                                                  ),
                                                ),
                                                SizedBox(width: 4),
                                                Icon(
                                                  expandedStates[registroId]!
                                                      ? Icons.keyboard_arrow_up
                                                      : Icons
                                                          .keyboard_arrow_down,
                                                  size: 16,
                                                  color: primaryTeal,
                                                ),
                                              ],
                                            ),
                                          ),
                                        ),
                                      ),
                                    ),

                                    // Sección expandible
                                    if (expandedStates[registroId]!)
                                      Container(
                                        padding: EdgeInsets.all(16),
                                        decoration: BoxDecoration(
                                          color:
                                              backgroundGrey.withOpacity(0.5),
                                          borderRadius: BorderRadius.only(
                                            bottomLeft: Radius.circular(16),
                                            bottomRight: Radius.circular(16),
                                          ),
                                        ),
                                        child: Column(
                                          crossAxisAlignment:
                                              CrossAxisAlignment.start,
                                          children: [
                                            Text(
                                              'Detalles Adicionales',
                                              style: TextStyle(
                                                fontSize: 18,
                                                fontWeight: FontWeight.bold,
                                                color: primaryTeal,
                                              ),
                                            ),
                                            SizedBox(height: 16),
                                            Row(
                                              mainAxisAlignment:
                                                  MainAxisAlignment.spaceEvenly,
                                              children: [
                                                Column(
                                                  children: [
                                                    Material(
                                                      color: Colors.transparent,
                                                      child: InkWell(
                                                        borderRadius:
                                                            BorderRadius
                                                                .circular(12),
                                                        onTap: () {
                                                          // Lógica para editar registro
                                                          _editarRegistro(
                                                              context,
                                                              registro);
                                                        },
                                                        child: Container(
                                                          padding:
                                                              EdgeInsets.all(
                                                                  12),
                                                          decoration:
                                                              BoxDecoration(
                                                            color: primaryTeal
                                                                .withOpacity(
                                                                    0.1),
                                                            borderRadius:
                                                                BorderRadius
                                                                    .circular(
                                                                        12),
                                                          ),
                                                          child: Column(
                                                            children: [
                                                              Icon(
                                                                Icons
                                                                    .edit_outlined,
                                                                color:
                                                                    primaryTeal,
                                                                size: 28,
                                                              ),
                                                              SizedBox(
                                                                  height: 4),
                                                              Text(
                                                                'Editar',
                                                                style:
                                                                    TextStyle(
                                                                  color:
                                                                      primaryTeal,
                                                                  fontSize: 12,
                                                                ),
                                                              ),
                                                            ],
                                                          ),
                                                        ),
                                                      ),
                                                    ),
                                                  ],
                                                ),
                                                Column(
                                                  children: [
                                                    Material(
                                                      color: Colors.transparent,
                                                      child: InkWell(
                                                        borderRadius:
                                                            BorderRadius
                                                                .circular(12),
                                                        onTap: () {
                                                          // Lógica para cambiar ministerio o tribu
                                                          _cambiarMinisterioTribu(
                                                              context,
                                                              registro);
                                                        },
                                                        child: Container(
                                                          padding:
                                                              EdgeInsets.all(
                                                                  12),
                                                          decoration:
                                                              BoxDecoration(
                                                            color:
                                                                secondaryOrange
                                                                    .withOpacity(
                                                                        0.1),
                                                            borderRadius:
                                                                BorderRadius
                                                                    .circular(
                                                                        12),
                                                          ),
                                                          child: Column(
                                                            children: [
                                                              Icon(
                                                                Icons
                                                                    .swap_horiz_outlined,
                                                                color:
                                                                    secondaryOrange,
                                                                size: 28,
                                                              ),
                                                              SizedBox(
                                                                  height: 4),
                                                              Text(
                                                                'Cambiar',
                                                                style:
                                                                    TextStyle(
                                                                  color:
                                                                      secondaryOrange,
                                                                  fontSize: 12,
                                                                ),
                                                              ),
                                                            ],
                                                          ),
                                                        ),
                                                      ),
                                                    ),
                                                  ],
                                                ),
                                              ],
                                            ),
                                          ],
                                        ),
                                      ),
                                  ],
                                ),
                              ),

                              // Badge flotante para registros muy nuevos (0-2 días)
                              if (esNuevo && diasDesdeAsignacion <= 2)
                                Positioned(
                                  top: -5,
                                  right: -5,
                                  child: Container(
                                    padding: EdgeInsets.all(6),
                                    decoration: BoxDecoration(
                                      gradient: LinearGradient(
                                        colors: [
                                          Colors.red.shade400,
                                          Colors.red.shade600
                                        ],
                                        begin: Alignment.topLeft,
                                        end: Alignment.bottomRight,
                                      ),
                                      shape: BoxShape.circle,
                                      boxShadow: [
                                        BoxShadow(
                                          color: Colors.red.withOpacity(0.3),
                                          blurRadius: 4,
                                          offset: Offset(0, 2),
                                        ),
                                      ],
                                    ),
                                    child: Icon(
                                      Icons.priority_high,
                                      color: Colors.white,
                                      size: 12,
                                    ),
                                  ),
                                ),
                            ],
                          ),
                        );
                      },
                    );
                  },
                ),
            ],
          ),
        );
      },
    );
  }

// Agregar después de la función _editarRegistro o antes del método build
  Future<void> _cambiarMinisterioTribu(
      BuildContext context, DocumentSnapshot registro) async {
    if (context == null || registro == null) {
      print('Error: Contexto o registro nulo');
      return;
    }

    final registroId = registro.id;
    final FirebaseFirestore _firestore = FirebaseFirestore.instance;
    final Color primaryTeal = Color(0xFF038C7F);
    final Color secondaryOrange = Color(0xFFFF5722);
    final Color accentGrey = Color(0xFF78909C);

    try {
      final registroDoc =
          await _firestore.collection('registros').doc(registroId).get();
      if (!registroDoc.exists) {
        if (context.mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(
              content: Text('El registro no existe o ha sido eliminado.'),
              backgroundColor: Colors.red,
            ),
          );
        }
        return;
      }

      List<DropdownMenuItem<String>> opciones = [];
      String? opcionSeleccionada;

      try {
        opciones.addAll([
          DropdownMenuItem(
            value: 'Ministerio de Damas',
            child: _buildOption(
                'Ministerio de Damas', Icons.female, Colors.pinkAccent),
          ),
          DropdownMenuItem(
            value: 'Ministerio de Caballeros',
            child: _buildOption(
                'Ministerio de Caballeros', Icons.male, Colors.blueAccent),
          ),
          DropdownMenuItem(
            value: 'separator',
            enabled: false,
            child: Divider(thickness: 2, color: Colors.grey.shade400),
          ),
          DropdownMenuItem(
            value: 'juveniles_title',
            enabled: false,
            child: Padding(
              padding: const EdgeInsets.symmetric(vertical: 8.0),
              child: Text(
                'Tribus del Ministerio Juvenil',
                style: TextStyle(
                    fontWeight: FontWeight.bold,
                    color: primaryTeal,
                    fontSize: 16),
              ),
            ),
          ),
        ]);

        final tribusSnapshot = await _firestore
            .collection('tribus')
            .where('categoria', isEqualTo: 'Ministerio Juvenil')
            .get();

        final sortedDocs = tribusSnapshot.docs
          ..sort((a, b) => (a.data()?['nombre'] as String? ?? '')
              .compareTo(b.data()?['nombre'] as String? ?? ''));

        for (var doc in sortedDocs) {
          final nombre = doc.data()?['nombre'] ?? 'Sin nombre';
          opciones.add(DropdownMenuItem(
            value: doc.id,
            child: _buildOption(nombre, Icons.people, primaryTeal),
          ));
        }

        if (opciones.length <= 4 && context.mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(
              content:
                  Text('No hay tribus juveniles disponibles para asignar.'),
              backgroundColor: Colors.orange,
            ),
          );
          return;
        }

        // Obtener el valor actual para preseleccionar
        final data = registroDoc.data() as Map<String, dynamic>?;
        if (data == null) {
          if (context.mounted) {
            ScaffoldMessenger.of(context).showSnackBar(
              SnackBar(
                content: Text(
                    'Error: No se pudieron cargar los datos del registro.'),
                backgroundColor: Colors.red,
              ),
            );
          }
          return;
        }

        final ministerioActual = data['ministerioAsignado'] as String?;
        final tribuActual = data['tribuAsignada'] as String?;

        if (ministerioActual != null &&
            ministerioActual.contains('Ministerio')) {
          opcionSeleccionada = ministerioActual;
        } else if (tribuActual != null) {
          opcionSeleccionada = tribuActual;
        }

        if (!context.mounted) return;

        await showDialog(
          context: context,
          barrierDismissible: false,
          builder: (context) {
            return StatefulBuilder(
              builder: (context, setState) {
                return AlertDialog(
                  shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(20)),
                  title: Row(
                    children: [
                      Icon(Icons.swap_horiz, color: primaryTeal),
                      SizedBox(width: 10),
                      Expanded(
                        child: Text(
                          'Cambiar Ministerio o Tribu',
                          style: TextStyle(
                              fontWeight: FontWeight.bold, color: primaryTeal),
                        ),
                      ),
                    ],
                  ),
                  content: Container(
                    width: double.maxFinite,
                    child: Column(
                      mainAxisSize: MainAxisSize.min,
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(
                          'Seleccione el nuevo ministerio o tribu para:',
                          style: TextStyle(fontSize: 14, color: accentGrey),
                        ),
                        SizedBox(height: 5),
                        Text(
                          '${data['nombre'] ?? ''} ${data['apellido'] ?? ''}',
                          style: TextStyle(
                            fontSize: 16,
                            fontWeight: FontWeight.bold,
                            color: secondaryOrange,
                          ),
                        ),
                        SizedBox(height: 15),
                        Text(
                          'Asignación actual:',
                          style: TextStyle(fontSize: 14, color: accentGrey),
                        ),
                        SizedBox(height: 5),
                        Container(
                          padding: EdgeInsets.all(10),
                          decoration: BoxDecoration(
                            color: primaryTeal.withOpacity(0.1),
                            borderRadius: BorderRadius.circular(10),
                            border:
                                Border.all(color: primaryTeal.withOpacity(0.3)),
                          ),
                          child: Row(
                            children: [
                              Icon(
                                ministerioActual?.contains('Damas') == true
                                    ? Icons.female
                                    : ministerioActual
                                                ?.contains('Caballeros') ==
                                            true
                                        ? Icons.male
                                        : Icons.people,
                                color: primaryTeal,
                              ),
                              SizedBox(width: 10),
                              Expanded(
                                child: Text(
                                  ministerioActual == null
                                      ? 'Sin asignación'
                                      : tribuActual != null
                                          ? 'Ministerio Juvenil - ${data['nombreTribu'] ?? 'Tribu sin nombre'}'
                                          : ministerioActual.contains('Damas')
                                              ? 'Ministerio de Damas'
                                              : ministerioActual
                                                      .contains('Caballeros')
                                                  ? 'Ministerio de Caballeros'
                                                  : ministerioActual,
                                  style: TextStyle(color: primaryTeal),
                                ),
                              ),
                            ],
                          ),
                        ),
                        SizedBox(height: 20),
                        DropdownButtonFormField<String>(
                          value: opcionSeleccionada,
                          items: opciones,
                          onChanged: (value) {
                            if (value != null &&
                                value != 'separator' &&
                                value != 'juveniles_title') {
                              setState(() {
                                opcionSeleccionada = value;
                              });
                            }
                          },
                          decoration: InputDecoration(
                            labelText: 'Nueva asignación',
                            border: OutlineInputBorder(
                              borderRadius: BorderRadius.circular(12),
                              borderSide: BorderSide(color: primaryTeal),
                            ),
                            focusedBorder: OutlineInputBorder(
                              borderRadius: BorderRadius.circular(12),
                              borderSide:
                                  BorderSide(color: primaryTeal, width: 2),
                            ),
                            labelStyle: TextStyle(color: primaryTeal),
                            prefixIcon:
                                Icon(Icons.swap_horiz, color: primaryTeal),
                          ),
                          isExpanded: true,
                        ),
                      ],
                    ),
                  ),
                  actions: [
                    TextButton(
                      onPressed: () => Navigator.pop(context),
                      child: Text(
                        'Cancelar',
                        style: TextStyle(color: accentGrey),
                      ),
                    ),
                    ElevatedButton(
                      style: ElevatedButton.styleFrom(
                        backgroundColor: primaryTeal,
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(10),
                        ),
                      ),
                      onPressed: opcionSeleccionada == null
                          ? null
                          : () async {
                              try {
                                // Mostrar confirmación antes de realizar el cambio
                                String mensajeConfirmacion =
                                    opcionSeleccionada!.contains('Ministerio')
                                        ? opcionSeleccionada!
                                        : 'Ministerio Juvenil - ' +
                                            await _obtenerNombreTribu(
                                                opcionSeleccionada!);

                                bool confirmar = await _mostrarConfirmacion(
                                  context,
                                  'Confirmar cambio',
                                  '¿Está seguro de cambiar a "$mensajeConfirmacion"?',
                                  primaryTeal,
                                  secondaryOrange,
                                );

                                if (confirmar) {
                                  Navigator.pop(context);
                                  if (context.mounted) {
                                    // ✅ LLAMAR A LA FUNCIÓN CORREGIDA
                                    await _procesarCambioAsignacionCorregida(
                                        context,
                                        registroId,
                                        opcionSeleccionada!,
                                        primaryTeal,
                                        _firestore,
                                        tribusSnapshot);
                                  }
                                }
                              } catch (e) {
                                if (context.mounted) {
                                  ScaffoldMessenger.of(context).showSnackBar(
                                    SnackBar(
                                      content: Text(
                                          'Error al procesar la confirmación: ${e.toString()}'),
                                      backgroundColor: Colors.red,
                                    ),
                                  );
                                }
                              }
                            },
                      child: Padding(
                        padding:
                            EdgeInsets.symmetric(horizontal: 10, vertical: 5),
                        child: Text('Cambiar'),
                      ),
                    ),
                  ],
                );
              },
            );
          },
        );
      } catch (e) {
        if (context.mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(
              content: Text('Error al cargar las opciones: ${e.toString()}'),
              backgroundColor: Colors.red,
            ),
          );
        }
      }
    } catch (e) {
      if (context.mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Error inesperado: ${e.toString()}'),
            backgroundColor: Colors.red,
          ),
        );
      }
    }
  }

// ✅ FUNCIÓN NUEVA CORREGIDA: Procesa el cambio de asignación correctamente
  Future<void> _procesarCambioAsignacionCorregida(
    BuildContext context,
    String registroId,
    String seleccion,
    Color primaryTeal,
    FirebaseFirestore firestore,
    QuerySnapshot tribusSnapshot,
  ) async {
    try {
      print('=== INICIO PROCESAMIENTO CAMBIO ASIGNACIÓN ===');
      print('Registro ID: $registroId');
      print('Selección: $seleccion');

      // ✅ LÓGICA CORREGIDA: Determinar datos de asignación
      String? ministerioAsignado;
      String? tribuAsignada;
      String? nombreTribu;

      if (seleccion.contains('Ministerio')) {
        // Es un ministerio directo (Damas o Caballeros)
        ministerioAsignado = seleccion;
        tribuAsignada = null;
        nombreTribu = null;
      } else {
        // Es una tribu del Ministerio Juvenil
        ministerioAsignado = 'Ministerio Juvenil'; // ✅ CORRECCIÓN PRINCIPAL
        tribuAsignada = seleccion;

        // Obtener el nombre de la tribu
        try {
          final tribuDoc = tribusSnapshot.docs.firstWhere(
            (doc) => doc.id == seleccion,
            orElse: () => throw Exception('Tribu no encontrada en snapshot'),
          );
          nombreTribu = tribuDoc['nombre'] ?? 'Tribu sin nombre';
        } catch (e) {
          // Si no se encuentra en el snapshot, consultar directamente
          final tribuDocDirecto =
              await firestore.collection('tribus').doc(seleccion).get();
          if (tribuDocDirecto.exists) {
            nombreTribu =
                tribuDocDirecto.data()?['nombre'] ?? 'Tribu sin nombre';
          } else {
            nombreTribu = 'Tribu sin nombre';
          }
        }
      }

      print('Ministerio a asignar: $ministerioAsignado');
      print('Tribu a asignar: $tribuAsignada');
      print('Nombre tribu: $nombreTribu');

      // ✅ PREPARAR DATOS DE ACTUALIZACIÓN
      Map<String, dynamic> updateData = {
        'ministerioAsignado': ministerioAsignado,
        'tribuAsignada': tribuAsignada,
        'fechaAsignacion': FieldValue.serverTimestamp(),
        // Limpiar campos relacionados con coordinador y timoteo
        'coordinadorAsignado': null,
        'timoteoAsignado': null,
        'nombreTimoteo': null,
      };

      // Agregar o limpiar nombreTribu según corresponda
      if (nombreTribu != null) {
        updateData['nombreTribu'] = nombreTribu;
      } else {
        updateData['nombreTribu'] = null;
      }

      print('Datos a actualizar: $updateData');

      // ✅ ACTUALIZAR EN FIRESTORE
      await firestore
          .collection('registros')
          .doc(registroId)
          .update(updateData);

      // ✅ VERIFICACIÓN POST-ACTUALIZACIÓN
      await Future.delayed(Duration(milliseconds: 500));
      final docVerificacion =
          await firestore.collection('registros').doc(registroId).get();

      if (docVerificacion.exists) {
        final data = docVerificacion.data() as Map<String, dynamic>;
        print('=== VERIFICACIÓN POST-ACTUALIZACIÓN ===');
        print('ministerioAsignado guardado: ${data['ministerioAsignado']}');
        print('tribuAsignada guardada: ${data['tribuAsignada']}');
        print('nombreTribu guardado: ${data['nombreTribu']}');
        print('=======================================');
      }

      // ✅ MOSTRAR MENSAJE DE ÉXITO
      if (context.mounted) {
        String mensajeExito;
        if (ministerioAsignado != null && tribuAsignada != null) {
          mensajeExito =
              '✅ Cambiado a tribu "$nombreTribu" del $ministerioAsignado';
        } else if (ministerioAsignado != null) {
          mensajeExito = '✅ Cambiado al $ministerioAsignado';
        } else {
          mensajeExito = '✅ Asignación cambiada exitosamente';
        }

        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Row(
              children: [
                Icon(Icons.check_circle, color: Colors.white),
                SizedBox(width: 10),
                Expanded(child: Text(mensajeExito)),
              ],
            ),
            backgroundColor: Colors.green,
            behavior: SnackBarBehavior.floating,
            shape: RoundedRectangleBorder(
              borderRadius: BorderRadius.circular(10),
            ),
            margin: EdgeInsets.all(12),
            duration: Duration(seconds: 4),
          ),
        );
      }

      print('=== FIN PROCESAMIENTO EXITOSO ===');
    } catch (e) {
      print('❌ ERROR en _procesarCambioAsignacionCorregida: $e');
      print('Stack trace: ${StackTrace.current}');

      if (context.mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Row(
              children: [
                Icon(Icons.error_outline, color: Colors.white),
                SizedBox(width: 10),
                Expanded(
                  child: Text('❌ Error al cambiar asignación: ${e.toString()}'),
                ),
              ],
            ),
            backgroundColor: Colors.red,
            behavior: SnackBarBehavior.floating,
            shape: RoundedRectangleBorder(
              borderRadius: BorderRadius.circular(10),
            ),
            margin: EdgeInsets.all(12),
            duration: Duration(seconds: 4),
          ),
        );
      }
    }
  }

  Future<bool> _mostrarConfirmacion(
    BuildContext context,
    String titulo,
    String mensaje,
    Color primaryColor,
    Color secondaryColor,
  ) async {
    if (context == null) {
      print('Error: Contexto nulo en mostrarConfirmacion');
      return false;
    }

    bool resultado = false;

    try {
      await showDialog(
        context: context,
        builder: (dialogContext) {
          if (dialogContext == null) return Container();

          return AlertDialog(
            shape:
                RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
            title: Row(
              children: [
                Icon(Icons.help_outline, color: primaryColor),
                SizedBox(width: 10),
                Text(titulo,
                    style: TextStyle(
                        fontWeight: FontWeight.bold, color: primaryColor)),
              ],
            ),
            content: Text(mensaje ?? 'Confirmar acción'),
            actions: [
              TextButton(
                onPressed: () {
                  resultado = false;
                  Navigator.pop(dialogContext);
                },
                child: Text('Cancelar', style: TextStyle(color: Colors.grey)),
              ),
              ElevatedButton(
                style: ElevatedButton.styleFrom(
                  backgroundColor: primaryColor,
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(10),
                  ),
                ),
                onPressed: () {
                  resultado = true;
                  Navigator.pop(dialogContext);
                },
                child: Text('Confirmar'),
              ),
            ],
          );
        },
      );
    } catch (e) {
      print('Error en diálogo de confirmación: $e');
      return false;
    }

    return resultado;
  }

  Future<String> _obtenerNombreTribu(String tribuId) async {
    if (tribuId == null || tribuId.isEmpty) {
      return 'Tribu sin nombre';
    }

    try {
      final doc = await FirebaseFirestore.instance
          .collection('tribus')
          .doc(tribuId)
          .get();
      if (doc.exists && doc.data() != null) {
        return doc.data()?['nombre'] ?? 'Tribu sin nombre';
      }
    } catch (e) {
      print('Error al obtener nombre de tribu: $e');
    }
    return 'Tribu sin nombre';
  }

  Future<void> _procesarCambioAsignacion(
    BuildContext context,
    String registroId,
    String opcionSeleccionada,
    Color primaryColor,
  ) async {
    if (context == null || registroId == null || opcionSeleccionada == null) {
      print('Error: Parámetros nulos en _procesarCambioAsignacion');
      return;
    }

    final FirebaseFirestore _firestore = FirebaseFirestore.instance;
    BuildContext? dialogContext;

    // Mostrar indicador de carga y capturar su contexto
    if (!context.mounted) return;

    showDialog(
      context: context,
      barrierDismissible: false,
      builder: (loadingContext) {
        dialogContext = loadingContext; // Guardar el contexto del diálogo
        return Center(
          child: CircularProgressIndicator(color: primaryColor),
        );
      },
    );

    try {
      Map<String, dynamic> datosActualizacion = {
        'tribuAsignada': null,
        'ministerioAsignado': null,
        'coordinadorAsignado': null,
        'timoteoAsignado': null,
        'nombreTimoteo': null,
        'fechaAsignacion': FieldValue.serverTimestamp(),
      };

      String mensajeExito = '';

      if (opcionSeleccionada.contains('Ministerio')) {
        // Es un ministerio
        datosActualizacion['ministerioAsignado'] = opcionSeleccionada;
        datosActualizacion['tribuAsignada'] = null;
        datosActualizacion['nombreTribu'] = null;
        mensajeExito =
            'Registro asignado a "$opcionSeleccionada" correctamente';
      } else {
        // Es una tribu
        datosActualizacion['ministerioAsignado'] = 'Ministerio Juvenil';
        datosActualizacion['tribuAsignada'] = opcionSeleccionada;

        String nombreTribu = 'Sin nombre';
        try {
          // Obtener el nombre de la tribu
          final tribuDoc = await _firestore
              .collection('tribus')
              .doc(opcionSeleccionada)
              .get();
          if (tribuDoc.exists && tribuDoc.data() != null) {
            nombreTribu = tribuDoc.data()?['nombre'] ?? 'Sin nombre';
          }
        } catch (e) {
          print('Error al obtener nombre de tribu: $e');
        }

        datosActualizacion['nombreTribu'] = nombreTribu;
        mensajeExito =
            'Registro asignado a "Ministerio Juvenil - $nombreTribu" correctamente';
      }

      // Realizar la actualización
      await _firestore
          .collection('registros')
          .doc(registroId)
          .update(datosActualizacion);

      // Cerrar el diálogo de carga siempre, usando el contexto específico del diálogo
      if (dialogContext != null && Navigator.canPop(dialogContext!)) {
        Navigator.pop(dialogContext!);
      }

      // Mostrar mensaje de éxito
      if (context.mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Row(
              children: [
                Icon(Icons.check_circle, color: Colors.white),
                SizedBox(width: 8),
                Text(mensajeExito),
              ],
            ),
            backgroundColor: Colors.green,
            duration: Duration(seconds: 2),
          ),
        );
      }
    } catch (e) {
      print('Error en _procesarCambioAsignacion: $e');

      // Cerrar el diálogo de carga siempre, usando el contexto específico del diálogo
      if (dialogContext != null && Navigator.canPop(dialogContext!)) {
        Navigator.pop(dialogContext!);
      } else {
        // Intento alternativo de cierre
        try {
          if (context.mounted) {
            Navigator.of(context, rootNavigator: true).pop();
          }
        } catch (navError) {
          print('Error al cerrar diálogo alternativo: $navError');
        }
      }

      // Mostrar error
      if (context.mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Error al cambiar asignación: ${e.toString()}'),
            backgroundColor: Colors.red,
            duration: Duration(seconds: 3),
          ),
        );
      }
    }
  }

// Agregar esta función para cerrar el diálogo de forma segura
  void _cerrarDialogo(BuildContext context) {
    if (context.mounted && Navigator.canPop(context)) {
      try {
        Navigator.of(context, rootNavigator: true).pop();
      } catch (e) {
        print('Error al cerrar diálogo: $e');
      }
    }
  }

  Widget _buildOption(String title, IconData icon, Color color) {
    return Row(
      children: [
        Icon(icon ?? Icons.error_outline, color: color),
        SizedBox(width: 10),
        Text(title ?? 'Opción', style: TextStyle(fontSize: 16)),
      ],
    );
  }

// Widget para campos de texto con animación y mejor diseño
  Widget _buildAnimatedTextField({
    required String label,
    required IconData icon,
    required TextEditingController controller,
    required Color primaryColor,
    required Function(String) onChanged,
  }) {
    // Asegurar que el controlador nunca sea nulo
    final TextEditingController safeController =
        controller ?? TextEditingController();

    return Padding(
      padding: const EdgeInsets.only(bottom: 16.0),
      child: AnimatedContainer(
        duration: const Duration(milliseconds: 300),
        child: TextField(
          controller: safeController,
          onChanged: onChanged,
          decoration: InputDecoration(
            labelText: label,
            labelStyle: TextStyle(
              color: primaryColor.withOpacity(0.8),
              fontWeight: FontWeight.w500,
            ),
            prefixIcon: Icon(icon, color: primaryColor),
            border: OutlineInputBorder(
              borderRadius: BorderRadius.circular(12),
              borderSide: BorderSide(color: primaryColor.withOpacity(0.3)),
            ),
            enabledBorder: OutlineInputBorder(
              borderRadius: BorderRadius.circular(12),
              borderSide: BorderSide(color: primaryColor.withOpacity(0.5)),
            ),
            focusedBorder: OutlineInputBorder(
              borderRadius: BorderRadius.circular(12),
              borderSide: BorderSide(color: primaryColor, width: 2),
            ),
            filled: true,
            fillColor: Colors.white,
            contentPadding:
                const EdgeInsets.symmetric(horizontal: 20, vertical: 16),
          ),
          style: const TextStyle(fontSize: 16),
        ),
      ),
    );
  }

// Widget para campos de texto con animación y opciones predefinidas
  Widget _buildAnimatedTextFieldConOpciones({
    required String label,
    required IconData icon,
    required TextEditingController controller,
    required Color primaryColor,
    required List<String> opciones,
    required Function(String) onChanged,
  }) {
    final TextEditingController safeController =
        controller ?? TextEditingController();

    return Padding(
      padding: const EdgeInsets.only(bottom: 16.0),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          AnimatedContainer(
            duration: const Duration(milliseconds: 300),
            child: TextField(
              controller: safeController,
              onChanged: onChanged,
              decoration: InputDecoration(
                labelText: label,
                labelStyle: TextStyle(
                  color: primaryColor.withOpacity(0.8),
                  fontWeight: FontWeight.w500,
                ),
                prefixIcon: Icon(icon, color: primaryColor),
                border: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(12),
                  borderSide: BorderSide(color: primaryColor.withOpacity(0.3)),
                ),
                enabledBorder: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(12),
                  borderSide: BorderSide(color: primaryColor.withOpacity(0.5)),
                ),
                focusedBorder: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(12),
                  borderSide: BorderSide(color: primaryColor, width: 2),
                ),
                filled: true,
                fillColor: Colors.white,
                contentPadding:
                    const EdgeInsets.symmetric(horizontal: 20, vertical: 16),
              ),
              style: const TextStyle(fontSize: 16),
            ),
          ),
          SizedBox(height: 12),
          Container(
            padding: EdgeInsets.all(12),
            decoration: BoxDecoration(
              color: primaryColor.withOpacity(0.05),
              borderRadius: BorderRadius.circular(12),
              border: Border.all(
                color: primaryColor.withOpacity(0.2),
                width: 1,
              ),
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Row(
                  children: [
                    Icon(
                      Icons.touch_app_outlined,
                      size: 14,
                      color: primaryColor,
                    ),
                    SizedBox(width: 6),
                    Text(
                      'Opciones rápidas:',
                      style: TextStyle(
                        fontWeight: FontWeight.w500,
                        color: primaryColor,
                        fontSize: 13,
                      ),
                    ),
                  ],
                ),
                SizedBox(height: 8),
                Wrap(
                  spacing: 6,
                  runSpacing: 6,
                  children: opciones.map((opcion) {
                    return ActionChip(
                      label: Text(
                        opcion,
                        style: TextStyle(
                          color: primaryColor,
                          fontWeight: FontWeight.w500,
                          fontSize: 12,
                        ),
                      ),
                      onPressed: () {
                        safeController.text = opcion;
                        onChanged(opcion);
                      },
                      backgroundColor: Colors.white,
                      side: BorderSide(
                        color: primaryColor.withOpacity(0.3),
                        width: 1.5,
                      ),
                      padding: EdgeInsets.symmetric(
                        horizontal: 8,
                        vertical: 4,
                      ),
                      elevation: 0,
                      pressElevation: 2,
                      shadowColor: primaryColor.withOpacity(0.3),
                    );
                  }).toList(),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

// Widget para campos de selección dropdown con mejor manejo de nulos
  Widget _buildDropdownField({
    required String label,
    required IconData icon,
    required String? value,
    required List<String> items,
    required Color primaryColor,
    required Function(String?) onChanged,
  }) {
    // Asegurar que value no sea nulo
    final String safeValue = value ?? (items.isNotEmpty ? items[0] : '');

    return Padding(
      padding: const EdgeInsets.only(bottom: 16.0),
      child: Container(
        decoration: BoxDecoration(
          borderRadius: BorderRadius.circular(12),
          border: Border.all(color: primaryColor.withOpacity(0.5)),
        ),
        child: Padding(
          padding: const EdgeInsets.symmetric(horizontal: 12.0),
          child: Row(
            children: [
              Icon(icon, color: primaryColor),
              SizedBox(width: 12),
              Expanded(
                child: DropdownButtonHideUnderline(
                  child: DropdownButton<String>(
                    value: items.contains(safeValue)
                        ? safeValue
                        : (items.isNotEmpty ? items[0] : null),
                    hint: Text(
                      'Seleccionar $label',
                      style: TextStyle(color: Colors.grey),
                    ),
                    icon: Icon(Icons.arrow_drop_down, color: primaryColor),
                    isExpanded: true,
                    onChanged: onChanged,
                    style: TextStyle(
                      color: Colors.black87,
                      fontSize: 16,
                    ),
                    dropdownColor: Colors.white,
                    items: items.map<DropdownMenuItem<String>>((String value) {
                      return DropdownMenuItem<String>(
                        value: value,
                        child: Padding(
                          padding: const EdgeInsets.symmetric(vertical: 8.0),
                          child: Text(value),
                        ),
                      );
                    }).toList(),
                  ),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

// Función para formatear nombres de campos
  String _formatFieldName(String fieldName) {
    // Convertir camelCase a palabras separadas y capitalizar
    final formattedName = fieldName.replaceAllMapped(
        RegExp(r'([A-Z])'), (match) => ' ${match.group(0)}');

    return formattedName[0].toUpperCase() + formattedName.substring(1);
  }

// Manejador para inicializar Firebase Messaging de manera segura
  Future<void> initializeFirebaseMessaging() async {
    try {
      // Comprobar si Firebase Messaging está disponible
      if (FirebaseMessaging.instance != null) {
        // Solicitar permisos de manera silenciosa, sin mostrar pop-up si es posible
        NotificationSettings settings =
            await FirebaseMessaging.instance.requestPermission(
          alert: true,
          announcement: false,
          badge: true,
          carPlay: false,
          criticalAlert: false,
          provisional: true, // Usar notificaciones provisionales para iOS
          sound: true,
        );

        // Solo intentar obtener el token si el usuario ha dado permiso
        if (settings.authorizationStatus == AuthorizationStatus.authorized ||
            settings.authorizationStatus == AuthorizationStatus.provisional) {
          // Obtener token de manera segura
          try {
            String? token = await FirebaseMessaging.instance.getToken();
            if (token != null) {
              print('Token FCM: $token');
              // Guardar el token en algún lugar si es necesario
            }
          } catch (e) {
            print('Error al obtener token FCM: $e');
            // No mostrar error al usuario, manejar silenciosamente
          }
        } else {
          print(
              'Permisos de notificación no concedidos: ${settings.authorizationStatus}');
          // No mostrar error al usuario, manejar silenciosamente
        }
      }
    } catch (e) {
      print('Error al inicializar Firebase Messaging: $e');
      // No mostrar error al usuario, manejar silenciosamente
    }
  }

  void _quitarAsignacion(
      BuildContext context, String registroId, Color primaryTeal) async {
    // Mostrar diálogo de confirmación
    bool confirmar = await showDialog(
          context: context,
          builder: (BuildContext context) {
            return AlertDialog(
              title: Text(
                "Confirmar",
                style: TextStyle(
                  color: primaryTeal,
                  fontWeight: FontWeight.bold,
                ),
              ),
              content: Text(
                "¿Estás seguro de quitar la asignación del coordinador?",
                style: TextStyle(fontSize: 16),
              ),
              actions: [
                TextButton(
                  child: Text(
                    "Cancelar",
                    style: TextStyle(color: Colors.grey),
                  ),
                  onPressed: () {
                    Navigator.of(context).pop(false);
                  },
                ),
                TextButton(
                  child: Text(
                    "Confirmar",
                    style: TextStyle(
                        color: primaryTeal, fontWeight: FontWeight.bold),
                  ),
                  onPressed: () {
                    Navigator.of(context).pop(true);
                  },
                ),
              ],
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(16),
              ),
            );
          },
        ) ??
        false;

    if (confirmar) {
      try {
        await FirebaseFirestore.instance
            .collection('registros')
            .doc(registroId)
            .update({
          'coordinadorAsignado': null,
          'coordinadorNombre': null,
          'timoteoAsignado': null,
        });

        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(
              "Se ha quitado la asignación correctamente",
              style: TextStyle(color: Colors.white),
            ),
            backgroundColor: primaryTeal,
            behavior: SnackBarBehavior.floating,
            shape: RoundedRectangleBorder(
              borderRadius: BorderRadius.circular(10),
            ),
            margin: EdgeInsets.all(10),
          ),
        );
      } catch (e) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(
              "Error al quitar la asignación: ${e.toString()}",
              style: TextStyle(color: Colors.white),
            ),
            backgroundColor: Colors.red,
            behavior: SnackBarBehavior.floating,
            shape: RoundedRectangleBorder(
              borderRadius: BorderRadius.circular(10),
            ),
            margin: EdgeInsets.all(10),
          ),
        );
      }
    }
  }

  void _mostrarDetallesRegistro(
    BuildContext context,
    Map<String, dynamic> data,
    Color primaryTeal,
    Color secondaryOrange,
    Color accentGrey,
    Color backgroundGrey,
  ) {
    // Función para formatear fechas
    String formatearFecha(String? fecha) {
      if (fecha == null || fecha.isEmpty) return '';

      // Si la fecha está en formato timestamp de Firestore
      if (fecha.contains('Timestamp')) {
        try {
          // Extraer los segundos del formato "Timestamp(seconds=1234567890, ...)"
          final regex = RegExp(r'seconds=(\d+)');
          final match = regex.firstMatch(fecha);
          if (match != null) {
            final seconds = int.tryParse(match.group(1) ?? '');
            if (seconds != null) {
              final date = DateTime.fromMillisecondsSinceEpoch(seconds * 1000);
              return '${date.day}/${date.month}/${date.year}';
            }
          }
        } catch (e) {
          // Si hay error en la conversión, devolver la fecha original
          return fecha;
        }
      }

      // Intentar parsear otras fechas comunes
      try {
        final date = DateTime.parse(fecha);
        return '${date.day}/${date.month}/${date.year}';
      } catch (e) {
        // Si no es parseable, devolver el texto original
        return fecha;
      }
    }

    int? calcularEdadDesdeData(Map<String, dynamic> data) {
      try {
        DateTime? fechaNacimiento;

        if (data.containsKey('fechaNacimiento')) {
          var value = data['fechaNacimiento'];

          // ✅ VALIDACIÓN: Si es null, retornar null inmediatamente
          if (value == null) {
            return null;
          }

          if (value is Timestamp) {
            fechaNacimiento = value.toDate();
          } else if (value is String && value.isNotEmpty) {
            // Manejar formato Timestamp en string
            if (value.contains('Timestamp')) {
              final regex = RegExp(r'seconds=(\d+)');
              final match = regex.firstMatch(value);
              if (match != null) {
                final seconds = int.tryParse(match.group(1) ?? '');
                if (seconds != null) {
                  fechaNacimiento =
                      DateTime.fromMillisecondsSinceEpoch(seconds * 1000);
                }
              }
            } else {
              try {
                fechaNacimiento = DateTime.parse(value);
              } catch (e) {
                print('⚠️ Error al parsear fecha: $e');
                return null;
              }
            }
          }

          // ✅ VALIDACIÓN ADICIONAL: Verificar que fechaNacimiento no sea null
          if (fechaNacimiento != null) {
            final hoy = DateTime.now();
            int edad = hoy.year - fechaNacimiento.year;

            // Ajustar si aún no ha cumplido años este año
            if (hoy.month < fechaNacimiento.month ||
                (hoy.month == fechaNacimiento.month &&
                    hoy.day < fechaNacimiento.day)) {
              edad--;
            }

            return edad;
          }
        }
        return null;
      } catch (e) {
        print('❌ Error en calcularEdadDesdeData: $e');
        return null;
      }
    }

// ✅ FUNCIÓN CORREGIDA 2: Calcular próximo cumpleaños con manejo robusto de null
    String? calcularProximoCumpleanosDesdeData(Map<String, dynamic> data) {
      try {
        DateTime? fechaNacimiento;

        if (data.containsKey('fechaNacimiento')) {
          var value = data['fechaNacimiento'];

          // ✅ VALIDACIÓN: Si es null, retornar null inmediatamente
          if (value == null) {
            return null;
          }

          if (value is Timestamp) {
            fechaNacimiento = value.toDate();
          } else if (value is String && value.isNotEmpty) {
            // Manejar formato Timestamp en string
            if (value.contains('Timestamp')) {
              final regex = RegExp(r'seconds=(\d+)');
              final match = regex.firstMatch(value);
              if (match != null) {
                final seconds = int.tryParse(match.group(1) ?? '');
                if (seconds != null) {
                  fechaNacimiento =
                      DateTime.fromMillisecondsSinceEpoch(seconds * 1000);
                }
              }
            } else {
              try {
                fechaNacimiento = DateTime.parse(value);
              } catch (e) {
                print('⚠️ Error al parsear fecha: $e');
                return null;
              }
            }
          }

          // ✅ VALIDACIÓN ADICIONAL: Verificar que fechaNacimiento no sea null
          if (fechaNacimiento != null) {
            final hoy = DateTime.now();
            DateTime proximoCumpleanos =
                DateTime(hoy.year, fechaNacimiento.month, fechaNacimiento.day);

            if (proximoCumpleanos.isBefore(hoy) ||
                proximoCumpleanos.isAtSameMomentAs(hoy)) {
              proximoCumpleanos = DateTime(
                  hoy.year + 1, fechaNacimiento.month, fechaNacimiento.day);
            }

            final diferencia = proximoCumpleanos.difference(hoy).inDays;

            if (diferencia == 0) {
              return '¡Hoy es su cumpleaños! 🎉';
            } else if (diferencia == 1) {
              return 'Mañana (1 día)';
            } else if (diferencia <= 7) {
              return 'En $diferencia días';
            } else if (diferencia <= 30) {
              return 'En $diferencia días';
            } else {
              final double mesesDouble = diferencia / 30;
              final int meses = mesesDouble.floor();
              if (meses == 1) {
                return 'En aproximadamente 1 mes';
              } else {
                return 'En aproximadamente $meses meses';
              }
            }
          }
        }
        return null;
      } catch (e) {
        print('❌ Error en calcularProximoCumpleanosDesdeData: $e');
        return null;
      }
    }

    // Definimos una lista de secciones y campos agrupados para mejor organización
    final secciones = [
      {
        'titulo': 'Información Personal',
        'icono': Icons.person_outline,
        'color': primaryTeal,
        'campos': [
          {'key': 'nombre', 'label': 'Nombre', 'icon': Icons.badge_outlined},
          {
            'key': 'apellido',
            'label': 'Apellido',
            'icon': Icons.badge_outlined
          },
          {
            'key': 'telefono',
            'label': 'Teléfono',
            'icon': Icons.phone_outlined
          },
          {
            'key': 'edad',
            'label': 'Edad',
            'icon': Icons.calendar_today_outlined
          },
          {'key': 'sexo', 'label': 'Sexo', 'icon': Icons.wc_outlined},
          {
            'key': 'estadoCivil',
            'label': 'Estado Civil',
            'icon': Icons.favorite_border
          },
          {
            'key': 'tieneHijos',
            'label': 'Tiene Hijos',
            'icon': Icons.child_care_outlined
          },
          {
            'key': 'nombrePareja',
            'label': 'Nombre Pareja',
            'icon': Icons.people_outline
          },
        ]
      },
      {
        'titulo': 'Información de Cumpleaños',
        'icono': Icons.celebration_outlined,
        'color': secondaryOrange, // Color naranja para cumpleaños
        'campos': [
          {
            'key': 'fechaNacimiento',
            'label': 'Fecha de Nacimiento',
            'icon': Icons.cake_outlined,
            'esFecha': true
          },
          {
            'key': 'edad',
            'label': 'Edad Actual',
            'icon': Icons.timeline_outlined,
            'esEdadCalculada':
                true // Nueva propiedad para identificar campos calculados
          },
          {
            'key': 'proximoCumpleanos',
            'label': 'Próximo Cumpleaños',
            'icon': Icons.event_available_outlined,
            'esProximoCumpleanos':
                true // Nueva propiedad para próximo cumpleaños
          },
        ]
      },
      {
        'titulo': 'Ubicación',
        'icono': Icons.location_on_outlined,
        'color': primaryTeal,
        'campos': [
          {
            'key': 'direccionBarrio',
            'label': 'Dirección/Barrio',
            'icon': Icons.home_outlined
          },
        ]
      },
      {
        'titulo': 'Ocupación',
        'icono': Icons.work_outline,
        'color': secondaryOrange,
        'campos': [
          {
            'key': 'ocupaciones',
            'label': 'Ocupaciones',
            'icon': Icons.work_outline
          },
          // MODIFICACIÓN: Aquí se detectarán ambos campos automáticamente
          {
            'keys': [
              'descripcionOcupaciones',
              'descripcionOcupacion'
            ], // Múltiples keys posibles
            'label': 'Descripción Ocupación',
            'icon': Icons.description_outlined
          },
        ]
      },
      {
        'titulo': 'Información Ministerial',
        'icono': Icons.groups_outlined,
        'color': accentGrey,
        'campos': [
          {
            'key': 'nombreTribu',
            'label': 'Tribu',
            'icon': Icons.group_outlined
          },
          {
            'key': 'ministerioAsignado',
            'label': 'Ministerio',
            'icon': Icons.assignment_ind_outlined
          },
          {
            'key': 'consolidador',
            'label': 'Consolidador',
            'icon': Icons.supervisor_account_outlined
          },
          {
            'key': 'referenciaInvitacion',
            'label': 'Ref. Invitación',
            'icon': Icons.share_outlined
          },
        ]
      },
      {
        'titulo': 'Fechas',
        'icono': Icons.event_outlined,
        'color': secondaryOrange,
        'campos': [
          {
            'key': 'fecha',
            'label': 'Registro',
            'icon': Icons.event_outlined,
            'esFecha': true
          },
          {
            'key': 'fechaAsignacion',
            'label': 'Asignación',
            'icon': Icons.date_range_outlined,
            'esFecha': true
          },
        ]
      },
      {
        'titulo': 'Notas',
        'icono': Icons.note_outlined,
        'color': accentGrey,
        'campos': [
          {
            'key': 'observaciones',
            'label': 'Observaciones',
            'icon': Icons.notes_outlined
          },
          {
            'key': 'peticiones',
            'label': 'Peticiones',
            'icon': Icons.message_outlined
          },
          {
            'key': 'estadoFonovisita',
            'label': 'Estado de Fonovisita',
            'icon': Icons.call_outlined
          },
          {
            'key': 'observaciones2',
            'label': 'Observaciones 2',
            'icon': Icons.note_add_outlined
          },
        ]
      },
      {
        'titulo': 'Estado del Proceso',
        'icono': Icons.track_changes_outlined,
        'color': secondaryOrange,
        'campos': [
          {
            'key': 'estadoProceso',
            'label': 'Estado en la Iglesia',
            'icon': Icons.verified_outlined
          },
        ]
      },
    ];

    // Crear lista de widgets para el contenido del diálogo
    List<Widget> contenidoWidgets = [];

    // Procesar cada sección
    for (var seccion in secciones) {
      // Filtrar solo los campos que contienen datos en esta sección
      final camposConDatos = (seccion['campos'] as List).where((campo) {
        // MODIFICACIÓN: Manejo de campos con múltiples keys posibles
        if (campo.containsKey('keys')) {
          // Para campos con múltiples keys posibles
          final keys = campo['keys'] as List<String>;
          return keys.any((key) {
            if (!data.containsKey(key)) return false;
            final value = data[key];
            if (value == null) return false;
            if (value is List) return value.isNotEmpty;
            if (value is String) return value.trim().isNotEmpty;
            return true;
          });
        } else if (campo.containsKey('esEdadCalculada') &&
            campo['esEdadCalculada'] == true) {
          // Para campos de edad calculada
          return calcularEdadDesdeData(data) != null;
        } else if (campo.containsKey('esProximoCumpleanos') &&
            campo['esProximoCumpleanos'] == true) {
          // Para campos de próximo cumpleaños
          return calcularProximoCumpleanosDesdeData(data) != null;
        } else {
          // Para campos con una sola key
          final key = campo['key'] as String;
          if (!data.containsKey(key)) return false;
          final value = data[key];
          if (value == null) return false;
          if (value is List) return value.isNotEmpty;
          if (value is String) return value.trim().isNotEmpty;
          return true;
        }
      }).toList();

      // Solo mostramos secciones con campos con datos
      if (camposConDatos.isNotEmpty) {
        // Añadir título de sección
        contenidoWidgets.add(
          Padding(
            padding: const EdgeInsets.only(top: 16.0, bottom: 8.0),
            child: Row(
              children: [
                Icon(
                  seccion['icono'] as IconData,
                  color: seccion['color'] as Color,
                  size: 20,
                ),
                SizedBox(width: 8),
                Text(
                  seccion['titulo'] as String,
                  style: TextStyle(
                    fontSize: 16,
                    fontWeight: FontWeight.w600,
                    color: seccion['color'] as Color,
                  ),
                ),
              ],
            ),
          ),
        );

        // Añadir línea separadora para el título
        contenidoWidgets.add(
          Divider(
            color: (seccion['color'] as Color).withOpacity(0.3),
            thickness: 1,
          ),
        );

        // Añadir campos de esta sección
        for (var campo in camposConDatos) {
          final label = campo['label'] as String;
          final icon = campo['icon'] as IconData;
          final esFecha = campo['esFecha'] as bool? ?? false;

          // Obtener el valor considerando múltiples keys posibles y campos calculados
          String textoValor = '';
          // NUEVA LÓGICA: Manejar campos calculados especiales
          if (campo.containsKey('esEdadCalculada') &&
              campo['esEdadCalculada'] == true) {
            // Campo de edad calculada
            final edadCalculada = calcularEdadDesdeData(data);
            if (edadCalculada != null) {
              textoValor = '$edadCalculada años';
            }
          } else if (campo.containsKey('esProximoCumpleanos') &&
              campo['esProximoCumpleanos'] == true) {
            // Campo de próximo cumpleaños
            final proximoCumpleanos = calcularProximoCumpleanosDesdeData(data);
            if (proximoCumpleanos != null) {
              textoValor = proximoCumpleanos;
            }
          } else if (campo.containsKey('keys')) {
            // LÓGICA ORIGINAL: Para campos con múltiples keys posibles
            final keys = campo['keys'] as List<String>;
            for (String key in keys) {
              if (data.containsKey(key) && data[key] != null) {
                var value = data[key];
                if (value is String && value.trim().isNotEmpty) {
                  textoValor = esFecha ? formatearFecha(value) : value;
                  break;
                } else if (value is List && value.isNotEmpty) {
                  textoValor = value.join(', ');
                  break;
                } else if (value is int || value is double) {
                  textoValor = value.toString();
                  break;
                } else if (value is bool) {
                  textoValor = value ? 'Sí' : 'No';
                  break;
                } else if (value != null) {
                  textoValor = esFecha
                      ? formatearFecha(value.toString())
                      : value.toString();
                  break;
                }
              }
            }
          } else {
            // LÓGICA ORIGINAL: Para campos con una sola key
            final key = campo['key'] as String;
            var value = data[key];
            if (esFecha) {
              textoValor = formatearFecha(value?.toString());
            } else if (value is List) {
              textoValor = (value as List).join(', ');
            } else if (value is int || value is double) {
              textoValor = value.toString();
            } else if (value is bool) {
              textoValor = value ? 'Sí' : 'No';
            } else {
              textoValor = value?.toString() ?? '';
            }
          }

          // Añadir widget de detalle solo si hay texto para mostrar
          if (textoValor.isNotEmpty) {
            contenidoWidgets.add(
              _buildDetalle(label, textoValor, icon, accentGrey, primaryTeal),
            );
          }
        }
      }
    }

    // Si no hay datos para mostrar, mostrar mensaje
    if (contenidoWidgets.isEmpty) {
      contenidoWidgets.add(
        Padding(
          padding: const EdgeInsets.all(16.0),
          child: Center(
            child: Column(
              children: [
                Icon(
                  Icons.info_outline,
                  size: 48,
                  color: accentGrey,
                ),
                SizedBox(height: 16),
                Text(
                  'No hay información disponible',
                  style: TextStyle(
                    fontSize: 16,
                    color: accentGrey,
                  ),
                ),
              ],
            ),
          ),
        ),
      );
    }

    // Mostrar el diálogo
    showDialog(
      context: context,
      builder: (context) => Dialog(
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(20),
        ),
        elevation: 5,
        backgroundColor: backgroundGrey,
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            // Encabezado del diálogo
            Container(
              padding: EdgeInsets.all(16),
              decoration: BoxDecoration(
                color: primaryTeal,
                borderRadius: BorderRadius.only(
                  topLeft: Radius.circular(20),
                  topRight: Radius.circular(20),
                ),
              ),
              child: Row(
                children: [
                  Container(
                    padding: EdgeInsets.all(8),
                    decoration: BoxDecoration(
                      color: Colors.white.withOpacity(0.2),
                      shape: BoxShape.circle,
                    ),
                    child: Icon(
                      Icons.person_outline,
                      color: Colors.white,
                      size: 24,
                    ),
                  ),
                  SizedBox(width: 12),
                  Expanded(
                    child: Text(
                      'Detalles del Registro',
                      style: TextStyle(
                        color: Colors.white,
                        fontWeight: FontWeight.bold,
                        fontSize: 18,
                      ),
                      overflow: TextOverflow.ellipsis,
                    ),
                  ),
                  Material(
                    color: Colors.transparent,
                    child: InkWell(
                      onTap: () => Navigator.pop(context),
                      borderRadius: BorderRadius.circular(50),
                      child: Padding(
                        padding: const EdgeInsets.all(4.0),
                        child: Icon(
                          Icons.close,
                          color: Colors.white,
                          size: 22,
                        ),
                      ),
                    ),
                  ),
                ],
              ),
            ),

            // Contenido con scrolling
            Container(
              constraints: BoxConstraints(
                maxHeight: MediaQuery.of(context).size.height * 0.7,
              ),
              child: SingleChildScrollView(
                child: Padding(
                  padding: const EdgeInsets.all(16.0),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    mainAxisSize: MainAxisSize.min,
                    children: contenidoWidgets,
                  ),
                ),
              ),
            ),

            // Pie del diálogo
            Padding(
              padding: const EdgeInsets.all(16.0),
              child: Row(
                mainAxisAlignment: MainAxisAlignment.end,
                children: [
                  ElevatedButton(
                    onPressed: () => Navigator.pop(context),
                    style: ElevatedButton.styleFrom(
                      backgroundColor: primaryTeal,
                      foregroundColor: Colors.white,
                      elevation: 0,
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(12),
                      ),
                      padding:
                          EdgeInsets.symmetric(horizontal: 16, vertical: 12),
                    ),
                    child: Row(
                      mainAxisSize: MainAxisSize.min,
                      children: [
                        Icon(Icons.check_circle_outline, size: 18),
                        SizedBox(width: 8),
                        Text('Cerrar'),
                      ],
                    ),
                  ),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildDetalle(String label, String value, IconData iconData,
      Color accentGrey, Color primaryTeal) {
    // Detectar si el campo es "Teléfono" para agregar funcionalidad de copiado
    final esTelefono = label.toLowerCase().contains('teléfono') ||
        label.toLowerCase().contains('telefono');

    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 8.0),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Container(
            padding: EdgeInsets.all(6),
            decoration: BoxDecoration(
              color: primaryTeal.withOpacity(0.1),
              borderRadius: BorderRadius.circular(8),
            ),
            child: Icon(
              iconData,
              size: 16,
              color: primaryTeal,
            ),
          ),
          SizedBox(width: 12),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  label,
                  style: TextStyle(
                    fontSize: 13,
                    color: accentGrey,
                    fontWeight: FontWeight.w500,
                  ),
                ),
                SizedBox(height: 4),
                // Si es teléfono, mostrar en un Row con el botón de copiar
                esTelefono
                    ? Row(
                        children: [
                          Expanded(
                            child: Text(
                              value,
                              style: TextStyle(
                                fontSize: 15,
                                color: Colors.black87,
                                height: 1.3,
                              ),
                            ),
                          ),
                          SizedBox(width: 8),
                          // Botón para copiar el teléfono usando Builder para obtener context
                          Builder(
                            builder: (BuildContext builderContext) {
                              return Material(
                                color: Colors.transparent,
                                child: InkWell(
                                  onTap: () async {
                                    // Copiar al portapapeles
                                    await Clipboard.setData(
                                        ClipboardData(text: value));

                                    // Mostrar feedback visual
                                    ScaffoldMessenger.of(builderContext)
                                        .showSnackBar(
                                      SnackBar(
                                        content: Row(
                                          children: [
                                            Icon(
                                              Icons.check_circle_outline,
                                              color: Colors.white,
                                              size: 20,
                                            ),
                                            SizedBox(width: 12),
                                            Expanded(
                                              child: Text(
                                                '¡Teléfono copiado!',
                                                style: TextStyle(
                                                  fontSize: 14,
                                                  fontWeight: FontWeight.w500,
                                                ),
                                              ),
                                            ),
                                          ],
                                        ),
                                        backgroundColor: primaryTeal,
                                        behavior: SnackBarBehavior.floating,
                                        shape: RoundedRectangleBorder(
                                          borderRadius:
                                              BorderRadius.circular(10),
                                        ),
                                        margin: EdgeInsets.all(12),
                                        duration: Duration(seconds: 2),
                                      ),
                                    );
                                  },
                                  borderRadius: BorderRadius.circular(8),
                                  child: Container(
                                    padding: EdgeInsets.all(8),
                                    decoration: BoxDecoration(
                                      gradient: LinearGradient(
                                        colors: [
                                          primaryTeal.withOpacity(0.8),
                                          primaryTeal,
                                        ],
                                        begin: Alignment.topLeft,
                                        end: Alignment.bottomRight,
                                      ),
                                      borderRadius: BorderRadius.circular(8),
                                      boxShadow: [
                                        BoxShadow(
                                          color: primaryTeal.withOpacity(0.3),
                                          blurRadius: 4,
                                          offset: Offset(0, 2),
                                        ),
                                      ],
                                    ),
                                    child: Icon(
                                      Icons.content_copy_rounded,
                                      size: 16,
                                      color: Colors.white,
                                    ),
                                  ),
                                ),
                              );
                            },
                          ),
                        ],
                      )
                    : Text(
                        value,
                        style: TextStyle(
                          fontSize: 15,
                          color: Colors.black87,
                          height: 1.3,
                        ),
                      ),
              ],
            ),
          ),
        ],
      ),
    );
  }

// ✅ NUEVO: Widget helper para crear dropdowns de filtro
  Widget _buildDropdownFiltro({
    required String label,
    required IconData icon,
    required String? value,
    required List<String> items,
    required Function(String?) onChanged,
    required Color primaryTeal,
    required Color accentGrey,
    String Function(String)? itemBuilder,
  }) {
    return Container(
      decoration: BoxDecoration(
        borderRadius: BorderRadius.circular(10),
        border: Border.all(
          color: value != null && value != 'Todos'
              ? primaryTeal
              : accentGrey.withOpacity(0.3),
          width: value != null && value != 'Todos' ? 2 : 1,
        ),
      ),
      child: DropdownButtonFormField<String>(
        value: value,
        decoration: InputDecoration(
          labelText: label,
          labelStyle: TextStyle(
            color: value != null && value != 'Todos' ? primaryTeal : accentGrey,
            fontSize: 13,
            fontWeight: value != null && value != 'Todos'
                ? FontWeight.w600
                : FontWeight.normal,
          ),
          prefixIcon: Icon(
            icon,
            color: value != null && value != 'Todos' ? primaryTeal : accentGrey,
            size: 20,
          ),
          border: InputBorder.none,
          contentPadding: EdgeInsets.symmetric(horizontal: 12, vertical: 8),
        ),
        icon: Icon(
          Icons.arrow_drop_down,
          color: primaryTeal,
        ),
        dropdownColor: Colors.white,
        isExpanded: true,
        items: items.map((item) {
          return DropdownMenuItem<String>(
            value: item,
            child: Text(
              itemBuilder != null ? itemBuilder(item) : item,
              style: TextStyle(
                fontSize: 14,
                fontWeight: item == value ? FontWeight.w600 : FontWeight.normal,
                color: item == 'Todos' ? accentGrey : Colors.black87,
              ),
            ),
          );
        }).toList(),
        onChanged: onChanged,
      ),
    );
  }

// 🆕 MÉTODOS AUXILIARES PARA EL PANEL DE FILTROS

  /// Verifica si hay filtros activos
  bool _hayFiltrosActivos() {
    return (_tipoBusqueda == 'nombre' && _searchTerm.isNotEmpty) ||
        (_tipoBusqueda == 'estado' && _searchEstadoTerm.isNotEmpty) ||
        _anioSeleccionado != null ||
        _mesSeleccionado != null;
  }

  /// Cuenta cuántos filtros están activos
  int _contarFiltrosActivos() {
    int count = 0;
    if (_tipoBusqueda == 'nombre' && _searchTerm.isNotEmpty) count++;
    if (_tipoBusqueda == 'estado' && _searchEstadoTerm.isNotEmpty) count++;
    if (_anioSeleccionado != null) count++;
    if (_mesSeleccionado != null) count++;
    return count;
  }

  /// Obtiene un texto descriptivo de los filtros activos
  String _obtenerTextoFiltrosActivos() {
    List<String> filtros = [];

    if (_tipoBusqueda == 'nombre' && _searchTerm.isNotEmpty) {
      filtros.add('Nombre: "$_searchTerm"');
    }
    if (_tipoBusqueda == 'estado' && _searchEstadoTerm.isNotEmpty) {
      filtros.add('Estado: "$_searchEstadoTerm"');
    }
    if (_anioSeleccionado != null) {
      filtros.add('Año: $_anioSeleccionado');
    }
    if (_mesSeleccionado != null) {
      final mesesNombres = {
        '1': 'Ene',
        '2': 'Feb',
        '3': 'Mar',
        '4': 'Abr',
        '5': 'May',
        '6': 'Jun',
        '7': 'Jul',
        '8': 'Ago',
        '9': 'Sep',
        '10': 'Oct',
        '11': 'Nov',
        '12': 'Dic'
      };
      filtros.add('Mes: ${mesesNombres[_mesSeleccionado]}');
    }

    if (filtros.isEmpty) {
      return 'Sin filtros aplicados • Toca para expandir';
    }

    return filtros.join(' • ');
  }
}

///------------------------------

//--------------------------PESTAÑA DE ASISTENCIA

class AsistenciasTab extends StatefulWidget {
  final String tribuId;
  final String tribuNombre;

  const AsistenciasTab({
    Key? key,
    required this.tribuId,
    required this.tribuNombre, // ✅ AGREGADO
  }) : super(key: key);

  @override
  State<AsistenciasTab> createState() => _AsistenciasTabState();
}

class _AsistenciasTabState extends State<AsistenciasTab>
    with SingleTickerProviderStateMixin {
  // ⬅️ NUEVO: Mixin para TabController

  // ========================================
  // NUEVAS VARIABLES PARA EL SISTEMA DE PESTAÑAS
  // ========================================
  late TabController _tabController;

  // ========================================
  // VARIABLES DE ESTADO ORIGINALES
  // ========================================
  final Map<String, bool> _servicioExpand = {};
  Map<String, Map<String, Map<String, List<Map<String, dynamic>>>>>?
      _cachedDataAsistencias; // ⬅️ NUEVO: Caché separado para asistencias
  Map<String, Map<String, Map<String, List<Map<String, dynamic>>>>>?
      _cachedDataFallas; // ⬅️ NUEVO: Caché separado para fallas
  bool _isFirstLoadAsistencias = true; // ⬅️ NUEVO: Control de carga por pestaña
  bool _isFirstLoadFallas = true; // ⬅️ NUEVO

  // ========================================
  // INICIALIZACIÓN DEL TabController
  // ========================================
  @override
  void initState() {
    super.initState();
    _tabController = TabController(length: 3, vsync: this);
  }

  // ========================================
  // LIMPIEZA DEL TabController
  // ========================================
  @override
  void dispose() {
    _tabController.dispose();
    super.dispose();
  }

  // ========================================
  // FUNCIÓN MODIFICADA: Ahora recibe parámetro para filtrar
  // true = asistencias, false = fallas
  // ========================================

// ========================================
// MÉTODOS AUXILIARES PARA NOMBRES DE SERVICIOS
// ========================================
  String _displayServiceName(String serviceName) {
    // Reemplazar "Dominical" por "Familiar" solo para mostrar
    if (serviceName.toLowerCase().contains('dominical')) {
      return serviceName.replaceAll(
          RegExp(r'dominical', caseSensitive: false), 'Familiar');
    }
    // Reemplazar "Reunión General" por "Servicio Especial" solo para mostrar
    if (serviceName.toLowerCase().contains('reunión general') ||
        serviceName.toLowerCase().contains('reunion general')) {
      return serviceName.replaceAll(
          RegExp(r'reuni[óo]n general', caseSensitive: false),
          'Servicio Especial');
    }
    return serviceName;
  }

  String _normalizeServiceName(String serviceName) {
    // Normalizar para comparación: aceptar tanto "Dominical" como "Familiar"
    if (serviceName.toLowerCase().contains('familiar')) {
      return serviceName.replaceAll(
          RegExp(r'familiar', caseSensitive: false), 'Dominical');
    }
    return serviceName;
  }

  Stream<QuerySnapshot> obtenerAsistenciasPorTribu(
      String tribuId, bool mostrarAsistencias) {
    return FirebaseFirestore.instance
        .collection('asistencias')
        .where('tribuId', isEqualTo: tribuId)
        .where('asistio',
            isEqualTo: mostrarAsistencias) // ⬅️ MODIFICADO: Filtro dinámico
        .snapshots();
  }

  @override
  Widget build(BuildContext context) {
    return Column(
      children: [
        // ========================================
        // NUEVO: BARRA DE PESTAÑAS
        // ========================================
        Container(
          decoration: BoxDecoration(
            color: Colors.white,
            boxShadow: [
              BoxShadow(
                color: Colors.black.withOpacity(0.05),
                blurRadius: 4,
                offset: Offset(0, 2),
              ),
            ],
          ),
          child: TabBar(
            controller: _tabController,
            labelColor: const Color(0xFF1D8A8A),
            unselectedLabelColor: Colors.grey[600],
            indicatorColor: const Color(0xFF1D8A8A),
            indicatorWeight: 3,
            labelStyle: TextStyle(
              fontWeight: FontWeight.bold,
              fontSize: 15,
            ),
            unselectedLabelStyle: TextStyle(
              fontWeight: FontWeight.w500,
              fontSize: 15,
            ),
            tabs: [
              Tab(
                icon: Icon(Icons.check_circle_outline),
                text: 'Asistencias',
              ),
              Tab(
                icon: Icon(Icons.cancel_outlined),
                text: 'Inasistencias',
              ),
            ],
          ),
        ),

        // ========================================
        // NUEVO: CONTENIDO DE LAS PESTAÑAS
        // ========================================
        Expanded(
          child: TabBarView(
            controller: _tabController,
            children: [
              // Pestaña 1: Asistencias (asistio = true)
              _buildContenidoAsistencias(true),

              // Pestaña 2: Fallas (asistio = false)
              _buildContenidoAsistencias(false),
            ],
          ),
        ),
      ],
    );
  }

  // ========================================
  // NUEVA FUNCIÓN: Construye el contenido para cada pestaña
  // Parámetro: mostrarAsistencias (true/false)
  // ========================================

// ========================================
// NUEVA FUNCIÓN OPTIMIZADA: Construye el contenido para cada pestaña
// ========================================
  Widget _buildContenidoAsistencias(bool mostrarAsistencias) {
    // ⬅️ OPTIMIZACIÓN: Determinar qué caché y control usar
    final cachedData =
        mostrarAsistencias ? _cachedDataAsistencias : _cachedDataFallas;
    final isFirstLoad =
        mostrarAsistencias ? _isFirstLoadAsistencias : _isFirstLoadFallas;

    return StreamBuilder<QuerySnapshot>(
      stream: obtenerAsistenciasPorTribu(widget.tribuId, mostrarAsistencias),
      builder: (context, snapshot) {
        // ⬅️ OPTIMIZACIÓN: Si ya hay caché, mostrarlo inmediatamente
        if (cachedData != null && cachedData.isNotEmpty) {
          return _buildListaConDatos(cachedData, mostrarAsistencias);
        }

        // Manejo de carga inicial
        if (snapshot.connectionState == ConnectionState.waiting &&
            isFirstLoad) {
          return Center(
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                SizedBox(
                  height: 60,
                  width: 60,
                  child: CircularProgressIndicator(
                    valueColor: AlwaysStoppedAnimation<Color>(
                      mostrarAsistencias
                          ? const Color(0xFF1D8A8A)
                          : const Color(0xFFE74C3C),
                    ),
                    strokeWidth: 4,
                  ),
                ),
                SizedBox(height: 16),
                Text(
                  mostrarAsistencias
                      ? 'Cargando asistencias...'
                      : 'Cargando inasistencias...',
                  style: TextStyle(
                    fontSize: 16,
                    color: mostrarAsistencias
                        ? const Color(0xFF1D8A8A)
                        : const Color(0xFFE74C3C),
                    fontWeight: FontWeight.w500,
                  ),
                ),
              ],
            ),
          );
        }

        // Manejo de datos vacíos
        if ((!snapshot.hasData || snapshot.data!.docs.isEmpty) && isFirstLoad) {
          // ⬅️ OPTIMIZACIÓN: Actualizar control de primera carga
          WidgetsBinding.instance.addPostFrameCallback((_) {
            if (mounted) {
              setState(() {
                if (mostrarAsistencias) {
                  _isFirstLoadAsistencias = false;
                } else {
                  _isFirstLoadFallas = false;
                }
              });
            }
          });

          return _buildMensajeVacio(mostrarAsistencias, true);
        }

        // Procesamiento de datos
        if (snapshot.hasData && snapshot.data!.docs.isNotEmpty) {
          // ⬅️ OPTIMIZACIÓN: Procesar y cachear datos
          final asistencias = snapshot.data!.docs.map((doc) {
            final data = doc.data() as Map<String, dynamic>;
            final nombre = data['nombre'] ?? "Sin nombre";
            final apellido = data['apellido'] ?? '';
            final nombreCompleto =
                apellido.isNotEmpty ? "$nombre $apellido" : nombre;

            return {
              'nombre': nombre,
              'nombreCompleto': nombreCompleto,
              'fecha': (data['fecha'] as Timestamp).toDate(),
              'diaSemana': data['diaSemana'] ?? '',
              'asistio': data['asistio'],
              'nombreServicio': data['nombreServicio'] ?? '',
              'ministerio': _determinarMinisterio(data['nombreServicio'] ?? ''),
            };
          }).toList();

          final datosAgrupados = _agruparAsistenciasPorFecha(asistencias);

          // ⬅️ OPTIMIZACIÓN: Guardar en caché correspondiente
          WidgetsBinding.instance.addPostFrameCallback((_) {
            if (mounted) {
              setState(() {
                if (mostrarAsistencias) {
                  _cachedDataAsistencias = datosAgrupados;
                  _isFirstLoadAsistencias = false;
                } else {
                  _cachedDataFallas = datosAgrupados;
                  _isFirstLoadFallas = false;
                }
              });
            }
          });

          return _buildListaConDatos(datosAgrupados, mostrarAsistencias);
        }

        return _buildMensajeVacio(mostrarAsistencias, true);
      },
    );
  }

// ========================================
// FUNCIÓN CORREGIDA: Construye la lista con datos
// ========================================
  Widget _buildListaConDatos(
    Map<String, Map<String, Map<String, List<Map<String, dynamic>>>>>
        asistenciasAgrupadas,
    bool mostrarAsistencias,
  ) {
    if (asistenciasAgrupadas.isEmpty) {
      return _buildMensajeVacio(mostrarAsistencias, false);
    }

    return Container(
      decoration: BoxDecoration(
        gradient: LinearGradient(
          begin: Alignment.topCenter,
          end: Alignment.bottomCenter,
          colors: mostrarAsistencias
              ? [
                  Colors.white,
                  const Color(0xFF1D8A8A).withOpacity(0.05),
                ]
              : [
                  Colors.white,
                  const Color(0xFFE74C3C).withOpacity(0.05),
                ],
        ),
      ),
      child: ListView.builder(
        // ⬅️ REMOVIDO: PageStorageKey que causaba el error
        padding: EdgeInsets.all(16),
        itemCount: asistenciasAgrupadas.keys.length,
        cacheExtent: 1000,
        itemBuilder: (context, yearIndex) {
          // Ordenar años de más reciente a más antiguo
          final yearsOrdenados = asistenciasAgrupadas.keys.toList()
            ..sort((a, b) => int.parse(b).compareTo(int.parse(a)));
          final year = yearsOrdenados[yearIndex];
          final months = asistenciasAgrupadas[year]!;

          return Card(
            elevation: 4,
            margin: EdgeInsets.only(bottom: 20),
            shape: RoundedRectangleBorder(
              borderRadius: BorderRadius.circular(16),
            ),
            clipBehavior: Clip.antiAlias,
            child: Column(
              children: [
                Container(
                  decoration: BoxDecoration(
                    gradient: LinearGradient(
                      begin: Alignment.topLeft,
                      end: Alignment.bottomRight,
                      colors: mostrarAsistencias
                          ? [
                              const Color(0xFF1D8A8A),
                              const Color(0xFF156D6D),
                            ]
                          : [
                              const Color(0xFFE74C3C),
                              const Color(0xFFC0392B),
                            ],
                    ),
                  ),
                  child: Theme(
                    data: Theme.of(context).copyWith(
                      dividerColor: Colors.transparent,
                      colorScheme: ColorScheme.light(
                        primary: Colors.white,
                      ),
                    ),
                    child: ExpansionTile(
                      // ⬅️ CORREGIDO: Key único sin conflictos
                      key: ValueKey(
                          'year_${year}_${mostrarAsistencias ? "asist" : "fallas"}'),
                      maintainState: true,
                      leading: Container(
                        padding: EdgeInsets.all(8),
                        decoration: BoxDecoration(
                          color: Colors.white.withOpacity(0.2),
                          shape: BoxShape.circle,
                        ),
                        child: Icon(
                          Icons.calendar_today,
                          color: Colors.white,
                          size: 20,
                        ),
                      ),
                      title: Text(
                        'Año $year',
                        style: TextStyle(
                          fontSize: 18,
                          fontWeight: FontWeight.bold,
                          color: Colors.white,
                        ),
                      ),
                      subtitle: Text(
                        mostrarAsistencias
                            ? 'Registro de asistencias'
                            : 'Registro de inasistencias',
                        style: TextStyle(
                          fontSize: 12,
                          color: Colors.white.withOpacity(0.8),
                        ),
                      ),
                      iconColor: Colors.white,
                      collapsedIconColor: Colors.white,
                      childrenPadding:
                          EdgeInsets.symmetric(vertical: 12, horizontal: 8),
                      children: (() {
                        final sortedMonths = months.keys.toList()
                          ..sort((a, b) =>
                              _monthToNumber(a).compareTo(_monthToNumber(b)));

                        final ordered = sortedMonths.map((month) {
                          return _buildMonthSection(context, month,
                              months[month]!, year, mostrarAsistencias);
                        }).toList();

                        return ordered.reversed.toList();
                      })(),
                    ),
                  ),
                ),
              ],
            ),
          );
        },
      ),
    );
  }

  Widget _buildMonthSection(
      BuildContext context,
      String month,
      Map<String, List<Map<String, dynamic>>> weeks,
      String year,
      bool mostrarAsistencias) {
    final monthName = _getSpanishMonth(month);
    final IconData monthIcon = _getMonthIcon(month);

    return Card(
      margin: EdgeInsets.symmetric(horizontal: 16, vertical: 10),
      elevation: 2,
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.circular(12),
        side: BorderSide(
          color: (mostrarAsistencias
                  ? const Color(0xFF1D8A8A)
                  : const Color(0xFFE74C3C))
              .withOpacity(0.2),
          width: 1,
        ),
      ),
      child: Container(
        decoration: BoxDecoration(
          borderRadius: BorderRadius.circular(12),
          gradient: LinearGradient(
            begin: Alignment.topRight,
            end: Alignment.bottomLeft,
            colors: mostrarAsistencias
                ? [
                    Colors.white,
                    const Color(0xFF1D8A8A).withOpacity(0.08),
                  ]
                : [
                    Colors.white,
                    const Color(0xFFE74C3C).withOpacity(0.08),
                  ],
          ),
        ),
        child: ExpansionTile(
          maintainState: true,
          leading: Container(
            padding: EdgeInsets.all(8),
            decoration: BoxDecoration(
              gradient: LinearGradient(
                begin: Alignment.topLeft,
                end: Alignment.bottomRight,
                colors: mostrarAsistencias
                    ? [
                        const Color(0xFF1D8A8A),
                        const Color(0xFF1D8A8A).withOpacity(0.7),
                      ]
                    : [
                        const Color(0xFFE74C3C),
                        const Color(0xFFE74C3C).withOpacity(0.7),
                      ],
              ),
              borderRadius: BorderRadius.circular(12),
            ),
            child: Icon(
              monthIcon,
              color: Colors.white,
              size: 20,
            ),
          ),
          title: Text(
            monthName,
            style: TextStyle(
              fontSize: 16,
              fontWeight: FontWeight.w600,
              color: mostrarAsistencias
                  ? const Color(0xFF1D8A8A)
                  : const Color(0xFFE74C3C),
            ),
          ),
          subtitle: Text(
            'Toca para ver semanas',
            style: TextStyle(
              fontSize: 12,
              color: Colors.grey[600],
            ),
          ),
          iconColor: mostrarAsistencias
              ? const Color(0xFF1D8A8A)
              : const Color(0xFFE74C3C),
          collapsedIconColor: mostrarAsistencias
              ? const Color(0xFF1D8A8A)
              : const Color(0xFFE74C3C),
          children: (() {
            // ✅ CORRECCIÓN: Ordenar las semanas por la fecha del MARTES de cada semana
            final sortedWeeks = weeks.entries.toList()
              ..sort((a, b) {
                // Obtener la fecha real del primer registro de cada semana
                final fechaA = a.value.isNotEmpty
                    ? a.value.first['fecha'] as DateTime
                    : DateTime.now();
                final fechaB = b.value.isNotEmpty
                    ? b.value.first['fecha'] as DateTime
                    : DateTime.now();

                // Obtener el MARTES de cada semana para comparar
                final martesA = _obtenerLunesDeLaSemana(fechaA);
                final martesB = _obtenerLunesDeLaSemana(fechaB);

                // Comparar las fechas completas del martes
                return martesA.compareTo(martesB);
              });

            // Revertir para mostrar de más reciente a más antigua
            return sortedWeeks.reversed.map((entry) {
              return _buildWeekSection(
                context,
                entry.key,
                entry.value,
                '$monthName $year',
                mostrarAsistencias,
              );
            }).toList();
          })(),
        ),
      ),
    );
  }

  // ========================================
  // FUNCIÓN MODIFICADA: Ahora recibe parámetro mostrarAsistencias
  // ========================================
  Widget _buildWeekSection(
      BuildContext context,
      String week,
      List<Map<String, dynamic>> asistencias,
      String monthYear,
      bool mostrarAsistencias) {
    Map<String, List<Map<String, dynamic>>> porServicio = {};
    Map<String, Set<String>> personasPorServicio = {};
    Set<String> todasLasPersonas = {};

    for (var asistencia in asistencias) {
      final servicio = asistencia['nombreServicio'] ?? 'Otro Servicio';
      final nombre = asistencia['nombre'];

      if (!porServicio.containsKey(servicio)) {
        porServicio[servicio] = [];
        personasPorServicio[servicio] = {};
      }

      porServicio[servicio]!.add(asistencia);
      personasPorServicio[servicio]!.add(nombre);
      todasLasPersonas.add(nombre);
    }

    Map<String, int> resumen = {
      for (var servicio in porServicio.keys)
        servicio: personasPorServicio[servicio]!.length
    };
    resumen[mostrarAsistencias
        ? 'Total del Fin de Semana'
        : 'Total de Fallas'] = todasLasPersonas.length;

    return Card(
      margin: EdgeInsets.symmetric(horizontal: 12, vertical: 8),
      elevation: 0,
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.circular(12),
      ),
      color: Colors.transparent,
      child: Container(
        decoration: BoxDecoration(
          borderRadius: BorderRadius.circular(12),
          gradient: LinearGradient(
            begin: Alignment.topLeft,
            end: Alignment.bottomRight,
            colors: [
              Colors.white,
              const Color(0xFFF5A623).withOpacity(0.05),
            ],
          ),
          border: Border.all(
            color: const Color(0xFFF5A623).withOpacity(0.2),
            width: 1,
          ),
        ),
        child: ExpansionTile(
          maintainState: true,
          leading: Container(
            padding: EdgeInsets.all(8),
            decoration: BoxDecoration(
              gradient: LinearGradient(
                begin: Alignment.topLeft,
                end: Alignment.bottomRight,
                colors: [
                  const Color(0xFFF5A623),
                  const Color(0xFFFF7A00),
                ],
              ),
              borderRadius: BorderRadius.circular(10),
            ),
            child: Icon(
              Icons.date_range,
              color: Colors.white,
              size: 18,
            ),
          ),
          title: Text(
            _formatearRangoSemana(week, asistencias),
            style: TextStyle(
              fontSize: 15,
              fontWeight: FontWeight.w600,
              color: const Color(0xFFEE5A24),
            ),
          ),
          subtitle: Text(
            _obtenerRangoFechasCompleto(week, asistencias),
            style: TextStyle(
              fontSize: 12,
              color: Colors.grey[600],
            ),
          ),
          iconColor: const Color(0xFFEE5A24),
          collapsedIconColor: const Color(0xFFEE5A24),
          children: [
            // ⬅️ ORDENAR por fecha real de asistencia
            ...(() {
              // Convertir entries a lista para poder ordenar
              final serviciosList = porServicio.entries.toList();

              // Ordenar por fecha real del primer registro de asistencia
              serviciosList.sort((a, b) {
                // Obtener la primera fecha de cada servicio
                final fechaA = a.value.isNotEmpty
                    ? a.value.first['fecha'] as DateTime
                    : DateTime.now();
                final fechaB = b.value.isNotEmpty
                    ? b.value.first['fecha'] as DateTime
                    : DateTime.now();

                // Comparar por día de la semana (1=Lunes, 7=Domingo)
                final diaA = fechaA.weekday;
                final diaB = fechaB.weekday;

                return diaA.compareTo(diaB);
              });

              // Mapear a widgets
              return serviciosList.map((entry) {
                final servicio = entry.key;
                final listaAsistencias = entry.value;
                final ministerio = _determinarMinisterio(servicio);

                final groupKey = '$monthYear|$week|$servicio';

                return _buildServicioSection(
                  servicio,
                  ministerio,
                  listaAsistencias,
                  groupKey: groupKey,
                  mostrarAsistencias: mostrarAsistencias,
                );
              }).toList();
            })(),
            _buildTotalSection(resumen, mostrarAsistencias, porServicio),
          ],
        ),
      ),
    );
  }

  Widget _buildServicioSection(
    String servicio,
    String ministerio,
    List<Map<String, dynamic>> asistencias, {
    required String groupKey,
    required bool mostrarAsistencias,
  }) {
    // ✅ NORMALIZAR NOMBRE DE SERVICIO PARA VISUALIZACIÓN
    final servicioNormalizado = servicio
        .replaceAll(RegExp(r'dominical', caseSensitive: false), 'Familiar')
        .replaceAll(RegExp(r'reuni[óo]n general', caseSensitive: false),
            'Servicio Especial');

    final color = _getColorByMinisterio(ministerio);
    final icon = _getIconByMinisterio(ministerio);
    final isOpen = _servicioExpand[groupKey] ?? false;

    return Container(
      margin: EdgeInsets.symmetric(horizontal: 12, vertical: 8),
      decoration: BoxDecoration(
        borderRadius: BorderRadius.circular(12),
        color: Colors.white,
        boxShadow: [
          BoxShadow(
            color: color.withOpacity(0.15),
            blurRadius: 8,
            offset: Offset(0, 3),
          ),
        ],
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          InkWell(
            borderRadius: BorderRadius.vertical(top: Radius.circular(12)),
            onTap: () {
              setState(() {
                _servicioExpand[groupKey] = !isOpen;
              });
            },
            child: Container(
              padding: EdgeInsets.symmetric(horizontal: 16, vertical: 12),
              decoration: BoxDecoration(
                gradient: LinearGradient(
                  begin: Alignment.topLeft,
                  end: Alignment.bottomRight,
                  colors: [
                    color,
                    color.withOpacity(0.8),
                  ],
                ),
                borderRadius: BorderRadius.vertical(top: Radius.circular(12)),
              ),
              child: LayoutBuilder(
                builder: (context, constraints) {
                  final screenWidth = MediaQuery.of(context).size.width;
                  final isVerySmallScreen = screenWidth < 360;
                  final isSmallScreen = screenWidth < 500;
                  final isMediumScreen =
                      screenWidth >= 500 && screenWidth < 700;

                  // Tamaños adaptativos
                  final iconSize =
                      isVerySmallScreen ? 16.0 : (isSmallScreen ? 18.0 : 20.0);
                  final titleFontSize = isVerySmallScreen
                      ? 12.0
                      : (isSmallScreen ? 13.0 : (isMediumScreen ? 14.0 : 16.0));
                  final subtitleFontSize = isVerySmallScreen
                      ? 9.0
                      : (isSmallScreen ? 10.0 : (isMediumScreen ? 11.0 : 12.0));
                  final countFontSize = isVerySmallScreen
                      ? 11.0
                      : (isSmallScreen ? 12.0 : (isMediumScreen ? 13.0 : 14.0));
                  final badgePadding =
                      isVerySmallScreen ? 6.0 : (isSmallScreen ? 8.0 : 10.0);
                  final iconPadding =
                      isVerySmallScreen ? 4.0 : (isSmallScreen ? 6.0 : 8.0);
                  final spacing =
                      isVerySmallScreen ? 6.0 : (isSmallScreen ? 8.0 : 12.0);
                  final expandIconSize =
                      isVerySmallScreen ? 18.0 : (isSmallScreen ? 20.0 : 24.0);

                  return Row(
                    children: [
                      Container(
                        padding: EdgeInsets.all(iconPadding),
                        decoration: BoxDecoration(
                          color: Colors.white.withOpacity(0.3),
                          borderRadius: BorderRadius.circular(10),
                        ),
                        child: Icon(
                          icon,
                          color: Colors.white,
                          size: iconSize,
                        ),
                      ),
                      SizedBox(width: spacing),
                      Expanded(
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          mainAxisSize: MainAxisSize.min,
                          children: [
                            Text(
                              servicioNormalizado,
                              style: TextStyle(
                                fontSize: titleFontSize,
                                fontWeight: FontWeight.bold,
                                color: Colors.white,
                                height: 1.2,
                              ),
                              maxLines: 2,
                              overflow: TextOverflow.ellipsis,
                              softWrap: true,
                            ),
                            SizedBox(height: 2),
                            Text(
                              ministerio,
                              style: TextStyle(
                                fontSize: subtitleFontSize,
                                color: Colors.white.withOpacity(0.85),
                                height: 1.2,
                              ),
                              maxLines: 2,
                              overflow: TextOverflow.ellipsis,
                              softWrap: true,
                            ),
                          ],
                        ),
                      ),
                      SizedBox(width: 6),
                      Container(
                        padding: EdgeInsets.symmetric(
                          horizontal: badgePadding,
                          vertical: badgePadding * 0.6,
                        ),
                        decoration: BoxDecoration(
                          color: Colors.white,
                          borderRadius: BorderRadius.circular(20),
                        ),
                        child: Text(
                          '${asistencias.length}',
                          style: TextStyle(
                            color: color,
                            fontWeight: FontWeight.bold,
                            fontSize: countFontSize,
                          ),
                        ),
                      ),
                      SizedBox(width: 6),
                      AnimatedRotation(
                        turns: isOpen ? 0.5 : 0.0,
                        duration: Duration(milliseconds: 200),
                        child: Icon(
                          Icons.expand_more,
                          color: Colors.white,
                          size: expandIconSize,
                        ),
                      ),
                    ],
                  );
                },
              ),
            ),
          ),
          AnimatedCrossFade(
            firstChild: SizedBox.shrink(),
            secondChild: asistencias.isNotEmpty
                ? _buildListaAsistencias(asistencias, color, mostrarAsistencias)
                : _buildMensajeVacio(mostrarAsistencias, false),
            crossFadeState:
                isOpen ? CrossFadeState.showSecond : CrossFadeState.showFirst,
            duration: Duration(milliseconds: 200),
            sizeCurve: Curves.easeInOutCubic,
            firstCurve: Curves.easeOut,
            secondCurve: Curves.easeIn,
          ),
        ],
      ),
    );
  }

  // ========================================
  // FUNCIÓN MODIFICADA: Ahora recibe parámetro mostrarAsistencias
  // Cambia el ícono final (check verde para asistencias, X roja para fallas)
  // ========================================
  Widget _buildListaAsistencias(
    List<Map<String, dynamic>> asistencias,
    Color color,
    bool mostrarAsistencias, // ⬅️ NUEVO PARÁMETRO
  ) {
    return ListView.builder(
      shrinkWrap: true,
      physics: NeverScrollableScrollPhysics(),
      addAutomaticKeepAlives: true,
      addRepaintBoundaries: true,
      cacheExtent: 0,
      itemCount: asistencias.length,
      padding: EdgeInsets.symmetric(vertical: 8),
      itemBuilder: (context, index) {
        final asistencia = asistencias[index];
        final nombreMostrado = asistencia['nombreCompleto'] ??
            asistencia['nombre'] ??
            'Sin nombre';
        final inicialNombre = nombreMostrado.toString().isNotEmpty
            ? nombreMostrado.toString()[0].toUpperCase()
            : '?';

        return LayoutBuilder(
          builder: (context, constraints) {
            final isNarrow = constraints.maxWidth < 400;

            return Container(
              margin: EdgeInsets.symmetric(
                vertical: 4,
                horizontal: isNarrow ? 6 : 8,
              ),
              decoration: BoxDecoration(
                color: Colors.grey.withOpacity(0.05),
                borderRadius: BorderRadius.circular(10),
              ),
              child: ListTile(
                dense: isNarrow,
                contentPadding: EdgeInsets.symmetric(
                  horizontal: isNarrow ? 8 : 16,
                  vertical: isNarrow ? 4 : 8,
                ),
                leading: Container(
                  width: isNarrow ? 35 : 40,
                  height: isNarrow ? 35 : 40,
                  decoration: BoxDecoration(
                    gradient: LinearGradient(
                      begin: Alignment.topLeft,
                      end: Alignment.bottomRight,
                      colors: [
                        color.withOpacity(0.8),
                        color.withOpacity(0.6),
                      ],
                    ),
                    shape: BoxShape.circle,
                  ),
                  child: Center(
                    child: Text(
                      inicialNombre,
                      style: TextStyle(
                        color: Colors.white,
                        fontWeight: FontWeight.bold,
                        fontSize: isNarrow ? 14 : 16,
                      ),
                    ),
                  ),
                ),
                title: Text(
                  nombreMostrado,
                  style: TextStyle(
                    fontWeight: FontWeight.w600,
                    fontSize: isNarrow ? 13 : 14,
                    color: Colors.black87,
                  ),
                ),
                subtitle: Row(
                  children: [
                    Icon(
                      Icons.event,
                      size: isNarrow ? 10 : 12,
                      color: Colors.grey[600],
                    ),
                    SizedBox(width: 4),
                    Expanded(
                      child: Text(
                        DateFormat('EEEE, d MMM', 'es')
                            .format(asistencia['fecha']),
                        style: TextStyle(
                          color: Colors.grey[600],
                          fontSize: isNarrow ? 11 : 12,
                        ),
                        overflow: TextOverflow.ellipsis,
                      ),
                    ),
                  ],
                ),
                // ⬅️ MODIFICADO: Ícono diferente según el tipo
                trailing: Container(
                  padding: EdgeInsets.all(isNarrow ? 3 : 4),
                  decoration: BoxDecoration(
                    color: (mostrarAsistencias ? Colors.green : Colors.red)
                        .withOpacity(0.1),
                    shape: BoxShape.circle,
                  ),
                  child: Icon(
                    mostrarAsistencias
                        ? Icons.check_circle_rounded
                        : Icons.cancel_rounded, // ⬅️ X roja para fallas
                    color: mostrarAsistencias ? Colors.green : Colors.red,
                    size: isNarrow ? 18 : 20,
                  ),
                ),
              ),
            );
          },
        );
      },
    );
  }

// ========================================
// FUNCIÓN MODIFICADA: Ahora recibe parámetro adicional
// ========================================
  Widget _buildMensajeVacio(bool mostrarAsistencias, bool isInCenter) {
    final widget = Container(
      padding: EdgeInsets.all(20),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Icon(
            Icons.info_outline,
            color: Colors.grey[400],
            size: 20,
          ),
          SizedBox(width: 10),
          Text(
            mostrarAsistencias
                ? 'No hay asistencias registradas'
                : 'No hay inasistencias registradas',
            style: TextStyle(
              color: Colors.grey[500],
              fontStyle: FontStyle.italic,
              fontSize: 14,
            ),
          ),
        ],
      ),
    );

    if (!isInCenter) return widget;

    return Center(
      child: Container(
        padding: EdgeInsets.symmetric(horizontal: 24, vertical: 32),
        decoration: BoxDecoration(
          color: Colors.white,
          borderRadius: BorderRadius.circular(16),
          boxShadow: [
            BoxShadow(
              color: Colors.black.withOpacity(0.08),
              blurRadius: 10,
              offset: Offset(0, 4),
            ),
          ],
        ),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Container(
              padding: EdgeInsets.all(16),
              decoration: BoxDecoration(
                color: (mostrarAsistencias
                        ? const Color(0xFF1D8A8A)
                        : const Color(0xFFE74C3C))
                    .withOpacity(0.1),
                shape: BoxShape.circle,
              ),
              child: Icon(
                mostrarAsistencias ? Icons.event_busy : Icons.person_off,
                size: 64,
                color: mostrarAsistencias
                    ? const Color(0xFF1D8A8A)
                    : const Color(0xFFE74C3C),
              ),
            ),
            SizedBox(height: 16),
            Text(
              mostrarAsistencias
                  ? 'No hay asistencias registradas'
                  : 'No hay inasistencias registradas',
              style: TextStyle(
                fontSize: 18,
                color: mostrarAsistencias
                    ? const Color(0xFF1D8A8A)
                    : const Color(0xFFE74C3C),
                fontWeight: FontWeight.bold,
              ),
            ),
            SizedBox(height: 8),
            Text(
              mostrarAsistencias
                  ? 'Los datos de asistencia aparecerán aquí'
                  : 'Los datos de inasistencias aparecerán aquí',
              style: TextStyle(
                fontSize: 14,
                color: Colors.grey[600],
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildTotalSection(
    Map<String, int> resumen,
    bool mostrarAsistencias,
    Map<String, List<Map<String, dynamic>>> porServicio,
  ) {
    final totalKey =
        mostrarAsistencias ? 'Total del Fin de Semana' : 'Total de Fallas';
    final totalUnico = resumen[totalKey] ?? 0;

    return Container(
      margin: EdgeInsets.all(16),
      decoration: BoxDecoration(
        borderRadius: BorderRadius.circular(16),
        gradient: LinearGradient(
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
          colors: mostrarAsistencias
              ? [
                  Colors.white,
                  const Color(0xFF1D8A8A).withOpacity(0.1),
                ]
              : [
                  Colors.white,
                  const Color(0xFFE74C3C).withOpacity(0.1),
                ],
        ),
        boxShadow: [
          BoxShadow(
            color: (mostrarAsistencias
                    ? const Color(0xFF1D8A8A)
                    : const Color(0xFFE74C3C))
                .withOpacity(0.1),
            blurRadius: 8,
            offset: Offset(0, 4),
          ),
        ],
        border: Border.all(
          color: (mostrarAsistencias
                  ? const Color(0xFF1D8A8A)
                  : const Color(0xFFE74C3C))
              .withOpacity(0.3),
          width: 1,
        ),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Container(
            padding: EdgeInsets.all(16),
            decoration: BoxDecoration(
              gradient: LinearGradient(
                begin: Alignment.topLeft,
                end: Alignment.bottomRight,
                colors: mostrarAsistencias
                    ? [
                        const Color(0xFF1D8A8A),
                        const Color(0xFF156D6D),
                      ]
                    : [
                        const Color(0xFFE74C3C),
                        const Color(0xFFC0392B),
                      ],
              ),
              borderRadius: BorderRadius.vertical(top: Radius.circular(16)),
            ),
            child: LayoutBuilder(
              builder: (context, constraints) {
                final screenWidth = MediaQuery.of(context).size.width;
                final isVerySmallScreen = screenWidth < 360;
                final isSmallScreen = screenWidth < 500;
                final isMediumScreen = screenWidth >= 500 && screenWidth < 700;

                // Tamaños adaptativos
                final iconSize =
                    isVerySmallScreen ? 14.0 : (isSmallScreen ? 16.0 : 18.0);
                final titleFontSize = isVerySmallScreen
                    ? 11.0
                    : (isSmallScreen ? 12.5 : (isMediumScreen ? 14.0 : 16.0));
                final spacing =
                    isVerySmallScreen ? 6.0 : (isSmallScreen ? 8.0 : 12.0);
                final iconPadding =
                    isVerySmallScreen ? 5.0 : (isSmallScreen ? 6.0 : 8.0);

                return Row(
                  children: [
                    Container(
                      padding: EdgeInsets.all(iconPadding),
                      decoration: BoxDecoration(
                        color: Colors.white.withOpacity(0.2),
                        borderRadius: BorderRadius.circular(8),
                      ),
                      child: Icon(
                        Icons.summarize_rounded,
                        color: Colors.white,
                        size: iconSize,
                      ),
                    ),
                    SizedBox(width: spacing),

                    Expanded(
                      flex: 3,
                      child: Text(
                        mostrarAsistencias
                            ? 'Resumen de Asistencia'
                            : 'Resumen de Inasistencias',
                        style: TextStyle(
                          fontSize: titleFontSize,
                          fontWeight: FontWeight.bold,
                          color: Colors.white,
                          height: 1.2,
                          letterSpacing: isVerySmallScreen ? -0.2 : 0.0,
                        ),
                        maxLines: 3,
                        softWrap: true,
                        overflow: TextOverflow.visible,
                      ),
                    ),

                    SizedBox(width: spacing * 0.5),
                    // ✅ Botón de copiar responsivo
                    _buildBotonCopiar(
                        resumen, mostrarAsistencias, porServicio, context),
                  ],
                );
              },
            ),
          ),
          Padding(
            padding: EdgeInsets.all(16),
            child: Column(
              children: [
                ...(() {
                  final resumenList =
                      resumen.entries.where((e) => e.key != totalKey).toList();

                  resumenList.sort((a, b) {
                    final fechaA = porServicio[a.key]?.isNotEmpty == true
                        ? porServicio[a.key]!.first['fecha'] as DateTime
                        : DateTime.now();
                    final fechaB = porServicio[b.key]?.isNotEmpty == true
                        ? porServicio[b.key]!.first['fecha'] as DateTime
                        : DateTime.now();

                    return fechaA.weekday.compareTo(fechaB.weekday);
                  });

                  return resumenList
                      .map((entry) => _buildTotalRow(
                          entry.key, entry.value, mostrarAsistencias))
                      .toList();
                })(),
                SizedBox(height: 8),
                Divider(
                  height: 24,
                  thickness: 1,
                  color: (mostrarAsistencias
                          ? const Color(0xFF1D8A8A)
                          : const Color(0xFFE74C3C))
                      .withOpacity(0.2),
                ),
                _buildTotalRow(totalKey, totalUnico, mostrarAsistencias,
                    isTotal: true),
              ],
            ),
          ),
        ],
      ),
    );
  }

  /// Construye el botón de copiar resumen con diseño responsivo
  Widget _buildBotonCopiar(
    Map<String, int> resumen,
    bool mostrarAsistencias,
    Map<String, List<Map<String, dynamic>>> porServicio,
    BuildContext context,
  ) {
    return LayoutBuilder(
      builder: (context, constraints) {
        final mediaQuery = MediaQuery.of(context);
        final screenWidth = mediaQuery.size.width;
        final isVerySmallScreen = screenWidth < 360;
        final isSmallScreen = screenWidth < 500;
        final isMediumScreen = screenWidth >= 500 && screenWidth < 700;

        // Tamaños adaptativos
        final iconSize = isVerySmallScreen
            ? 16.0
            : (isSmallScreen ? 17.0 : (isMediumScreen ? 18.0 : 20.0));
        final fontSize = isVerySmallScreen
            ? 11.0
            : (isSmallScreen ? 12.0 : (isMediumScreen ? 13.0 : 14.0));
        final horizontalPadding = isVerySmallScreen
            ? 6.0
            : (isSmallScreen ? 8.0 : (isMediumScreen ? 10.0 : 12.0));
        final verticalPadding = isVerySmallScreen
            ? 5.0
            : (isSmallScreen ? 6.0 : (isMediumScreen ? 8.0 : 10.0));
        final borderRadius = isVerySmallScreen ? 8.0 : 10.0;
        final spacing = isVerySmallScreen
            ? 4.0
            : (isSmallScreen ? 5.0 : (isMediumScreen ? 6.0 : 8.0));

        return Container(
          constraints: BoxConstraints(
            minWidth: isVerySmallScreen ? 40 : 60,
            maxWidth: isVerySmallScreen ? 80 : (isSmallScreen ? 100 : 120),
          ),
          decoration: BoxDecoration(
            gradient: LinearGradient(
              begin: Alignment.topLeft,
              end: Alignment.bottomRight,
              colors: [
                Colors.white.withOpacity(0.25),
                Colors.white.withOpacity(0.15),
              ],
            ),
            borderRadius: BorderRadius.circular(borderRadius),
            border: Border.all(
              color: Colors.white.withOpacity(0.6),
              width: isVerySmallScreen ? 1.5 : 2,
            ),
            boxShadow: [
              BoxShadow(
                color: Colors.black.withOpacity(0.15),
                blurRadius: 6,
                offset: Offset(0, 3),
              ),
            ],
          ),
          child: Material(
            color: Colors.transparent,
            child: InkWell(
              onTap: () => _copiarResumen(resumen, mostrarAsistencias,
                  porServicio, context, widget.tribuNombre),
              borderRadius: BorderRadius.circular(borderRadius),
              splashColor: Colors.white.withOpacity(0.3),
              highlightColor: Colors.white.withOpacity(0.2),
              child: Padding(
                padding: EdgeInsets.symmetric(
                  horizontal: horizontalPadding,
                  vertical: verticalPadding,
                ),
                child: isVerySmallScreen
                    ? Center(
                        child: Icon(
                          Icons.content_copy_rounded,
                          color: Colors.white,
                          size: iconSize,
                        ),
                      )
                    : Row(
                        mainAxisSize: MainAxisSize.min,
                        mainAxisAlignment: MainAxisAlignment.center,
                        children: [
                          Icon(
                            Icons.content_copy_rounded,
                            color: Colors.white,
                            size: iconSize,
                          ),
                          SizedBox(width: spacing),
                          Flexible(
                            child: Text(
                              'Copiar',
                              style: TextStyle(
                                color: Colors.white,
                                fontSize: fontSize,
                                fontWeight: FontWeight.w700,
                                letterSpacing: 0.3,
                              ),
                              maxLines: 1,
                              overflow: TextOverflow.ellipsis,
                            ),
                          ),
                        ],
                      ),
              ),
            ),
          ),
        );
      },
    );
  }

  /// Copia el resumen formateado al portapapeles
  Future<void> _copiarResumen(
    Map<String, int> resumen,
    bool mostrarAsistencias,
    Map<String, List<Map<String, dynamic>>> porServicio,
    BuildContext context,
    String tribuNombre,
  ) async {
    try {
      // Obtener el rango de fechas del resumen
      String rangoFechas = _obtenerRangoFechasResumen(porServicio);

      // Construir el texto formateado
      final StringBuffer texto = StringBuffer();

      // Título con negrilla
      texto.writeln('*Tribu $tribuNombre*');

      // Subtítulo con cursiva
      texto.writeln(
          '_${mostrarAsistencias ? 'Asistencia' : 'Inasistencias'} $rangoFechas' +
              '_');

      // Separador
      texto.writeln('');

      // ✅ NUEVO: Agrupar por día de la semana en lugar de por servicio
      Map<String, int> asistenciasPorDia = {};
      Set<String> personasUnicas = {};

      // Recorrer todos los servicios y agrupar por día
      for (var entry in porServicio.entries) {
        final servicio = entry.key;
        final listaAsistencias = entry.value;

        for (var asistencia in listaAsistencias) {
          final fecha = asistencia['fecha'] as DateTime;
          final nombrePersona = asistencia['nombre'] ?? '';

          // Obtener el día de la semana
          String diaSemana = _obtenerNombreDiaSemana(fecha.weekday);

          // Inicializar el contador del día si no existe
          if (!asistenciasPorDia.containsKey(diaSemana)) {
            asistenciasPorDia[diaSemana] = 0;
          }

          // Contar personas únicas por día (no duplicar si asistió a varios servicios el mismo día)
          String claveDiaPersona = '$diaSemana-$nombrePersona';
          if (!personasUnicas.contains(claveDiaPersona)) {
            asistenciasPorDia[diaSemana] = asistenciasPorDia[diaSemana]! + 1;
            personasUnicas.add(claveDiaPersona);
          }
        }
      }

      // Ordenar los días de la semana
      final diasOrdenados = _ordenarDiasSemana(asistenciasPorDia.keys.toList());

      // Agregar cada día con negrilla
      for (var dia in diasOrdenados) {
        final cantidad = asistenciasPorDia[dia] ?? 0;
        texto.writeln('*$dia:* $cantidad');
      }

      // Separador
      texto.writeln('');

      // Total con negrilla (contar personas únicas en todo el fin de semana)
      Set<String> personasTotales = {};
      for (var servicio in porServicio.values) {
        for (var asistencia in servicio) {
          personasTotales.add(asistencia['nombre'] ?? '');
        }
      }

      texto.write('*Total FDS:* ${personasTotales.length}');

      // Copiar al portapapeles
      await Clipboard.setData(ClipboardData(text: texto.toString()));

      // Mostrar confirmación
      if (context.mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Row(
              children: [
                Container(
                  padding: EdgeInsets.all(4),
                  decoration: BoxDecoration(
                    color: Colors.white.withOpacity(0.2),
                    shape: BoxShape.circle,
                  ),
                  child: Icon(
                    Icons.check_circle,
                    color: Colors.white,
                    size: 20,
                  ),
                ),
                SizedBox(width: 12),
                Expanded(
                  child: Text(
                    'Resumen copiado al portapapeles',
                    style: TextStyle(
                      color: Colors.white,
                      fontWeight: FontWeight.w600,
                      fontSize: 15,
                    ),
                  ),
                ),
              ],
            ),
            backgroundColor: const Color(0xFF27AE60),
            behavior: SnackBarBehavior.floating,
            shape: RoundedRectangleBorder(
              borderRadius: BorderRadius.circular(12),
            ),
            margin: EdgeInsets.all(16),
            duration: Duration(seconds: 2),
            elevation: 6,
          ),
        );
      }
    } catch (e) {
      print('Error al copiar resumen: $e');

      if (context.mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Row(
              children: [
                Icon(Icons.error_outline, color: Colors.white),
                SizedBox(width: 12),
                Expanded(
                  child: Text(
                    'Error al copiar el resumen',
                    style: TextStyle(fontWeight: FontWeight.w600),
                  ),
                ),
              ],
            ),
            backgroundColor: Colors.red,
            behavior: SnackBarBehavior.floating,
            shape: RoundedRectangleBorder(
              borderRadius: BorderRadius.circular(12),
            ),
            margin: EdgeInsets.all(16),
          ),
        );
      }
    }
  }

  /// Obtiene el nombre del día de la semana a partir del número (1=Lunes, 7=Domingo)
  String _obtenerNombreDiaSemana(int weekday) {
    switch (weekday) {
      case DateTime.monday:
        return 'Lunes';
      case DateTime.tuesday:
        return 'Martes';
      case DateTime.wednesday:
        return 'Miércoles';
      case DateTime.thursday:
        return 'Jueves';
      case DateTime.friday:
        return 'Viernes';
      case DateTime.saturday:
        return 'Sábado';
      case DateTime.sunday:
        return 'Domingo';
      default:
        return 'Desconocido';
    }
  }

  /// Ordena los días de la semana en orden cronológico
  List<String> _ordenarDiasSemana(List<String> dias) {
    final ordenDias = {
      'Lunes': 1,
      'Martes': 2,
      'Miércoles': 3,
      'Jueves': 4,
      'Viernes': 5,
      'Sábado': 6,
      'Domingo': 7,
    };

    dias.sort((a, b) {
      final ordenA = ordenDias[a] ?? 999;
      final ordenB = ordenDias[b] ?? 999;
      return ordenA.compareTo(ordenB);
    });

    return dias;
  }

  /// Obtiene el rango de fechas del resumen (ej: "16-18 Enero 2026")
  String _obtenerRangoFechasResumen(
      Map<String, List<Map<String, dynamic>>> porServicio) {
    if (porServicio.isEmpty) return '';

    // Obtener todas las fechas
    List<DateTime> todasFechas = [];
    for (var servicio in porServicio.values) {
      for (var asistencia in servicio) {
        todasFechas.add(asistencia['fecha'] as DateTime);
      }
    }

    if (todasFechas.isEmpty) return '';

    // Ordenar fechas
    todasFechas.sort();

    final fechaInicio = todasFechas.first;
    final fechaFin = todasFechas.last;

    // Formatear según si son del mismo mes o no
    if (fechaInicio.month == fechaFin.month &&
        fechaInicio.year == fechaFin.year) {
      // Mismo mes: "16-18 Enero 2026"
      final mes = _getSpanishMonth(_getNombreMesIngles(fechaInicio.month));
      return '${fechaInicio.day}-${fechaFin.day} $mes ${fechaInicio.year}';
    } else if (fechaInicio.year == fechaFin.year) {
      // Mismo año, diferente mes: "28 Dic - 3 Ene 2026"
      final mesInicio = _obtenerMesAbreviado(fechaInicio.month);
      final mesFin = _obtenerMesAbreviado(fechaFin.month);
      return '${fechaInicio.day} $mesInicio - ${fechaFin.day} $mesFin ${fechaInicio.year}';
    } else {
      // Años diferentes: "28 Dic 2025 - 3 Ene 2026"
      final mesInicio = _obtenerMesAbreviado(fechaInicio.month);
      final mesFin = _obtenerMesAbreviado(fechaFin.month);
      return '${fechaInicio.day} $mesInicio ${fechaInicio.year} - ${fechaFin.day} $mesFin ${fechaFin.year}';
    }
  }

  Widget _buildTotalRow(String label, int count, bool mostrarAsistencias,
      {bool isTotal = false}) {
    final color =
        mostrarAsistencias ? const Color(0xFF1D8A8A) : const Color(0xFFE74C3C);

    return Container(
      margin: EdgeInsets.symmetric(vertical: 4),
      padding: EdgeInsets.symmetric(vertical: 8, horizontal: 12),
      decoration: BoxDecoration(
        color: isTotal ? color.withOpacity(0.1) : Colors.transparent,
        borderRadius: BorderRadius.circular(8),
        border: isTotal
            ? Border.all(color: color.withOpacity(0.3), width: 1)
            : null,
      ),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceBetween,
        children: [
          Expanded(
            child: Text(
              label,
              style: TextStyle(
                fontWeight: isTotal ? FontWeight.bold : FontWeight.w500,
                color: isTotal ? color : Colors.grey[700],
                fontSize: isTotal ? 15 : 14,
              ),
            ),
          ),
          Container(
            padding: EdgeInsets.symmetric(horizontal: 12, vertical: 6),
            decoration: BoxDecoration(
              gradient: isTotal
                  ? LinearGradient(
                      begin: Alignment.topLeft,
                      end: Alignment.bottomRight,
                      colors: mostrarAsistencias
                          ? [
                              const Color(0xFF1D8A8A),
                              const Color(0xFF156D6D),
                            ]
                          : [
                              const Color(0xFFE74C3C),
                              const Color(0xFFC0392B),
                            ],
                    )
                  : null,
              color: isTotal ? null : Colors.grey.withOpacity(0.1),
              borderRadius: BorderRadius.circular(20),
              boxShadow: isTotal
                  ? [
                      BoxShadow(
                        color: color.withOpacity(0.2),
                        blurRadius: 4,
                        offset: Offset(0, 2),
                      )
                    ]
                  : null,
            ),
            child: Text(
              count.toString(),
              style: TextStyle(
                fontWeight: FontWeight.bold,
                color: isTotal ? Colors.white : Colors.grey[700],
                fontSize: isTotal ? 15 : 14,
              ),
            ),
          ),
        ],
      ),
    );
  }

  // ========================================
  // FUNCIONES AUXILIARES (SIN CAMBIOS)
  // ========================================
  Map<String, Map<String, Map<String, List<Map<String, dynamic>>>>>
      _agruparAsistenciasPorFecha(List<Map<String, dynamic>> asistencias) {
    final Map<String, Map<String, Map<String, List<Map<String, dynamic>>>>>
        agrupadas = {};

    for (var asistencia in asistencias) {
      final fecha = asistencia['fecha'] as DateTime;
      final year = DateFormat('yyyy').format(fecha);

      // ✅ CORRECCIÓN: Obtener el martes de la semana para determinar el mes correcto
      final DateTime martes = _obtenerLunesDeLaSemana(fecha);
      final String monthKey = DateFormat('MMMM').format(martes);

      // ✅ CORRECCIÓN: Usar el martes como referencia para la semana
      final DateTime lunes = _obtenerDomingoDeLaSemana(martes);
      final String semanaKey = '${martes.day}-${lunes.day}';

      agrupadas.putIfAbsent(year, () => {});
      agrupadas[year]!.putIfAbsent(monthKey, () => {});
      agrupadas[year]![monthKey]!.putIfAbsent(semanaKey, () => []);
      agrupadas[year]![monthKey]![semanaKey]!.add(asistencia);
    }

    return agrupadas;
  }

  DateTime _obtenerLunesDeLaSemana(DateTime fecha) {
    // Calcular el martes de la semana (nueva lógica)
    // DateTime.tuesday = 2
    int diferencia = fecha.weekday - DateTime.tuesday;

    // Si es lunes (weekday = 1), retroceder 6 días para llegar al martes anterior
    if (fecha.weekday == DateTime.monday) {
      diferencia = 6;
    }

    return fecha.subtract(Duration(days: diferencia));
  }

  DateTime _obtenerDomingoDeLaSemana(DateTime martes) {
    // Ahora el rango es Martes a Lunes (7 días después)
    return martes.add(Duration(days: 6));
  }

  String _formatearRangoSemana(
      String week, List<Map<String, dynamic>> asistencias) {
    if (asistencias.isEmpty) return 'Semana $week';

    // Obtener la fecha real del primer registro
    final fechaInicial = asistencias.first['fecha'] as DateTime;
    final martes = _obtenerLunesDeLaSemana(fechaInicial);
    final lunes = _obtenerDomingoDeLaSemana(martes);

    // ✅ CORRECCIÓN: Formatear considerando que puede cruzar meses
    if (martes.month == lunes.month) {
      // Mismo mes: "Semana 7-13"
      return 'Semana ${martes.day}-${lunes.day}';
    } else {
      // ✅ NUEVO: Meses diferentes - mostrar ambos meses
      final mesMartes = _obtenerMesAbreviado(martes.month);
      final mesLunes = _obtenerMesAbreviado(lunes.month);

      // Si además cruza años, mostrar ambos años
      if (martes.year != lunes.year) {
        return 'Semana ${martes.day} $mesMartes ${martes.year} - ${lunes.day} $mesLunes ${lunes.year}';
      }

      return 'Semana ${martes.day} $mesMartes - ${lunes.day} $mesLunes';
    }
  }

  String _obtenerRangoFechasCompleto(
      String week, List<Map<String, dynamic>> asistencias) {
    if (asistencias.isEmpty) return '';

    final fechaInicial = asistencias.first['fecha'] as DateTime;
    final martes = _obtenerLunesDeLaSemana(fechaInicial);
    final lunes = _obtenerDomingoDeLaSemana(martes);

    if (martes.month == lunes.month && martes.year == lunes.year) {
      // Mismo mes y año: "1 - 7 de octubre de 2025"
      return '${martes.day} - ${lunes.day} de ${_getSpanishMonth(_getNombreMesIngles(martes.month))} ${martes.year}';
    } else if (martes.year == lunes.year) {
      // Mismo año, diferente mes: "28 de enero - 3 de febrero de 2025"
      return '${martes.day} de ${_getSpanishMonth(_getNombreMesIngles(martes.month))} - ${lunes.day} de ${_getSpanishMonth(_getNombreMesIngles(lunes.month))} ${lunes.year}';
    } else {
      // ✅ NUEVO: Años diferentes: "28 de diciembre de 2024 - 3 de enero de 2025"
      return '${martes.day} de ${_getSpanishMonth(_getNombreMesIngles(martes.month))} de ${martes.year} - ${lunes.day} de ${_getSpanishMonth(_getNombreMesIngles(lunes.month))} de ${lunes.year}';
    }
  }

  String _obtenerMesAbreviado(int mes) {
    const meses = [
      'Ene',
      'Feb',
      'Mar',
      'Abr',
      'May',
      'Jun',
      'Jul',
      'Ago',
      'Sep',
      'Oct',
      'Nov',
      'Dic'
    ];
    return meses[mes - 1];
  }

  String _getNombreMesIngles(int mes) {
    const meses = [
      'January',
      'February',
      'March',
      'April',
      'May',
      'June',
      'July',
      'August',
      'September',
      'October',
      'November',
      'December'
    ];
    return meses[mes - 1];
  }

  String _determinarMinisterio(String nombreServicio) {
    final servicioLower = nombreServicio.toLowerCase();

    if (servicioLower.contains("damas")) return "Ministerio de Damas";
    if (servicioLower.contains("caballeros")) return "Ministerio de Caballeros";
    if (servicioLower.contains("juvenil") || servicioLower.contains("impacto"))
      return "Ministerio Juvenil";

    // ✅ MODIFICADO: Aceptar tanto "familiar" como "dominical"
    if (servicioLower.contains("familiar") ||
        servicioLower.contains("dominical")) return "Servicio Familiar";

    if (servicioLower.contains("poder")) return "Viernes de Poder";

    return "Servicio Especial";
  }

  Color _getColorByMinisterio(String ministerio) {
    switch (ministerio) {
      case "Ministerio de Damas":
        return Color(0xFFFF6B8B);
      case "Ministerio de Caballeros":
        return Color(0xFF3498DB);
      case "Ministerio Juvenil":
        return Color(0xFFF5A623);
      case "Servicio Familiar":
        return Color(0xFF2ECC71);
      case "Viernes de Poder":
        return Color(0xFF1D8A8A);
      default:
        return Color(0xFF9B59B6);
    }
  }

  IconData _getIconByMinisterio(String ministerio) {
    switch (ministerio) {
      case "Ministerio de Damas":
        return Icons.volunteer_activism;
      case "Ministerio de Caballeros":
        return Icons.fitness_center;
      case "Ministerio Juvenil":
        return Icons.emoji_people;
      case "Servicio Familiar":
        return Icons.family_restroom;
      case "Viernes de Poder":
        return Icons.local_fire_department;
      default:
        return Icons.star_border_rounded;
    }
  }

  IconData _getMonthIcon(String month) {
    switch (month) {
      case 'January':
        return Icons.ac_unit;
      case 'February':
        return Icons.favorite;
      case 'March':
        return Icons.eco;
      case 'April':
        return Icons.water_drop;
      case 'May':
        return Icons.local_florist;
      case 'June':
        return Icons.wb_sunny;
      case 'July':
        return Icons.beach_access;
      case 'August':
        return Icons.waves;
      case 'September':
        return Icons.school;
      case 'October':
        return Icons.theater_comedy;
      case 'November':
        return Icons.savings;
      case 'December':
        return Icons.celebration;
      default:
        return Icons.calendar_month;
    }
  }

  String _getSpanishMonth(String month) {
    final months = {
      'January': 'Enero',
      'February': 'Febrero',
      'March': 'Marzo',
      'April': 'Abril',
      'May': 'Mayo',
      'June': 'Junio',
      'July': 'Julio',
      'August': 'Agosto',
      'September': 'Septiembre',
      'October': 'Octubre',
      'November': 'Noviembre',
      'December': 'Diciembre',
    };
    return months[month] ?? month;
  }

  int _monthToNumber(String m) {
    final key = m.toLowerCase().trim();

    const es = {
      'enero': 1,
      'febrero': 2,
      'marzo': 3,
      'abril': 4,
      'mayo': 5,
      'junio': 6,
      'julio': 7,
      'agosto': 8,
      'septiembre': 9,
      'octubre': 10,
      'noviembre': 11,
      'diciembre': 12
    };

    const en = {
      'january': 1,
      'february': 2,
      'march': 3,
      'april': 4,
      'may': 5,
      'june': 6,
      'july': 7,
      'august': 8,
      'september': 9,
      'october': 10,
      'november': 11,
      'december': 12
    };

    return es[key] ?? en[key] ?? 13;
  }
}

//----------------------------------------------------------------------------------------------

// la clase InscripcionesTab existente

class InscripcionesTab extends StatefulWidget {
  final String tribuId;

  const InscripcionesTab({Key? key, required this.tribuId}) : super(key: key);

  @override
  _InscripcionesTabState createState() => _InscripcionesTabState();
}

class _InscripcionesTabState extends State<InscripcionesTab> {
  final Color primaryTeal = Color(0xFF1B998B);
  final Color secondaryOrange = Color(0xFFFF7E00);
  final Color lightTeal = Color(0xFFE0F7FA);

  // Estado para alternar entre eventos y cumpleaños
  bool mostrandoCumpleanos = false;
  String _vistaMostrada = 'eventos';
  bool isLoading = false;

  Future<String> _obtenerNombreTribu(String tribuId) async {
    try {
      final doc = await FirebaseFirestore.instance
          .collection('tribus')
          .doc(tribuId)
          .get();

      if (doc.exists && doc.data() != null) {
        return doc.data()?['nombre'] ?? 'Sin nombre';
      }
    } catch (e) {
      print('Error al obtener nombre de tribu: $e');
    }
    return 'Sin nombre';
  }

// Sistema de iconos por tipo de evento
  IconData _getIconoPorTipo(String tipo) {
    switch (tipo.toLowerCase()) {
      case 'encuentro':
        return Icons.groups;
      case 'raíces':
        return Icons.nature_people;
      case 'reencuentro':
        return Icons.handshake;
      case 'personalizado':
        return Icons.star;
      default:
        return Icons.event;
    }
  }

  Color _getColorPorTipo(String tipo) {
    switch (tipo.toLowerCase()) {
      case 'encuentro':
        return Colors.blue;
      case 'raíces':
        return Colors.green;
      case 'reencuentro':
        return Colors.purple;
      case 'personalizado':
        return Colors.orange;
      default:
        return primaryTeal;
    }
  }

  @override
  Widget build(BuildContext context) {
    // ✅ Obtener información de la pantalla
    final screenWidth = MediaQuery.of(context).size.width;
    final screenHeight = MediaQuery.of(context).size.height;

    // ✅ Definir breakpoints responsivos
    final isVerySmall = screenWidth < 360;
    final isSmall = screenWidth < 600;
    final isMedium = screenWidth >= 600 && screenWidth < 900;
    final isLarge = screenWidth >= 900;

    // ✅ Calcular tamaños de fuente responsivos
    final titleFontSize = isVerySmall
        ? 16.0
        : isSmall
            ? 18.0
            : isMedium
                ? 20.0
                : 22.0;
    final subtitleFontSize = isVerySmall
        ? 12.0
        : isSmall
            ? 13.0
            : isMedium
                ? 14.0
                : 15.0;
    final buttonFontSize = isVerySmall
        ? 11.0
        : isSmall
            ? 12.0
            : isMedium
                ? 13.0
                : 14.0;
    final buttonIconSize = isVerySmall
        ? 16.0
        : isSmall
            ? 18.0
            : isMedium
                ? 20.0
                : 22.0;

    // ✅ Calcular padding responsivo
    final horizontalPadding = isVerySmall
        ? 12.0
        : isSmall
            ? 14.0
            : isMedium
                ? 16.0
                : 20.0;
    final verticalPadding = isVerySmall
        ? 12.0
        : isSmall
            ? 14.0
            : isMedium
                ? 16.0
                : 18.0;

    // ✅ Definir textos dinámicos según la pestaña activa
    String getTituloActual() {
      switch (_vistaMostrada) {
        case 'eventos':
          return 'Eventos e Inscripciones';
        case 'cumpleanos':
          return 'Cumpleaños del Mes';
        case 'clases':
          return 'Clases de Discipulado';
        default:
          return 'Eventos e Inscripciones';
      }
    }

    String getSubtituloActual() {
      switch (_vistaMostrada) {
        case 'eventos':
          return 'Gestiona encuentros, raíces y reencuentros';
        case 'cumpleanos':
          return 'Celebra con los cumpleañeros de este mes';
        case 'clases':
          return 'Inscribe discípulos en las clases activas';
        default:
          return '';
      }
    }

    IconData getIconoActual() {
      switch (_vistaMostrada) {
        case 'eventos':
          return Icons.event_note;
        case 'cumpleanos':
          return Icons.cake;
        case 'clases':
          return Icons.school;
        default:
          return Icons.event_note;
      }
    }

    return Container(
      decoration: BoxDecoration(
        gradient: LinearGradient(
          begin: Alignment.topCenter,
          end: Alignment.bottomCenter,
          colors: [lightTeal, Colors.white],
          stops: [0.0, 0.5],
        ),
      ),
      child: Column(
        children: [
          // ═══════════════════════════════════════════════════════════════
          // HEADER RESPONSIVO CON PESTAÑAS Y BOTÓN CONDICIONAL
          // ═══════════════════════════════════════════════════════════════
          Container(
            padding: EdgeInsets.symmetric(
              horizontal: horizontalPadding,
              vertical: verticalPadding,
            ),
            decoration: BoxDecoration(
              color: primaryTeal,
              borderRadius: BorderRadius.only(
                bottomLeft: Radius.circular(20),
                bottomRight: Radius.circular(20),
              ),
              boxShadow: [
                BoxShadow(
                  color: Colors.black26,
                  offset: Offset(0, 2),
                  blurRadius: 4,
                ),
              ],
            ),
            child: Column(
              children: [
                // ───────────────────────────────────────────────────────────
                // FILA DE 3 PESTAÑAS - COMPLETAMENTE RESPONSIVA
                // ───────────────────────────────────────────────────────────
                Container(
                  margin: EdgeInsets.only(bottom: isVerySmall ? 10 : 12),
                  child: LayoutBuilder(
                    builder: (context, constraints) {
                      final availableWidth = constraints.maxWidth;
                      final buttonSpacing = isVerySmall
                          ? 4.0
                          : isSmall
                              ? 6.0
                              : 8.0;
                      final totalSpacing =
                          buttonSpacing * 2; // Espacios entre 3 botones
                      final buttonWidth = (availableWidth - totalSpacing) / 3;

                      return Row(
                        children: [
                          // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                          // BOTÓN 1: EVENTOS
                          // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                          Flexible(
                            flex: 1,
                            child: SizedBox(
                              width: buttonWidth,
                              child: ElevatedButton(
                                style: ElevatedButton.styleFrom(
                                  backgroundColor: _vistaMostrada == 'eventos'
                                      ? Colors.white
                                      : Colors.white.withOpacity(0.3),
                                  foregroundColor: _vistaMostrada == 'eventos'
                                      ? primaryTeal
                                      : Colors.white,
                                  elevation:
                                      _vistaMostrada == 'eventos' ? 2 : 0,
                                  shape: RoundedRectangleBorder(
                                    borderRadius: BorderRadius.circular(
                                        isVerySmall ? 10 : 12),
                                  ),
                                  padding: EdgeInsets.symmetric(
                                    horizontal: isVerySmall
                                        ? 4
                                        : isSmall
                                            ? 6
                                            : 8,
                                    vertical: isVerySmall
                                        ? 8
                                        : isSmall
                                            ? 10
                                            : 12,
                                  ),
                                ),
                                onPressed: () =>
                                    setState(() => _vistaMostrada = 'eventos'),
                                child: FittedBox(
                                  fit: BoxFit.scaleDown,
                                  child: Row(
                                    mainAxisSize: MainAxisSize.min,
                                    mainAxisAlignment: MainAxisAlignment.center,
                                    children: [
                                      Icon(Icons.event_note,
                                          size: buttonIconSize),
                                      if (screenWidth > 380) ...[
                                        SizedBox(width: 4),
                                        Text(
                                          'Eventos',
                                          style: TextStyle(
                                            fontWeight: FontWeight.bold,
                                            fontSize: buttonFontSize,
                                          ),
                                          overflow: TextOverflow.ellipsis,
                                        ),
                                      ],
                                    ],
                                  ),
                                ),
                              ),
                            ),
                          ),
                          SizedBox(width: buttonSpacing),

                          // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                          // BOTÓN 2: CUMPLEAÑOS
                          // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                          Flexible(
                            flex: 1,
                            child: SizedBox(
                              width: buttonWidth,
                              child: ElevatedButton(
                                style: ElevatedButton.styleFrom(
                                  backgroundColor:
                                      _vistaMostrada == 'cumpleanos'
                                          ? Colors.white
                                          : Colors.white.withOpacity(0.3),
                                  foregroundColor:
                                      _vistaMostrada == 'cumpleanos'
                                          ? primaryTeal
                                          : Colors.white,
                                  elevation:
                                      _vistaMostrada == 'cumpleanos' ? 2 : 0,
                                  shape: RoundedRectangleBorder(
                                    borderRadius: BorderRadius.circular(
                                        isVerySmall ? 10 : 12),
                                  ),
                                  padding: EdgeInsets.symmetric(
                                    horizontal: isVerySmall
                                        ? 4
                                        : isSmall
                                            ? 6
                                            : 8,
                                    vertical: isVerySmall
                                        ? 8
                                        : isSmall
                                            ? 10
                                            : 12,
                                  ),
                                ),
                                onPressed: () => setState(
                                    () => _vistaMostrada = 'cumpleanos'),
                                child: FittedBox(
                                  fit: BoxFit.scaleDown,
                                  child: Row(
                                    mainAxisSize: MainAxisSize.min,
                                    mainAxisAlignment: MainAxisAlignment.center,
                                    children: [
                                      Icon(Icons.cake, size: buttonIconSize),
                                      if (screenWidth > 380) ...[
                                        SizedBox(width: 4),
                                        Text(
                                          'Cumpleaños',
                                          style: TextStyle(
                                            fontWeight: FontWeight.bold,
                                            fontSize: buttonFontSize,
                                          ),
                                          overflow: TextOverflow.ellipsis,
                                        ),
                                      ],
                                    ],
                                  ),
                                ),
                              ),
                            ),
                          ),
                          SizedBox(width: buttonSpacing),

                          // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                          // BOTÓN 3: CLASES
                          // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                          Flexible(
                            flex: 1,
                            child: SizedBox(
                              width: buttonWidth,
                              child: ElevatedButton(
                                style: ElevatedButton.styleFrom(
                                  backgroundColor: _vistaMostrada == 'clases'
                                      ? Colors.white
                                      : Colors.white.withOpacity(0.3),
                                  foregroundColor: _vistaMostrada == 'clases'
                                      ? primaryTeal
                                      : Colors.white,
                                  elevation: _vistaMostrada == 'clases' ? 2 : 0,
                                  shape: RoundedRectangleBorder(
                                    borderRadius: BorderRadius.circular(
                                        isVerySmall ? 10 : 12),
                                  ),
                                  padding: EdgeInsets.symmetric(
                                    horizontal: isVerySmall
                                        ? 4
                                        : isSmall
                                            ? 6
                                            : 8,
                                    vertical: isVerySmall
                                        ? 8
                                        : isSmall
                                            ? 10
                                            : 12,
                                  ),
                                ),
                                onPressed: () =>
                                    setState(() => _vistaMostrada = 'clases'),
                                child: FittedBox(
                                  fit: BoxFit.scaleDown,
                                  child: Row(
                                    mainAxisSize: MainAxisSize.min,
                                    mainAxisAlignment: MainAxisAlignment.center,
                                    children: [
                                      Icon(Icons.school, size: buttonIconSize),
                                      if (screenWidth > 380) ...[
                                        SizedBox(width: 4),
                                        Text(
                                          'Clases',
                                          style: TextStyle(
                                            fontWeight: FontWeight.bold,
                                            fontSize: buttonFontSize,
                                          ),
                                          overflow: TextOverflow.ellipsis,
                                        ),
                                      ],
                                    ],
                                  ),
                                ),
                              ),
                            ),
                          ),
                        ],
                      );
                    },
                  ),
                ),

                // ───────────────────────────────────────────────────────────
                // TÍTULO DINÁMICO Y BOTÓN CREAR EVENTO (SOLO EN EVENTOS)
                // ───────────────────────────────────────────────────────────
                LayoutBuilder(
                  builder: (context, constraints) {
                    final showFullButton = screenWidth > 450;
                    final showCompactButton =
                        screenWidth > 350 && screenWidth <= 450;

                    return Row(
                      children: [
                        // Icono representativo
                        Icon(
                          getIconoActual(),
                          color: Colors.white,
                          size: isVerySmall
                              ? 24
                              : isSmall
                                  ? 26
                                  : 28,
                        ),
                        SizedBox(width: isVerySmall ? 8 : 12),

                        // Título y subtítulo
                        Expanded(
                          child: Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              FittedBox(
                                fit: BoxFit.scaleDown,
                                alignment: Alignment.centerLeft,
                                child: Text(
                                  getTituloActual(),
                                  style: TextStyle(
                                    fontSize: titleFontSize,
                                    fontWeight: FontWeight.bold,
                                    color: Colors.white,
                                    letterSpacing: 0.3,
                                  ),
                                  maxLines: 1,
                                  overflow: TextOverflow.ellipsis,
                                ),
                              ),
                              if (getSubtituloActual().isNotEmpty) ...[
                                SizedBox(height: 2),
                                FittedBox(
                                  fit: BoxFit.scaleDown,
                                  alignment: Alignment.centerLeft,
                                  child: Text(
                                    getSubtituloActual(),
                                    style: TextStyle(
                                      fontSize: subtitleFontSize,
                                      color: Colors.white.withOpacity(0.9),
                                      fontWeight: FontWeight.w400,
                                    ),
                                    maxLines: 1,
                                    overflow: TextOverflow.ellipsis,
                                  ),
                                ),
                              ],
                            ],
                          ),
                        ),

                        // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                        // BOTÓN "CREAR EVENTO" - SOLO EN PESTAÑA EVENTOS
                        // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                        if (_vistaMostrada == 'eventos') ...[
                          SizedBox(width: isVerySmall ? 6 : 8),

                          // Versión completa (pantallas grandes)
                          if (showFullButton)
                            ElevatedButton.icon(
                              style: ElevatedButton.styleFrom(
                                backgroundColor: secondaryOrange,
                                foregroundColor: Colors.white,
                                shape: RoundedRectangleBorder(
                                  borderRadius: BorderRadius.circular(12),
                                ),
                                padding: EdgeInsets.symmetric(
                                  horizontal: isMedium ? 16 : 20,
                                  vertical: isMedium ? 10 : 12,
                                ),
                              ),
                              icon: Icon(Icons.add, size: buttonIconSize),
                              label: Text(
                                'Crear Evento',
                                style: TextStyle(
                                  fontSize: buttonFontSize,
                                  fontWeight: FontWeight.bold,
                                ),
                              ),
                              onPressed: () => _mostrarDialogoCrearEvento(),
                            )

                          // Versión compacta (pantallas medianas)
                          else if (showCompactButton)
                            ElevatedButton(
                              style: ElevatedButton.styleFrom(
                                backgroundColor: secondaryOrange,
                                foregroundColor: Colors.white,
                                shape: RoundedRectangleBorder(
                                  borderRadius: BorderRadius.circular(12),
                                ),
                                padding: EdgeInsets.symmetric(
                                  horizontal: 12,
                                  vertical: 10,
                                ),
                              ),
                              onPressed: () => _mostrarDialogoCrearEvento(),
                              child: Row(
                                mainAxisSize: MainAxisSize.min,
                                children: [
                                  Icon(Icons.add, size: buttonIconSize),
                                  SizedBox(width: 4),
                                  Text(
                                    'Crear',
                                    style: TextStyle(
                                      fontSize: buttonFontSize,
                                      fontWeight: FontWeight.bold,
                                    ),
                                  ),
                                ],
                              ),
                            )

                          // Versión solo icono (pantallas pequeñas)
                          else
                            Container(
                              decoration: BoxDecoration(
                                color: secondaryOrange,
                                borderRadius: BorderRadius.circular(12),
                                boxShadow: [
                                  BoxShadow(
                                    color: Colors.black.withOpacity(0.2),
                                    blurRadius: 4,
                                    offset: Offset(0, 2),
                                  ),
                                ],
                              ),
                              child: Material(
                                color: Colors.transparent,
                                child: InkWell(
                                  borderRadius: BorderRadius.circular(12),
                                  onTap: () => _mostrarDialogoCrearEvento(),
                                  child: Padding(
                                    padding:
                                        EdgeInsets.all(isVerySmall ? 8 : 10),
                                    child: Icon(
                                      Icons.add,
                                      color: Colors.white,
                                      size: buttonIconSize,
                                    ),
                                  ),
                                ),
                              ),
                            ),
                        ],
                      ],
                    );
                  },
                ),
              ],
            ),
          ),

          // ═══════════════════════════════════════════════════════════════
          // CONTENIDO DE LAS PESTAÑAS
          // ═══════════════════════════════════════════════════════════════
          Expanded(
            child: _vistaMostrada == 'cumpleanos'
                ? _buildCumpleanosView()
                : _vistaMostrada == 'clases'
                    ? _buildClasesDiscipuladoView()
                    : _buildEventosView(),
          ),
        ],
      ),
    );
  }

  // AÑADIR AL FINAL DE LA CLASE _InscripcionesTabState
  Widget _buildEventosView() {
    return StreamBuilder<QuerySnapshot>(
      stream: FirebaseFirestore.instance
          .collection('eventos')
          .where('tribuId', isEqualTo: widget.tribuId)
          .where('estado', isNotEqualTo: 'cancelado')
          .orderBy('estado')
          .orderBy('fechaInicio', descending: false)
          .snapshots(),
      builder: (context, snapshot) {
        // Debug info
        print('StreamBuilder state: ${snapshot.connectionState}');
        print('Has data: ${snapshot.hasData}');
        if (snapshot.hasData) {
          print('Documents count: ${snapshot.data!.docs.length}');
        }
        if (snapshot.hasError) {
          print('StreamBuilder error: ${snapshot.error}');
        }

        if (snapshot.connectionState == ConnectionState.waiting) {
          return Center(
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                Container(
                  padding: EdgeInsets.all(20),
                  decoration: BoxDecoration(
                    color: primaryTeal.withOpacity(0.1),
                    borderRadius: BorderRadius.circular(20),
                  ),
                  child: CircularProgressIndicator(
                    valueColor: AlwaysStoppedAnimation<Color>(primaryTeal),
                    strokeWidth: 3,
                  ),
                ),
                SizedBox(height: 24),
                Text(
                  'Cargando eventos...',
                  style: TextStyle(
                    color: Colors.grey[600],
                    fontSize: 16,
                    fontWeight: FontWeight.w500,
                  ),
                ),
              ],
            ),
          );
        }

        if (snapshot.hasError) {
          return Center(
            child: Container(
              padding: EdgeInsets.all(24),
              margin: EdgeInsets.all(16),
              decoration: BoxDecoration(
                color: Colors.red.shade50,
                borderRadius: BorderRadius.circular(16),
                border: Border.all(color: Colors.red.shade200),
              ),
              child: Column(
                mainAxisAlignment: MainAxisAlignment.center,
                mainAxisSize: MainAxisSize.min,
                children: [
                  Icon(Icons.error_outline, size: 64, color: Colors.red[400]),
                  SizedBox(height: 16),
                  Text(
                    'Error al cargar eventos',
                    style: TextStyle(
                      fontSize: 18,
                      color: Colors.red[600],
                      fontWeight: FontWeight.w600,
                    ),
                  ),
                  SizedBox(height: 8),
                  Text(
                    'Por favor, intenta nuevamente',
                    style: TextStyle(color: Colors.grey[600]),
                    textAlign: TextAlign.center,
                  ),
                  SizedBox(height: 16),
                  ElevatedButton.icon(
                    onPressed: () {
                      setState(() {}); // Forzar rebuild
                    },
                    icon: Icon(Icons.refresh),
                    label: Text('Reintentar'),
                    style: ElevatedButton.styleFrom(
                      backgroundColor: Colors.red[400],
                      foregroundColor: Colors.white,
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(12),
                      ),
                    ),
                  ),
                ],
              ),
            ),
          );
        }

        if (!snapshot.hasData || snapshot.data!.docs.isEmpty) {
          return Center(
            child: Container(
              padding: EdgeInsets.all(32),
              margin: EdgeInsets.all(16),
              decoration: BoxDecoration(
                gradient: LinearGradient(
                  begin: Alignment.topLeft,
                  end: Alignment.bottomRight,
                  colors: [
                    Colors.grey.shade50,
                    Colors.grey.shade100,
                  ],
                ),
                borderRadius: BorderRadius.circular(20),
                boxShadow: [
                  BoxShadow(
                    color: Colors.black.withOpacity(0.05),
                    blurRadius: 10,
                    offset: Offset(0, 4),
                  ),
                ],
              ),
              child: Column(
                mainAxisAlignment: MainAxisAlignment.center,
                mainAxisSize: MainAxisSize.min,
                children: [
                  Container(
                    padding: EdgeInsets.all(20),
                    decoration: BoxDecoration(
                      color: Colors.grey.shade200,
                      borderRadius: BorderRadius.circular(50),
                    ),
                    child: Icon(Icons.event_busy,
                        size: 48, color: Colors.grey[500]),
                  ),
                  SizedBox(height: 20),
                  Text(
                    'No hay eventos creados',
                    style: TextStyle(
                      fontSize: 20,
                      color: Colors.grey[700],
                      fontWeight: FontWeight.w600,
                    ),
                  ),
                  SizedBox(height: 8),
                  Text(
                    'Crea tu primer evento tocando\nel botón "Crear Evento"',
                    style: TextStyle(
                      color: Colors.grey[500],
                      fontSize: 14,
                      height: 1.5,
                    ),
                    textAlign: TextAlign.center,
                  ),
                ],
              ),
            ),
          );
        }

        final eventos = snapshot.data!.docs;
        print('Eventos encontrados: ${eventos.length}');

        // Debug: imprimir información de cada evento
        for (var evento in eventos) {
          final data = evento.data() as Map<String, dynamic>;
          print('Evento: ${data['nombre']}, TribuId: ${data['tribuId']}');
        }

        final eventosAgrupados = _agruparEventosPorFecha(eventos);

        return RefreshIndicator(
          onRefresh: () async {
            setState(() {}); // Forzar refresh
          },
          color: primaryTeal,
          child: ListView(
            padding: EdgeInsets.all(16),
            children: eventosAgrupados.entries.map((anioEntry) {
              return Container(
                margin: EdgeInsets.symmetric(vertical: 8),
                child: Card(
                  key: ValueKey('anio_${anioEntry.key}'),
                  elevation: 8,
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(16),
                  ),
                  child: Container(
                    decoration: BoxDecoration(
                      borderRadius: BorderRadius.circular(16),
                      gradient: LinearGradient(
                        begin: Alignment.topLeft,
                        end: Alignment.bottomRight,
                        colors: [
                          Colors.white,
                          primaryTeal.withOpacity(0.02),
                        ],
                      ),
                    ),
                    child: Theme(
                      data: Theme.of(context).copyWith(
                        dividerColor: Colors.transparent,
                      ),
                      child: ExpansionTile(
                        initiallyExpanded: false, // Cerrado por defecto
                        tilePadding:
                            EdgeInsets.symmetric(horizontal: 20, vertical: 8),
                        childrenPadding: EdgeInsets.all(0),
                        leading: Container(
                          padding: EdgeInsets.all(8),
                          decoration: BoxDecoration(
                            color: primaryTeal.withOpacity(0.1),
                            borderRadius: BorderRadius.circular(12),
                          ),
                          child: Icon(
                            Icons.calendar_today,
                            color: primaryTeal,
                            size: 24,
                          ),
                        ),
                        title: Text(
                          'Año ${anioEntry.key}',
                          style: TextStyle(
                            fontSize: 20,
                            fontWeight: FontWeight.bold,
                            color: primaryTeal,
                            letterSpacing: 0.3,
                          ),
                        ),
                        subtitle: Text(
                          '${anioEntry.value.values.expand((x) => x).length} eventos',
                          style: TextStyle(
                            color: Colors.grey[600],
                            fontSize: 13,
                          ),
                        ),
                        children: anioEntry.value.entries.map((mesEntry) {
                          return Container(
                            margin: EdgeInsets.symmetric(
                                horizontal: 12, vertical: 4),
                            decoration: BoxDecoration(
                              color: secondaryOrange.withOpacity(0.02),
                              borderRadius: BorderRadius.circular(12),
                              border: Border.all(
                                color: secondaryOrange.withOpacity(0.1),
                                width: 1,
                              ),
                            ),
                            child: Theme(
                              data: Theme.of(context).copyWith(
                                dividerColor: Colors.transparent,
                              ),
                              child: ExpansionTile(
                                initiallyExpanded: false, // Cerrado por defecto
                                tilePadding: EdgeInsets.symmetric(
                                    horizontal: 16, vertical: 4),
                                leading: Container(
                                  padding: EdgeInsets.all(6),
                                  decoration: BoxDecoration(
                                    color: secondaryOrange.withOpacity(0.15),
                                    borderRadius: BorderRadius.circular(10),
                                  ),
                                  child: Icon(
                                    Icons.date_range,
                                    color: secondaryOrange,
                                    size: 20,
                                  ),
                                ),
                                title: Text(
                                  _nombreMes(mesEntry.key),
                                  style: TextStyle(
                                    fontSize: 16,
                                    fontWeight: FontWeight.w600,
                                    color: secondaryOrange,
                                  ),
                                ),
                                subtitle: Text(
                                  '${mesEntry.value.length} eventos',
                                  style: TextStyle(
                                    color: Colors.grey[600],
                                    fontSize: 12,
                                  ),
                                ),
                                children: [
                                  // Grid responsivo de eventos
                                  Container(
                                    padding: EdgeInsets.all(12),
                                    child: LayoutBuilder(
                                      builder: (context, constraints) {
                                        return Wrap(
                                          spacing: 8.0,
                                          runSpacing: 8.0,
                                          children:
                                              mesEntry.value.map((eventoDoc) {
                                            return _buildEventCard(eventoDoc);
                                          }).toList(),
                                        );
                                      },
                                    ),
                                  ),
                                ],
                              ),
                            ),
                          );
                        }).toList(),
                      ),
                    ),
                  ),
                ),
              );
            }).toList(),
          ),
        );
      },
    );
  }

  Widget _buildCumpleanosView() {
    final now = DateTime.now();
    final currentMonth = now.month;
    final currentYear = now.year;

    return StreamBuilder<QuerySnapshot>(
      stream: FirebaseFirestore.instance
          .collection('registros')
          .where('tribuAsignada', isEqualTo: widget.tribuId)
          .snapshots(),
      builder: (context, snapshot) {
        if (snapshot.connectionState == ConnectionState.waiting) {
          return Center(
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                CircularProgressIndicator(
                  valueColor: AlwaysStoppedAnimation<Color>(primaryTeal),
                ),
                SizedBox(height: 16),
                Text(
                  'Cargando cumpleañeros...',
                  style: TextStyle(color: Colors.grey[600]),
                ),
              ],
            ),
          );
        }

        if (snapshot.hasError) {
          return Center(
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                Icon(Icons.error_outline, size: 80, color: Colors.red[300]),
                SizedBox(height: 16),
                Text(
                  'Error al cargar cumpleaños',
                  style: TextStyle(
                    fontSize: 18,
                    color: Colors.red[600],
                    fontWeight: FontWeight.w500,
                  ),
                ),
              ],
            ),
          );
        }

        if (!snapshot.hasData) {
          return Center(child: CircularProgressIndicator());
        }

        final docs = snapshot.data!.docs;

// Filtrar registros con cumpleaños en el mes actual
        final cumpleanieros = docs.where((doc) {
          final data = doc.data() as Map<String, dynamic>;
          final raw = data['fechaNacimiento'];

          DateTime? fechaNacimiento;
          if (raw is Timestamp) {
            fechaNacimiento = raw.toDate();
          } else if (raw is DateTime) {
            fechaNacimiento = raw;
          } else if (raw is String && raw.trim().isNotEmpty) {
            fechaNacimiento = DateTime.tryParse(raw.trim());
          }

          if (fechaNacimiento == null) return false;
          return fechaNacimiento.month == currentMonth;
        }).toList();

        if (cumpleanieros.isEmpty) {
          return Center(
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                Icon(Icons.cake_outlined, size: 80, color: Colors.grey[400]),
                SizedBox(height: 16),
                Text(
                  'No hay cumpleaños este mes',
                  style: TextStyle(
                    fontSize: 18,
                    color: Colors.grey[600],
                    fontWeight: FontWeight.w500,
                  ),
                ),
                SizedBox(height: 8),
                Text(
                  'Los cumpleaños aparecerán aquí cuando llegue su mes',
                  style: TextStyle(color: Colors.grey[500]),
                  textAlign: TextAlign.center,
                ),
              ],
            ),
          );
        }

// Ordenar por día de cumpleaños
        cumpleanieros.sort((a, b) {
          final aData = a.data() as Map<String, dynamic>;
          final bData = b.data() as Map<String, dynamic>;

          DateTime? aDate;
          final aRaw = aData['fechaNacimiento'];
          if (aRaw is Timestamp) {
            aDate = aRaw.toDate();
          } else if (aRaw is DateTime) {
            aDate = aRaw;
          } else if (aRaw is String && aRaw.trim().isNotEmpty) {
            aDate = DateTime.tryParse(aRaw.trim());
          }

          DateTime? bDate;
          final bRaw = bData['fechaNacimiento'];
          if (bRaw is Timestamp) {
            bDate = bRaw.toDate();
          } else if (bRaw is DateTime) {
            bDate = bRaw;
          } else if (bRaw is String && bRaw.trim().isNotEmpty) {
            bDate = DateTime.tryParse(bRaw.trim());
          }

          if (aDate == null && bDate == null) return 0;
          if (aDate == null) return 1;
          if (bDate == null) return -1;

          return aDate.day.compareTo(bDate.day);
        });

        return RefreshIndicator(
          onRefresh: () async {
            setState(() {});
          },
          child: Column(
            children: [
              // Header del mes actual
              Container(
                margin: EdgeInsets.all(12),
                child: Card(
                  elevation: 4,
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(12),
                  ),
                  child: Container(
                    decoration: BoxDecoration(
                      borderRadius: BorderRadius.circular(12),
                      gradient: LinearGradient(
                        colors: [primaryTeal, primaryTeal.withOpacity(0.8)],
                        begin: Alignment.topLeft,
                        end: Alignment.bottomRight,
                      ),
                    ),
                    padding: EdgeInsets.all(16),
                    child: Row(
                      children: [
                        Icon(Icons.calendar_month,
                            color: Colors.white, size: 28),
                        SizedBox(width: 12),
                        Expanded(
                          child: Text(
                            '🎉 ${_nombreMes(currentMonth)} $currentYear',
                            style: TextStyle(
                              fontSize: 20,
                              fontWeight: FontWeight.bold,
                              color: Colors.white,
                            ),
                          ),
                        ),
                        Container(
                          padding:
                              EdgeInsets.symmetric(horizontal: 12, vertical: 6),
                          decoration: BoxDecoration(
                            color: Colors.white.withOpacity(0.2),
                            borderRadius: BorderRadius.circular(12),
                          ),
                          child: Text(
                            '${cumpleanieros.length} cumpleaños',
                            style: TextStyle(
                              color: Colors.white,
                              fontWeight: FontWeight.bold,
                            ),
                          ),
                        ),
                      ],
                    ),
                  ),
                ),
              ),
              // Lista de cumpleañeros
              Expanded(
                child: ListView.builder(
                  padding: EdgeInsets.symmetric(horizontal: 12),
                  itemCount: cumpleanieros.length,
                  itemBuilder: (context, index) {
                    final data =
                        cumpleanieros[index].data() as Map<String, dynamic>;
                    return _buildCumpleanosCard(data);
                  },
                ),
              ),
            ],
          ),
        );
      },
    );
  }

  Widget _buildCumpleanosCard(Map<String, dynamic> data) {
    final raw = data['fechaNacimiento'];
    DateTime? fechaNacimiento;

    if (raw is Timestamp) {
      fechaNacimiento = raw.toDate();
    } else if (raw is DateTime) {
      fechaNacimiento = raw;
    } else if (raw is String && raw.trim().isNotEmpty) {
      fechaNacimiento = DateTime.tryParse(raw.trim());
    }

    if (fechaNacimiento == null) {
      return const SizedBox.shrink();
    }

    final now = DateTime.now();
    final diaCumple = fechaNacimiento.day;

    final nombre = data['nombre'] ?? '';
    final apellido = data['apellido'] ?? '';
    final edad = _calcularEdad(fechaNacimiento, now);
    final sexo = data['sexo'] ?? '';
    final telefono = data['telefono'] ?? '';
    final barrio = data['barrio'] ?? '';

    // Verificar si es hoy
    final esHoy = now.day == diaCumple && now.month == fechaNacimiento.month;

    return Card(
      elevation: esHoy ? 8 : 4,
      margin: EdgeInsets.symmetric(vertical: 6),
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.circular(16),
        side: esHoy
            ? BorderSide(color: secondaryOrange, width: 2)
            : BorderSide.none,
      ),
      child: Container(
        decoration: BoxDecoration(
          borderRadius: BorderRadius.circular(16),
          gradient: esHoy
              ? LinearGradient(
                  colors: [secondaryOrange.withOpacity(0.1), Colors.white],
                  begin: Alignment.topLeft,
                  end: Alignment.bottomRight,
                )
              : null,
        ),
        child: Padding(
          padding: EdgeInsets.all(16),
          child: Column(
            children: [
              Row(
                children: [
                  // Día del cumpleaños
                  Container(
                    width: 60,
                    height: 60,
                    decoration: BoxDecoration(
                      shape: BoxShape.circle,
                      gradient: LinearGradient(
                        colors: esHoy
                            ? [
                                secondaryOrange,
                                secondaryOrange.withOpacity(0.8)
                              ]
                            : [
                                primaryTeal.withOpacity(0.2),
                                primaryTeal.withOpacity(0.1)
                              ],
                        begin: Alignment.topLeft,
                        end: Alignment.bottomRight,
                      ),
                      boxShadow: esHoy
                          ? [
                              BoxShadow(
                                color: secondaryOrange.withOpacity(0.3),
                                blurRadius: 8,
                                spreadRadius: 2,
                              ),
                            ]
                          : null,
                    ),
                    child: Center(
                      child: Column(
                        mainAxisAlignment: MainAxisAlignment.center,
                        children: [
                          Text(
                            '$diaCumple',
                            style: TextStyle(
                              fontSize: 18,
                              fontWeight: FontWeight.bold,
                              color: esHoy ? Colors.white : primaryTeal,
                            ),
                          ),
                          if (esHoy)
                            Text(
                              'HOY',
                              style: TextStyle(
                                fontSize: 8,
                                fontWeight: FontWeight.bold,
                                color: Colors.white,
                              ),
                            ),
                        ],
                      ),
                    ),
                  ),
                  SizedBox(width: 16),

                  // Información principal
                  Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Row(
                          children: [
                            Expanded(
                              child: Text(
                                "$nombre $apellido",
                                style: TextStyle(
                                  fontSize: 18,
                                  fontWeight: FontWeight.bold,
                                  color: Colors.black87,
                                ),
                              ),
                            ),
                            if (esHoy)
                              Container(
                                padding: EdgeInsets.symmetric(
                                    horizontal: 8, vertical: 4),
                                decoration: BoxDecoration(
                                  color: secondaryOrange,
                                  borderRadius: BorderRadius.circular(12),
                                ),
                                child: Text(
                                  '🎂 HOY',
                                  style: TextStyle(
                                    color: Colors.white,
                                    fontSize: 12,
                                    fontWeight: FontWeight.bold,
                                  ),
                                ),
                              ),
                          ],
                        ),
                        SizedBox(height: 8),
                        Row(
                          children: [
                            Icon(Icons.cake_outlined,
                                size: 16, color: Colors.grey[600]),
                            SizedBox(width: 4),
                            Text(
                              "Cumple $edad años",
                              style: TextStyle(
                                  color: Colors.grey[700],
                                  fontWeight: FontWeight.w500),
                            ),
                            SizedBox(width: 16),
                            Icon(
                              sexo.toLowerCase() == 'masculino'
                                  ? Icons.male
                                  : Icons.female,
                              size: 16,
                              color: sexo.toLowerCase() == 'masculino'
                                  ? Colors.blue
                                  : Colors.pink,
                            ),
                            SizedBox(width: 4),
                            Text(
                              sexo,
                              style: TextStyle(color: Colors.grey[700]),
                            ),
                          ],
                        ),
                      ],
                    ),
                  ),
                ],
              ),
              SizedBox(height: 12),

              // Información de contacto
              Container(
                padding: EdgeInsets.all(12),
                decoration: BoxDecoration(
                  color: Colors.grey[50],
                  borderRadius: BorderRadius.circular(12),
                ),
                child: Column(
                  children: [
                    if (telefono.isNotEmpty)
                      Row(
                        children: [
                          Icon(Icons.phone, size: 16, color: primaryTeal),
                          SizedBox(width: 8),
                          Expanded(
                            child: Text(
                              telefono,
                              style: TextStyle(color: Colors.grey[700]),
                            ),
                          ),
                        ],
                      ),
                    if (telefono.isNotEmpty && barrio.isNotEmpty)
                      SizedBox(height: 8),
                    if (barrio.isNotEmpty)
                      Row(
                        children: [
                          Icon(Icons.location_on, size: 16, color: primaryTeal),
                          SizedBox(width: 8),
                          Expanded(
                            child: Text(
                              barrio,
                              style: TextStyle(color: Colors.grey[700]),
                            ),
                          ),
                        ],
                      ),
                  ],
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  int _calcularEdad(DateTime fechaNacimiento, DateTime fechaActual) {
    int edad = fechaActual.year - fechaNacimiento.year;
    if (fechaActual.month < fechaNacimiento.month ||
        (fechaActual.month == fechaNacimiento.month &&
            fechaActual.day < fechaNacimiento.day)) {
      edad--;
    }
    return edad + 1; // +1 porque queremos la edad que va a cumplir
  }

  Widget _buildEventCard(DocumentSnapshot eventoDoc) {
    final evento = eventoDoc.data() as Map<String, dynamic>;
    final fechaInicio = (evento['fechaInicio'] as Timestamp).toDate();
    final fechaFin = (evento['fechaFin'] as Timestamp).toDate();
    final ahora = DateTime.now();
    final cumplido = ahora.isAfter(fechaFin);
    final estado = evento['estado'] ?? 'activo';

    // Cálculo responsivo del ancho de las tarjetas
    final screenWidth = MediaQuery.of(context).size.width;
    double cardWidth;

    if (screenWidth > 900) {
      // Pantallas muy grandes - 4 columnas
      cardWidth = (screenWidth - 80) / 4;
    } else if (screenWidth > 600) {
      // Pantallas medianas - 3 columnas
      cardWidth = (screenWidth - 60) / 3;
    } else if (screenWidth > 400) {
      // Pantallas pequeñas - 2 columnas
      cardWidth = (screenWidth - 40) / 2;
    } else {
      // Pantallas muy pequeñas - 1 columna
      cardWidth = screenWidth - 24;
    }

    return AnimatedContainer(
      duration: Duration(milliseconds: 300),
      curve: Curves.easeInOut,
      width: cardWidth,
      child: Card(
        key: ValueKey(eventoDoc.id),
        elevation: 6,
        margin: EdgeInsets.all(6),
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(20),
          side: BorderSide(
            color: estado == 'cancelado'
                ? Colors.red.shade400
                : cumplido
                    ? Colors.green.shade400
                    : primaryTeal,
            width: 2.5,
          ),
        ),
        child: Container(
          decoration: BoxDecoration(
            borderRadius: BorderRadius.circular(20),
            gradient: LinearGradient(
              begin: Alignment.topLeft,
              end: Alignment.bottomRight,
              colors: estado == 'cancelado'
                  ? [Colors.red[50]!, Colors.red[100]!]
                  : cumplido
                      ? [Colors.green[50]!, Colors.green[100]!]
                      : [Colors.white, lightTeal.withOpacity(0.2)],
            ),
            boxShadow: [
              BoxShadow(
                color: Colors.black.withOpacity(0.08),
                blurRadius: 12,
                offset: Offset(0, 4),
              ),
            ],
          ),
          child: Material(
            color: Colors.transparent,
            child: InkWell(
              borderRadius: BorderRadius.circular(20),
              onTap: () => _abrirDetalleEvento(eventoDoc),
              onLongPress: () => _mostrarOpcionesEvento(eventoDoc),
              child: Padding(
                padding: EdgeInsets.all(18),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  mainAxisSize: MainAxisSize.min,
                  children: [
                    // Header mejorado con animación
                    Row(
                      children: [
                        Hero(
                          tag: 'avatar_${eventoDoc.id}',
                          child: AnimatedContainer(
                            duration: Duration(milliseconds: 200),
                            child: CircleAvatar(
                              radius: 24,
                              backgroundColor: estado == 'cancelado'
                                  ? Colors.red.shade400
                                  : cumplido
                                      ? Colors.green.shade400
                                      : _getColorPorTipo(
                                          evento['tipo'] ?? 'encuentro'),
                              child: Icon(
                                estado == 'cancelado'
                                    ? Icons.cancel_outlined
                                    : cumplido
                                        ? Icons.check_circle_outlined
                                        : _getIconoPorTipo(
                                            evento['tipo'] ?? 'encuentro'),
                                color: Colors.white,
                                size: 24,
                              ),
                            ),
                          ),
                        ),
                        SizedBox(width: 12),
                        Expanded(
                          child: Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              Text(
                                evento['nombre'] ?? 'Sin nombre',
                                style: TextStyle(
                                  fontWeight: FontWeight.bold,
                                  fontSize: 16,
                                  color: estado == 'cancelado'
                                      ? Colors.red[700]
                                      : cumplido
                                          ? Colors.green[700]
                                          : Colors.black87,
                                  letterSpacing: 0.3,
                                ),
                                maxLines: 2,
                                overflow: TextOverflow.ellipsis,
                              ),
                              SizedBox(height: 6),
                              // Chip de tipo mejorado
                              Container(
                                padding: EdgeInsets.symmetric(
                                    horizontal: 10, vertical: 4),
                                decoration: BoxDecoration(
                                  gradient: LinearGradient(
                                    colors: [
                                      _getColorPorTipo(
                                              evento['tipo'] ?? 'encuentro')
                                          .withOpacity(0.2),
                                      _getColorPorTipo(
                                              evento['tipo'] ?? 'encuentro')
                                          .withOpacity(0.1),
                                    ],
                                  ),
                                  borderRadius: BorderRadius.circular(12),
                                  border: Border.all(
                                    color: _getColorPorTipo(
                                            evento['tipo'] ?? 'encuentro')
                                        .withOpacity(0.3),
                                    width: 1,
                                  ),
                                ),
                                child: Text(
                                  evento['tipo'] ?? 'Encuentro',
                                  style: TextStyle(
                                    fontSize: 11,
                                    color: _getColorPorTipo(
                                        evento['tipo'] ?? 'encuentro'),
                                    fontWeight: FontWeight.w600,
                                    letterSpacing: 0.2,
                                  ),
                                ),
                              ),
                            ],
                          ),
                        ),
                      ],
                    ),
                    SizedBox(height: 16),

                    // Fechas con diseño mejorado
                    Container(
                      padding: EdgeInsets.all(12),
                      decoration: BoxDecoration(
                        color: Colors.white.withOpacity(0.9),
                        borderRadius: BorderRadius.circular(12),
                        border: Border.all(
                          color: Colors.grey.shade200,
                          width: 1,
                        ),
                        boxShadow: [
                          BoxShadow(
                            color: Colors.black.withOpacity(0.03),
                            blurRadius: 4,
                            offset: Offset(0, 2),
                          ),
                        ],
                      ),
                      child: Column(
                        children: [
                          _buildFechaRow(
                            Icons.play_circle_outline,
                            'Inicio',
                            DateFormat('dd/MM/yyyy').format(fechaInicio),
                            Colors.green.shade600,
                          ),
                          Divider(height: 16, color: Colors.grey.shade300),
                          _buildFechaRow(
                            Icons.stop_circle_outlined,
                            'Fin',
                            DateFormat('dd/MM/yyyy').format(fechaFin),
                            Colors.red.shade600,
                          ),
                        ],
                      ),
                    ),
                    SizedBox(height: 12),

                    // Estado mejorado con gradiente
                    Container(
                      width: double.infinity,
                      padding:
                          EdgeInsets.symmetric(horizontal: 12, vertical: 8),
                      decoration: BoxDecoration(
                        gradient: LinearGradient(
                          colors: estado == 'cancelado'
                              ? [Colors.red.shade400, Colors.red.shade600]
                              : cumplido
                                  ? [
                                      Colors.green.shade400,
                                      Colors.green.shade600
                                    ]
                                  : [primaryTeal, primaryTeal.withOpacity(0.8)],
                        ),
                        borderRadius: BorderRadius.circular(16),
                        boxShadow: [
                          BoxShadow(
                            color: (estado == 'cancelado'
                                    ? Colors.red
                                    : cumplido
                                        ? Colors.green
                                        : primaryTeal)
                                .withOpacity(0.3),
                            blurRadius: 8,
                            offset: Offset(0, 2),
                          ),
                        ],
                      ),
                      child: Row(
                        mainAxisAlignment: MainAxisAlignment.center,
                        children: [
                          Icon(
                            estado == 'cancelado'
                                ? Icons.cancel
                                : cumplido
                                    ? Icons.check_circle
                                    : Icons.schedule,
                            color: Colors.white,
                            size: 16,
                          ),
                          SizedBox(width: 6),
                          Text(
                            estado == 'cancelado'
                                ? 'CANCELADO'
                                : cumplido
                                    ? 'CUMPLIDO'
                                    : 'ACTIVO',
                            style: TextStyle(
                              color: Colors.white,
                              fontSize: 12,
                              fontWeight: FontWeight.bold,
                              letterSpacing: 0.5,
                            ),
                          ),
                        ],
                      ),
                    ),
                    SizedBox(height: 12),

                    // Footer mejorado
                    Row(
                      mainAxisAlignment: MainAxisAlignment.spaceBetween,
                      children: [
                        // Contador de inscritos mejorado
                        Container(
                          padding:
                              EdgeInsets.symmetric(horizontal: 10, vertical: 6),
                          decoration: BoxDecoration(
                            gradient: LinearGradient(
                              colors: [
                                secondaryOrange.withOpacity(0.2),
                                secondaryOrange.withOpacity(0.1),
                              ],
                            ),
                            borderRadius: BorderRadius.circular(12),
                            border: Border.all(
                              color: secondaryOrange.withOpacity(0.3),
                              width: 1,
                            ),
                          ),
                          child: Row(
                            mainAxisSize: MainAxisSize.min,
                            children: [
                              Icon(Icons.people_outline,
                                  size: 16, color: secondaryOrange),
                              SizedBox(width: 4),
                              Text(
                                '${(evento['inscripciones'] as List?)?.length ?? 0}',
                                style: TextStyle(
                                  fontSize: 13,
                                  fontWeight: FontWeight.bold,
                                  color: secondaryOrange,
                                ),
                              ),
                            ],
                          ),
                        ),

                        // Botón de opciones mejorado
                        Container(
                          decoration: BoxDecoration(
                            color: Colors.grey.shade100,
                            borderRadius: BorderRadius.circular(20),
                          ),
                          child: Material(
                            color: Colors.transparent,
                            child: InkWell(
                              borderRadius: BorderRadius.circular(20),
                              onTap: () => _mostrarOpcionesEvento(eventoDoc),
                              child: Padding(
                                padding: EdgeInsets.all(8),
                                child: Icon(
                                  Icons.more_vert,
                                  size: 18,
                                  color: Colors.grey[600],
                                ),
                              ),
                            ),
                          ),
                        ),
                      ],
                    ),
                  ],
                ),
              ),
            ),
          ),
        ),
      ),
    );
  }

// Widget auxiliar para las filas de fecha
  Widget _buildFechaRow(
      IconData icon, String label, String fecha, Color color) {
    return Row(
      children: [
        Icon(icon, size: 16, color: color),
        SizedBox(width: 8),
        Text(
          label,
          style: TextStyle(
            fontSize: 12,
            color: Colors.grey[600],
            fontWeight: FontWeight.w500,
          ),
        ),
        Spacer(),
        Text(
          fecha,
          style: TextStyle(
            fontSize: 13,
            color: Colors.grey[800],
            fontWeight: FontWeight.w600,
          ),
        ),
      ],
    );
  }

  void _mostrarOpcionesEvento(DocumentSnapshot eventoDoc) {
    final evento = eventoDoc.data() as Map<String, dynamic>;
    final estado = evento['estado'] ?? 'activo';
    final fechaFin = (evento['fechaFin'] as Timestamp).toDate();
    final cumplido = DateTime.now().isAfter(fechaFin);

    showModalBottomSheet(
      context: context,
      backgroundColor: Colors.transparent,
      builder: (context) => Container(
        decoration: BoxDecoration(
          color: Colors.white,
          borderRadius: BorderRadius.only(
            topLeft: Radius.circular(20),
            topRight: Radius.circular(20),
          ),
        ),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            // Handle
            Container(
              margin: EdgeInsets.only(top: 8),
              width: 40,
              height: 4,
              decoration: BoxDecoration(
                color: Colors.grey[300],
                borderRadius: BorderRadius.circular(2),
              ),
            ),

            // Header
            Padding(
              padding: EdgeInsets.all(20),
              child: Row(
                children: [
                  Icon(Icons.settings, color: primaryTeal),
                  SizedBox(width: 12),
                  Expanded(
                    child: Text(
                      'Opciones de Evento',
                      style: TextStyle(
                        fontSize: 18,
                        fontWeight: FontWeight.bold,
                        color: primaryTeal,
                      ),
                    ),
                  ),
                ],
              ),
            ),

            // Opciones
            if (estado != 'cancelado') ...[
              ListTile(
                leading: Icon(Icons.visibility, color: primaryTeal),
                title: Text('Ver Detalles'),
                onTap: () {
                  Navigator.pop(context);
                  _abrirDetalleEvento(eventoDoc);
                },
              ),
              if (!cumplido) ...[
                ListTile(
                  leading: Icon(Icons.edit, color: secondaryOrange),
                  title: Text('Editar Evento'),
                  onTap: () {
                    Navigator.pop(context);
                    _editarEvento(eventoDoc);
                  },
                ),
                ListTile(
                  leading: Icon(Icons.cancel, color: Colors.red),
                  title: Text('Cancelar Evento'),
                  onTap: () {
                    Navigator.pop(context);
                    _cancelarEvento(eventoDoc);
                  },
                ),
              ],
            ],

            if (estado == 'cancelado')
              ListTile(
                leading: Icon(Icons.restore, color: Colors.green),
                title: Text('Reactivar Evento'),
                onTap: () {
                  Navigator.pop(context);
                  _reactivarEvento(eventoDoc);
                },
              ),

            SizedBox(height: 20),
          ],
        ),
      ),
    );
  }

  void _editarEvento(DocumentSnapshot eventoDoc) {
    showDialog(
      context: context,
      builder: (context) => DialogoEditarEvento(
        eventoDoc: eventoDoc,
        primaryColor: primaryTeal,
        secondaryColor: secondaryOrange,
      ),
    );
  }

  void _cancelarEvento(DocumentSnapshot eventoDoc) async {
    final confirmacion = await showDialog<bool>(
      context: context,
      builder: (context) => AlertDialog(
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(15)),
        title: Row(
          children: [
            Icon(Icons.warning, color: Colors.red),
            SizedBox(width: 8),
            Text('Cancelar Evento'),
          ],
        ),
        content: Text(
          '¿Estás seguro de que quieres cancelar este evento?\n\nEsta acción no afectará las inscripciones existentes, pero el evento aparecerá como cancelado.',
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context, false),
            child: Text('No'),
          ),
          ElevatedButton(
            style: ElevatedButton.styleFrom(backgroundColor: Colors.red),
            onPressed: () => Navigator.pop(context, true),
            child: Text('Sí, Cancelar', style: TextStyle(color: Colors.white)),
          ),
        ],
      ),
    );

    if (confirmacion == true) {
      try {
        await FirebaseFirestore.instance
            .collection('eventos')
            .doc(eventoDoc.id)
            .update({
          'estado': 'cancelado',
          'fechaCancelacion': FieldValue.serverTimestamp(),
        });

        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Evento cancelado correctamente'),
            backgroundColor: Colors.orange,
          ),
        );
      } catch (e) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Error al cancelar evento: $e'),
            backgroundColor: Colors.red,
          ),
        );
      }
    }
  }

  void _reactivarEvento(DocumentSnapshot eventoDoc) async {
    try {
      await FirebaseFirestore.instance
          .collection('eventos')
          .doc(eventoDoc.id)
          .update({
        'estado': 'activo',
        'fechaReactivacion': FieldValue.serverTimestamp(),
      });

      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Evento reactivado correctamente'),
          backgroundColor: Colors.green,
        ),
      );
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Error al reactivar evento: $e'),
          backgroundColor: Colors.red,
        ),
      );
    }
  }

  Map<int, Map<int, List<DocumentSnapshot>>> _agruparEventosPorFecha(
      List<DocumentSnapshot> eventos) {
    Map<int, Map<int, List<DocumentSnapshot>>> agrupados = {};

    print('Agrupando ${eventos.length} eventos');

    for (var evento in eventos) {
      try {
        final data = evento.data() as Map<String, dynamic>;

        // Verificar que existe fechaInicio
        if (data['fechaInicio'] == null) {
          print('Evento ${evento.id} no tiene fechaInicio');
          continue;
        }

        final fechaInicio = (data['fechaInicio'] as Timestamp).toDate();
        final anio = fechaInicio.year;
        final mes = fechaInicio.month;

        print('Evento: ${data['nombre']}, Año: $anio, Mes: $mes');

        // Inicializar estructuras si no existen
        if (agrupados[anio] == null) {
          agrupados[anio] = {};
        }
        if (agrupados[anio]![mes] == null) {
          agrupados[anio]![mes] = [];
        }

        agrupados[anio]![mes]!.add(evento);
      } catch (e) {
        print('Error al procesar evento ${evento.id}: $e');
      }
    }

    // Ordenar los eventos dentro de cada mes por fecha
    agrupados.forEach((anio, meses) {
      meses.forEach((mes, eventosDelMes) {
        eventosDelMes.sort((a, b) {
          try {
            final dataA = a.data() as Map<String, dynamic>;
            final dataB = b.data() as Map<String, dynamic>;
            final fechaA = (dataA['fechaInicio'] as Timestamp).toDate();
            final fechaB = (dataB['fechaInicio'] as Timestamp).toDate();
            return fechaA.compareTo(fechaB);
          } catch (e) {
            print('Error al ordenar eventos: $e');
            return 0;
          }
        });
      });
    });

    print('Eventos agrupados por año: ${agrupados.keys.toList()}');

    return agrupados;
  }

  String _nombreMes(int mes) {
    const meses = [
      '',
      'Enero',
      'Febrero',
      'Marzo',
      'Abril',
      'Mayo',
      'Junio',
      'Julio',
      'Agosto',
      'Septiembre',
      'Octubre',
      'Noviembre',
      'Diciembre'
    ];
    return meses[mes];
  }

  void _mostrarDialogoCrearEvento() {
    showDialog(
      context: context,
      builder: (context) => DialogoCrearEvento(
        tribuId: widget.tribuId,
        primaryColor: primaryTeal,
        secondaryColor: secondaryOrange,
      ),
    );
  }

  void _abrirDetalleEvento(DocumentSnapshot eventoDoc) {
    showBottomSheet(
      context: context,
      builder: (context) => DetalleEventoModal(
        eventoDoc: eventoDoc,
        tribuId: widget.tribuId,
        primaryColor: primaryTeal,
        secondaryColor: secondaryOrange,
      ),
    );
  }

  Widget _buildClasesDiscipuladoView() {
    return StreamBuilder<QuerySnapshot>(
      stream: FirebaseFirestore.instance
          .collection('clasesDiscipulado')
          .where('estado', isEqualTo: 'activa')
          .snapshots(),
      builder: (context, snapshot) {
        if (snapshot.connectionState == ConnectionState.waiting) {
          return Center(
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                Container(
                  padding: EdgeInsets.all(20),
                  decoration: BoxDecoration(
                    color: primaryTeal.withOpacity(0.1),
                    borderRadius: BorderRadius.circular(20),
                  ),
                  child: CircularProgressIndicator(
                    valueColor: AlwaysStoppedAnimation<Color>(primaryTeal),
                    strokeWidth: 3,
                  ),
                ),
                SizedBox(height: 24),
                Text(
                  'Cargando clases...',
                  style: TextStyle(
                    color: Colors.grey[600],
                    fontSize: 16,
                    fontWeight: FontWeight.w500,
                  ),
                ),
              ],
            ),
          );
        }

        if (snapshot.hasError) {
          return Center(
            child: Container(
              padding: EdgeInsets.all(24),
              margin: EdgeInsets.all(16),
              decoration: BoxDecoration(
                color: Colors.red.shade50,
                borderRadius: BorderRadius.circular(16),
                border: Border.all(color: Colors.red.shade200),
              ),
              child: Column(
                mainAxisAlignment: MainAxisAlignment.center,
                mainAxisSize: MainAxisSize.min,
                children: [
                  Icon(Icons.error_outline, size: 64, color: Colors.red[400]),
                  SizedBox(height: 16),
                  Text(
                    'Error al cargar clases',
                    style: TextStyle(
                      fontSize: 18,
                      color: Colors.red[600],
                      fontWeight: FontWeight.w600,
                    ),
                  ),
                ],
              ),
            ),
          );
        }

        if (!snapshot.hasData || snapshot.data!.docs.isEmpty) {
          return Center(
            child: Container(
              padding: EdgeInsets.all(32),
              margin: EdgeInsets.all(16),
              decoration: BoxDecoration(
                gradient: LinearGradient(
                  begin: Alignment.topLeft,
                  end: Alignment.bottomRight,
                  colors: [Colors.grey.shade50, Colors.grey.shade100],
                ),
                borderRadius: BorderRadius.circular(20),
                boxShadow: [
                  BoxShadow(
                    color: Colors.black.withOpacity(0.05),
                    blurRadius: 10,
                    offset: Offset(0, 4),
                  ),
                ],
              ),
              child: Column(
                mainAxisAlignment: MainAxisAlignment.center,
                mainAxisSize: MainAxisSize.min,
                children: [
                  Container(
                    padding: EdgeInsets.all(20),
                    decoration: BoxDecoration(
                      color: Colors.grey.shade200,
                      borderRadius: BorderRadius.circular(50),
                    ),
                    child: Icon(Icons.school_outlined,
                        size: 48, color: Colors.grey[500]),
                  ),
                  SizedBox(height: 20),
                  Text(
                    'No hay clases disponibles',
                    style: TextStyle(
                      fontSize: 20,
                      color: Colors.grey[700],
                      fontWeight: FontWeight.w600,
                    ),
                  ),
                  SizedBox(height: 8),
                  Text(
                    'Las clases aparecerán aquí cuando estén activas',
                    style: TextStyle(
                      color: Colors.grey[500],
                      fontSize: 14,
                      height: 1.5,
                    ),
                    textAlign: TextAlign.center,
                  ),
                ],
              ),
            ),
          );
        }

        // ✅ SEPARAR CLASES EN ABIERTAS Y CERRADAS Y ORDENAR
        final todasLasClases = snapshot.data!.docs;

        // Ordenar todas las clases por fechaInicio
        todasLasClases.sort((a, b) {
          final dataA = a.data() as Map<String, dynamic>;
          final dataB = b.data() as Map<String, dynamic>;

          final fechaA =
              (dataA['fechaInicio'] as Timestamp?)?.toDate() ?? DateTime.now();
          final fechaB =
              (dataB['fechaInicio'] as Timestamp?)?.toDate() ?? DateTime.now();

          return fechaA.compareTo(fechaB); // Orden cronológico ascendente
        });

        // Separar en abiertas y cerradas
        final clasesAbiertas = todasLasClases
            .where((doc) =>
                !(doc.data()
                    as Map<String, dynamic>)['inscripcionesCerradas'] ??
                false)
            .toList();

        final clasesCerradas = todasLasClases
            .where((doc) =>
                (doc.data() as Map<String, dynamic>)['inscripcionesCerradas'] ??
                false)
            .toList();

        return RefreshIndicator(
          onRefresh: () async {
            setState(() {}); // Forzar refresh
          },
          color: primaryTeal,
          child: ListView(
            padding: EdgeInsets.all(16),
            children: [
              // ✅ SECCIÓN: CLASES CON INSCRIPCIONES ABIERTAS
              if (clasesAbiertas.isNotEmpty) ...[
                _buildSeccionClases(
                  titulo: 'Inscripciones Abiertas',
                  icono: Icons.lock_open_rounded,
                  color: Colors.green,
                  clases: clasesAbiertas,
                  inicialmenteExpandido: false,
                ),
                SizedBox(height: 16),
              ],

              // ✅ SECCIÓN: CLASES CON INSCRIPCIONES CERRADAS
              if (clasesCerradas.isNotEmpty) ...[
                _buildSeccionClases(
                  titulo: 'Inscripciones Cerradas',
                  icono: Icons.lock_rounded,
                  color: Colors.red,
                  clases: clasesCerradas,
                  inicialmenteExpandido: false,
                ),
              ],

              // ✅ MENSAJE SI NO HAY CLASES EN NINGUNA CATEGORÍA
              if (clasesAbiertas.isEmpty && clasesCerradas.isEmpty)
                Container(
                  padding: EdgeInsets.all(24),
                  child: Text(
                    'No hay clases disponibles en este momento',
                    textAlign: TextAlign.center,
                    style: TextStyle(
                      color: Colors.grey[600],
                      fontSize: 16,
                    ),
                  ),
                ),
            ],
          ),
        );
      },
    );
  }

  Future<void> _inscribirPersonaEnClase(
      String claseId, Map<String, dynamic> claseData) async {
    // ✅ VERIFICAR SI LAS INSCRIPCIONES ESTÁN CERRADAS
    final inscripcionesCerradas = claseData['inscripcionesCerradas'] ?? false;

    if (inscripcionesCerradas) {
      showDialog(
        context: context,
        builder: (context) => Dialog(
          shape:
              RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
          child: Container(
            padding: EdgeInsets.all(24),
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                Container(
                  padding: EdgeInsets.all(16),
                  decoration: BoxDecoration(
                    color: Colors.red.withOpacity(0.1),
                    shape: BoxShape.circle,
                  ),
                  child: Icon(
                    Icons.lock_outline,
                    size: 64,
                    color: Colors.red[600],
                  ),
                ),
                SizedBox(height: 20),
                Text(
                  'Inscripciones Cerradas',
                  style: TextStyle(
                    fontSize: 22,
                    fontWeight: FontWeight.bold,
                    color: Colors.red[700],
                  ),
                  textAlign: TextAlign.center,
                ),
                SizedBox(height: 12),
                Text(
                  'Las inscripciones para esta clase han sido cerradas por el Departamento de Discipulado.',
                  style: TextStyle(
                    fontSize: 15,
                    color: Colors.grey[700],
                    height: 1.5,
                  ),
                  textAlign: TextAlign.center,
                ),
                SizedBox(height: 24),
                SizedBox(
                  width: double.infinity,
                  child: ElevatedButton(
                    onPressed: () => Navigator.pop(context),
                    style: ElevatedButton.styleFrom(
                      backgroundColor: Colors.red[600],
                      padding: EdgeInsets.symmetric(vertical: 14),
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(12),
                      ),
                    ),
                    child: Text(
                      'Entendido',
                      style: TextStyle(
                        fontSize: 16,
                        fontWeight: FontWeight.w600,
                        color: Colors.white,
                      ),
                    ),
                  ),
                ),
              ],
            ),
          ),
        ),
      );
      return;
    }

    setState(() => isLoading = true);

    try {
      final results = await Future.wait([
        FirebaseFirestore.instance
            .collection('registros')
            .where('tribuAsignada', isEqualTo: widget.tribuId)
            .where('activo', isEqualTo: true)
            .get(),
        FirebaseFirestore.instance
            .collection('eventos')
            .where('tribuId', isEqualTo: widget.tribuId)
            .where('estado', isEqualTo: 'activo')
            .get(),
      ]);

      final personasSnapshot = results[0] as QuerySnapshot;
      final eventosActivosSnapshot = results[1] as QuerySnapshot;

      final Set<String> personasConInscripcionActiva = {};
      final ahora = DateTime.now();

      for (var eventoDoc in eventosActivosSnapshot.docs) {
        final eventoData = eventoDoc.data() as Map<String, dynamic>;
        final fechaFin = (eventoData['fechaFin'] as Timestamp).toDate();

        if (fechaFin.isAfter(ahora)) {
          final inscripcionesEvento = List<Map<String, dynamic>>.from(
              eventoData['inscripciones'] ?? []);

          for (var inscripcion in inscripcionesEvento) {
            personasConInscripcionActiva
                .add(inscripcion['personaId'] as String);
          }
        }
      }

      final discipulosActuales = List<Map<String, dynamic>>.from(
          claseData['discipulosInscritos'] ?? []);

      final Set<String> personasYaInscritasEstaClase =
          discipulosActuales.map((d) => d['personaId'] as String).toSet();

      final personasDisponibles = personasSnapshot.docs.where((doc) {
        if (personasYaInscritasEstaClase.contains(doc.id)) {
          return false;
        }

        if (personasConInscripcionActiva.contains(doc.id)) {
          return false;
        }

        final data = doc.data() as Map<String, dynamic>?;
        if (data == null) return false;

        final nombre = data['nombre']?.toString().trim() ?? '';
        return nombre.isNotEmpty && nombre != 'Sin nombre';
      }).toList();

      setState(() => isLoading = false);

      if (personasDisponibles.isEmpty) {
        final totalPersonas = personasSnapshot.docs.length;
        final yaInscritas = discipulosActuales.length;
        final conInscripcionesActivas = personasConInscripcionActiva.length;

        String mensaje;
        if (yaInscritas == totalPersonas) {
          mensaje =
              'Todas las personas de la tribu ya están inscritas en esta clase';
        } else if (conInscripcionesActivas > 0) {
          mensaje =
              'Las personas restantes tienen inscripciones activas en otros eventos';
        } else {
          mensaje = 'No hay más personas disponibles para inscribir';
        }

        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(mensaje),
            backgroundColor: Colors.orange,
            duration: Duration(seconds: 4),
          ),
        );
        return;
      }

      final seleccion = await showDialog<DocumentSnapshot>(
        context: context,
        builder: (context) => _DialogoBuscarPersona(
          personas: personasDisponibles,
          primaryColor: primaryTeal,
          secondaryColor: secondaryOrange,
        ),
      );

      if (seleccion != null) {
        final personaData = seleccion.data() as Map<String, dynamic>;

        String nombreTribu = 'Sin nombre';
        try {
          final tribuDoc = await FirebaseFirestore.instance
              .collection('tribus')
              .doc(widget.tribuId)
              .get();

          if (tribuDoc.exists) {
            nombreTribu = tribuDoc.data()?['nombre'] ?? 'Sin nombre';
          }
        } catch (e) {
          print('Error al obtener nombre de tribu: $e');
        }

        // ✅ CRÍTICO: Usar doc.id como personaId para mantener sincronización
        discipulosActuales.add({
          'personaId':
              seleccion.id, // ✅ Este es el ID del documento en Firebase
          'nombre': '${personaData['nombre']} ${personaData['apellido']}',
          'telefono': personaData['telefono'] ?? 'Sin teléfono',
          'tribu': nombreTribu,
          'tribuId': widget.tribuId,
          'ministerio': personaData['ministerioAsignado'] ?? 'Sin ministerio',
          'fechaInscripcion': Timestamp.now(),
          'registradoPorMaestro': false, // ✅ Indicar que viene de tribu
        });

        await FirebaseFirestore.instance
            .collection('clasesDiscipulado')
            .doc(claseId)
            .update({
          'discipulosInscritos': discipulosActuales,
        });

        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('${personaData['nombre']} inscrito correctamente'),
            backgroundColor: Colors.green,
          ),
        );
      }
    } catch (e) {
      setState(() => isLoading = false);
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Error al inscribir: $e'),
          backgroundColor: Colors.red,
        ),
      );
    }
  }

  Future<void> _desasignarDiscipuloDeClase(
    String claseId,
    Map<String, dynamic> discipulo,
    String nombreTribu,
  ) async {
    final nombreCompleto = discipulo['nombre'] ?? 'Discípulo';

    // ✅ Mostrar confirmación sin Future.delayed
    final confirmar = await showDialog<bool>(
      context: context,
      barrierDismissible: false, // Prevenir cierre accidental
      builder: (dialogContext) => Dialog(
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
        child: Container(
          padding: EdgeInsets.all(24),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              // Icono de advertencia
              Container(
                padding: EdgeInsets.all(16),
                decoration: BoxDecoration(
                  color: Colors.orange.withOpacity(0.1),
                  shape: BoxShape.circle,
                ),
                child: Icon(
                  Icons.person_remove_outlined,
                  size: 64,
                  color: Colors.orange[700],
                ),
              ),
              SizedBox(height: 20),

              // Título
              Text(
                'Desasignar Discípulo',
                style: TextStyle(
                  fontSize: 22,
                  fontWeight: FontWeight.bold,
                  color: primaryTeal,
                ),
                textAlign: TextAlign.center,
              ),
              SizedBox(height: 12),

              // Mensaje
              RichText(
                textAlign: TextAlign.center,
                text: TextSpan(
                  style: TextStyle(
                    fontSize: 15,
                    color: Colors.grey[700],
                    height: 1.5,
                  ),
                  children: [
                    TextSpan(text: '¿Estás seguro de desasignar a '),
                    TextSpan(
                      text: '"$nombreCompleto"',
                      style: TextStyle(
                        fontWeight: FontWeight.bold,
                        color: primaryTeal,
                      ),
                    ),
                    TextSpan(text: ' de '),
                    TextSpan(
                      text: '"$nombreTribu"',
                      style: TextStyle(
                        fontWeight: FontWeight.bold,
                        color: secondaryOrange,
                      ),
                    ),
                    TextSpan(text: ' en esta clase?\n\n'),
                    TextSpan(
                      text:
                          'Podrás volver a inscribirlo mientras las inscripciones estén abiertas.',
                      style: TextStyle(
                        fontSize: 13,
                        fontStyle: FontStyle.italic,
                        color: Colors.grey[600],
                      ),
                    ),
                  ],
                ),
              ),
              SizedBox(height: 24),

              // Botones
              Row(
                children: [
                  Expanded(
                    child: TextButton(
                      onPressed: () => Navigator.of(dialogContext).pop(false),
                      style: TextButton.styleFrom(
                        padding: EdgeInsets.symmetric(vertical: 14),
                      ),
                      child: Text(
                        'Cancelar',
                        style: TextStyle(
                          fontSize: 16,
                          color: Colors.grey[700],
                        ),
                      ),
                    ),
                  ),
                  SizedBox(width: 12),
                  Expanded(
                    child: ElevatedButton(
                      onPressed: () => Navigator.of(dialogContext).pop(true),
                      style: ElevatedButton.styleFrom(
                        backgroundColor: Colors.orange[700],
                        padding: EdgeInsets.symmetric(vertical: 14),
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(12),
                        ),
                      ),
                      child: Text(
                        'Desasignar',
                        style: TextStyle(
                          fontSize: 16,
                          fontWeight: FontWeight.w600,
                          color: Colors.white,
                        ),
                      ),
                    ),
                  ),
                ],
              ),
            ],
          ),
        ),
      ),
    );

    // ✅ Si no confirmó, salir inmediatamente
    if (confirmar != true) return;

    // ✅ Mostrar loading overlay
    bool isLoading = true;

    // Mostrar overlay de loading sin usar showDialog
    final overlayEntry = OverlayEntry(
      builder: (context) => Container(
        color: Colors.black54,
        child: Center(
          child: Container(
            padding: EdgeInsets.all(24),
            decoration: BoxDecoration(
              color: Colors.white,
              borderRadius: BorderRadius.circular(16),
            ),
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                CircularProgressIndicator(
                  valueColor: AlwaysStoppedAnimation<Color>(primaryTeal),
                ),
                SizedBox(height: 16),
                Text(
                  'Desasignando...',
                  style: TextStyle(
                    fontSize: 16,
                    fontWeight: FontWeight.w600,
                    color: primaryTeal,
                  ),
                ),
              ],
            ),
          ),
        ),
      ),
    );

    // Insertar overlay
    Overlay.of(context)?.insert(overlayEntry);

    try {
      // ✅ Obtener la clase actual
      final claseDoc = await FirebaseFirestore.instance
          .collection('clasesDiscipulado')
          .doc(claseId)
          .get();

      if (!claseDoc.exists) {
        throw Exception('La clase no existe');
      }

      final claseData = claseDoc.data() as Map<String, dynamic>;
      final discipulos = List<Map<String, dynamic>>.from(
          claseData['discipulosInscritos'] ?? []);

      // ✅ Verificar que el discípulo existe en la lista
      final discipuloIndex = discipulos
          .indexWhere((d) => d['personaId'] == discipulo['personaId']);

      if (discipuloIndex == -1) {
        throw Exception('El discípulo no está inscrito en esta clase');
      }

      // ✅ Eliminar el discípulo de la lista
      discipulos.removeAt(discipuloIndex);

      // ✅ Actualizar en Firebase
      await FirebaseFirestore.instance
          .collection('clasesDiscipulado')
          .doc(claseId)
          .update({
        'discipulosInscritos': discipulos,
      });

      // ✅ Remover loading
      overlayEntry.remove();

      // ✅ Mostrar confirmación de éxito
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Row(
              children: [
                Icon(Icons.check_circle, color: Colors.white, size: 20),
                SizedBox(width: 12),
                Expanded(
                  child: Text(
                    '$nombreCompleto desasignado correctamente',
                    style: TextStyle(fontSize: 15),
                  ),
                ),
              ],
            ),
            backgroundColor: Colors.green[700],
            behavior: SnackBarBehavior.floating,
            shape: RoundedRectangleBorder(
              borderRadius: BorderRadius.circular(10),
            ),
            duration: Duration(seconds: 3),
          ),
        );
      }
    } catch (e) {
      // ✅ Remover loading en caso de error
      overlayEntry.remove();

      // ✅ Mostrar error
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Row(
              children: [
                Icon(Icons.error_outline, color: Colors.white, size: 20),
                SizedBox(width: 12),
                Expanded(
                  child: Text(
                    'Error al desasignar: ${e.toString()}',
                    style: TextStyle(fontSize: 15),
                  ),
                ),
              ],
            ),
            backgroundColor: Colors.red[700],
            behavior: SnackBarBehavior.floating,
            shape: RoundedRectangleBorder(
              borderRadius: BorderRadius.circular(10),
            ),
            duration: Duration(seconds: 4),
          ),
        );
      }

      // ✅ Log para debugging
      print('❌ Error al desasignar discípulo: $e');
    }
  }

  Widget _buildSeccionClases({
    required String titulo,
    required IconData icono,
    required Color color,
    required List<QueryDocumentSnapshot> clases,
    required bool inicialmenteExpandido,
  }) {
    return Card(
      elevation: 6,
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.circular(16),
      ),
      child: Container(
        decoration: BoxDecoration(
          borderRadius: BorderRadius.circular(16),
          gradient: LinearGradient(
            begin: Alignment.topLeft,
            end: Alignment.bottomRight,
            colors: [
              Colors.white,
              color.withOpacity(0.02),
            ],
          ),
        ),
        child: Theme(
          data: Theme.of(context).copyWith(
            dividerColor: Colors.transparent,
          ),
          child: ExpansionTile(
            initiallyExpanded: inicialmenteExpandido,
            tilePadding: EdgeInsets.symmetric(horizontal: 20, vertical: 12),
            childrenPadding: EdgeInsets.only(bottom: 12),
            leading: Container(
              padding: EdgeInsets.all(10),
              decoration: BoxDecoration(
                color: color.withOpacity(0.15),
                borderRadius: BorderRadius.circular(12),
              ),
              child: Icon(icono, color: color, size: 26),
            ),
            title: Text(
              titulo,
              style: TextStyle(
                fontSize: 18,
                fontWeight: FontWeight.bold,
                color: color,
                letterSpacing: 0.3,
              ),
            ),
            subtitle: Padding(
              padding: EdgeInsets.only(top: 4),
              child: Text(
                '${clases.length} ${clases.length == 1 ? 'clase' : 'clases'}',
                style: TextStyle(
                  color: Colors.grey[600],
                  fontSize: 13,
                  fontWeight: FontWeight.w500,
                ),
              ),
            ),
            children: [
              // ✅ Grid responsivo para las cards de clases
              Padding(
                padding: EdgeInsets.symmetric(horizontal: 12),
                child: LayoutBuilder(
                  builder: (context, constraints) {
                    return Wrap(
                      spacing: 12.0,
                      runSpacing: 12.0,
                      children: clases.map((claseDoc) {
                        return _buildClaseCard(claseDoc, constraints.maxWidth);
                      }).toList(),
                    );
                  },
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildClaseCard(DocumentSnapshot claseDoc, double maxWidth) {
    final data = claseDoc.data() as Map<String, dynamic>;
    final discipulos =
        List<Map<String, dynamic>>.from(data['discipulosInscritos'] ?? []);
    final personasDeEstaTribu =
        discipulos.where((d) => d['tribuId'] == widget.tribuId).length;
    final inscripcionesCerradas = data['inscripcionesCerradas'] ?? false;

    // ✅ DETERMINAR NOMENCLATURA SEGÚN TIPO DE CLASE
    final tipoClase = data['tipo'] ?? 'Clase';
    final usarLeccion = tipoClase == 'Discipulado 1' ||
        tipoClase == 'Discipulado 2' ||
        tipoClase == 'Discipulado 3' ||
        tipoClase == 'Consolidación';

    final nombreUnidad = usarLeccion ? 'Lecciones' : 'Módulos';

    // ✅ Cálculo responsivo del ancho de las tarjetas
    final screenWidth = MediaQuery.of(context).size.width;
    double cardWidth;

    if (screenWidth > 900) {
      // Pantallas muy grandes - 4 columnas
      cardWidth = (screenWidth - 80) / 4;
    } else if (screenWidth > 600) {
      // Pantallas medianas - 3 columnas
      cardWidth = (screenWidth - 60) / 3;
    } else if (screenWidth > 400) {
      // Pantallas pequeñas - 2 columnas
      cardWidth = (screenWidth - 40) / 2;
    } else {
      // Pantallas muy pequeñas - 1 columna
      cardWidth = screenWidth - 24;
    }

    return AnimatedContainer(
      duration: Duration(milliseconds: 300),
      curve: Curves.easeInOut,
      width: cardWidth,
      child: Card(
        elevation: 4,
        margin: EdgeInsets.zero,
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(16),
          side: BorderSide(
            color: inscripcionesCerradas
                ? Colors.red.withOpacity(0.3)
                : Colors.green.withOpacity(0.3),
            width: 2,
          ),
        ),
        child: Container(
          decoration: BoxDecoration(
            borderRadius: BorderRadius.circular(16),
            gradient: LinearGradient(
              begin: Alignment.topLeft,
              end: Alignment.bottomRight,
              colors: inscripcionesCerradas
                  ? [Colors.red.shade50, Colors.red.shade100]
                  : [Colors.green.shade50, Colors.green.shade100],
            ),
          ),
          child: Padding(
            padding: EdgeInsets.all(16),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                // ✅ Header con tipo y estado
                Row(
                  children: [
                    Expanded(
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Row(
                            children: [
                              Icon(
                                Icons.school_rounded,
                                color: primaryTeal,
                                size: 20,
                              ),
                              SizedBox(width: 6),
                              Expanded(
                                child: Text(
                                  tipoClase,
                                  style: TextStyle(
                                    fontWeight: FontWeight.bold,
                                    fontSize: 16,
                                    color: primaryTeal,
                                  ),
                                  maxLines: 2,
                                  overflow: TextOverflow.ellipsis,
                                ),
                              ),
                            ],
                          ),
                          SizedBox(height: 8),
                          // Badge de estado
                          Container(
                            padding: EdgeInsets.symmetric(
                                horizontal: 8, vertical: 4),
                            decoration: BoxDecoration(
                              color: inscripcionesCerradas
                                  ? Colors.red.withOpacity(0.2)
                                  : Colors.green.withOpacity(0.2),
                              borderRadius: BorderRadius.circular(8),
                              border: Border.all(
                                color: inscripcionesCerradas
                                    ? Colors.red.withOpacity(0.4)
                                    : Colors.green.withOpacity(0.4),
                              ),
                            ),
                            child: Row(
                              mainAxisSize: MainAxisSize.min,
                              children: [
                                Icon(
                                  inscripcionesCerradas
                                      ? Icons.lock
                                      : Icons.lock_open,
                                  size: 12,
                                  color: inscripcionesCerradas
                                      ? Colors.red[700]
                                      : Colors.green[700],
                                ),
                                SizedBox(width: 4),
                                Text(
                                  inscripcionesCerradas
                                      ? 'Cerradas'
                                      : 'Abiertas',
                                  style: TextStyle(
                                    fontSize: 11,
                                    fontWeight: FontWeight.bold,
                                    color: inscripcionesCerradas
                                        ? Colors.red[700]
                                        : Colors.green[700],
                                  ),
                                ),
                              ],
                            ),
                          ),
                        ],
                      ),
                    ),
                  ],
                ),
                SizedBox(height: 12),

                // ✅ Información de la clase CON NOMENCLATURA CORRECTA
                Container(
                  padding: EdgeInsets.all(10),
                  decoration: BoxDecoration(
                    color: Colors.white.withOpacity(0.7),
                    borderRadius: BorderRadius.circular(10),
                  ),
                  child: Column(
                    children: [
                      _buildInfoRow(
                        Icons.format_list_numbered_rounded,
                        nombreUnidad, // ✅ CAMBIADO
                        '${data['totalModulos'] ?? 0}',
                        Colors.blue,
                      ),
                      Divider(height: 12, color: Colors.grey.shade300),
                      _buildInfoRow(
                        Icons.calendar_today_rounded,
                        'Inicio',
                        DateFormat('dd/MM/yyyy').format(
                            (data['fechaInicio'] as Timestamp).toDate()),
                        Colors.orange,
                      ),
                      if (data['maestroNombre'] != null) ...[
                        Divider(height: 12, color: Colors.grey.shade300),
                        _buildInfoRow(
                          Icons.person_rounded,
                          'Maestro',
                          data['maestroNombre'],
                          Colors.purple,
                        ),
                      ],
                    ],
                  ),
                ),
                SizedBox(height: 12),

                // ✅ Footer con contador e inscripción
                Row(
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: [
                    // Contador de inscritos de esta tribu
                    Container(
                      padding:
                          EdgeInsets.symmetric(horizontal: 10, vertical: 6),
                      decoration: BoxDecoration(
                        gradient: LinearGradient(
                          colors: [
                            secondaryOrange.withOpacity(0.2),
                            secondaryOrange.withOpacity(0.1),
                          ],
                        ),
                        borderRadius: BorderRadius.circular(12),
                        border: Border.all(
                          color: secondaryOrange.withOpacity(0.3),
                        ),
                      ),
                      child: Row(
                        mainAxisSize: MainAxisSize.min,
                        children: [
                          Icon(Icons.people_rounded,
                              size: 16, color: secondaryOrange),
                          SizedBox(width: 4),
                          Text(
                            '$personasDeEstaTribu',
                            style: TextStyle(
                              fontSize: 13,
                              fontWeight: FontWeight.bold,
                              color: secondaryOrange,
                            ),
                          ),
                        ],
                      ),
                    ),

                    // Botón de inscripción
                    Tooltip(
                      message: inscripcionesCerradas
                          ? 'Inscripciones cerradas'
                          : 'Inscribir persona',
                      child: Material(
                        color: Colors.transparent,
                        child: InkWell(
                          borderRadius: BorderRadius.circular(20),
                          onTap: inscripcionesCerradas
                              ? () =>
                                  _inscribirPersonaEnClase(claseDoc.id, data)
                              : () =>
                                  _inscribirPersonaEnClase(claseDoc.id, data),
                          child: Container(
                            padding: EdgeInsets.all(8),
                            decoration: BoxDecoration(
                              color: inscripcionesCerradas
                                  ? Colors.grey.shade300
                                  : primaryTeal.withOpacity(0.1),
                              borderRadius: BorderRadius.circular(20),
                              border: Border.all(
                                color: inscripcionesCerradas
                                    ? Colors.grey.shade400
                                    : primaryTeal.withOpacity(0.3),
                              ),
                            ),
                            child: Icon(
                              Icons.person_add_rounded,
                              color: inscripcionesCerradas
                                  ? Colors.grey.shade600
                                  : primaryTeal,
                              size: 20,
                            ),
                          ),
                        ),
                      ),
                    ),
                  ],
                ),

                // ✅ Lista de inscritos expandible (sin cambios adicionales)
                if (personasDeEstaTribu > 0) ...[
                  SizedBox(height: 12),
                  Theme(
                    data: Theme.of(context).copyWith(
                      dividerColor: Colors.transparent,
                    ),
                    child: ExpansionTile(
                      tilePadding: EdgeInsets.zero,
                      childrenPadding: EdgeInsets.only(top: 8),
                      title: Text(
                        'Ver inscritos de esta tribu',
                        style: TextStyle(
                          fontSize: 13,
                          fontWeight: FontWeight.w600,
                          color: primaryTeal,
                        ),
                      ),
                      leading:
                          Icon(Icons.expand_more, color: primaryTeal, size: 20),
                      children: [
                        Container(
                          padding: EdgeInsets.all(8),
                          decoration: BoxDecoration(
                            color: Colors.white.withOpacity(0.5),
                            borderRadius: BorderRadius.circular(8),
                          ),
                          child: Column(
                            children: discipulos
                                .where((d) => d['tribuId'] == widget.tribuId)
                                .map((d) => Padding(
                                      padding: EdgeInsets.only(bottom: 6),
                                      child: Row(
                                        children: [
                                          CircleAvatar(
                                            backgroundColor:
                                                primaryTeal.withOpacity(0.1),
                                            radius: 14,
                                            child: Icon(Icons.person,
                                                size: 14, color: primaryTeal),
                                          ),
                                          SizedBox(width: 8),
                                          Expanded(
                                            child: Column(
                                              crossAxisAlignment:
                                                  CrossAxisAlignment.start,
                                              children: [
                                                Text(
                                                  d['nombre'] ?? '',
                                                  style: TextStyle(
                                                    fontSize: 12,
                                                    fontWeight: FontWeight.w600,
                                                  ),
                                                ),
                                                Text(
                                                  '${d['telefono']} | ${d['ministerio']}',
                                                  style: TextStyle(
                                                    fontSize: 10,
                                                    color: Colors.grey[600],
                                                  ),
                                                ),
                                              ],
                                            ),
                                          ),
                                          if (!inscripcionesCerradas)
                                            Tooltip(
                                              message: 'Desasignar',
                                              child: InkWell(
                                                borderRadius:
                                                    BorderRadius.circular(12),
                                                onTap: () async {
                                                  final nombreTribu =
                                                      await _obtenerNombreTribu(
                                                          widget.tribuId);
                                                  _desasignarDiscipuloDeClase(
                                                      claseDoc.id,
                                                      d,
                                                      nombreTribu);
                                                },
                                                child: Container(
                                                  padding: EdgeInsets.all(4),
                                                  decoration: BoxDecoration(
                                                    color: Colors.red
                                                        .withOpacity(0.1),
                                                    borderRadius:
                                                        BorderRadius.circular(
                                                            12),
                                                  ),
                                                  child: Icon(
                                                    Icons.close_rounded,
                                                    color: Colors.red[700],
                                                    size: 16,
                                                  ),
                                                ),
                                              ),
                                            ),
                                        ],
                                      ),
                                    ))
                                .toList(),
                          ),
                        ),
                      ],
                    ),
                  ),
                ],
              ],
            ),
          ),
        ),
      ),
    );
  }

  /// Widget auxiliar para filas de información
  Widget _buildInfoRow(IconData icon, String label, String value, Color color) {
    return Row(
      children: [
        Icon(icon, size: 14, color: color),
        SizedBox(width: 6),
        Text(
          label,
          style: TextStyle(
            fontSize: 11,
            color: Colors.grey[700],
            fontWeight: FontWeight.w500,
          ),
        ),
        Spacer(),
        Flexible(
          child: Text(
            value,
            style: TextStyle(
              fontSize: 12,
              color: Colors.grey[800],
              fontWeight: FontWeight.w600,
            ),
            textAlign: TextAlign.right,
            overflow: TextOverflow.ellipsis,
          ),
        ),
      ],
    );
  }
}

//Clase dialogo buscar persona

class _DialogoBuscarPersona extends StatefulWidget {
  final List<DocumentSnapshot> personas;
  final Color primaryColor;
  final Color secondaryColor;

  const _DialogoBuscarPersona({
    Key? key,
    required this.personas,
    required this.primaryColor,
    required this.secondaryColor,
  }) : super(key: key);

  @override
  _DialogoBuscarPersonaState createState() => _DialogoBuscarPersonaState();
}

class _DialogoBuscarPersonaState extends State<_DialogoBuscarPersona> {
  final TextEditingController _searchController = TextEditingController();
  final FocusNode _searchFocusNode = FocusNode();
  final ScrollController _scrollController = ScrollController();
  List<DocumentSnapshot> personasFiltradas = [];

  @override
  void initState() {
    super.initState();
    personasFiltradas = widget.personas;
    _searchController.addListener(_filtrarPersonas);
  }

  @override
  void dispose() {
    _searchController.removeListener(_filtrarPersonas);
    _searchController.dispose();
    _searchFocusNode.dispose();
    _scrollController.dispose();
    super.dispose();
  }

  void _filtrarPersonas() {
    final query = _searchController.text.toLowerCase().trim();

    setState(() {
      if (query.isEmpty) {
        personasFiltradas = widget.personas;
      } else {
        personasFiltradas = widget.personas.where((doc) {
          try {
            final data = doc.data() as Map<String, dynamic>?;
            if (data == null) return false;

            final nombre = data['nombre']?.toString().toLowerCase() ?? '';
            final apellido = data['apellido']?.toString().toLowerCase() ?? '';
            final nombreCompleto = '$nombre $apellido'.trim();

            return nombreCompleto.contains(query);
          } catch (e) {
            print('Error filtrando persona: $e');
            return false;
          }
        }).toList();
      }
    });

    // ✅ Auto-scroll al inicio después de filtrar
    if (_scrollController.hasClients) {
      _scrollController.jumpTo(0);
    }
  }

  @override
  Widget build(BuildContext context) {
    final screenSize = MediaQuery.of(context).size;
    final isSmallScreen = screenSize.width < 600;

    return GestureDetector(
      onTap: () => Navigator.pop(context), // ✅ Cerrar al tocar afuera
      child: Dialog(
        backgroundColor: Colors.transparent,
        insetPadding: EdgeInsets.zero, // ✅ Sin padding automático
        child: GestureDetector(
          onTap: () {}, // ✅ Prevenir cierre al tocar el dialog
          child: Center(
            child: Container(
              width: isSmallScreen ? screenSize.width * 0.92 : 600,
              height: screenSize.height * 0.80, // ✅ Altura fija
              margin: EdgeInsets.symmetric(horizontal: 16),
              decoration: BoxDecoration(
                color: Colors.white,
                borderRadius: BorderRadius.circular(20),
                boxShadow: [
                  BoxShadow(
                    color: Colors.black26,
                    blurRadius: 20,
                    offset: Offset(0, 10),
                  ),
                ],
              ),
              child: Column(
                mainAxisSize: MainAxisSize.min,
                children: [
                  // ═══════════════════════════════════════════════════════
                  // HEADER FIJO
                  // ═══════════════════════════════════════════════════════
                  Container(
                    padding: EdgeInsets.all(isSmallScreen ? 14 : 18),
                    decoration: BoxDecoration(
                      color: widget.primaryColor.withOpacity(0.1),
                      borderRadius: BorderRadius.only(
                        topLeft: Radius.circular(20),
                        topRight: Radius.circular(20),
                      ),
                    ),
                    child: Row(
                      children: [
                        Icon(
                          Icons.person_search,
                          color: widget.primaryColor,
                          size: isSmallScreen ? 22 : 26,
                        ),
                        SizedBox(width: 10),
                        Expanded(
                          child: Text(
                            'Buscar Persona',
                            style: TextStyle(
                              fontSize: isSmallScreen ? 17 : 19,
                              fontWeight: FontWeight.bold,
                              color: widget.primaryColor,
                            ),
                          ),
                        ),
                        Material(
                          color: Colors.transparent,
                          child: InkWell(
                            borderRadius: BorderRadius.circular(20),
                            onTap: () => Navigator.pop(context),
                            child: Container(
                              padding: EdgeInsets.all(6),
                              child: Icon(
                                Icons.close,
                                color: Colors.grey[600],
                                size: isSmallScreen ? 20 : 24,
                              ),
                            ),
                          ),
                        ),
                      ],
                    ),
                  ),

                  // ═══════════════════════════════════════════════════════
                  // BARRA DE BÚSQUEDA FIJA
                  // ═══════════════════════════════════════════════════════
                  Container(
                    padding: EdgeInsets.fromLTRB(
                      isSmallScreen ? 12 : 16,
                      isSmallScreen ? 12 : 14,
                      isSmallScreen ? 12 : 16,
                      isSmallScreen ? 8 : 10,
                    ),
                    child: TextField(
                      controller: _searchController,
                      focusNode: _searchFocusNode,
                      autofocus: false,
                      style: TextStyle(
                        fontSize: isSmallScreen ? 14 : 16,
                        height: 1.3,
                      ),
                      decoration: InputDecoration(
                        hintText: 'Buscar por nombre...',
                        hintStyle: TextStyle(
                          fontSize: isSmallScreen ? 13 : 15,
                          color: Colors.grey[500],
                        ),
                        prefixIcon: Icon(
                          Icons.search,
                          color: widget.primaryColor,
                          size: isSmallScreen ? 20 : 22,
                        ),
                        suffixIcon: _searchController.text.isNotEmpty
                            ? IconButton(
                                icon: Icon(
                                  Icons.clear,
                                  size: isSmallScreen ? 18 : 20,
                                ),
                                onPressed: () {
                                  _searchController.clear();
                                  _searchFocusNode.unfocus();
                                },
                                padding: EdgeInsets.all(8),
                                constraints: BoxConstraints(),
                              )
                            : null,
                        border: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(12),
                          borderSide: BorderSide(color: widget.primaryColor),
                        ),
                        enabledBorder: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(12),
                          borderSide: BorderSide(color: Colors.grey[300]!),
                        ),
                        focusedBorder: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(12),
                          borderSide: BorderSide(
                            color: widget.primaryColor,
                            width: 2,
                          ),
                        ),
                        contentPadding: EdgeInsets.symmetric(
                          horizontal: isSmallScreen ? 10 : 14,
                          vertical: isSmallScreen ? 12 : 14,
                        ),
                        isDense: true,
                      ),
                    ),
                  ),

                  // ═══════════════════════════════════════════════════════
                  // CONTADOR DE RESULTADOS FIJO
                  // ═══════════════════════════════════════════════════════
                  Padding(
                    padding: EdgeInsets.symmetric(
                      horizontal: isSmallScreen ? 12 : 16,
                      vertical: 4,
                    ),
                    child: Row(
                      children: [
                        Icon(
                          Icons.people_outline,
                          size: isSmallScreen ? 14 : 16,
                          color: Colors.grey[600],
                        ),
                        SizedBox(width: 6),
                        Text(
                          '${personasFiltradas.length} ${personasFiltradas.length == 1 ? 'persona' : 'personas'}',
                          style: TextStyle(
                            color: Colors.grey[600],
                            fontSize: isSmallScreen ? 12 : 13,
                            fontWeight: FontWeight.w500,
                          ),
                        ),
                      ],
                    ),
                  ),

                  // ═══════════════════════════════════════════════════════
                  // LISTA SCROLLABLE - ÁREA EXPANSIBLE
                  // ═══════════════════════════════════════════════════════

                  Expanded(
                    child: personasFiltradas.isEmpty
                        ? Center(
                            child: Padding(
                              padding: EdgeInsets.all(isSmallScreen ? 16 : 24),
                              child: Column(
                                mainAxisAlignment: MainAxisAlignment.center,
                                children: [
                                  Container(
                                    padding:
                                        EdgeInsets.all(isSmallScreen ? 14 : 18),
                                    decoration: BoxDecoration(
                                      color: Colors.grey[100],
                                      shape: BoxShape.circle,
                                    ),
                                    child: Icon(
                                      Icons.person_off_outlined,
                                      size: isSmallScreen ? 40 : 50,
                                      color: Colors.grey[400],
                                    ),
                                  ),
                                  SizedBox(height: isSmallScreen ? 12 : 16),
                                  Text(
                                    'No se encontraron personas',
                                    style: TextStyle(
                                      fontSize: isSmallScreen ? 15 : 17,
                                      color: Colors.grey[700],
                                      fontWeight: FontWeight.w600,
                                    ),
                                    textAlign: TextAlign.center,
                                  ),
                                  SizedBox(height: 6),
                                  Text(
                                    'Intenta con otro término',
                                    style: TextStyle(
                                      color: Colors.grey[500],
                                      fontSize: isSmallScreen ? 12 : 14,
                                    ),
                                    textAlign: TextAlign.center,
                                  ),
                                ],
                              ),
                            ),
                          )
                        : NotificationListener<ScrollNotification>(
                            onNotification: (notification) {
                              // ✅ SOLUCIÓN: Prevenir que el scroll cierre el teclado
                              return true; // Consumir la notificación
                            },
                            child: ListView.builder(
                              controller: _scrollController,
                              padding: EdgeInsets.fromLTRB(
                                isSmallScreen ? 8 : 12,
                                4,
                                isSmallScreen ? 8 : 12,
                                8,
                              ),
                              itemCount: personasFiltradas.length,
                              keyboardDismissBehavior:
                                  ScrollViewKeyboardDismissBehavior
                                      .manual, // ✅ CRÍTICO
                              physics: AlwaysScrollableScrollPhysics(),
                              itemBuilder: (context, index) {
                                final doc = personasFiltradas[index];

                                try {
                                  final data =
                                      doc.data() as Map<String, dynamic>?;
                                  if (data == null) {
                                    return SizedBox.shrink();
                                  }

                                  final nombre = data['nombre']?.toString() ??
                                      'Sin nombre';
                                  final apellido =
                                      data['apellido']?.toString() ?? '';
                                  final nombreCompleto = apellido.isNotEmpty
                                      ? '$nombre $apellido'
                                      : nombre;

                                  return Card(
                                    margin: EdgeInsets.symmetric(
                                      vertical: isSmallScreen ? 4 : 5,
                                      horizontal: 2,
                                    ),
                                    elevation: 2,
                                    shape: RoundedRectangleBorder(
                                      borderRadius: BorderRadius.circular(12),
                                    ),
                                    child: InkWell(
                                      borderRadius: BorderRadius.circular(12),
                                      onTap: () {
                                        _searchFocusNode.unfocus();
                                        Navigator.pop(context, doc);
                                      },
                                      child: Padding(
                                        padding: EdgeInsets.symmetric(
                                          horizontal: isSmallScreen ? 10 : 14,
                                          vertical: isSmallScreen ? 10 : 12,
                                        ),
                                        child: Row(
                                          children: [
                                            // Avatar
                                            CircleAvatar(
                                              backgroundColor: widget
                                                  .primaryColor
                                                  .withOpacity(0.1),
                                              radius: isSmallScreen ? 18 : 22,
                                              child: Text(
                                                nombreCompleto.isNotEmpty
                                                    ? nombreCompleto[0]
                                                        .toUpperCase()
                                                    : '?',
                                                style: TextStyle(
                                                  color: widget.primaryColor,
                                                  fontWeight: FontWeight.bold,
                                                  fontSize:
                                                      isSmallScreen ? 15 : 17,
                                                ),
                                              ),
                                            ),
                                            SizedBox(
                                                width: isSmallScreen ? 10 : 14),

                                            // Nombre
                                            Expanded(
                                              child: Text(
                                                nombreCompleto,
                                                style: TextStyle(
                                                  fontWeight: FontWeight.w600,
                                                  fontSize:
                                                      isSmallScreen ? 14 : 15,
                                                  color: Colors.black87,
                                                  height: 1.3,
                                                ),
                                                maxLines: 2,
                                                overflow: TextOverflow.ellipsis,
                                              ),
                                            ),

                                            // Icono de acción
                                            Container(
                                              padding: EdgeInsets.all(6),
                                              decoration: BoxDecoration(
                                                color: widget.secondaryColor
                                                    .withOpacity(0.1),
                                                borderRadius:
                                                    BorderRadius.circular(8),
                                              ),
                                              child: Icon(
                                                Icons.add_circle_outline,
                                                color: widget.secondaryColor,
                                                size: isSmallScreen ? 20 : 24,
                                              ),
                                            ),
                                          ],
                                        ),
                                      ),
                                    ),
                                  );
                                } catch (e) {
                                  print('Error mostrando persona: $e');
                                  return SizedBox.shrink();
                                }
                              },
                            ),
                          ),
                  ),
                  // ═══════════════════════════════════════════════════════
                  // BOTÓN CANCELAR FIJO - SIEMPRE AL FINAL
                  // ═══════════════════════════════════════════════════════
                  Container(
                    padding: EdgeInsets.fromLTRB(
                      isSmallScreen ? 12 : 16,
                      isSmallScreen ? 10 : 12,
                      isSmallScreen ? 12 : 16,
                      isSmallScreen ? 12 : 14,
                    ),
                    decoration: BoxDecoration(
                      color: Colors.white,
                      border: Border(
                        top: BorderSide(color: Colors.grey[300]!, width: 1),
                      ),
                      borderRadius: BorderRadius.only(
                        bottomLeft: Radius.circular(20),
                        bottomRight: Radius.circular(20),
                      ),
                    ),
                    child: SizedBox(
                      width: double.infinity,
                      child: TextButton(
                        onPressed: () {
                          _searchFocusNode.unfocus();
                          Navigator.pop(context);
                        },
                        style: TextButton.styleFrom(
                          padding: EdgeInsets.symmetric(
                            vertical: isSmallScreen ? 12 : 14,
                          ),
                          shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(12),
                          ),
                          backgroundColor: Colors.grey[100],
                        ),
                        child: Text(
                          'Cancelar',
                          style: TextStyle(
                            color: Colors.grey[700],
                            fontSize: isSmallScreen ? 14 : 15,
                            fontWeight: FontWeight.w600,
                          ),
                        ),
                      ),
                    ),
                  ),
                ],
              ),
            ),
          ),
        ),
      ),
    );
  }
}

//----------------------------------------------------------------------------------------------

class DialogoCrearEvento extends StatefulWidget {
  final String tribuId;
  final Color primaryColor;
  final Color secondaryColor;

  const DialogoCrearEvento({
    Key? key,
    required this.tribuId,
    required this.primaryColor,
    required this.secondaryColor,
  }) : super(key: key);

  @override
  _DialogoCrearEventoState createState() => _DialogoCrearEventoState();
}

class _DialogoCrearEventoState extends State<DialogoCrearEvento> {
  final _formKey = GlobalKey<FormState>();
  final _nombreController = TextEditingController();

  String tipoSeleccionado = 'Encuentro';
  DateTime? fechaInicio;
  DateTime? fechaFin;

  final List<String> tiposEvento = [
    'Encuentro',
    'Raíces',
    'Reencuentro',
    'Personalizado'
  ];

  @override
  void dispose() {
    _nombreController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Dialog(
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
      child: SingleChildScrollView(
        child: Padding(
          padding: EdgeInsets.all(20),
          child: Form(
            key: _formKey,
            child: Column(
              mainAxisSize: MainAxisSize.min,
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                // Header
                Container(
                  padding: EdgeInsets.all(12),
                  decoration: BoxDecoration(
                    color: widget.primaryColor.withOpacity(0.1),
                    borderRadius: BorderRadius.circular(10),
                  ),
                  child: Row(
                    children: [
                      Icon(Icons.event_note,
                          color: widget.primaryColor, size: 28),
                      SizedBox(width: 12),
                      Text(
                        'Crear Nuevo Evento',
                        style: TextStyle(
                          fontSize: 20,
                          fontWeight: FontWeight.bold,
                          color: widget.primaryColor,
                        ),
                      ),
                    ],
                  ),
                ),
                SizedBox(height: 20),

                // Tipo de evento
                Text(
                  'Tipo de Evento',
                  style: TextStyle(
                    fontWeight: FontWeight.bold,
                    color: widget.primaryColor,
                    fontSize: 16,
                  ),
                ),
                SizedBox(height: 8),
                DropdownButtonFormField<String>(
                  value: tipoSeleccionado,
                  decoration: InputDecoration(
                    border: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(12),
                    ),
                    prefixIcon:
                        Icon(Icons.category, color: widget.primaryColor),
                  ),
                  items: tiposEvento.map((tipo) {
                    return DropdownMenuItem(
                      value: tipo,
                      child: Row(
                        children: [
                          Icon(
                            tipo == 'Personalizado' ? Icons.edit : Icons.event,
                            color: widget.secondaryColor,
                            size: 20,
                          ),
                          SizedBox(width: 8),
                          Text(tipo),
                        ],
                      ),
                    );
                  }).toList(),
                  onChanged: (valor) {
                    setState(() {
                      tipoSeleccionado = valor!;
                      if (tipoSeleccionado != 'Personalizado') {
                        _nombreController.text = tipoSeleccionado;
                      } else {
                        _nombreController.clear();
                      }
                    });
                  },
                  validator: (value) =>
                      value == null ? 'Selecciona un tipo' : null,
                ),
                SizedBox(height: 16),

                // Nombre personalizado
                if (tipoSeleccionado == 'Personalizado') ...[
                  Text(
                    'Nombre del Evento',
                    style: TextStyle(
                      fontWeight: FontWeight.bold,
                      color: widget.primaryColor,
                      fontSize: 16,
                    ),
                  ),
                  SizedBox(height: 8),
                  TextFormField(
                    controller: _nombreController,
                    decoration: InputDecoration(
                      border: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(12),
                      ),
                      prefixIcon: Icon(Icons.title, color: widget.primaryColor),
                      hintText: 'Ingresa el nombre del evento',
                    ),
                    validator: (value) {
                      if (tipoSeleccionado == 'Personalizado' &&
                          (value == null || value.isEmpty)) {
                        return 'El nombre es obligatorio';
                      }
                      return null;
                    },
                  ),
                  SizedBox(height: 16),
                ],

                // Fecha de inicio
                Text(
                  'Fecha de Inicio',
                  style: TextStyle(
                    fontWeight: FontWeight.bold,
                    color: widget.primaryColor,
                    fontSize: 16,
                  ),
                ),
                SizedBox(height: 8),
                InkWell(
                  onTap: () => _seleccionarFechaInicio(),
                  child: Container(
                    padding: EdgeInsets.all(16),
                    decoration: BoxDecoration(
                      border: Border.all(color: Colors.grey),
                      borderRadius: BorderRadius.circular(12),
                    ),
                    child: Row(
                      children: [
                        Icon(Icons.calendar_today, color: widget.primaryColor),
                        SizedBox(width: 12),
                        Text(
                          fechaInicio == null
                              ? 'Seleccionar fecha de inicio'
                              : DateFormat('dd/MM/yyyy').format(fechaInicio!),
                          style: TextStyle(
                            color: fechaInicio == null
                                ? Colors.grey
                                : Colors.black,
                          ),
                        ),
                      ],
                    ),
                  ),
                ),
                SizedBox(height: 16),

                // Fecha de fin
                Text(
                  'Fecha de Fin',
                  style: TextStyle(
                    fontWeight: FontWeight.bold,
                    color: widget.primaryColor,
                    fontSize: 16,
                  ),
                ),
                SizedBox(height: 8),
                InkWell(
                  onTap:
                      fechaInicio == null ? null : () => _seleccionarFechaFin(),
                  child: Container(
                    padding: EdgeInsets.all(16),
                    decoration: BoxDecoration(
                      border: Border.all(
                        color: fechaInicio == null
                            ? Colors.grey[300]!
                            : Colors.grey,
                      ),
                      borderRadius: BorderRadius.circular(12),
                    ),
                    child: Row(
                      children: [
                        Icon(
                          Icons.event_available,
                          color: fechaInicio == null
                              ? Colors.grey[300]
                              : widget.primaryColor,
                        ),
                        SizedBox(width: 12),
                        Text(
                          fechaFin == null
                              ? 'Seleccionar fecha de fin'
                              : DateFormat('dd/MM/yyyy').format(fechaFin!),
                          style: TextStyle(
                            color:
                                fechaFin == null ? Colors.grey : Colors.black,
                          ),
                        ),
                      ],
                    ),
                  ),
                ),
                SizedBox(height: 24),

                // Botones
                Row(
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: [
                    TextButton(
                      onPressed: () => Navigator.pop(context),
                      child: Text(
                        'Cancelar',
                        style: TextStyle(color: Colors.grey[600]),
                      ),
                    ),
                    ElevatedButton(
                      style: ElevatedButton.styleFrom(
                        backgroundColor: widget.secondaryColor,
                        padding:
                            EdgeInsets.symmetric(horizontal: 24, vertical: 12),
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(12),
                        ),
                      ),
                      onPressed: _crearEvento,
                      child: Text(
                        'Crear Evento',
                        style: TextStyle(
                          color: Colors.white,
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                    ),
                  ],
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }

  Future<void> _seleccionarFechaInicio() async {
    final fecha = await showDatePicker(
      context: context,
      initialDate: DateTime.now(),
      firstDate: DateTime.now(),
      lastDate: DateTime(2030),
      builder: (context, child) {
        return Theme(
          data: Theme.of(context).copyWith(
            colorScheme: ColorScheme.light(
              primary: widget.primaryColor,
              onPrimary: Colors.white,
              onSurface: Colors.black,
            ),
          ),
          child: child!,
        );
      },
    );

    if (fecha != null) {
      setState(() {
        fechaInicio = fecha;
        fechaFin = null; // Reset fecha fin
      });
    }
  }

  Future<void> _seleccionarFechaFin() async {
    final fecha = await showDatePicker(
      context: context,
      initialDate: fechaInicio!,
      firstDate: fechaInicio!,
      lastDate: DateTime(2030),
      builder: (context, child) {
        return Theme(
          data: Theme.of(context).copyWith(
            colorScheme: ColorScheme.light(
              primary: widget.primaryColor,
              onPrimary: Colors.white,
              onSurface: Colors.black,
            ),
          ),
          child: child!,
        );
      },
    );

    if (fecha != null) {
      setState(() {
        fechaFin = fecha;
      });
    }
  }

  Future<String> _obtenerNombreTribu(String tribuId) async {
    try {
      final doc = await FirebaseFirestore.instance
          .collection('tribus')
          .doc(tribuId)
          .get();

      if (doc.exists && doc.data() != null) {
        return doc.data()?['nombre'] ?? 'Sin nombre';
      }
    } catch (e) {
      print('Error al obtener nombre de tribu: $e');
    }
    return 'Sin nombre';
  }

  /// Función principal para crear un nuevo evento en Firebase
  /// Incluye validaciones, formato automático del nombre y eliminación automática
  void _crearEvento() async {
    // ===== VALIDACIONES INICIALES =====

    // Validar que el formulario esté correctamente llenado
    if (!_formKey.currentState!.validate()) return;

    // Validar que ambas fechas estén seleccionadas
    if (fechaInicio == null || fechaFin == null) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Por favor selecciona las fechas del evento'),
          backgroundColor: Colors.red,
        ),
      );
      return;
    }

    // ===== MOSTRAR INDICADOR DE CARGA =====

    // Mostrar diálogo de loading mientras se procesa
    showDialog(
      context: context,
      barrierDismissible: false, // No se puede cerrar tocando fuera
      builder: (context) => Center(
        child: CircularProgressIndicator(
          valueColor: AlwaysStoppedAnimation<Color>(widget.primaryColor),
        ),
      ),
    );

    try {
      // ===== CONSTRUCCIÓN DEL NOMBRE AUTOMÁTICO =====

      // Determinar el nombre base según el tipo seleccionado
      final nombreBase = tipoSeleccionado == 'Personalizado'
          ? _nombreController.text.trim() // Usar texto personalizado
          : tipoSeleccionado; // Usar tipo predefinido (Encuentro, Raíces, etc.)

      // Construir nombre completo: "TipoEvento - NombreTribu"
      final nombre =
          '$nombreBase - ${await _obtenerNombreTribu(widget.tribuId)}';

      // ===== CONFIGURACIÓN DE FECHAS =====

      // Crear fecha de inicio con hora 00:00:00 para que empiece al inicio del día
      final fechaInicioConHora = DateTime(fechaInicio!.year, fechaInicio!.month,
          fechaInicio!.day, 0, 0, 0 // Hora: 00:00:00
          );

      // Crear fecha de fin con hora 23:59:59 para que termine al final del día
      final fechaFinConHora = DateTime(fechaFin!.year, fechaFin!.month,
          fechaFin!.day, 23, 59, 59 // Hora: 23:59:59
          );

      // ===== FECHA DE ELIMINACIÓN AUTOMÁTICA =====

      // Calcular cuándo se eliminará automáticamente (1 año después del fin)
      final fechaEliminacionAutomatica = DateTime(
          fechaFinConHora.year + 1, // Agregar 1 año
          fechaFinConHora.month,
          fechaFinConHora.day,
          23,
          59,
          59 // Al final del día de eliminación
          );

      // ===== GUARDAR EN FIREBASE =====

      // Crear el documento del evento en la colección 'eventos'
      await FirebaseFirestore.instance.collection('eventos').add({
        // Información básica del evento
        'nombre': nombre, // Nombre con formato: "Tipo - Tribu"
        'tipo': tipoSeleccionado, // Tipo original seleccionado

        // Fechas del evento (convertidas a Timestamp de Firebase)
        'fechaInicio': Timestamp.fromDate(fechaInicioConHora),
        'fechaFin': Timestamp.fromDate(fechaFinConHora),

        // NUEVO: Fecha de eliminación automática
        'fechaEliminacionAutomatica':
            Timestamp.fromDate(fechaEliminacionAutomatica),

        // Relación con la tribu
        'tribuId': widget.tribuId,

        // Lista vacía para inscripciones (se llenará después)
        'inscripciones': <Map<String, dynamic>>[],

        // Metadatos del evento
        'fechaCreacion':
            FieldValue.serverTimestamp(), // Fecha actual del servidor
        'estado': 'activo', // Estado inicial del evento

        // Información adicional para el sistema de eliminación
        'eliminacionAutomatica':
            true, // Indica que se eliminará automáticamente
        'añosParaEliminar': 1, // Configuración: eliminar después de 1 año
      });

      // ===== CERRAR LOADING Y DIÁLOGO =====

      Navigator.of(context, rootNavigator: true).pop(); // Cerrar loading
      Navigator.pop(context); // Cerrar diálogo de crear evento

      // ===== MOSTRAR CONFIRMACIÓN DE ÉXITO =====

      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Row(
            children: [
              Icon(Icons.check_circle, color: Colors.white),
              SizedBox(width: 12),
              Expanded(
                child: Column(
                  mainAxisSize: MainAxisSize.min,
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text('Evento "$nombre" creado correctamente'),
                    Text(
                      'Se eliminará automáticamente el ${DateFormat('dd/MM/yyyy').format(fechaEliminacionAutomatica)}',
                      style: TextStyle(fontSize: 12, color: Colors.white70),
                    ),
                  ],
                ),
              ),
            ],
          ),
          backgroundColor: Colors.green,
          behavior: SnackBarBehavior.floating,
          shape:
              RoundedRectangleBorder(borderRadius: BorderRadius.circular(10)),
          duration: Duration(seconds: 4), // Mostrar por 4 segundos
        ),
      );
    } catch (e) {
      // ===== MANEJO DE ERRORES =====

      Navigator.of(context, rootNavigator: true).pop(); // Cerrar loading

      // Mostrar mensaje de error al usuario
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Error al crear el evento: $e'),
          backgroundColor: Colors.red,
        ),
      );

      // Log detallado para debugging (solo visible en consola de desarrollo)
      print('Error detallado al crear evento: $e');
    }
  }

// =============================================================================
// FUNCIÓN ADICIONAL: Sistema de limpieza automática
// UBICACIÓN: Colócala también dentro de la clase _DialogoCrearEventoState
// O mejor aún, en un archivo separado como 'services/limpieza_service.dart'
// =============================================================================

  /// Función para eliminar eventos que ya cumplieron su fecha de eliminación automática
  /// Se debe ejecutar periódicamente (por ejemplo, al iniciar la app)
  static Future<void> eliminarEventosVencidos() async {
    try {
      final ahora = DateTime.now();

      print('🧹 Iniciando limpieza de eventos vencidos...');

      // Buscar eventos cuya fecha de eliminación automática ya pasó
      final querySnapshot = await FirebaseFirestore.instance
          .collection('eventos')
          .where('fechaEliminacionAutomatica',
              isLessThan: Timestamp.fromDate(ahora))
          .get();

      print(
          '📋 Encontrados ${querySnapshot.docs.length} eventos para eliminar');

      if (querySnapshot.docs.isEmpty) {
        print('✅ No hay eventos para eliminar');
        return;
      }

      // Eliminar eventos en lotes para mejor rendimiento
      WriteBatch batch = FirebaseFirestore.instance.batch();
      int contador = 0;
      List<String> nombresEliminados = [];

      for (var doc in querySnapshot.docs) {
        // Agregar operación de eliminación al batch
        batch.delete(doc.reference);
        contador++;

        // Guardar nombre para log
        final data = doc.data() as Map<String, dynamic>;
        nombresEliminados.add(data['nombre'] ?? 'Sin nombre');

        // Firebase permite máximo 500 operaciones por batch
        if (contador >= 500) {
          await batch.commit();
          batch = FirebaseFirestore.instance.batch();
          contador = 0;
          print('🗑️ Eliminado lote de 500 eventos');
        }
      }

      // Ejecutar el último batch si tiene operaciones pendientes
      if (contador > 0) {
        await batch.commit();
      }

      // Log de eventos eliminados
      print('✅ Eliminados ${querySnapshot.docs.length} eventos vencidos:');
      for (String nombre in nombresEliminados) {
        print('   - $nombre');
      }
    } catch (e) {
      print('❌ Error al eliminar eventos vencidos: $e');
    }
  }
}

// AGREGA esta clase DESPUÉS de la clase DialogoCrearEvento

class DialogoEditarEvento extends StatefulWidget {
  final DocumentSnapshot eventoDoc;
  final Color primaryColor;
  final Color secondaryColor;

  const DialogoEditarEvento({
    Key? key,
    required this.eventoDoc,
    required this.primaryColor,
    required this.secondaryColor,
  }) : super(key: key);

  @override
  _DialogoEditarEventoState createState() => _DialogoEditarEventoState();
}

class _DialogoEditarEventoState extends State<DialogoEditarEvento> {
  final _formKey = GlobalKey<FormState>();
  final _nombreController = TextEditingController();

  String tipoSeleccionado = 'Encuentro';
  DateTime? fechaInicio;
  DateTime? fechaFin;
  bool _isLoading = false;

  final List<String> tiposEvento = [
    'Encuentro',
    'Raíces',
    'Reencuentro',
    'Personalizado'
  ];

  @override
  void initState() {
    super.initState();
    _cargarDatosEvento();
  }

  void _cargarDatosEvento() {
    final data = widget.eventoDoc.data() as Map<String, dynamic>;

    setState(() {
      tipoSeleccionado = data['tipo'] ?? 'Encuentro';
      _nombreController.text = data['nombre'] ?? '';
      fechaInicio = (data['fechaInicio'] as Timestamp).toDate();
      fechaFin = (data['fechaFin'] as Timestamp).toDate();
    });
  }

  @override
  void dispose() {
    _nombreController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Dialog(
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
      child: SingleChildScrollView(
        child: Padding(
          padding: EdgeInsets.all(20),
          child: Form(
            key: _formKey,
            child: Column(
              mainAxisSize: MainAxisSize.min,
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                // Header
                Container(
                  padding: EdgeInsets.all(12),
                  decoration: BoxDecoration(
                    color: widget.primaryColor.withOpacity(0.1),
                    borderRadius: BorderRadius.circular(10),
                  ),
                  child: Row(
                    children: [
                      Icon(Icons.edit_note,
                          color: widget.primaryColor, size: 28),
                      SizedBox(width: 12),
                      Text(
                        'Editar Evento',
                        style: TextStyle(
                          fontSize: 20,
                          fontWeight: FontWeight.bold,
                          color: widget.primaryColor,
                        ),
                      ),
                    ],
                  ),
                ),
                SizedBox(height: 20),

                // Tipo de evento
                Text(
                  'Tipo de Evento',
                  style: TextStyle(
                    fontWeight: FontWeight.bold,
                    color: widget.primaryColor,
                    fontSize: 16,
                  ),
                ),
                SizedBox(height: 8),
                DropdownButtonFormField<String>(
                  value: tipoSeleccionado,
                  decoration: InputDecoration(
                    border: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(12),
                    ),
                    prefixIcon:
                        Icon(Icons.category, color: widget.primaryColor),
                  ),
                  items: tiposEvento.map((tipo) {
                    return DropdownMenuItem(
                      value: tipo,
                      child: Row(
                        children: [
                          Icon(
                            tipo == 'Personalizado' ? Icons.edit : Icons.event,
                            color: widget.secondaryColor,
                            size: 20,
                          ),
                          SizedBox(width: 8),
                          Text(tipo),
                        ],
                      ),
                    );
                  }).toList(),
                  onChanged: (valor) {
                    setState(() {
                      tipoSeleccionado = valor!;
                      if (tipoSeleccionado != 'Personalizado') {
                        _nombreController.text = tipoSeleccionado;
                      }
                    });
                  },
                  validator: (value) =>
                      value == null ? 'Selecciona un tipo' : null,
                ),
                SizedBox(height: 16),

                // Nombre del evento
                Text(
                  'Nombre del Evento',
                  style: TextStyle(
                    fontWeight: FontWeight.bold,
                    color: widget.primaryColor,
                    fontSize: 16,
                  ),
                ),
                SizedBox(height: 8),
                TextFormField(
                  controller: _nombreController,
                  decoration: InputDecoration(
                    border: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(12),
                    ),
                    prefixIcon: Icon(Icons.title, color: widget.primaryColor),
                    hintText: 'Ingresa el nombre del evento',
                  ),
                  validator: (value) {
                    if (value == null || value.isEmpty) {
                      return 'El nombre es obligatorio';
                    }
                    return null;
                  },
                ),
                SizedBox(height: 16),

                // Fecha de inicio
                Text(
                  'Fecha de Inicio',
                  style: TextStyle(
                    fontWeight: FontWeight.bold,
                    color: widget.primaryColor,
                    fontSize: 16,
                  ),
                ),
                SizedBox(height: 8),
                InkWell(
                  onTap: _isLoading ? null : () => _seleccionarFechaInicio(),
                  child: Container(
                    padding: EdgeInsets.all(16),
                    decoration: BoxDecoration(
                      border: Border.all(color: Colors.grey),
                      borderRadius: BorderRadius.circular(12),
                    ),
                    child: Row(
                      children: [
                        Icon(Icons.calendar_today, color: widget.primaryColor),
                        SizedBox(width: 12),
                        Text(
                          fechaInicio == null
                              ? 'Seleccionar fecha de inicio'
                              : DateFormat('dd/MM/yyyy').format(fechaInicio!),
                          style: TextStyle(
                            color: fechaInicio == null
                                ? Colors.grey
                                : Colors.black,
                          ),
                        ),
                      ],
                    ),
                  ),
                ),
                SizedBox(height: 16),

                // Fecha de fin
                Text(
                  'Fecha de Fin',
                  style: TextStyle(
                    fontWeight: FontWeight.bold,
                    color: widget.primaryColor,
                    fontSize: 16,
                  ),
                ),
                SizedBox(height: 8),
                InkWell(
                  onTap: _isLoading || fechaInicio == null
                      ? null
                      : () => _seleccionarFechaFin(),
                  child: Container(
                    padding: EdgeInsets.all(16),
                    decoration: BoxDecoration(
                      border: Border.all(
                        color: fechaInicio == null || _isLoading
                            ? Colors.grey[300]!
                            : Colors.grey,
                      ),
                      borderRadius: BorderRadius.circular(12),
                    ),
                    child: Row(
                      children: [
                        Icon(
                          Icons.event_available,
                          color: fechaInicio == null || _isLoading
                              ? Colors.grey[300]
                              : widget.primaryColor,
                        ),
                        SizedBox(width: 12),
                        Text(
                          fechaFin == null
                              ? 'Seleccionar fecha de fin'
                              : DateFormat('dd/MM/yyyy').format(fechaFin!),
                          style: TextStyle(
                            color:
                                fechaFin == null ? Colors.grey : Colors.black,
                          ),
                        ),
                      ],
                    ),
                  ),
                ),
                SizedBox(height: 24),

                // Botones
                Row(
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: [
                    TextButton(
                      onPressed:
                          _isLoading ? null : () => Navigator.pop(context),
                      child: Text(
                        'Cancelar',
                        style: TextStyle(color: Colors.grey[600]),
                      ),
                    ),
                    ElevatedButton(
                      style: ElevatedButton.styleFrom(
                        backgroundColor: widget.secondaryColor,
                        padding:
                            EdgeInsets.symmetric(horizontal: 24, vertical: 12),
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(12),
                        ),
                      ),
                      onPressed: _isLoading ? null : _actualizarEvento,
                      child: _isLoading
                          ? SizedBox(
                              width: 20,
                              height: 20,
                              child: CircularProgressIndicator(
                                strokeWidth: 2,
                                valueColor:
                                    AlwaysStoppedAnimation<Color>(Colors.white),
                              ),
                            )
                          : Text(
                              'Actualizar Evento',
                              style: TextStyle(
                                color: Colors.white,
                                fontWeight: FontWeight.bold,
                              ),
                            ),
                    ),
                  ],
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }

  Future<void> _seleccionarFechaInicio() async {
    final fecha = await showDatePicker(
      context: context,
      initialDate: fechaInicio ?? DateTime.now(),
      firstDate: DateTime(2020),
      lastDate: DateTime(2030),
      builder: (context, child) {
        return Theme(
          data: Theme.of(context).copyWith(
            colorScheme: ColorScheme.light(
              primary: widget.primaryColor,
              onPrimary: Colors.white,
              onSurface: Colors.black,
            ),
          ),
          child: child!,
        );
      },
    );

    if (fecha != null) {
      setState(() {
        fechaInicio = fecha;
        // Solo resetear fecha fin si la nueva fecha inicio es posterior
        if (fechaFin != null && fecha.isAfter(fechaFin!)) {
          fechaFin = null;
        }
      });
    }
  }

  Future<void> _seleccionarFechaFin() async {
    final fecha = await showDatePicker(
      context: context,
      initialDate: fechaFin ?? fechaInicio!,
      firstDate: fechaInicio!,
      lastDate: DateTime(2030),
      builder: (context, child) {
        return Theme(
          data: Theme.of(context).copyWith(
            colorScheme: ColorScheme.light(
              primary: widget.primaryColor,
              onPrimary: Colors.white,
              onSurface: Colors.black,
            ),
          ),
          child: child!,
        );
      },
    );

    if (fecha != null) {
      setState(() {
        fechaFin = fecha;
      });
    }
  }

  void _actualizarEvento() async {
    if (!_formKey.currentState!.validate()) return;
    if (fechaInicio == null || fechaFin == null) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Por favor selecciona las fechas del evento'),
          backgroundColor: Colors.red,
        ),
      );
      return;
    }

    setState(() => _isLoading = true);

    try {
      final nombre = _nombreController.text.trim();

      // Crear las fechas con hora específica para mejor control
      final fechaInicioConHora = DateTime(
          fechaInicio!.year, fechaInicio!.month, fechaInicio!.day, 0, 0, 0);

      final fechaFinConHora =
          DateTime(fechaFin!.year, fechaFin!.month, fechaFin!.day, 23, 59, 59);

      // Actualizar el evento
      await FirebaseFirestore.instance
          .collection('eventos')
          .doc(widget.eventoDoc.id)
          .update({
        'nombre': nombre,
        'tipo': tipoSeleccionado,
        'fechaInicio': Timestamp.fromDate(fechaInicioConHora),
        'fechaFin': Timestamp.fromDate(fechaFinConHora),
        'fechaActualizacion': FieldValue.serverTimestamp(),
      });

      Navigator.pop(context); // Cerrar diálogo

      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Row(
            children: [
              Icon(Icons.check_circle, color: Colors.white),
              SizedBox(width: 12),
              Text('Evento "$nombre" actualizado correctamente'),
            ],
          ),
          backgroundColor: Colors.green,
          behavior: SnackBarBehavior.floating,
          shape:
              RoundedRectangleBorder(borderRadius: BorderRadius.circular(10)),
        ),
      );
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Error al actualizar el evento: $e'),
          backgroundColor: Colors.red,
        ),
      );
      print('Error detallado al actualizar evento: $e'); // Para debugging
    } finally {
      if (mounted) {
        setState(() => _isLoading = false);
      }
    }
  }
}

//----------------------------------------------------------------------

class DetalleEventoModal extends StatefulWidget {
  final DocumentSnapshot eventoDoc;
  final String tribuId;
  final Color primaryColor;
  final Color secondaryColor;

  const DetalleEventoModal({
    Key? key,
    required this.eventoDoc,
    required this.tribuId,
    required this.primaryColor,
    required this.secondaryColor,
  }) : super(key: key);

  @override
  _DetalleEventoModalState createState() => _DetalleEventoModalState();
}

class _DetalleEventoModalState extends State<DetalleEventoModal> {
  List<Map<String, dynamic>> inscripciones = [];
  bool isLoading = false;

  @override
  void initState() {
    super.initState();
    _cargarInscripciones();
  }

  void _cargarInscripciones() {
    final data = widget.eventoDoc.data() as Map<String, dynamic>;
    setState(() {
      inscripciones =
          List<Map<String, dynamic>>.from(data['inscripciones'] ?? []);
    });
  }

  @override
  Widget build(BuildContext context) {
    final data = widget.eventoDoc.data() as Map<String, dynamic>;
    final nombre = data['nombre'] ?? 'Sin nombre';
    final fechaInicio = (data['fechaInicio'] as Timestamp).toDate();
    final fechaFin = (data['fechaFin'] as Timestamp).toDate();
    final ahora = DateTime.now();
    final cumplido = ahora.isAfter(fechaFin);

    return DraggableScrollableSheet(
      initialChildSize: 0.9,
      minChildSize: 0.5,
      maxChildSize: 0.95,
      builder: (context, scrollController) {
        return Container(
          decoration: BoxDecoration(
            color: Colors.white,
            borderRadius: BorderRadius.only(
              topLeft: Radius.circular(20),
              topRight: Radius.circular(20),
            ),
            boxShadow: [
              BoxShadow(
                color: Colors.black26,
                blurRadius: 10,
                offset: Offset(0, -5),
              ),
            ],
          ),
          child: Column(
            children: [
              // Handle para arrastrar
              Container(
                margin: EdgeInsets.only(top: 8),
                width: 40,
                height: 4,
                decoration: BoxDecoration(
                  color: Colors.grey[300],
                  borderRadius: BorderRadius.circular(2),
                ),
              ),

              // Header del evento
              Container(
                padding: EdgeInsets.all(20),
                decoration: BoxDecoration(
                  gradient: LinearGradient(
                    colors: [
                      widget.primaryColor,
                      widget.primaryColor.withOpacity(0.8)
                    ],
                    begin: Alignment.topLeft,
                    end: Alignment.bottomRight,
                  ),
                  borderRadius: BorderRadius.only(
                    topLeft: Radius.circular(20),
                    topRight: Radius.circular(20),
                  ),
                ),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Row(
                      children: [
                        CircleAvatar(
                          backgroundColor: Colors.white,
                          child: Icon(
                            cumplido ? Icons.check : Icons.event,
                            color: widget.primaryColor,
                          ),
                        ),
                        SizedBox(width: 12),
                        Expanded(
                          child: Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              Text(
                                nombre,
                                style: TextStyle(
                                  fontSize: 22,
                                  fontWeight: FontWeight.bold,
                                  color: Colors.white,
                                ),
                              ),
                              Text(
                                'Del ${DateFormat('dd/MM/yyyy').format(fechaInicio)} al ${DateFormat('dd/MM/yyyy').format(fechaFin)}',
                                style: TextStyle(
                                  color: Colors.white.withOpacity(0.9),
                                  fontSize: 14,
                                ),
                              ),
                            ],
                          ),
                        ),
                        if (cumplido)
                          Container(
                            padding: EdgeInsets.symmetric(
                                horizontal: 8, vertical: 4),
                            decoration: BoxDecoration(
                              color: Colors.green,
                              borderRadius: BorderRadius.circular(12),
                            ),
                            child: Text(
                              'CUMPLIDO',
                              style: TextStyle(
                                color: Colors.white,
                                fontSize: 12,
                                fontWeight: FontWeight.bold,
                              ),
                            ),
                          ),
                      ],
                    ),
                    SizedBox(height: 16),
                    Row(
                      mainAxisAlignment: MainAxisAlignment.spaceAround,
                      children: [
                        _buildStatCard(
                          'Inscritos',
                          inscripciones.length.toString(),
                          Icons.people,
                        ),
                        _buildStatCard(
                          'Confirmados',
                          inscripciones
                              .where((i) => i['asistio'] == true)
                              .length
                              .toString(),
                          Icons.check_circle,
                        ),
                        _buildStatCard(
                          'Total Abonos',
                          '\$${inscripciones.fold<int>(0, (sum, i) => sum + (i['abono'] as int? ?? 0))}',
                          Icons.monetization_on,
                        ),
                      ],
                    ),
                  ],
                ),
              ),

              // Boton para agregar persona
              if (!cumplido)
                Container(
                  padding: EdgeInsets.all(16),
                  child: ElevatedButton.icon(
                    style: ElevatedButton.styleFrom(
                      backgroundColor: widget.secondaryColor,
                      padding:
                          EdgeInsets.symmetric(horizontal: 24, vertical: 12),
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(12),
                      ),
                    ),
                    icon: Icon(Icons.person_add, color: Colors.white),
                    label: Text(
                      'Inscribir Persona',
                      style: TextStyle(
                        color: Colors.white,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                    onPressed: isLoading ? null : _mostrarDialogoInscribir,
                  ),
                ),

              // Lista de inscritos
              Expanded(
                child: inscripciones.isEmpty
                    ? Center(
                        child: Column(
                          mainAxisAlignment: MainAxisAlignment.center,
                          children: [
                            Icon(
                              Icons.person_add_disabled,
                              size: 64,
                              color: Colors.grey[400],
                            ),
                            SizedBox(height: 16),
                            Text(
                              'No hay personas inscritas',
                              style: TextStyle(
                                fontSize: 16,
                                color: Colors.grey[600],
                                fontWeight: FontWeight.w500,
                              ),
                            ),
                            SizedBox(height: 8),
                            Text(
                              'Agrega la primera persona al evento',
                              style: TextStyle(color: Colors.grey[500]),
                            ),
                          ],
                        ),
                      )
                    : ListView.builder(
                        controller: scrollController,
                        padding: EdgeInsets.symmetric(horizontal: 16),
                        itemCount: inscripciones.length,
                        itemBuilder: (context, index) {
                          final inscripcion = inscripciones[index];
                          return Card(
                            margin: EdgeInsets.symmetric(vertical: 4),
                            elevation: 2,
                            shape: RoundedRectangleBorder(
                              borderRadius: BorderRadius.circular(12),
                            ),
                            child: ListTile(
                              leading: CircleAvatar(
                                backgroundColor:
                                    widget.primaryColor.withOpacity(0.1),
                                child: Text(
                                  inscripcion['nombre'][0].toUpperCase(),
                                  style: TextStyle(
                                    color: widget.primaryColor,
                                    fontWeight: FontWeight.bold,
                                  ),
                                ),
                              ),
                              title: Text(
                                inscripcion['nombre'],
                                style: TextStyle(fontWeight: FontWeight.w600),
                              ),
                              subtitle: Text(
                                'Abono: \$${inscripcion['abono']}',
                                style: TextStyle(color: Colors.grey[600]),
                              ),
                              trailing: cumplido
                                  ? Container(
                                      padding: EdgeInsets.symmetric(
                                          horizontal: 8, vertical: 4),
                                      decoration: BoxDecoration(
                                        color: inscripcion['asistio'] == true
                                            ? Colors.green.withOpacity(0.1)
                                            : Colors.red.withOpacity(0.1),
                                        borderRadius: BorderRadius.circular(8),
                                      ),
                                      child: Text(
                                        inscripcion['asistio'] == true
                                            ? 'Asistio'
                                            : 'No asistio',
                                        style: TextStyle(
                                          color: inscripcion['asistio'] == true
                                              ? Colors.green
                                              : Colors.red,
                                          fontSize: 12,
                                          fontWeight: FontWeight.bold,
                                        ),
                                      ),
                                    )
                                  : Row(
                                      mainAxisSize: MainAxisSize.min,
                                      children: [
                                        IconButton(
                                          icon: Icon(Icons.edit,
                                              color: widget.secondaryColor),
                                          onPressed: () => _editarAbono(index),
                                        ),
                                        IconButton(
                                          icon: Icon(
                                            inscripcion['asistio'] == true
                                                ? Icons.check_circle
                                                : Icons.radio_button_unchecked,
                                            color:
                                                inscripcion['asistio'] == true
                                                    ? Colors.green
                                                    : Colors.grey,
                                          ),
                                          onPressed: () =>
                                              _toggleAsistencia(index),
                                        ),
                                      ],
                                    ),
                            ),
                          );
                        },
                      ),
              ),
            ],
          ),
        );
      },
    );
  }

  Widget _buildStatCard(String title, String value, IconData icon) {
    return Container(
      padding: EdgeInsets.all(12),
      decoration: BoxDecoration(
        color: Colors.white.withOpacity(0.2),
        borderRadius: BorderRadius.circular(12),
      ),
      child: Column(
        children: [
          Icon(icon, color: Colors.white, size: 20),
          SizedBox(height: 4),
          Text(
            value,
            style: TextStyle(
              color: Colors.white,
              fontWeight: FontWeight.bold,
              fontSize: 16,
            ),
          ),
          Text(
            title,
            style: TextStyle(
              color: Colors.white.withOpacity(0.9),
              fontSize: 12,
            ),
          ),
        ],
      ),
    );
  }

  void _mostrarDialogoInscribir() async {
    setState(() => isLoading = true);

    try {
      // ✅ OPTIMIZACIÓN: Consultas en paralelo
      final results = await Future.wait([
        // Consulta 1: Obtener personas de la tribu
        FirebaseFirestore.instance
            .collection('registros')
            .where('tribuAsignada', isEqualTo: widget.tribuId)
            .where('activo', isEqualTo: true) // ✅ Solo personas activas
            .get(),

        // Consulta 2: Obtener eventos activos de la tribu
        FirebaseFirestore.instance
            .collection('eventos')
            .where('tribuId', isEqualTo: widget.tribuId)
            .where('estado', isEqualTo: 'activo')
            .get(),
      ]);

      final personasSnapshot = results[0] as QuerySnapshot;
      final eventosActivosSnapshot = results[1] as QuerySnapshot;

      // ✅ OPTIMIZACIÓN: Crear Set de personas con inscripciones activas
      final Set<String> personasConInscripcionActiva = {};
      final ahora = DateTime.now();

      for (var eventoDoc in eventosActivosSnapshot.docs) {
        // Saltar el evento actual
        if (eventoDoc.id == widget.eventoDoc.id) continue;

        final eventoData = eventoDoc.data() as Map<String, dynamic>;
        final fechaFin = (eventoData['fechaFin'] as Timestamp).toDate();

        // Solo verificar eventos que no han terminado
        if (fechaFin.isAfter(ahora)) {
          final inscripciones = List<Map<String, dynamic>>.from(
              eventoData['inscripciones'] ?? []);

          for (var inscripcion in inscripciones) {
            personasConInscripcionActiva
                .add(inscripcion['personaId'] as String);
          }
        }
      }

      // ✅ OPTIMIZACIÓN: Filtrar usando Set (O(1) lookup)
      final personasDisponibles = personasSnapshot.docs.where((doc) {
        // Filtrar personas ya inscritas en este evento
        if (inscripciones.any((i) => i['personaId'] == doc.id)) {
          return false;
        }

        // Filtrar personas con inscripciones activas en otros eventos
        if (personasConInscripcionActiva.contains(doc.id)) {
          return false;
        }

        // Validar que tenga datos básicos
        final data = doc.data() as Map<String, dynamic>?;
        if (data == null) return false;

        final nombre = data['nombre']?.toString().trim() ?? '';
        return nombre.isNotEmpty && nombre != 'Sin nombre';
      }).toList();

      setState(() => isLoading = false);

      if (personasDisponibles.isEmpty) {
        final totalPersonas = personasSnapshot.docs.length;
        final yaInscritas = inscripciones.length;
        final conInscripcionesActivas = personasConInscripcionActiva.length;

        String mensaje;
        if (yaInscritas == totalPersonas) {
          mensaje =
              'Todas las personas de la tribu ya están inscritas en este evento';
        } else if (conInscripcionesActivas > 0) {
          mensaje =
              'Las personas restantes tienen inscripciones activas en otros eventos. Deben completar esos eventos primero.';
        } else {
          mensaje = 'No hay más personas disponibles para inscribir';
        }

        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(mensaje),
            backgroundColor: Colors.orange,
            duration: Duration(seconds: 4),
          ),
        );
        return;
      }

      final seleccion = await showDialog<DocumentSnapshot>(
        context: context,
        builder: (context) => _DialogoBuscarPersona(
          personas: personasDisponibles,
          primaryColor: widget.primaryColor,
          secondaryColor: widget.secondaryColor,
        ),
      );

      if (seleccion != null) {
        await _inscribirPersona(seleccion);
      }
    } catch (e) {
      setState(() => isLoading = false);
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Error al cargar personas: $e'),
          backgroundColor: Colors.red,
        ),
      );
    }
  }

  // Función auxiliar para verificar inscripciones activas
  Future<bool> _tieneInscripcionActiva(String personaId) async {
    try {
      final eventosSnapshot = await FirebaseFirestore.instance
          .collection('eventos')
          .where('tribuId', isEqualTo: widget.tribuId)
          .where('estado', isEqualTo: 'activo')
          .get();

      final ahora = DateTime.now();

      for (var eventoDoc in eventosSnapshot.docs) {
        // Saltar el evento actual
        if (eventoDoc.id == widget.eventoDoc.id) continue;

        final eventoData = eventoDoc.data();
        final fechaFin = (eventoData['fechaFin'] as Timestamp).toDate();

        // Solo verificar eventos que no han terminado
        if (fechaFin.isAfter(ahora)) {
          final inscripciones = List<Map<String, dynamic>>.from(
              eventoData['inscripciones'] ?? []);

          if (inscripciones.any((i) => i['personaId'] == personaId)) {
            return true;
          }
        }
      }
      return false;
    } catch (e) {
      print('Error verificando inscripciones activas: $e');
      return false;
    }
  }

  Future<void> _inscribirPersona(DocumentSnapshot personaDoc) async {
    try {
      // ✅ Validar que el documento tenga datos
      if (!personaDoc.exists || personaDoc.data() == null) {
        if (mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(
              content:
                  Text('Error: La persona seleccionada no tiene datos válidos'),
              backgroundColor: Colors.red,
            ),
          );
        }
        return;
      }

      final personaData = personaDoc.data() as Map<String, dynamic>;

      // ✅ Validar campos requeridos con valores por defecto seguros
      final nombre = personaData['nombre']?.toString().trim() ?? 'Sin nombre';
      final apellido = personaData['apellido']?.toString().trim() ?? '';
      final nombreCompleto = apellido.isNotEmpty ? '$nombre $apellido' : nombre;

      // ✅ Validar que el nombre no esté vacío
      if (nombreCompleto.isEmpty || nombreCompleto == 'Sin nombre') {
        if (mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(
              content: Text('Error: La persona no tiene un nombre válido'),
              backgroundColor: Colors.red,
            ),
          );
        }
        return;
      }

      // ✅ Crear inscripción con validación
      final nuevaInscripcion = {
        'personaId': personaDoc.id,
        'nombre': nombreCompleto,
        'abono': 0,
        'asistio': false,
        'fechaInscripcion': Timestamp.now(),
      };

      // ✅ Actualizar estado local primero
      if (mounted) {
        setState(() {
          inscripciones.add(nuevaInscripcion);
        });
      }

      // ✅ Guardar en Firebase
      await FirebaseFirestore.instance
          .collection('eventos')
          .doc(widget.eventoDoc.id)
          .update({
        'inscripciones': inscripciones,
      });

      // ✅ Mostrar confirmación
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Row(
              children: [
                Icon(Icons.check_circle, color: Colors.white),
                SizedBox(width: 12),
                Expanded(child: Text('$nombreCompleto inscrito correctamente')),
              ],
            ),
            backgroundColor: Colors.green,
            behavior: SnackBarBehavior.floating,
            shape:
                RoundedRectangleBorder(borderRadius: BorderRadius.circular(10)),
            duration: Duration(seconds: 3),
          ),
        );
      }
    } catch (e, stackTrace) {
      // ✅ Manejo de errores mejorado
      print('❌ Error al inscribir persona: $e');
      print('Stack trace: $stackTrace');

      // Revertir cambios en caso de error
      if (mounted) {
        setState(() {
          if (inscripciones.isNotEmpty) {
            inscripciones.removeLast();
          }
        });

        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Row(
              children: [
                Icon(Icons.error_outline, color: Colors.white),
                SizedBox(width: 12),
                Expanded(
                  child: Text('Error al inscribir: ${e.toString()}'),
                ),
              ],
            ),
            backgroundColor: Colors.red,
            behavior: SnackBarBehavior.floating,
            shape:
                RoundedRectangleBorder(borderRadius: BorderRadius.circular(10)),
            duration: Duration(seconds: 4),
          ),
        );
      }
    }
  }

  void _editarAbono(int index) async {
    final controller =
        TextEditingController(text: inscripciones[index]['abono'].toString());

    final resultado = await showDialog<String>(
      context: context,
      builder: (context) => AlertDialog(
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(15)),
        title: Row(
          children: [
            Icon(Icons.monetization_on, color: widget.primaryColor),
            SizedBox(width: 8),
            Text('Editar Abono'),
          ],
        ),
        content: TextField(
          controller: controller,
          keyboardType: TextInputType.number,
          decoration: InputDecoration(
            prefixText: '\$ ',
            labelText: 'Abono en COP',
            border: OutlineInputBorder(
              borderRadius: BorderRadius.circular(10),
            ),
          ),
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: Text('Cancelar'),
          ),
          ElevatedButton(
            style: ElevatedButton.styleFrom(
              backgroundColor: widget.secondaryColor,
            ),
            onPressed: () => Navigator.pop(context, controller.text),
            child: Text('Guardar', style: TextStyle(color: Colors.white)),
          ),
        ],
      ),
    );

    if (resultado != null) {
      final abono = int.tryParse(resultado.replaceAll(',', '')) ?? 0;
      await _actualizarInscripcion(index, {'abono': abono});
    }
  }

  void _toggleAsistencia(int index) async {
    final nuevaAsistencia = !inscripciones[index]['asistio'];
    await _actualizarInscripcion(index, {'asistio': nuevaAsistencia});
  }

  Future<void> _actualizarInscripcion(
      int index, Map<String, dynamic> cambios) async {
    try {
      setState(() {
        inscripciones[index].addAll(cambios);
      });

      await FirebaseFirestore.instance
          .collection('eventos')
          .doc(widget.eventoDoc.id)
          .update({
        'inscripciones': inscripciones,
      });

      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Actualizado correctamente'),
          backgroundColor: Colors.green,
        ),
      );
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Error al actualizar: $e'),
          backgroundColor: Colors.red,
        ),
      );
    }
  }
}

// Esta clase permite el arrastre y reordenamiento de los cards de eventos

class ReorderableWrap extends StatefulWidget {
  final List<Widget> children;
  final double spacing;
  final double runSpacing;
  final Function(int oldIndex, int newIndex)? onReorder;

  const ReorderableWrap({
    Key? key,
    required this.children,
    this.spacing = 0.0,
    this.runSpacing = 0.0,
    this.onReorder,
  }) : super(key: key);

  @override
  _ReorderableWrapState createState() => _ReorderableWrapState();
}

class _ReorderableWrapState extends State<ReorderableWrap>
    with TickerProviderStateMixin {
  List<Widget> _children = [];
  int? _draggedIndex;
  late AnimationController _scaleController;
  late Animation<double> _scaleAnimation;

  @override
  void initState() {
    super.initState();
    _children = List.from(widget.children);

    _scaleController = AnimationController(
      duration: Duration(milliseconds: 200),
      vsync: this,
    );

    _scaleAnimation = Tween<double>(
      begin: 1.0,
      end: 1.05,
    ).animate(CurvedAnimation(
      parent: _scaleController,
      curve: Curves.elasticOut,
    ));
  }

  @override
  void dispose() {
    _scaleController.dispose();
    super.dispose();
  }

  @override
  void didUpdateWidget(ReorderableWrap oldWidget) {
    super.didUpdateWidget(oldWidget);
    if (widget.children != oldWidget.children) {
      _children = List.from(widget.children);
    }
  }

  @override
  Widget build(BuildContext context) {
    return Wrap(
      spacing: widget.spacing,
      runSpacing: widget.runSpacing,
      children: _children.asMap().entries.map((entry) {
        final index = entry.key;
        final child = entry.value;

        return AnimatedBuilder(
          animation: _scaleAnimation,
          builder: (context, _) {
            return LongPressDraggable<int>(
              data: index,
              hapticFeedbackOnStart: true,
              feedback: Material(
                elevation: 12,
                borderRadius: BorderRadius.circular(16),
                shadowColor: Colors.black45,
                child: Transform.scale(
                  scale: 1.1,
                  child: Container(
                    decoration: BoxDecoration(
                      borderRadius: BorderRadius.circular(16),
                      boxShadow: [
                        BoxShadow(
                          color: Colors.blue.withOpacity(0.3),
                          blurRadius: 8,
                          spreadRadius: 2,
                        ),
                      ],
                    ),
                    child: Opacity(
                      opacity: 0.9,
                      child: child,
                    ),
                  ),
                ),
              ),
              childWhenDragging: Transform.scale(
                scale: 0.95,
                child: Opacity(
                  opacity: 0.5,
                  child: Container(
                    decoration: BoxDecoration(
                      borderRadius: BorderRadius.circular(16),
                      border: Border.all(
                        color: Colors.grey.withOpacity(0.5),
                        width: 2,
                        style: BorderStyle.solid,
                      ),
                    ),
                    child: child,
                  ),
                ),
              ),
              onDragStarted: () {
                setState(() {
                  _draggedIndex = index;
                });
                _scaleController.forward();

                // Feedback háptico
                HapticFeedback.mediumImpact();
              },
              onDragEnd: (details) {
                setState(() {
                  _draggedIndex = null;
                });
                _scaleController.reverse();
              },
              child: DragTarget<int>(
                onWillAccept: (draggedIndex) {
                  return draggedIndex != null && draggedIndex != index;
                },
                onAccept: (draggedIndex) {
                  if (widget.onReorder != null) {
                    widget.onReorder!(draggedIndex, index);
                  }

                  setState(() {
                    final draggedChild = _children.removeAt(draggedIndex);
                    _children.insert(index, draggedChild);
                    _draggedIndex = null;
                  });

                  // Feedback háptico al soltar
                  HapticFeedback.lightImpact();
                },
                onMove: (details) {
                  // Feedback visual mientras se arrastra sobre el target
                  HapticFeedback.selectionClick();
                },
                builder: (context, candidateData, rejectedData) {
                  final isTarget = candidateData.isNotEmpty;
                  final isDragging = _draggedIndex == index;

                  return AnimatedContainer(
                    duration: Duration(milliseconds: 300),
                    curve: Curves.easeInOut,
                    decoration: BoxDecoration(
                      borderRadius: BorderRadius.circular(16),
                      border: isTarget
                          ? Border.all(
                              color: Colors.blue,
                              width: 3,
                            )
                          : null,
                      boxShadow: isTarget
                          ? [
                              BoxShadow(
                                color: Colors.blue.withOpacity(0.3),
                                blurRadius: 8,
                                spreadRadius: 2,
                              ),
                            ]
                          : null,
                    ),
                    transform: Matrix4.identity()..scale(isTarget ? 1.02 : 1.0),
                    child: Container(
                      decoration: BoxDecoration(
                        borderRadius: BorderRadius.circular(16),
                        color: isTarget
                            ? Colors.blue.withOpacity(0.05)
                            : Colors.transparent,
                      ),
                      child: child,
                    ),
                  );
                },
              ),
            );
          },
        );
      }).toList(),
    );
  }
}
//--------------------------------------------------------------------------------------------------------
